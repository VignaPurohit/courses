---
title: "Cloud Native Geospatial Workflows with QGIS (Full workshop Material)"
subtitle: "Using QGIS for visualizing and analyzing large cloud-hosted datasets."
author: "Ujaval Gandhi"
fontsize: 12pt
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
    highlight: pygments
    includes:
      after_body: comment.html
  # word_document:
  #   toc: false
  #   fig_caption: false
  # pdf_document:
  #   latex_engine: xelatex
  #   toc: yes
  #   toc_depth: 3
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \renewcommand{\footrulewidth}{0.4pt}
- \fancyhead[LE,RO]{\thepage}
- \geometry{left=1in,top=0.75in,bottom=0.75in}
- \fancyfoot[CE,CO]{{\includegraphics[height=0.5cm]{images/cc-by-nc.png}} Ujaval Gandhi http://www.spatialthoughts.com}
classoption: a4paper
---

\newpage

***

```{r echo=FALSE, fig.align='center', out.width='75%', out.width='250pt'}
knitr::include_graphics('images/spatial_thoughts_logo.png')
```

***

\newpage

# Introduction 

This workshop will introduce participants to the modern approach to working with large datasets in QGIS. Modern data formats - such as Cloud-Optimized GeoTIFFs (COG), Cloud-Optimized Point Clouds (COPC), and FlatGeoBuf (FGB) allow datasets to be streamed from cloud storage without having to download entire files. Spatial Temporal Asset Catalog (STAC) provides a standardized way to query cloud-hosted datasets. Combined with QGIS, these technologies allow users to visualize and analyze large datasets which was not possible before.

[![View Presentation](images/qgis_cloud_native_geospatial/introduction.png){width="400px"}](https://docs.google.com/presentation/d/1cpu1PcEX1pCpFvGZ9yyNH_YKfndmSoxV6qi2Bf7p_jk/edit?usp=sharing){target="_blank"}

[View the Presentation &#8599;](https://docs.google.com/presentation/d/1cpu1PcEX1pCpFvGZ9yyNH_YKfndmSoxV6qi2Bf7p_jk/edit?usp=sharing){target="_blank"}

# Installation and Setting up the Environment

## Install QGIS

This workshop requires QGIS LTR version 3.34. Please review [QGIS-LTR Installation Guide](install-qgis-ltr.html) for step-by-step instructions.

## Get the Data Package

We have created a data package containing checkpoint projects that will allow you to load the results of each section. You can download the data package from `qgis-cloud-native-geospatial.zip`.

# 1. Cloud Native Geospatial Formats

## 1.1 Load a Cloud-Optimized GeoTIFF (COG)

1. Open QGIS. We'll first load a basemap. From the *Browser* panel, scroll down and locate **XYZ Tiles &rarr; OpenStreetMap** tile layer. Drag and drop it to the main canvas. 

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/cog1.png')
```

2. Once the `OpenStreetMap` layer is loaded, go to your region of interest. Now we will load a 8GB cloud-optimized geotiff file stored on Google Cloud Storage and stream the pixels over this region. Click the *Open Data Source Manager* button.


```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/cog2.png')
```

3. Select the *Raster* tab. Select `Protocol: HTTP(S), cloud etc.` as the *Source Type*. Enter the following URL as the *URI*. Click *Add*.

```
https://storage.googleapis.com/spatialthoughts-public-data/ntl/viirs/viirs_ntl_2021_global.tif
```
 
```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/cog3.png')
```

4. A new layer `viirs_ntl_2021_global` will be added to the *Layers* panel. This is a global layer showing nighttime lights intensity values recorded by the VIIRS instrument. Note that the file loaded instantly and as you zoom in further, higher resolution pixels are fetched dynamically from the file. While this file is located on a remote location, you can use it just as if it was a regular GeoTIFF file. Let's visualize the layer using a color-ramp. Click the *Open Layer Styling Panel* button on the *Layers* panel.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/cog4.png')
```

5. In the *Layer Styling* panel, change the renderer to `Singleband pseudocolor`. Select a color ramp of your choice. The layer rendering will be updated.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/cog5.png')
```

## 1.2 Load a FlatGeoBuf (FGB) Vector Layer

1. Next, we will learn how to load a cloud-hosted vector layer to QGIS. We will stream a 800MB line layer hosted on GitHub file storage and stream the features in the current canvas extent. Click the *Open Data Source Manager* button.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/fgb1.png')
```

2. Select the *Vector* tab. Select `Protocol: HTTP(S), cloud etc.` as the *Source Type*. Enter the following URL as the *URI*. Click *Add*.

```
https://github.com/spatialthoughts/cloud-native-geospatial/releases/download/hydrorivers/hydrorivers.fgb
```

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/fgb2.png')
```

3. A new layer `hydrorivers -- rivers` will be added to the *Layers* panel. This is a large line layer containing over 2.5 million features. QGIS will request and load only the features within the current canvas extent. FlatGeoBuf format does not contain simplified versions of features that can be loaded at lower zoom levels. So if you zoom out to a large region, all the features within that region will be requested. To prevent fetching unnecessarily large amounts of data - we can enable scale dependent visibility. Right-click the `hydrorivers -- rivers` layer and select *Properties*.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/fgb3.png')
```

4. Select the *Rendering* tab and enable the *Scale Dependent Visibility*. From the drop-down selector for *Minimum (exclusive)* scale, select `1:1000000`. Click *OK*.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/fgb4.png')
```

5. Now only when your canvas is zoomed in beyond the selected scale, the features will be requested and rendered. Next, we will apply some style to the vector layer. Click the *Open Layer Styling Panel* button on the *Layers* panel. Change the *Color* to any color of your choice. You can also adjust the *Width* of the lines if required.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/fgb5.png')
```

6. Zoom/Pan around the map and go to any region in the world. Data from both the cloud-hosted files will be requested and rendered in the chosen style.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/fgb6.png')
```

# 2. SpatioTemporal Asset Catalogs (STAC)

## 2.1 Load a STAC Asset

1. Visit the [OpenLandMap STAC](https://stac.openlandmap.org/) catalog in a web browser. Locate the **JRC Global Human Settlement annual population (GHS)** collection and click to view more details.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/stac1.png')
```

2. This collection consists of GHSL Gridded Population rasters from year 2000-2021. Sort the collection in *Descending* order. The first item will be the latest population raster. Click on it to explore it further.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/stac2.png')
```

3. This STAC Item consists of a Cloud-Optimized GeoTIFF image of population for the year 2021. Click **Copy URL** button to get the direct link to access the file.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/stac3.png')
```

4. Open QGIS. From the *Browser* panel, scroll down and locate **XYZ Tiles &rarr; OpenStreetMap** tile layer. Drag and drop it to the main canvas. Once the `OpenStreetMap` layer is loaded, go to your region of interest. Click the *Open Data Source Manager* button.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/stac4.png')
```

5. Select the *Raster* tab. Select `Protocol: HTTP(S), cloud etc.` as the *Source Type*. Enter the URL copied in the previous step as the *URI*. Click *Add*.

```
https://s3.openlandmap.org/arco/pop.count_ghs.jrc_m_100m_s_20210101_20211231_go_epsg.4326_v20230620.tif
```

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/stac5.png')
```

6. A new layer `pop.count_ghs.jrc_m_100m_s_20210101_20211231_go_epsg.4326_v20230620` will be added to the *Layers* panel. This image represents the population count in each 100m x 100m grid cell. The original data comes with decimal values, but to optimize the storage space and transfer of data, the image is saved with the data type *UInt32* (Integers). To preserve the full fidelity of the data, the original pixel values are multiplied by 100. Hence if the the pixel value is `2068` - it represents a population count of `20.68`. Keep this in mind and we will appropriately scale our results with this factor. 

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/stac6.png')
```

## 2.2 Zonal Statistics with Cloud-hosted Data

1. Let's load some vector data. Click the *Open Data Source Manager* button. Select the *Vector* tab. Select `Protocol: HTTP(S), cloud etc.` as the *Source Type*. Enter the following URL as the *URI*. Click *Add*.

```
https://storage.googleapis.com/spatialthoughts-public-data/geoboundaries/admin2.fgb
```

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/zonal1.png')
```

2. A new layer `admin2 -- adm2_polygons` will be added to the *Layers* panel. This is a very large vector polygon layer and the polygons for Admin2 regions within the current canvas extents will be fetched and loaded. We will pick a region of interest. To make the selection easier, let's add some labels to the polygons. Click the *Open Layer Styling Panel* button on the *Layers* panel.Select the *Labels* tab. Select `Single Labels` from the drop-down menu and select `adm2_name` as the *Value*. The name of the administrative region will be rendered on the map.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/zonal2.png')
```

3. Click on the *Select Features by Area or Single Click* button on the *Selection Toolbar*. Once activated, click on your chosen administrative region to select it. Go to **Processing &rarr; Toolbox**. From the *Processing Toolbox*, search and locate the **Raster analysis &rarr; Zonal statistics** algorithm. Double-click to open it.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/zonal3.png')
```

4. In the *Zonal Statistics* dialog, select `admin2 -- adm2_polygons` as the *Input layer*. Make sure to check the *Selected features only* box. Select the `pop.count_ghs.jrc_m_100m_s_20210101_20211231_go_epsg.4326_v20230620` layer as the *Raster layer*. Enter `population_` as the *Output column prefix*. For the *Statistics to calculate*, click the *...* button and select only `Sum`. Save the output as a file `zonal_stats.gpkg` and click *Run*.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/zonal4.png')
```

5. The algorithm will fetch the pixels required to perform the calculation and once complete, a new layer `zonal_stats` will be added to the *Layers* panel. This layer contains the result of the Zonal Statistics that was computed directed from the cloud-hosted dataset by fetching only required pixels and features - saving us time, bandwidth and storage.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/zonal5.png')
```

6. The resulting value needs to be scaled by a factor of 100 to get the actual population count. Search and locate the **Vector table &rarr; Field calculator** algorithm and double-click to open it. Select `zonal_stats` as the *Input layer* and enter `population` as the *Field name*. Enter the following expression to scale the population value. Enter the output file name as `zonal_stats_final.gpkg` and click *Run*.

```
"population_sum" / 100
```

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/zonal6.png')
```

7. Once the computation finishes and the new layer `zonal_stats_final` is loaded, right-click the layer and select *Open Attribute Table*. The field **population** contains the total population within the selected administrative region.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/zonal7.png')
```

## 2.3 Explore STAC Catalogs

There are many publicly accessible STAC catalogs available - with more providers making their data available through STAC. To explore all the available catalogs, you can visit the [STAC Index](https://stacindex.org/). Click on *Catalogs* and explore the listings.

```{r echo=FALSE, fig.align='center', out.width='75%'}
knitr::include_graphics('images/qgis_cloud_native_geospatial/stacindex.png')
```


# 3. STAC API Browser Plugin

## 3.1 Query a STAC API

## 3.2 Analyze Landcover Change

## 3.3 Create a Sentinel-2 RGB Composite

# 4. Creating and Hosting Cloud Native Geospatial Data

## 4.1 Creating Cloud Native Geospatial Data

```
gdal_translate -of COG viirs_ntl_2021_global.tif viirs_ntl_2021_global_cog.tif
```

```
ogr2ogr -f FlatGeobuf hydrorivers.fgb hydrorivers.gpkg
```

```
ogr2ogr -f FlatGeobuf admin2.fgb admin2.gpkg -select "adm2_name,adm1_name,adm0_name,iso_2,iso_3"
```

## 4.2 Hosting Cloud Native Geospatial Data

# Data Credits

* Global Edge-matched Subnational Boundaries: Humanitarian Edge Matched, FieldMaps, OCHA, geoBoundaries, U.S. Department of State, OpenStreetMap. Downloaded from https://fieldmaps.io/data


# License

This workshop material is licensed under a [Creative Commons Attribution 4.0 International (CC BY 4.0)](https://creativecommons.org/licenses/by/4.0/). You are free to re-use and adapt the material but are required to give appropriate credit to the original author as below:

*Cloud Native Geospatial Workflows with QGIS* by Ujaval Gandhi [www.spatialthoughts.com](https://spatialthoughts.com)


&copy; 2024 Spatial Thoughts [www.spatialthoughts.com](https://spatialthoughts.com)