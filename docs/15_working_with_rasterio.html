<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>15_working_with_rasterio.utf8</title>

<script src="site_libs/header-attrs-2.6/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372432-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372432-3');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<div id="working-with-rasterio" class="section level1">
<h1>Working with RasterIO</h1>
<p><a href="https://rasterio.readthedocs.io/en/latest/">RasterIO</a> is a modern library to work with geospatial data in a gridded format. It excels at providing an easy way to read/write raster data and access individual bands and pixels as <code>numpy</code> arrays.</p>
<p>RasterIO is built on top of the popular <a href="https://gdal.org/">GDAL (Geospatial Data Abstraction Library)</a>. GDAL is written in C++ so the Python API provided by GDAL is not very intuitive for Python users. RaserIO aims to make it easy for Python users to use the underlying GDAL library in an intuitive way.</p>
<p>In this section, we will take 4 individual SRTM tiles around the Mt. Everest region and merge them to a single GeoTiff using RasterIO.</p>
<p><img src="images/python_foundation/srtm.png" /></p>
<pre class="python"><code>import rasterio</code></pre>
<pre class="python"><code>import os
data_pkg_path = &#39;data&#39;
srtm_dir = &#39;srtm&#39;
filename = &#39;N28E087.hgt&#39;
path = os.path.join(data_pkg_path, srtm_dir, filename)</code></pre>
<div id="reading-raster-data" class="section level2">
<h2>Reading Raster Data</h2>
<p>RasterIO can read any raster format supported by the GDAL library. We can call the <code>open()</code> method with the file path of the raster. The resulting dataset behaves much like Python’s File object.</p>
<pre class="python"><code>dataset = rasterio.open(path)</code></pre>
<p>You can check information about the raster using the <code>meta</code> attribute.</p>
<p>An important property is the dataset <em>transform</em>. The transform contains the pixel resolution of the dataset and the row and column coordinates of the upper left corner of the dataset.</p>
<pre class="python"><code>metadata = dataset.meta
metadata</code></pre>
<p>To read the pixel values, we need to call the <code>read()</code> method by passing it a band’s index number. Following the GDAL convention, bands are indexed from 1. Since our dataset contain just 1-band, we can read it as follows.</p>
<pre class="python"><code>band1 = dataset.read(1)
print(band1)</code></pre>
<p>Finally, when we are done with the dataset, we must close it. It is especially important when writing a dataset.</p>
<pre class="python"><code>dataset.close()</code></pre>
</div>
<div id="merging-datasets" class="section level2">
<h2>Merging Datasets</h2>
<p>Let’s see how we can read the 4 individual tiles and mosaic them together. RasterIO provides multiple sub-modules for various raster operations. We can use the <code>rasterio.merge</code> module to carry out this operation.</p>
<p>We first find all the individual files in the directory using the <code>os.listdir()</code> function.</p>
<pre class="python"><code>srtm_path = os.path.join(data_pkg_path, &#39;srtm&#39;)
all_files = os.listdir(srtm_path)
print(all_files)</code></pre>
<p>The rasterio.merge module has a <code>merge()</code> method that takes a list of <em>datasets</em> and returns the merged dataset. So we create an empty list, open each of the files and append it to the list.</p>
<pre class="python"><code>dataset_list = []
for file in all_files:
    path = os.path.join(srtm_path, file)
    dataset_list.append(rasterio.open(path))
print(dataset_list)</code></pre>
<p>We can pass on the list of tile dataset to the merge method, which will return us the merged data and a new <em>transform</em> which contains the updated extent of the merged raster.</p>
<pre class="python"><code>from rasterio import merge
merged_result = merge.merge(dataset_list)
print(merged_result)</code></pre>
<p>We save the data and the transform to separate variables.</p>
<pre class="python"><code>merged_data = merged_result[0]
merged_transform = merged_result[1]</code></pre>
<p>Verify that the resulting array shape the sum of individual rasters</p>
<pre class="python"><code>print(merged_data.shape)</code></pre>
</div>
<div id="writing-raster-data" class="section level2">
<h2>Writing Raster Data</h2>
<p>Similar to regular Python files, to create a new file, we can open the output file in the <em>write</em> mode. RasterIO provides a <code>write()</code> method that we can use to write individual bands.</p>
<pre class="python"><code>output_filename = &#39;merged.tif&#39;
output_dir = &#39;output&#39;
output_path = os.path.join(output_dir, output_filename)</code></pre>
<p>We need to specify many metadata parameters to initialize the output dataset. Some of these parameter values can be directly copied from the input files, such as <code>crs</code>, <code>dtype</code>, <code>nodata</code> etc. , while others can be obtained from the merged dataset, such as <code>height</code> and <code>width</code>.</p>
<p>Remember to call the <code>close()</code> method which will finalize the file and write the data to disk.</p>
<pre class="python"><code>new_dataset = rasterio.open(output_path, &#39;w&#39;, 
                            driver=&#39;GTiff&#39;,
                            height=merged_data.shape[1],
                            width=merged_data.shape[2],
                            count=1,
                            nodata=-32768.0,
                            dtype=merged_data.dtype,
                            crs=&#39;+proj=latlong&#39;,
                            transform=merged_transform)
new_dataset.write(merged_data)
new_dataset.close()
print(&#39;Successfully written output file at {}&#39;.format(output_path))</code></pre>
</div>
<div id="exercise" class="section level2">
<h2>Exercise</h2>
<p>The merged array represents elevation values. The extent of the tiles cover Mt. Everest. Read the resulting raster and find the maximum elevation value contained in it.</p>
<pre class="python"><code>import rasterio
import os
import numpy as np

output_filename = &#39;merged.tif&#39;
output_dir = &#39;output&#39;
output_path = os.path.join(output_dir, output_filename)

# Read the output file as a NumPy array and find the maximum value</code></pre>
<hr />
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
