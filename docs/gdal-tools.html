<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>Mastering GDAL Tools (Full Course Material)</title>

<script src="site_libs/header-attrs-2.6/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372432-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372432-3');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Mastering GDAL Tools (Full Course Material)</h1>
<h3 class="subtitle">Satellite and aerial image processing using GDAL tools</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#get-the-data-package">Get the Data Package</a></li>
<li><a href="#software">Software</a>
<ul>
<li><a href="#gdal">GDAL</a>
<ul>
<li><a href="#windows">Windows</a></li>
<li><a href="#maclinux">Mac/Linux</a></li>
</ul></li>
<li><a href="#qgis">QGIS</a></li>
</ul></li>
<li><a href="#getting-familiar-with-the-command-prompt">Getting Familiar with the Command Prompt</a>
<ul>
<li><a href="#windows-1">Windows</a></li>
<li><a href="#maclinux-1">Mac/Linux</a></li>
</ul></li>
<li><a href="#gdal-tools">1. GDAL Tools</a>
<ul>
<li><a href="#basic-raster-processing">1.1 Basic Raster Processing</a>
<ul>
<li><a href="#merging-tiles">1.1.1 Merging Tiles</a></li>
<li><a href="#exercise-1">Exercise 1</a></li>
<li><a href="#converting-formats">1.1.2 Converting Formats</a></li>
<li><a href="#compressing-output">1.1.3 Compressing Output</a></li>
<li><a href="#setting-nodata-values">1.1.4 Setting NoData Values</a></li>
<li><a href="#wrting-cloud-optimized-geotiff-cog">1.1.5 Wrting Cloud-Optimized GeoTIFF (COG)</a></li>
</ul></li>
<li><a href="#processing-elevation-data">1.2 Processing Elevation Data</a>
<ul>
<li><a href="#creating-hillshade">1.2.1 Creating Hillshade</a></li>
<li><a href="#creating-color-relief">1.2.2 Creating Color Relief</a></li>
<li><a href="#exercise-2">Exercise 2</a></li>
<li><a href="#creating-contours">1.2.3 Creating Contours</a></li>
<li><a href="#exercise-3">Exercise 3</a></li>
</ul></li>
<li><a href="#processing-aerial-imagery">1.3 Processing Aerial Imagery</a>
<ul>
<li><a href="#create-a-preview-image-from-source-tiles">1.3.1 Create a preview image from source tiles</a></li>
<li><a href="#create-a-tile-index">1.3.2 Create a Tile Index</a></li>
<li><a href="#mosaic-and-clip-to-aoi">1.3.3 Mosaic and clip to AOI</a></li>
<li><a href="#tips-for-improving-performance">1.3.4 Tips for Improving Performance</a></li>
<li><a href="#creating-overviews">1.3.5 Creating Overviews</a></li>
</ul></li>
<li><a href="#processing-satellite-imagery">1.4 Processing Satellite Imagery</a>
<ul>
<li><a href="#merging-individual-bands-into-rgb-composite">1.4.1 Merging individual bands into RGB composite</a></li>
<li><a href="#apply-histogram-stretch-and-color-correction">1.4.2 Apply Histogram Stretch and Color Correction</a></li>
<li><a href="#exercise-4">Exercise 4</a></li>
<li><a href="#pan-sharpening">1.4.3 Pan Sharpening</a></li>
<li><a href="#raster-algebra">1.4.4 Raster Algebra</a></li>
</ul></li>
<li><a href="#processing-wms-layers">1.5 Processing WMS Layers</a></li>
<li><a href="#georeferencing">1.6 Georeferencing</a>
<ul>
<li><a href="#georeferencing-images-with-bounding-box-coordinates">1.6.1 Georeferencing Images with Bounding Box Coordinates</a></li>
<li><a href="#georeferencing-with-gcps">1.6.2 Georeferencing with GCPs</a></li>
</ul></li>
</ul></li>
<li><a href="#ogr-tools">2. OGR Tools</a>
<ul>
<li><a href="#working-with-csv-files">2.1 Working with CSV files</a></li>
<li><a href="#working-with-multiple-layers">2.2 Working with Multiple Layers</a>
<ul>
<li><a href="#read-geonames-files">2.2.1 Read Geonames Files</a></li>
<li><a href="#applying-filters">2.2.2 Applying Filters</a></li>
<li><a href="#merging-files">2.2.3 Merging Files</a></li>
</ul></li>
<li><a href="#geoprocessing-and-spatial-queries">2.2.4 Geoprocessing and Spatial Queries</a></li>
</ul></li>
<li><a href="#multi-criteria-weighted-overlay-analysis">3. Multi Criteria Weighted Overlay Analysis</a>
<ul>
<li><a href="#rasterize-vector-layers">3.1 Rasterize vector layers</a></li>
<li><a href="#generate-proximity-euclidean-distance-rasters">3.2 Generate proximity (Euclidean distance) rasters</a></li>
<li><a href="#re-classify-raster-values">3.3 Re-classify raster values</a></li>
<li><a href="#overlay-analysis">3.4 Overlay analysis</a></li>
</ul></li>
<li><a href="#running-commands-in-batch">4. Running commands in batch</a></li>
<li><a href="#supplement">Supplement</a>
<ul>
<li><a href="#creating-colorized-hillshade">Creating Colorized Hillshade</a></li>
<li><a href="#splitting-a-mosaic-into-tiles">Splitting a Mosaic into Tiles</a></li>
</ul></li>
<li><a href="#resources">Resources</a></li>
<li><a href="#data-credits">Data Credits</a></li>
<li><a href="#license">License</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p><a href="https://gdal.org/">GDAL</a> is an open-source library for raster and vector geospatial data formats. The library comes with a vast collection of utility programs that can perform many geoprocessing tasks. This class introduces GDAL and OGR utilities with example workflows for processing raster and vector data. The class also shows how to use these utility programs to build Spatial ETL pipelines and do batch processing.</p>
<p><a href="https://docs.google.com/presentation/d/1JvGjb5eNM9F--zfyTFAeAk0R5UG6weFpOUVDVkJSnho/edit?usp=sharing" target="_blank"><img src="images/gdal/introduction.png" width="400" alt="View Presentation" /></a></p>
<p><a href="https://docs.google.com/presentation/d/1JvGjb5eNM9F--zfyTFAeAk0R5UG6weFpOUVDVkJSnho/edit?usp=sharing" target="_blank">View the Presentation ↗</a></p>
</div>
<div id="get-the-data-package" class="section level1">
<h1>Get the Data Package</h1>
<p>The code examples in this class use a variety of datasets. All the required datasets are supplied to you in the <code>gdal_tools.zip</code> file. Unzip this file to the <code>Downloads</code> directory. All commands below assume the data is available in the <code>&lt;home folder&gt;/Downloads/gdal_tools/</code> directory.</p>
<p><em>Not enrolled in our instructor-led class but want to work through the material on your own?</em> <a href="https://docs.google.com/forms/d/e/1FAIpQLScfS6sICXfbAfPr2MOAkfAIbpj8G6v3FR_YtMRGOoKrDnDBtw/viewform" target="_blank">Get free access to the data package</a></p>
</div>
<div id="software" class="section level1">
<h1>Software</h1>
<p>This courses requires installing the GDAL package. Along with GDAL, we highly recommend installing QGIS to view the result of the command-line operations. You will find installation instructions for both the software below.</p>
<div id="gdal" class="section level2">
<h2>GDAL</h2>
<p>The preferred method for installing the GDAL Tools is via Anaconda. Follow these steps to install Anaconda and the GDAL library.</p>
<p><a href="https://www.anaconda.com/products/individual">Download the Anaconda Installer</a> for Python 3.7 (or a higher version) for your operating system. Once downloaded, double click the installer and install it into the default suggested directory.</p>
<p><em>Note: If your username has spaces, or non-English characters, it causes problems. In that case, you can install it to a path such as <code>C:\anaconda</code>.</em></p>
<p><img src="images/gdal/conda.png" width="75%" style="display: block; margin: auto;" /></p>
<div id="windows" class="section level3">
<h3>Windows</h3>
<p>Once Anaconda installed, search for <em>Anaconda Prompt</em> in the Start Menu and launch a new window.</p>
<ol style="list-style-type: decimal">
<li>Create a new environment named <code>gdal</code>. When prompted to confirm, type <code>y</code> and press <em>Enter</em>.</li>
</ol>
<pre><code>conda create --name gdal</code></pre>
<blockquote>
<p>Note: You can use the shortcut <em>Shift + Insert</em> to paste commands in Anaconda Prompt.</p>
</blockquote>
<p><img src="images/gdal/condawin1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Activate the environment and install the <code>gdal</code> package. When prompted to confirm, type <code>y</code> and press <em>Enter</em>.</li>
</ol>
<pre><code>conda activate gdal
conda install -c conda-forge gdal</code></pre>
<p><img src="images/gdal/condawin2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Once the installation finishes, verify if you are able to run the GDAL tools. Type the following command and check if a version number is printed.</li>
</ol>
<pre><code>gdalinfo --version</code></pre>
<blockquote>
<p>The version number displayed for you may be slightly different. As long as you do not get a <code>command not found</code> error, you should be set for the class.</p>
</blockquote>
<p><img src="images/gdal/condawin3.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="maclinux" class="section level3">
<h3>Mac/Linux</h3>
<p>Once Anaconda is installed, launch a <em>Terminal</em> window.</p>
<ol style="list-style-type: decimal">
<li>Create a new environment named <code>gdal</code>. When prompted to confirm, type <code>y</code> and press <em>Enter</em>.</li>
</ol>
<pre><code>conda create --name gdal</code></pre>
<p><img src="images/gdal/condamac1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Activate the environment and install the <code>gdal</code> package. When prompted to confirm, type <code>y</code> and press <em>Enter</em>.</li>
</ol>
<pre><code>conda activate gdal
conda install -c conda-forge gdal</code></pre>
<p><img src="images/gdal/condamac2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Once the installation finishes, verify if you are able to run the GDAL tools. Type the following command and check if a version number is printed.</li>
</ol>
<pre><code>gdalinfo --version</code></pre>
<blockquote>
<p>The version number displayed for you may be slightly different. As long as you do not get a <code>command not found</code> error, you should be set for the class.</p>
</blockquote>
<p><img src="images/gdal/condamac3.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="qgis" class="section level2">
<h2>QGIS</h2>
<p>This course uses QGIS LTR version 3.16 for visualization of results. It is not mandatory to install QGIS, but highly recommended.</p>
<p>Please review <a href="install-qgis-ltr.html">QGIS-LTR Installation Guide</a> for step-by-step instructions.</p>
</div>
</div>
<div id="getting-familiar-with-the-command-prompt" class="section level1">
<h1>Getting Familiar with the Command Prompt</h1>
<p>All the commands in the exercises below are expected to be run from the <em>Anaconda Prompt</em> on Windows or a <em>Terminal</em> on Mac/Linux. We will now cover basic terminal commands that will help you get comfortable with the environment</p>
<div id="windows-1" class="section level3">
<h3>Windows</h3>
<table>
<thead>
<tr class="header">
<th align="left"><strong>Command</strong></th>
<th align="left"><strong>Description</strong></th>
<th align="left"><strong>Example</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>cd</code></td>
<td align="left">Change directory</td>
<td align="left"><code>cd Downloads\gdal-tools</code></td>
</tr>
<tr class="even">
<td align="left"><code>cd ..</code></td>
<td align="left">Change to the parent directory</td>
<td align="left"><code>cd ..</code></td>
</tr>
<tr class="odd">
<td align="left"><code>dir</code></td>
<td align="left">List files in the current directory</td>
<td align="left"><code>dir</code></td>
</tr>
<tr class="even">
<td align="left"><code>del</code></td>
<td align="left">Delete a file</td>
<td align="left"><code>del test.txt</code></td>
</tr>
<tr class="odd">
<td align="left"><code>rmdir</code></td>
<td align="left">Delete a directory</td>
<td align="left"><code>rmdir /s test</code></td>
</tr>
<tr class="even">
<td align="left"><code>type</code></td>
<td align="left">Print the contents of a file</td>
<td align="left"><code>type test.txt</code></td>
</tr>
<tr class="odd">
<td align="left"><code>&gt; output.txt</code></td>
<td align="left">Redirect the output to a file</td>
<td align="left"><code>dir /b *.csv &gt; output.txt</code></td>
</tr>
<tr class="even">
<td align="left"><code>cls</code></td>
<td align="left">Clear screen</td>
<td align="left"><code>cls</code></td>
</tr>
</tbody>
</table>
</div>
<div id="maclinux-1" class="section level3">
<h3>Mac/Linux</h3>
<table>
<thead>
<tr class="header">
<th align="left"><strong>Command</strong></th>
<th align="left"><strong>Description</strong></th>
<th align="left"><strong>Example</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>cd</code></td>
<td align="left">Change directory</td>
<td align="left"><code>cd Downloads/gdal-tools</code></td>
</tr>
<tr class="even">
<td align="left"><code>cd ..</code></td>
<td align="left">Change to the parent directory</td>
<td align="left"><code>cd ..</code></td>
</tr>
<tr class="odd">
<td align="left"><code>ls</code></td>
<td align="left">List files in the current directory</td>
<td align="left"><code>ls</code></td>
</tr>
<tr class="even">
<td align="left"><code>rm</code></td>
<td align="left">Delete a file</td>
<td align="left"><code>rm test.txt</code></td>
</tr>
<tr class="odd">
<td align="left"><code>rm -R</code></td>
<td align="left">Delete a directory</td>
<td align="left"><code>rm -R test</code></td>
</tr>
<tr class="even">
<td align="left"><code>cat</code></td>
<td align="left">Print the contents of a file</td>
<td align="left"><code>cat test.txt</code></td>
</tr>
<tr class="odd">
<td align="left"><code>&gt; output.txt</code></td>
<td align="left">Redirect the output to a file</td>
<td align="left"><code>ls *.csv &gt; output.txt</code></td>
</tr>
<tr class="even">
<td align="left"><code>clear</code></td>
<td align="left">Clear screen</td>
<td align="left"><code>clear</code></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="gdal-tools" class="section level1">
<h1>1. GDAL Tools</h1>
<div id="basic-raster-processing" class="section level2">
<h2>1.1 Basic Raster Processing</h2>
<p>We will start learning the basic GDAL commands by processing elevation rasters from SRTM. In the <em>Command Prompt</em> window, use the <code>cd</code> command to change to the <code>srtm</code> directory which 4 individual SRTM tiles around the Mt. Everest region.</p>
<pre><code>cd srtm</code></pre>
<p>Use the <code>gdalinfo</code> command to check the information about a single image.</p>
<pre><code>gdalinfo N27E086.hgt</code></pre>
<p><img src="images/gdal/gdalinfo1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>A useful parameter is <code>-stats</code> which computes and displays image statistics. Run it on the raster to get some statistics of pixel values in the image.</p>
<pre><code>gdalinfo -stats N27E086.hgt</code></pre>
<p><img src="images/gdal/gdalinfo2.png" width="75%" style="display: block; margin: auto;" /></p>
<div id="merging-tiles" class="section level3">
<h3>1.1.1 Merging Tiles</h3>
<p>We will now merge the 4 neighboring SRTM tiles into 1 raster so we can work with them together. GDAL provides a useful format called <a href="https://gdal.org/drivers/raster/vrt.html">Virtual Raster</a> that allows us to create a <em>Virtual</em> file with <code>.vrt</code> extension that is a pointer to multiple source files. A <code>.vrt</code> file is just a text file, so it doesn’t consume any disk space but allows us to run any GDAL command as if it was a raster file.</p>
<p>First we need to create a text file containing all the files we want to merge. We can use the <code>dir</code> command on Windows prompt list the files matching the pattern <code>*.hgt</code> and redirect the output to a file. Here the <code>/b</code> option runs the command in the <em>Bare</em> mode which excludes all info except file names.</p>
<p><strong>Windows</strong></p>
<pre><code>dir /b *.hgt &gt; filelist.txt</code></pre>
<p>On Mac/Linux systems, the same came be achieved using the <code>ls</code> command.</p>
<p><strong>Mac/Linux</strong></p>
<pre><code>ls *.hgt &gt; filelist.txt</code></pre>
<p>Once the command finishes, verify that the <code>filelist.txt</code> has the names of the source tiles.</p>
<p><img src="images/gdal/merging1.png" width="50%" style="display: block; margin: auto;" /></p>
<p>We can now use the <code>gdalbuildvrt</code> command to create a virtual raster from the source files in the <code>filelist.txt</code>.</p>
<pre><code>gdalbuildvrt -input_file_list filelist.txt merged.vrt</code></pre>
<p><img src="images/gdal/merging2.png" width="100%" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Note: We could have done this operation in a single step using the command <code>gdalbuildvrt merged.vrt *.hgt</code>. However, some versions of GDAL on Windows do not expand the <code>*</code> wildcard correctly and the command results in an error. It is recommended to use a filelist instead of wildcards with GDAL commands on Windows to avoid unexpeted results.[<a href="https://github.com/OSGeo/gdal/issues/1749">reference</a>]</p>
</blockquote>
</div>
<div id="exercise-1" class="section level3">
<h3>Exercise 1</h3>
<p>Can you find out what is the highest elevation value in the merged raster? Since these rasters are around the Mt.Everest region, the <em>MAXIMUM</em> value will be the elevation of the summit.</p>
<p><img src="images/gdal/exercise1.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="converting-formats" class="section level3">
<h3>1.1.2 Converting Formats</h3>
<p>Let’s convert the <em>Virtual Raster</em> to a GeoTIFF file. <code>gdal_translate</code> program allows us to convert between any of the hundreds of data formats supported by GDAL. The format is automatically guessed from the file extension. Alternatively, you can also specify it using the <code>-of</code> option with the <a href="https://gdal.org/drivers/raster/index.html">short name of the format</a> such a <strong>GTiff</strong>.</p>
<pre><code>gdal_translate -of GTiff merged.vrt merged.tif</code></pre>
<p><img src="images/gdal/compression1.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="compressing-output" class="section level3">
<h3>1.1.3 Compressing Output</h3>
<p>The default output GeoTIFF file is uncompressed - meaning each pixel’s value is stored on the disk without any further processing. For large rasters, this can consume a lot of disk space. A smarter approach is to use a lossless compression algorithm to reduce the size of the raster while maintaining full fidelity of the original data. GDAL supports many compression algorithm out-of-the-box and can be specified with GDAL commands using the <code>-co</code> option. The most popular loss-less compression algorithms are <strong>DEFLATE</strong>, <strong>LZW</strong> and <strong>PACKBITS</strong>. We can try the <code>DEFLATE</code> algorithm on our dataset.</p>
<pre><code>gdal_translate -of GTiff merged.vrt merged.tif -co COMPRESS=DEFLATE</code></pre>
<p><img src="images/gdal/compression2.png" width="75%" style="display: block; margin: auto;" /></p>
<p>The uncompressed file size was <strong>100+ MB</strong>. After applying the <em>DEFLATE</em> compression, the file size reduced to <strong>72MB</strong>. We can further reduce the file size by specifying additional options. The <code>PREDICTOR</code> option helps compress data better when the neighboring values are correlated. For elevation data, this is definitely the case. The <code>TILED</code> option will compress the data in blocks rather than line-by-line.</p>
<pre><code>gdal_translate -of GTiff merged.vrt merged.tif -co COMPRESS=DEFLATE -co TILED=YES -co PREDICTOR=2</code></pre>
<p><img src="images/gdal/compression3.png" width="75%" style="display: block; margin: auto;" /></p>
<p>The resulting file now comes out much smaller at <strong>39MB</strong>. Check this article <a href="https://kokoalberti.com/articles/geotiff-compression-optimization-guide/">GeoTIFF compression and optimization with GDAL</a> to learn more about various options and compression algorithms.</p>
</div>
<div id="setting-nodata-values" class="section level3">
<h3>1.1.4 Setting NoData Values</h3>
<p>The output from <code>gdalinfo</code> command shows that the original data has a <em>NoData</em> Value set to <code>-32768</code>. We can set a new <em>NoData</em> value. The <code>-a_nodata</code> option allows us to specify a new value.</p>
<pre><code>gdal_translate -of GTiff merged.vrt merged.tif -co COMPRESS=DEFLATE -co TILED=YES -co PREDICTOR=2 -a_nodata -9999</code></pre>
<p>After running the command, you can verify the results using the <code>gdalinfo</code> command.</p>
</div>
<div id="wrting-cloud-optimized-geotiff-cog" class="section level3">
<h3>1.1.5 Wrting Cloud-Optimized GeoTIFF (COG)</h3>
<p>A new format called <a href="https://www.cogeo.org/">Cloud-Optimized GeoTIFF (COG)</a> is making access to such vast amount of imagery easier to access and analyze. A <em>Cloud-optimized</em> GeoTIFF is behaves just like a regular GeoTIFF imagery, but instead of downloading the entire image locally, you are able to access <em>portions</em> of imagery hosted on a cloud server streamed to clients like QGIS. This makes is very efficient to access this data and even analyze it - without downloading large files. GDAL makes it very easy to create COG files by specifying the <code>-of COG</code> option.</p>
<pre><code>gdal_translate -of COG merged.vrt merged_cog.tif -co COMPRESS=DEFLATE -co PREDICTOR=2 -a_nodata -9999</code></pre>
</div>
</div>
<div id="processing-elevation-data" class="section level2">
<h2>1.2 Processing Elevation Data</h2>
<p>GDAL comes with the <code>gdaldem</code> utility that provides a suite of tools for visualizing and analyzing Digital Elevation Models (DEM). The tool supports the following modes</p>
<ul>
<li>Hillshade</li>
<li>Slope</li>
<li>Aspect</li>
<li>Color-relief</li>
<li>Terrain Ruggedness Index (TRI)</li>
<li>Topographic Position Index (TPI)</li>
<li>Roughness</li>
</ul>
<p>Am important point to note is that the x, y and z units of the DEM should be in the same unit. If you are using data in a Geographic CRS (like EPSG:4326) and the height units are meters, you must specify a scale value using <code>-s</code> option.</p>
<div id="creating-hillshade" class="section level3">
<h3>1.2.1 Creating Hillshade</h3>
<p>Let’s create a hillshade map from the merged SRTM dataset. The <code>hillshade</code> mode creates an 8-bit raster with a nice shaded relief effect. This dataset has X and Y units in degrees and Z units in meters. So we specify <code>111120</code> as the scale value.</p>
<pre><code>gdaldem hillshade merged.tif hillshade.tif -s 111120</code></pre>
<p><code>gdaldem</code> supports multiple hillshading algorithms. Apart from the default, it currently includes the following algorithms.</p>
<ul>
<li>Combined shading (<code>-combined</code>): A combination of slope and oblique shading.</li>
<li>Multidirectional shading (<code>-multidirectional</code>): A combination of hillshading illuminated from 225 deg, 270 deg, 315 deg, and 360 deg azimuth.</li>
</ul>
<p>Let’s create a hillshade map with the <code>-multidirectional</code> option.</p>
<pre><code>gdaldem hillshade merged.tif hillshade_combined.tif -s 111120 -multidirectional</code></pre>
<p><img src="images/gdal/hillshade.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<div id="creating-color-relief" class="section level3">
<h3>1.2.2 Creating Color Relief</h3>
<p>A color relief map is an elevation map where different ranges of elevations are colored differently. The <code>color-relief</code> mode can create a color relief map with the colors and elevation ranges supplied in a text file.</p>
<p>Your data package contains a <code>colormap.txt</code> file with the following content. The format of the text file is <code>elevation,red,green,blue</code> values.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">1000</span>,101,146,82</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">1500</span>,190,202,130</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="ex">2000</span>,241,225,145</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="ex">2500</span>,244,200,126</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="ex">3000</span>,197,147,117</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="ex">4000</span>,204,169,170</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="ex">5000</span>,251,238,253</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="ex">6000</span>,255,255,255</span></code></pre></div>
<p>We can supply this file to create a colorized elevation map.</p>
<pre><code>gdaldem color-relief merged.tif colormap.txt colorized.tif</code></pre>
<div class="figure" style="text-align: center">
<img src="images/gdal/colorized.png" alt="Color Relief" width="75%" />
<p class="caption">
Color Relief
</p>
</div>
</div>
<div id="exercise-2" class="section level3">
<h3>Exercise 2</h3>
<p>Save the color relief in the PNG format.</p>
</div>
<div id="creating-contours" class="section level3">
<h3>1.2.3 Creating Contours</h3>
<p>The GDAL package comes with the utility <code>gdal_countour</code> that can create contour lines and polygons from DEMs.</p>
<p>You can specify the interval between contour lines using the <code>-i</code> option.</p>
<pre><code>gdal_contour merged.tif contours.gpkg -i 500</code></pre>
<div class="figure" style="text-align: center">
<img src="images/gdal/contours_withoutelevation.png" alt="Contour Lines from DEM" width="75%" />
<p class="caption">
Contour Lines from DEM
</p>
</div>
<p>Running the command with default options generate a vector layer with contours but they do not have any attributes. If you want to label your contour lines in your map, you may want to create contours with elevation values as attribute. You can use the <code>-a</code> option and specify the name of the attribute.</p>
<pre><code>gdal_contour merged.tif contours.gpkg -i 500 -a elev</code></pre>
<div class="figure" style="text-align: center">
<img src="images/gdal/contours_withelevation.png" alt="Contour Lines with Elevation Attribute" width="75%" />
<p class="caption">
Contour Lines with Elevation Attribute
</p>
</div>
</div>
<div id="exercise-3" class="section level3">
<h3>Exercise 3</h3>
<p>Create polygon contours shapefile from <code>merged.tif</code> and name the attributes <code>MINELEV</code> and <code>MAXELEV</code> represented by each polygon.</p>
</div>
</div>
<div id="processing-aerial-imagery" class="section level2">
<h2>1.3 Processing Aerial Imagery</h2>
<p>Use the <code>cd</code> command to change to the <code>naip</code> directory which contains individual aerial imagery tiles in the <strong>JPEG2000</strong> format.</p>
<pre><code>cd naip</code></pre>
<div id="create-a-preview-image-from-source-tiles" class="section level3">
<h3>1.3.1 Create a preview image from source tiles</h3>
<p>The source imagery is heavily compressed and cover a large region. Instead of loading the full resolution tiles in a viewer, it is a good practice to create a preview mosaic that can help us assess the coverage and quality of the data.</p>
<p>We first create a <em>Virtual Raster</em> mosaic from all the <code>.jp2</code> tiles. We can create a text file containing all the files we want to merge.</p>
<p><strong>Windows</strong></p>
<pre><code>dir /b *.jp2 &gt; filelist.txt</code></pre>
<p><strong>Mac/Linux</strong></p>
<pre><code>ls *.jp2 &gt; filelist.txt</code></pre>
<div class="figure" style="text-align: center">
<img src="images/gdal/aoi_textfile.png" alt="Text File with the List of Images" width="75%" />
<p class="caption">
Text File with the List of Images
</p>
</div>
<pre><code>gdalbuildvrt -input_file_list filelist.txt naip.vrt</code></pre>
<p>We can use the <code>-outsize</code> option and specify a percentage to generate a smaller size preview. The below command generates a 2% preview image in the JPEG format.</p>
<pre><code>gdal_translate -of JPEG -outsize 2% 2% naip.vrt naip_preview.jpg </code></pre>
<p><img src="images/gdal/naip_preview.jpg" style="display: block; margin: auto;" /></p>
</div>
<div id="create-a-tile-index" class="section level3">
<h3>1.3.2 Create a Tile Index</h3>
<p>When working with large amounts of imagery tiles, it is useful to generate a tile index. A tile index layer is a polygon layer with the bounding box of each tile. An index layer allows us to check the coverage of the source data and locate specific tiles. It is a simple but effective way to catalog raster data from a hard drive or from a folder on your computer.</p>
<p><code>gdaltindex</code> command creates a tile index from a list of input files. Here we can use the <code>--optfile</code> option to supply the list of files via a file.</p>
<pre><code>gdaltindex -write_absolute_path index.shp --optfile filelist.txt</code></pre>
</div>
<div id="mosaic-and-clip-to-aoi" class="section level3">
<h3>1.3.3 Mosaic and clip to AOI</h3>
<p>Let’s say we want to mosaic all the source tile into a single image. We also want to clip the mosaic to a given AOI.</p>
<p><img src="images/gdal/aoiselection.png" style="display: block; margin: auto;" /></p>
<p>We can use the <code>gdalwarp</code> utility to clip the raster using the <code>-cutline</code> option. We can also add JPEG compression to the output file to reduce the file size. Refer to the post <a href="https://blog.cleverelephant.ca/2015/02/geotiff-compression-for-dummies.html">GeoTiff Compression for Dummies</a> by Paul Ramsey that gives more insights into compression imagery.</p>
<blockquote>
<p>Note that JPEG is a lossy compression method and is suited only for photographic rasters such as aerial/drone imagery. For scientific datasets, you should always use lossless compression as shown in the <a href="#compressing-output">previous section</a>.</p>
</blockquote>
<pre><code>gdalwarp -cutline aoi.shp  -crop_to_cutline naip.vrt aoi.tif -co COMPRESS=JPEG -co TILED=YES -co PHOTOMETRIC=YCBCR</code></pre>
<p><img src="images/gdal/mosaic.png" style="display: block; margin: auto;" /></p>
</div>
<div id="tips-for-improving-performance" class="section level3">
<h3>1.3.4 Tips for Improving Performance</h3>
<p><code>gdalwarp</code> utility supports multithreaded processing. There are 2 different options for parallel processing.</p>
<ul>
<li><code>-multi</code>: This option parallelizes I/O and CPU operations.</li>
<li><code>-wo NUM_THREADS=ALL_CPUS</code>: This option parallelizes CPU operations over several cores.</li>
</ul>
<p>There is also another option that allows <code>gdalwarp</code> to use more RAM for caching. This option is very helpful to speed up operations on large rasters</p>
<ul>
<li><code>-wm</code>: Set a higher memory for caching</li>
</ul>
<p>All of these options can be combined that may result in faster processing of the data.</p>
<pre><code>gdalwarp -cutline aoi.shp  -crop_to_cutline naip.vrt aoi.tif -co COMPRESS=JPEG -co TILED=YES -co PHOTOMETRIC=YCBCR -multi -wo NUM_THREADS=ALL_CPUS -wm 512</code></pre>
</div>
<div id="creating-overviews" class="section level3">
<h3>1.3.5 Creating Overviews</h3>
<p>If you try loading the resulting raster into a viewer, you will notice that it takes a lot of time for it to render. Zoom/Pan operations are quite slow as well. This is because the viewer is rendering all the pixels at native resolution. Since this is a very high resolution dataset, it requires processing a lot of pixels, even if you are zoomed out. A common solution to this problem is to create <em>Pyramid Tiles</em> or <em>Overviews</em>. This process creates low resolution versions of the image by averaging pixel values from higher resolution pixels. If the pyramid tiles are present, imagery viewers can use it to speed up the rendering process. GDAL provides the utility <code>gdaladdo</code> to create overview tiles. GeoTIFF format supports storing the overviews within the file itself. For other formats, the program generates external overviews in the <code>.ovr</code> format.</p>
<p>You can run the <code>gdaladdo</code> (<strong>GDAL</strong>-<strong>Add</strong>-<strong>O</strong>verview) command with default options to create internal overviews. Once the overviews are created, try opening the <code>aoi.tif</code> in QGIS. You will see that it renders much faster and zoom/pan operations are very smooth.</p>
<pre><code>gdaladdo aoi.tif</code></pre>
<p>The default overviews use the nearest neighbor resampling. We can pick any resampling method from the many available algorithms. We can try the bilinear interpolation using the <code>-r bilinear</code> option. Since the source imagery is JPEG compressed, we can compress the overviews with the same compression.</p>
<pre><code>gdaladdo -r bilinear --config COMPRESS_OVERVIEW JPEG aoi.tif</code></pre>
</div>
</div>
<div id="processing-satellite-imagery" class="section level2">
<h2>1.4 Processing Satellite Imagery</h2>
<p>This section shows how to take satellite data from Landsat-8 and create various derived products. Use the <code>cd</code> command to change to the <code>landsat8</code> directory which contains Landsat-8 imagery. This directory has 5 individual GeoTIFF files for 5 different bands from a single landsat-8 scene.</p>
<pre><code>cd landsat8</code></pre>
<div id="merging-individual-bands-into-rgb-composite" class="section level3">
<h3>1.4.1 Merging individual bands into RGB composite</h3>
<p>Let’s create a RGB composite image by combining thee 3 different bands - Red, Green and Blue - into a single image. We can use the <code>gdal_merge.py</code> command to merge different images. Here we must use the <code>-separate</code> option which tells the command to place each image in a separate band.</p>
<pre><code>gdal_merge.py -o rgb.tif -separate -co PHOTOMETRIC=RGB -co COMPRESS=DEFLATE RT_LC08_L1TP_137042_20190920_20190926_01_T1_2019-09-20_B4.TIF RT_LC08_L1TP_137042_20190920_20190926_01_T1_2019-09-20_B3.TIF RT_LC08_L1TP_137042_20190920_20190926_01_T1_2019-09-20_B2.TIF</code></pre>
<p>Once the command finishes, you can view the result in QGIS.</p>
<p><img src="images/gdal/rgb.png" style="display: block; margin: auto;" /></p>
</div>
<div id="apply-histogram-stretch-and-color-correction" class="section level3">
<h3>1.4.2 Apply Histogram Stretch and Color Correction</h3>
<p>The resulting composite appears quite dark and has low-contrast. QGIS applies a default contrast stretch based on the minimum and maximum values in the image. Due to the presence of clouds and cloud-shadows - there are outlier pixels which make the default contrast stretch not optimal.</p>
<p>Here’s what the histogram of the RGB composite looks like.</p>
<p><img src="images/gdal/histogram.png" style="display: block; margin: auto;" /></p>
<p>We can apply a histogram stretch to increase the contrast. This is done using the <code>-scale</code> option. Since most of the pixels have a value between 0 and 0.3, we can choose these are minimum and maximum values and apply a contrast stretch to make them go from 0 to 255. The resulting image will be a 8-bit color image where the input pixel values are linearly scaled to the target value.</p>
<blockquote>
<p>Note: Scaling the image will alter the pixel values. The resulting image is suitable for visualizaion, but they should never be used for analysis. Scientific analysis should always use the un-scaled pixel values.</p>
</blockquote>
<pre><code>gdal_translate -scale 0 0.3 0 255 -ot Byte rgb.tif rgb_stretch.tif</code></pre>
<div class="figure" style="text-align: center">
<img src="images/gdal/rgb_stretch_linear.png" alt="RGB Composite with Linear Stretch" width="75%" />
<p class="caption">
RGB Composite with Linear Stretch
</p>
</div>
<p>We can also apply a non-linear stretch. <code>gdal_translate</code> has a <code>-exponent</code> option that scales the input values using the following formula. Choosing an exponent value between 0 and 1 will enhance low intensity values - resulting in a brighter image. <a href="https://homepages.inf.ed.ac.uk/rbf/HIPR2/pixexp.htm">Learn more ↗</a></p>
<p>Let’s try exponent value of <strong>0.5</strong>. The result is a much better looking output.</p>
<pre><code>gdal_translate -scale 0 0.3 0 255 -exponent 0.5 -ot Byte rgb.tif rgb_stretch.tif</code></pre>
<div class="figure" style="text-align: center">
<img src="images/gdal/rgb_stretch_exponent.png" alt="RGB Composite with Exponential Stretch" width="75%" />
<p class="caption">
RGB Composite with Exponential Stretch
</p>
</div>
</div>
<div id="exercise-4" class="section level3">
<h3>Exercise 4</h3>
<p>Create a NRG Composite image with Near Infrared, Red and Green bands. Apply a contrast stretch to the result and save it as a PNG image.</p>
<div class="figure" style="text-align: center">
<img src="images/gdal/nrg_stretch.png" alt="NRG Composite" width="75%" />
<p class="caption">
NRG Composite
</p>
</div>
</div>
<div id="pan-sharpening" class="section level3">
<h3>1.4.3 Pan Sharpening</h3>
<p>Most satellite and airborne sensors capture images in the <em>Pan-chromatic</em> band along with other spectral bands. The <em>Red</em>, <em>Green</em>, and <em>Blue</em> bands capture signals in the <em>Red</em>, <em>Green</em>, and <em>Blue</em> portions of the electromagnetic spectrum respectively. But the <em>Pan</em>-band captures the data across the entire range of wavelengths in the visible spectrum. This allows the sensor to capture the data in a higher spatial resolution than other bands which capture the signal from a subset of this wavelength range.</p>
<p>Landsat-8 satellite produces images at a <strong>30m</strong> spatial resolution in the <em>Red</em>, <em>Green</em>, <em>Blue</em> bands and at a <strong>15m</strong> spatial resolution in the <em>Panchromatic</em> band. We can use the higher spatial resolution of the <em>Panchromatic</em> band to improve the resolution of the other bands, resulting in sharper image with more details. This process is called <em>Pan-Sharpening</em>.</p>
<p>GDAL comes with a script <code>gdal_pansharpen.py</code> that implements the <a href="https://gdal.org/drivers/raster/vrt.html#gdal-vrttut-pansharpen">Brovey algorithm</a> to compute the pansharpened output. In the example below we fuse the 15m resolution panchromatic band (B8) with the RGB composite created in the previous step.</p>
<pre><code>gdal_pansharpen.py RT_LC08_L1TP_137042_20190920_20190926_01_T1_2019-09-20_B8.TIF rgb.tif pansharpened.tif -r bilinear -co COMPRESS=DEFLATE -co PHOTOMETRIC=RGB</code></pre>
<p>We can apply the same contrast stretch as before and compare the output. You will notice that the resulting composite is much sharper and is able to resolve the details in the scene much better.</p>
<pre><code>gdal_translate -scale 0 0.3 0 255 -exponent 0.5 -ot Byte -a_nodata 0 pansharpened.tif pansharpened_stretch.tif</code></pre>
<p><img src="images/gdal/pansharpen_before.png" style="display: block; margin: auto;" /></p>
<p><img src="images/gdal/pansharpen_after.png" style="display: block; margin: auto;" /></p>
</div>
<div id="raster-algebra" class="section level3">
<h3>1.4.4 Raster Algebra</h3>
<pre><code>gdalinfo -stats landsat8/RT_LC08_L1TP_137042_20190920_20190926_01_T1_2019-09-20_B4.TIF</code></pre>
<p>It is important to set nodata value. As seen from the output above, nodata is set to -9999.</p>
<pre><code>gdal_calc.py -A RT_LC08_L1TP_137042_20190920_20190926_01_T1_2019-09-20_B5.TIF -B RT_LC08_L1TP_137042_20190920_20190926_01_T1_2019-09-20_B4.TIF --outfile ndvi.tif --calc=&quot;(A-B)/(A+B)&quot; --NoDataValue=-9999</code></pre>
<p><img src="images/gdal/ndvi.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="processing-wms-layers" class="section level2">
<h2>1.5 Processing WMS Layers</h2>
<pre><code>gdalinfo WMS:http://sedac.ciesin.columbia.edu/geoserver/wms</code></pre>
<p><a href="https://sedac.ciesin.columbia.edu/data/set/grand-v1-reservoirs-rev01">Global Reservoir and Dam (GRanD), v1</a></p>
<pre><code>gdalinfo &quot;WMS:https://sedac.ciesin.columbia.edu/geoserver/wms?SERVICE=WMS&amp;VERSION=1.1.1&amp;REQUEST=GetMap&amp;LAYERS=lulc%3Alulc-global-grid-prob-urban-expansion-2030&amp;SRS=EPSG:4326&amp;BBOX=-179.99997803468415,-55.922762245435266,180.02788233587063,83.97845284575614&quot;</code></pre>
<p><img src="images/gdal/wms2.png" style="display: block; margin: auto;" /></p>
<pre><code>gdal_translate -of WMS &quot;WMS:https://sedac.ciesin.columbia.edu/geoserver/wms?SERVICE=WMS&amp;VERSION=1.1.1&amp;REQUEST=GetMap&amp;LAYERS=grand-v1:Agrand-v1-reservoirs-rev01&quot; reservoirs.xml</code></pre>
<p><img src="images/gdal/wms3.png" style="display: block; margin: auto;" /></p>
<pre><code>gdal_translate -outsize 3600 1800 &quot;WMS:https://sedac.ciesin.columbia.edu/geoserver/wms?SERVICE=WMS&amp;VERSION=1.1.1&amp;REQUEST=GetMap&amp;LAYERS=grand-v1%3Agrand-v1-reservoirs-rev01&amp;SRS=EPSG:4326&amp;BBOX=-153.037,-45.881,176.825,70.398&quot; reservoirs.tif</code></pre>
<p>Specify a Bounding Box for India</p>
<pre><code>gdal_translate -outsize 10000 10000 &quot;WMS:https://sedac.ciesin.columbia.edu/geoserver/wms?SERVICE=WMS&amp;VERSION=1.1.1&amp;REQUEST=GetMap&amp;LAYERS=grand-v1%3Agrand-v1-reservoirs-rev01&amp;SRS=EPSG:4326&amp;BBOX=68.106,6.762,97.412,37.078&quot; reservoirs_india.tif</code></pre>
<p><img src="images/gdal/wms4.png" style="display: block; margin: auto;" /></p>
</div>
<div id="georeferencing" class="section level2">
<h2>1.6 Georeferencing</h2>
<p>GDAL command-line utilities are extremely useful in batch georeferencing tasks. We will learn 2 different techniques for georeferencing/warping images.</p>
<div id="georeferencing-images-with-bounding-box-coordinates" class="section level3">
<h3>1.6.1 Georeferencing Images with Bounding Box Coordinates</h3>
<p>Often you get images from web portals that are maps but lack georeference information. Data from weather satellites, output from simulations, exports from photo editing software etc. can contain images that reference a fixed frame on the earth but are given in a regular image formats such as JPEG or PNG. If you know the bounding box coordinates and the CRS used in creating these images, you can use <code>gdal_translate</code> command to assign georeference information. The <code>-a_ullr</code> option allows you to specify the bounding box coordinates using the Upper-Left (UL) and Lower-Right (LR) coordinates.</p>
<p>Your data package contains the image file <code>earth_at_night.jpg</code>. This is a beautifully rendered image of the earth captured at night time. You will see that this is a plain JPEG image without any georeference information.</p>
<pre><code>gdalinfo earth_at_night.jpg</code></pre>
<p>Since this is a global image, we know the corner coordinates. We can assign the CRS <strong>EPSG:4326</strong> using the <code>-a_srs</code> option and specify the bounding box coordinates in the following order <code>&lt;ulx&gt; &lt;uly&gt; &lt;lrx&gt; &lt;lry&gt;</code>.</p>
<pre><code>gdal_translate -a_ullr -180 90 180 -90 -a_srs EPSG:4326 earth_at_night.jpg earth_at_night.tif -co COMPRESS=JPEG -co TILED=YES -co PHOTOMETRIC=RGB</code></pre>
<p>The resulting file <code>earth_at_night.tif</code> is a GeoTiff file with the correct georeference information and can now be used in a GIS software.</p>
<pre><code>gdalinfo earth_at_night.tif</code></pre>
<p><img src="images/gdal/earth_at_night.png" style="display: block; margin: auto;" /></p>
</div>
<div id="georeferencing-with-gcps" class="section level3">
<h3>1.6.2 Georeferencing with GCPs</h3>
<p>Another option for georeferencing images it to use Ground Control Points (GCPs) or Tie-Points. A GCP specifies the real-world coordinates for a given pixel in the image. The GCPs can be obtained by reading the map markings or locating landmarks from a georeferenced source. Given a set of GCPs, <code>gdalwarp</code> can georeference the image using a variety of transformation types.</p>
<p>Your data package contain an image of a old scanned map called <code>1870_southern_india.jpg</code>.</p>
<p><img src="images/gdal/scanned_map.png" style="display: block; margin: auto;" /></p>
<p>The map contain graticule lines with latitude and longitude information that can be read from the image. We can read the coordinate values at the grid intersections and find that pixel’s image coordinates</p>
<table>
<thead>
<tr class="header">
<th align="left"><strong>pixel (column)</strong></th>
<th align="left"><strong>line (row)</strong></th>
<th align="left"><strong>X (Longitude)</strong></th>
<th align="left"><strong>Y (Latitude)</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">418</td>
<td align="left">893</td>
<td align="left">70</td>
<td align="left">15</td>
</tr>
<tr class="even">
<td align="left">380</td>
<td align="left">2432</td>
<td align="left">70</td>
<td align="left">5</td>
</tr>
<tr class="odd">
<td align="left">3453</td>
<td align="left">2434</td>
<td align="left">90</td>
<td align="left">5</td>
</tr>
<tr class="even">
<td align="left">3407</td>
<td align="left">895</td>
<td align="left">90</td>
<td align="left">15</td>
</tr>
<tr class="odd">
<td align="left">2662</td>
<td align="left">911</td>
<td align="left">85</td>
<td align="left">15</td>
</tr>
</tbody>
</table>
<p>The first step is to store these GCPs in the image metadata using <code>gdal_translate</code> command.</p>
<pre><code>gdal_translate -gcp 418 893 70 15 -gcp 380 2432 70 5 -gcp 3453 2434  90 5 -gcp 3407 895 90 15 -gcp 2662 911 85 15 1870_southern-india.jpg india-with-gcp.tif</code></pre>
<p>Now that the GCPs are stored in the image, we are ready to do the georeferencing. Assuming the CRS of the map is a Geographic CRS based on the Everest 1830 datum, we choose <strong>EPSG:4042</strong> as the target CRS.</p>
<p>Next, we need to choose the transformation type. <code>gdalwarp</code> supports the following transformation types</p>
<ul>
<li><em>Polynomial 1,2 or 3</em> using <code>-order</code> option</li>
<li><em>Thin Plate Spline</em> using the <code>-tps</code> option</li>
</ul>
<p>Let’s try <strong>Polynomial 1</strong> transformation and check the results.</p>
<pre><code>gdalwarp -t_srs EPSG:4042 -order 1 -tr 0.005 0.005  india-with-gcp.tif india-reprojected-polynomial.tif -co COMPRESS=JPEG -co JPEG_QUALITY=50 -co PHOTOMETRIC=YCBCR</code></pre>
<p>We can use the same GCPs and do a Thin-plate-spline transformation.</p>
<pre><code>gdalwarp -t_srs EPSG:4042 -tps -tr 0.005 0.005 india-with-gcp.tif india-reprojected-tps.tif -co COMPRESS=JPEG -co JPEG_QUALITY=50 -co PHOTOMETRIC=YCBCR</code></pre>
<p><img src="images/gdal/georeference_gcp.png" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="ogr-tools" class="section level1">
<h1>2. OGR Tools</h1>
<div id="working-with-csv-files" class="section level2">
<h2>2.1 Working with CSV files</h2>
<pre><code>ogrinfo worldcities.csv</code></pre>
<p><img src="images/gdal/ogr_csv01.png" width="75%" style="display: block; margin: auto;" /></p>
<pre><code>ogrinfo -so -al worldcities.csv</code></pre>
<p><img src="images/gdal/ogr_csv02.png" width="75%" style="display: block; margin: auto;" /></p>
<pre><code>ogrinfo -so -al worldcities.csv -oo X_POSSIBLE_NAMES=lng -oo Y_POSSIBLE_NAMES=lat</code></pre>
<p><img src="images/gdal/ogr_csv03.png" width="75%" style="display: block; margin: auto;" /></p>
<pre><code>ogr2ogr -f GPKG worldcities.gpkg worldcities.csv -oo X_POSSIBLE_NAMES=lng -oo Y_POSSIBLE_NAMES=lat </code></pre>
<p><img src="images/gdal/ogr_csv04.png" width="75%" style="display: block; margin: auto;" /></p>
<pre><code>ogr2ogr -f GPKG worldcities.gpkg worldcities.csv -oo X_POSSIBLE_NAMES=lng -oo Y_POSSIBLE_NAMES=lat -a_srs EPSG:4326</code></pre>
<p><img src="images/gdal/ogr_csv05.png" width="75%" style="display: block; margin: auto;" /></p>
<p><a href="https://gdal.org/user/ogr_sql_dialect.html#ogr-sql-dialect">OGR SQL Syntax</a></p>
<pre><code>ogr2ogr -f GPKG mycities.gpkg worldcities.csv -oo X_POSSIBLE_NAMES=lng -oo Y_POSSIBLE_NAMES=lat -a_srs EPSG:4326  -where &quot;country = &#39;India&#39;&quot;</code></pre>
<p><img src="images/gdal/ogr_csv06.png" width="75%" style="display: block; margin: auto;" /></p>
<pre><code>ogr2ogr -f GPKG mycities.gpkg worldcities.csv -oo X_POSSIBLE_NAMES=lng -oo Y_POSSIBLE_NAMES=lat -a_srs EPSG:4326 -sql &quot;SELECT city, country, CAST(population AS integer) as population from worldcities where country = &#39;India&#39;&quot;</code></pre>
<p><img src="images/gdal/ogr_csv07.png" width="75%" style="display: block; margin: auto;" /></p>
<pre><code>ogr2ogr -f GPKG mycities.gpkg worldcities.csv -oo X_POSSIBLE_NAMES=lng -oo Y_POSSIBLE_NAMES=lat -a_srs EPSG:4326 -sql &quot;SELECT city, country, CAST(population AS integer) as population from worldcities where country = &#39;India&#39;&quot; -nln mycities</code></pre>
<p><img src="images/gdal/ogr_csv08.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="working-with-multiple-layers" class="section level2">
<h2>2.2 Working with Multiple Layers</h2>
<div id="read-geonames-files" class="section level3">
<h3>2.2.1 Read Geonames Files</h3>
<pre><code>&lt;OGRVRTDataSource&gt;
        &lt;OGRVRTLayer name=&quot;CA&quot;&gt;
            &lt;SrcDataSource&gt;CSV:CA.txt&lt;/SrcDataSource&gt;
            &lt;SrcLayer&gt;CA&lt;/SrcLayer&gt;
        &lt;/OGRVRTLayer&gt;
&lt;/OGRVRTDataSource&gt;</code></pre>
<pre><code>ogrinfo -al -so CA.vrt</code></pre>
</div>
<div id="applying-filters" class="section level3">
<h3>2.2.2 Applying Filters</h3>
<pre><code>&lt;OGRVRTDataSource&gt;
        &lt;OGRVRTLayer name=&quot;CA&quot;&gt;
            &lt;SrcDataSource&gt;CSV:CA.txt&lt;/SrcDataSource&gt;
            &lt;SrcLayer&gt;CA&lt;/SrcLayer&gt;
            &lt;SrcSQL&gt;select * from CA where &quot;FEATCLASS&quot; = &#39;T&#39;&lt;/SrcSQL&gt;
        &lt;/OGRVRTLayer&gt;
&lt;/OGRVRTDataSource&gt;</code></pre>
<pre><code>ogrinfo -al -so CA.vrt</code></pre>
</div>
<div id="merging-files" class="section level3">
<h3>2.2.3 Merging Files</h3>
<pre><code>
&lt;OGRVRTDataSource&gt;
    &lt;OGRVRTUnionLayer name=&quot;NA&quot;&gt;
    
        &lt;OGRVRTLayer name=&quot;CA&quot;&gt;
            &lt;SrcDataSource&gt;CSV:CA.txt&lt;/SrcDataSource&gt;
            &lt;SrcLayer&gt;CA&lt;/SrcLayer&gt;
            &lt;SrcSQL&gt;select * from CA where &quot;FEATCLASS&quot; = &#39;T&#39;&lt;/SrcSQL&gt;
        &lt;/OGRVRTLayer&gt;
    
        &lt;OGRVRTLayer name=&quot;MX&quot;&gt;
            &lt;SrcDataSource&gt;CSV:MX.txt&lt;/SrcDataSource&gt;
            &lt;SrcLayer&gt;MX&lt;/SrcLayer&gt;
            &lt;SrcSQL&gt;select * from MX where &quot;FEATCLASS&quot; = &#39;T&#39;&lt;/SrcSQL&gt;
        &lt;/OGRVRTLayer&gt;
    
        &lt;OGRVRTLayer name=&quot;US&quot;&gt;
            &lt;SrcDataSource&gt;CSV:US.txt&lt;/SrcDataSource&gt;
            &lt;SrcLayer&gt;US&lt;/SrcLayer&gt;
            &lt;SrcSQL&gt;select * from US where &quot;FEATCLASS&quot; = &#39;T&#39;&lt;/SrcSQL&gt;
        &lt;/OGRVRTLayer&gt;
    
    &lt;/OGRVRTUnionLayer&gt; 
&lt;/OGRVRTDataSource&gt;</code></pre>
<pre><code>ogr2ogr -f GPKG NA.gpkg NA.vrt</code></pre>
</div>
</div>
<div id="geoprocessing-and-spatial-queries" class="section level2">
<h2>2.2.4 Geoprocessing and Spatial Queries</h2>
<pre><code>ogr2ogr -t_srs EPSG:7855 spatial_query.gpkg spatial_query.gpkg bars_and_pubs -update -nln bars_and_pubs_reprojected
ogr2ogr -t_srs EPSG:7855 spatial_query.gpkg spatial_query.gpkg metro_stations -update -nln metro_stations_reprojected</code></pre>
<pre><code>ogr2ogr spatial_query.gpkg spatial_query.gpkg -update -nln metro_stations_buffer -sql &quot;select m.station, buffer(m.geom, 500) as geom from metro_stations_reprojected m&quot; -dialect SQLITE </code></pre>
<p>You can dissolve the buffers using <code>ST_COLLECT</code></p>
<pre><code>ogr2ogr spatial_query.gpkg spatial_query.gpkg -update -nln metro_stations_buffer_dissolved -sql &quot;select st_union(d.geom) as geom from (select st_collect(buffer(m.geom, 500)) as geom from metro_stations_reprojected m) as d&quot; -dialect SQLITE</code></pre>
<pre><code>ogr2ogr -t_srs EPSG:4326 spatial_query.gpkg spatial_query.gpkg -update -nln selected -sql &quot;select  b.* from bars_and_pubs_reprojected as b join metro_stations_buffer_dissolved as m on ST_Within( b.geom, m.geom)&quot; -dialect SQLITE </code></pre>
</div>
</div>
<div id="multi-criteria-weighted-overlay-analysis" class="section level1">
<h1>3. Multi Criteria Weighted Overlay Analysis</h1>
<p>Multi-criteria analysis is the process of the allocation of land to suit a specific objective on the basis of a variety of attributes that the selected areas should possess.</p>
<p>Although this is a common GIS operation, it is best performed in the raster space. Below is the typical workflow to take source vector data, transform them to appropriate rasters, re-classify them and perform mathematical operations to do a suitability analysis.</p>
<p>We will work with crime and infrastructure data for the city of London and find suitable areas to build new parking facilities that can help reduce bicycle thefts. Our analysis will apply the following 3 criteria. The proposed parking must be</p>
<ol style="list-style-type: decimal">
<li>In a bicycle theft hotspot</li>
<li>Close to a bicycle route</li>
<li>Far from existing parking facilities</li>
</ol>
<div id="rasterize-vector-layers" class="section level2">
<h2>3.1 Rasterize vector layers</h2>
<p>For overlay analysis, all rasters must be of the same extent. So we first find the extent of the dataset that we can use while rasterizing.</p>
<pre><code>ogrinfo multicriteria.gpkg</code></pre>
<pre><code>ogrinfo -so multicriteria.gpkg boundary</code></pre>
<pre><code>gdal_rasterize -burn 1 -add -tr 100 100 -te 523843.7 177847.3 531169.1 183893.8 multicriteria.gpkg -l bicycle_thefts thefts.tif -ot Int16</code></pre>
<pre><code>gdal_rasterize -ot Int16 -burn 1 -tr 10 10 -te 523843.7 177847.3 531169.1 183893.8 multicriteria.gpkg -l cycling_routes routes.tif

gdal_rasterize -ot Int16 -burn 1 -tr 10 10 -te 523843.7 177847.3 531169.1 183893.8 multicriteria.gpkg -l cycle_parking existing_parking.tif</code></pre>
</div>
<div id="generate-proximity-euclidean-distance-rasters" class="section level2">
<h2>3.2 Generate proximity (Euclidean distance) rasters</h2>
<pre><code>gdal_proximity.py routes.tif outes_proximity.tif -ot Int16 -distunits GEO
gdal_proximity.py existing_parking.tif existing_parking_proximity.tif -ot Int16 -distunits GEO</code></pre>
</div>
<div id="re-classify-raster-values" class="section level2">
<h2>3.3 Re-classify raster values</h2>
<table>
<thead>
<tr class="header">
<th align="left"><strong>Thefts</strong></th>
<th align="left"><strong>Routes</strong></th>
<th align="left"><strong>Existing Parking</strong></th>
<th>Re-Class Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">&gt; 20</td>
<td align="left">0-50m</td>
<td align="left">&gt; 100m</td>
<td>100</td>
</tr>
<tr class="even">
<td align="left">10-20</td>
<td align="left">50-100m</td>
<td align="left">50-100m</td>
<td>50</td>
</tr>
<tr class="odd">
<td align="left">&lt; 10</td>
<td align="left">&gt; 100m</td>
<td align="left">&lt; 50m</td>
<td>10</td>
</tr>
</tbody>
</table>
<pre><code>gdal_calc.py -A thefts.tif --outfile thefts_reclass.tif --calc=&quot;100*(A&gt;20) + 50*(A&gt;10)*(A&lt;=20) + 10*(A&lt;10)&quot;

gdal_calc.py -A routes_proximity.tif --outfile routes_reclass.tif --calc=&quot;100*(A&lt;=50) + 50*(A&gt;50)*(A&lt;=100) + 10*(A&gt;100)&quot;

gdal_calc.py -A existing_parking_proximity.tif --outfile existing_parking_reclass.tif --calc=&quot;100*(A&gt;100) + 50*(A&gt;50)*(A&lt;=100) + 10*(A&lt;50)&quot;</code></pre>
</div>
<div id="overlay-analysis" class="section level2">
<h2>3.4 Overlay analysis</h2>
<p>Roads and Water have a range of values, but protected areas are either 0 or 1. So we combine these together accordingly.</p>
<pre><code>gdalwarp -r average -tr 100 100 existing_parking_reclass.tif parking_reclass_resampled.tif
gdalwarp -r average -tr 100 100 routes_reclass.tif routes_reclass_resampled.tif</code></pre>
<pre><code>gdal_calc.py -A thefts_reclass.tif -B routes_reclass_resampled.tif -C parking_reclass_resampled.tif --outfile suitability.tif --calc=&quot;(A + B + C)/3&quot; --NoDataValue=0</code></pre>
</div>
</div>
<div id="running-commands-in-batch" class="section level1">
<h1>4. Running commands in batch</h1>
<p>You can run the GDAL/OGR commands in a loop using Python. Say you want to convert the format of the images from JPEG200 to GeoTiff. You would run a command such as below.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gdal_translate</span> -of GTiff -co COMPRESS=JPEG <span class="dt">{input}</span> <span class="dt">{output}</span></span></code></pre></div>
<p>But it would be a lot of manual effort if you want to run the commands on hundreds of input files. Here’s where a simple python script can help you automate running the commands in a batch. The data directory contains a file called <code>batch.py</code> with the following python code.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>input_dir <span class="op">=</span> <span class="st">&#39;naip&#39;</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>command <span class="op">=</span> <span class="st">&#39;gdal_translate -of GTiff -co COMPRESS=JPEG </span><span class="sc">{input}</span><span class="st"> </span><span class="sc">{output}</span><span class="st">&#39;</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> os.listdir(input_dir):</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">file</span>.endswith(<span class="st">&#39;.jp2&#39;</span>):</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span> <span class="op">=</span> os.path.join(input_dir, <span class="bu">file</span>)</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> os.path.splitext(os.path.basename(<span class="bu">file</span>))[<span class="dv">0</span>]</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span>  os.path.join(input_dir, filename <span class="op">+</span> <span class="st">&#39;.tif&#39;</span>)</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    os.system(command.<span class="bu">format</span>(<span class="bu">input</span><span class="op">=</span><span class="bu">input</span>, output<span class="op">=</span>output))</span></code></pre></div>
<p>In OsGeo4W shell, run the following command to start batch processing on all tiles contained in the <code>naip/</code> directory.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> batch.py</span></code></pre></div>
<p>The data directory also contains an example of running the batch commands in parallel using python’s built-in multiprocessing library. If your system has multi-core CPU, running commands in parallel like this on multiple threads can give you performance boost over running them in series.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> multiprocessing <span class="im">import</span> Pool</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> timeit <span class="im">import</span> default_timer <span class="im">as</span> timer</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>input_dir <span class="op">=</span> <span class="st">&#39;naip&#39;</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>command <span class="op">=</span> <span class="st">&#39;gdal_translate -of GTiff -co COMPRESS=JPEG </span><span class="sc">{input}</span><span class="st"> </span><span class="sc">{output}</span><span class="st">&#39;</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process(<span class="bu">file</span>):</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span> <span class="op">=</span> os.path.join(input_dir, <span class="bu">file</span>)</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> os.path.splitext(os.path.basename(<span class="bu">file</span>))[<span class="dv">0</span>]</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span>  os.path.join(input_dir, filename <span class="op">+</span> <span class="st">&#39;.tif&#39;</span>)</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>    os.system(command.<span class="bu">format</span>(<span class="bu">input</span><span class="op">=</span><span class="bu">input</span>, output<span class="op">=</span>output))</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> [<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> os.listdir(input_dir) <span class="cf">if</span> <span class="bu">file</span>.endswith(<span class="st">&#39;.jp2&#39;</span>)]</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>  start <span class="op">=</span> timer()</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>  p <span class="op">=</span> Pool(<span class="dv">4</span>)</span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>  p.<span class="bu">map</span>(process, files)</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>  end <span class="op">=</span> timer()</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(end <span class="op">-</span> start)</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>  start <span class="op">=</span> timer()</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>    process(<span class="bu">file</span>)</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>  end <span class="op">=</span> timer()</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(end <span class="op">-</span> start)</span></code></pre></div>
<p>The script runs the commands both in parallel and serial mode and prints the time taken by each of them.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> batch-parallel.py</span></code></pre></div>
</div>
<div id="supplement" class="section level1">
<h1>Supplement</h1>
<div id="creating-colorized-hillshade" class="section level2">
<h2>Creating Colorized Hillshade</h2>
<p>If you want to merge hillshade and color-relief to create a colored shaded relief map, you can use use <code>gdal_calc.py</code> to create do gamma and overlay calculations to combine the 2 rasters. <a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<pre><code>gdal_calc.py -A hillshade.tif --outfile=gamma_hillshade.tif \
  --calc=&quot;uint8(((A / 255.)**(1/0.5)) * 255)&quot;</code></pre>
<pre><code>gdal_calc.py -A gamma_hillshade.tif -B colorized.tif --allBands=B \
--calc=&quot;uint8( ( \
                 2 * (A/255.)*(B/255.)*(A&lt;128) + \
                 ( 1 - 2 * (1-(A/255.))*(1-(B/255.)) ) * (A&gt;=128) \
               ) * 255 )&quot; --outfile=colorized_hillshade.tif</code></pre>
<div class="figure" style="text-align: center">
<img src="images/gdal/colorized_hillshade.png" alt="Colorized Shaded Relief" width="75%" />
<p class="caption">
Colorized Shaded Relief
</p>
</div>
</div>
<div id="splitting-a-mosaic-into-tiles" class="section level2">
<h2>Splitting a Mosaic into Tiles</h2>
<p>When delivering large mosaics, it is a good idea to split your large input file into smaller chunks. If you are working with a very large mosaic, splitting it into smaller chunks and processing them independently can help overcome memory issues. GDAL ships with a handy script called <code>gdal_retile.py</code> that is designed for this task.</p>
<p>Let’s say we have a large GeoTIFF file <code>aoi.tif</code> and want to split it into tiles of 5000 pixels. We can use the following command to split the file and write the output to a directory named <code>tiles/</code>.</p>
<pre><code>gdal_retile.py -targetDir tiles -ps 5000 5000 aoi.tif</code></pre>
</div>
</div>
<div id="resources" class="section level1">
<h1>Resources</h1>
<ul>
<li><a href="https://twitter.com/gdaltips">GDAL Tips</a> <code>@gdaltips</code> on Twitter</li>
</ul>
</div>
<div id="data-credits" class="section level1">
<h1>Data Credits</h1>
<ul>
<li>OpenStreetMap (osm) data layers: Data/Maps Copyright 2019 Geofabrik GmbH and OpenStreetMap Contributors. <a href="https://download.geofabrik.de/asia/india.html">OSM India free extract</a> downloaded from Geofabrik.</li>
<li>Landsat: Landsat-8 image courtesy of the U.S. Geological Survey. Image downloaded from <a href="https://console.cloud.google.com/marketplace/details/usgs-public-data/landast">Google Cloud Platform</a> and pre-processed using <a href="https://fromgistors.blogspot.com/p/semi-automatic-classification-plugin.html">Semi Automatic Classification Plugin from QGIS</a></li>
<li>Earth at Night image: Credit: NASA Earth Observatory/NOAA NGDC. Earth at Night flat hi-resolution map downloaded from <a href="https://earthobservatory.nasa.gov/features/NightLights/page3.php">NASA earth observatory</a></li>
<li>William Mackenzie 1870 map of Southern India: out-of-copyright scanned map downloaded from <a href="http://www.hipkiss.org/data/maps.html">Hipkiss’s Scanned Old Maps</a></li>
<li>NAIP 2016 Aerial Imagery for California: The National Agriculture Imagery Program (NAIP). USDA-FSA-APFO Aerial Photography Field Office. Downloaded from <a href="https://nrcs.app.box.com/v/naip/folder/18144379349">NRCS</a></li>
</ul>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>This course material is licensed under a <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>. You are free to use the material for any non-commercial purpose. Kindly give appropriate credit to the original author.</p>
<p>© 2020 Ujaval Gandhi <a href="http://spatialthoughts.com">www.spatialthoughts.com</a></p>
<hr />
<p><strong>This course is offered as an instructor-led online class. Visit <a href="https://spatialthoughts.com/events/">Spatial Thoughts</a> to know details of upcoming sessions.</strong></p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Code reference <a href="https://gis.stackexchange.com/questions/255537/merging-hillshade-dem-data-into-color-relief-single-geotiff-with-qgis-and-gdal" class="uri">https://gis.stackexchange.com/questions/255537/merging-hillshade-dem-data-into-color-relief-single-geotiff-with-qgis-and-gdal</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>

<div id="disqus_thread" class="standardPadding"></div>

<!-- disqus -->
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = 'https://courses.spatialthoughts.com' + location.pathname;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://spatialthoughts.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
