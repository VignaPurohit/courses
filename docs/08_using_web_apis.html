<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>08_using_web_apis.utf8</title>

<script src="site_libs/header-attrs-2.6/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372432-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372432-3');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<div id="using-web-apis" class="section level1">
<h1>Using Web APIs</h1>
<p>An API, or Application Program Interface, allows one program to <em>talk</em> to another program. Many websites or services provide an API so you can query for information in an automated way.</p>
<p>For mapping and spatial analysis, being able to use APIs is critical. For the longest time, Google Maps API was the most popular API on the web. APIs allow you to query web servers and get results without downloading data or running computation on your machine.</p>
<p>Common use cases for using APIs for spatial analysis are</p>
<ul>
<li>Getting directions / routing</li>
<li>Route optimization</li>
<li>Geocoding</li>
<li>Downloading data</li>
<li>Getting real-time weather data</li>
<li>…</li>
</ul>
<p>The provide of such APIs have many ways to implement an API. There are standards such as REST, SOAP, GraphQL etc. <em>REST</em> is the most populat standard for web APIs, and for geospatial APIs. REST APIs are used over HTTP and thus called web APIs.</p>
<div id="understanding-json-and-geojson" class="section level2">
<h2>Understanding JSON and GeoJSON</h2>
<p>JSON stands for <strong>J</strong>ava<strong>S</strong>cript <strong>O</strong>bject <strong>N</strong>otation. It is a format for storing and transporting data, and is the de-facto standard for data exchanged by APIs. GeoJSON is an extension of the JSON format that is commonly used to represent spatial data.</p>
<p>Python has a built-in <code>json</code> module that has methods for reading json data and converting it to Python objects, and vice-versa. In this example, we are using the <code>requests</code> module for querying the API which conveniently does the conversion for us. But it is useful to learn the basics of working with JSON in Python.</p>
<p>The GeoJSON data contains <em>features</em>, where each feature has some <em>properties</em> and a <em>geometry</em>.</p>
<pre class="python"><code>geojson_string = &#39;&#39;&#39;
{
  &quot;type&quot;: &quot;FeatureCollection&quot;,
  &quot;features&quot;: [
    {&quot;type&quot;: &quot;Feature&quot;,
      &quot;properties&quot;: {&quot;name&quot;: &quot;San Francisco&quot;},
      &quot;geometry&quot;: {&quot;type&quot;: &quot;Point&quot;, &quot;coordinates&quot;: [-121.5687, 37.7739]}
    }
  ]
}
&#39;&#39;&#39;
print(geojson_string)</code></pre>
<p>To convert a JSON string to a Python object (i.e. parsing JSON), we can use the <code>json.loads()</code> method.</p>
<pre class="python"><code>import json

data = json.loads(geojson_string)
print(type(data))
print(data)</code></pre>
<p>Now that we have <em>parsed</em> the GeoJSON string and have a Python object, we can extract infromation from it. The data is stored in a <em>FeatureCollection</em> - which is a list of <em>features</em>. In our example, we have just 1 feature inside the feature collection, so we can access it by using index <strong>0</strong>.</p>
<pre class="python"><code>city_data = data[&#39;features&#39;][0]
print(city_data)</code></pre>
<p>The feature representation is a dictionary, and individual items can be accesses using the <em>keys</em></p>
<pre class="python"><code>city_name = city_data[&#39;properties&#39;][&#39;name&#39;]
city_coordinates = city_data[&#39;geometry&#39;][&#39;coordinates&#39;]
print(city_name, city_coordinates)</code></pre>
</div>
<div id="the-requests-module" class="section level2">
<h2>The <code>requests</code> module</h2>
<p>To query a server, we send a <strong>GET</strong> request with some parameters and the server sends a response back. The <code>requests</code> module allows you to send HTTP requests and parse the responses using Python.</p>
<p>The response contains the data received from the server. It contains the HTTP <em>status_code</em> which tells us if the request was successful. HTTP code 200 stands for <em>Sucess OK</em>.</p>
<pre class="python"><code>import requests

response = requests.get(&#39;https://www.spatialthoughts.com&#39;)

print(response.status_code)</code></pre>
</div>
<div id="calculating-distance-using-openrouteservice-api" class="section level2">
<h2>Calculating Distance using OpenRouteService API</h2>
<p><img src="images/python_foundation/ors_direction.png" /></p>
<p><a href="https://openrouteservice.org/">OpenRouteService (ORS)</a> provides a free API for routing, distance matrix, geocoding, route optimization etc. using OpenStreetMap data. We will learn how to use this API through Python and get real-world distance between cities.</p>
<p>Almost all APIs require you to sign-up and obtain a <em>key</em>. The <em>key</em> is used to identify you and enforce usage limits so that you do not overwhelm the servers. We will obtain a key from OpenRouteServie so we can use their API</p>
<p>Visit <a href="https://openrouteservice.org/dev/#/signup">OpenRouteService Sign-up page</a> and create an account. Once your account is activated, visit your Dashboard and request a token. Select <em>Free</em> as the Token type and enter <code>python_foundation</code> as the Token name. Click <em>CREATE TOKEN</em>. Once created, copy the long string displayed under Key and enter below.</p>
<pre class="python"><code>ORS_API_KEY = &#39;&lt;replace this with your key&gt;&#39;</code></pre>
<p>We will use the OpenRouteServices’s <a href="https://openrouteservice.org/dev/#/api-docs/v2/directions/%7Bprofile%7D/get">Directions Service</a>. This service returns the driving, biking or walking directions between the given origin and destination points.</p>
<pre class="python"><code>import requests

san_francisco = (37.7749, -122.4194)
new_york = (40.661, -73.944)

parameters = {
    &#39;api_key&#39;: ORS_API_KEY,
    &#39;start&#39; : &#39;{},{}&#39;.format(san_francisco[1], san_francisco[0]),
    &#39;end&#39; : &#39;{},{}&#39;.format(new_york[1], new_york[0])
}

response = requests.get(
    &#39;https://api.openrouteservice.org/v2/directions/driving-car&#39;, params=parameters)

if response.status_code == 200:
    print(&#39;Request successful.&#39;)
    data = response.json()
else:
    print(&#39;Request failed.&#39;)
</code></pre>
<p>We can read the <code>response</code> in JSON format by calling <code>json()</code> method on it.</p>
<pre class="python"><code>data = response.json()</code></pre>
<p>The response is a GeoJSON object representing the driving direction between the 2 points. The object is a feature collection with just 1 feature. We can access it using the index <strong>0</strong>. The feature’s property contains <code>summary</code> information which has the data we need.</p>
<pre class="python"><code>summary = data[&#39;features&#39;][0][&#39;properties&#39;][&#39;summary&#39;]
print(summary)</code></pre>
<p>We can extract the <code>distance</code> and convert it to kilometers.</p>
<pre class="python"><code>distance = summary[&#39;distance&#39;]
print(distance/1000)</code></pre>
<p>You can compare this distance to the straight-line distance and see the difference.</p>
</div>
<div id="api-rate-limiting" class="section level2">
<h2>API Rate Limiting</h2>
<p>Many web APIs enforce <em>rate limiting</em> - allowing a limited number of requests over time. With computers it is easy to write a for loop, or have multiple programs send hundrends or thousands of queries per second. The server may not be configured to handle such volume. So the providers specify the limits on how many and how fast the queries can be sent.</p>
<p>OpenRouteService lists several <a href="https://openrouteservice.org/plans/">API Restrictions</a>. The free plan allows for upto 40 direction requests/minute.</p>
<p>There are many libraries available to implement various strategies for rate limiting. But we can use the built-in <code>time</code> module to implement a very simple rate limiting method.</p>
<div id="the-time-module" class="section level3">
<h3>The <code>time</code> module</h3>
<p>Python Standard Library has a <code>time</code> module that allows for time related operation. It contains a method <code>time.sleep()</code> which delays the execution of the program for the specified number of seconds.</p>
<pre class="python"><code>import time
for x in range(10):
    print(x)
    time.sleep(1)</code></pre>
</div>
</div>
<div id="exercise" class="section level2">
<h2>Exercise</h2>
<p>Below cell contains a dictionary with 3 destination cities and their coordinates. Write a <code>for</code> loop to iterate over the <code>destination_cities</code> disctionary and call <code>get_driving_distance()</code> function to print real driving distance between San Fransico and each city. Rate limit your queries by adding <code>time.sleep(2)</code> between successive function calls.</p>
<pre class="python"><code>import csv
import os
import requests
import time
ORS_API_KEY = &#39;&lt;replace this with your key&gt;&#39;

def get_driving_distance(source_coordinates, dest_coordinates):
    parameters = {
    &#39;api_key&#39;: ORS_API_KEY,
    &#39;start&#39; : &#39;{},{}&#39;.format(source_coordinates[1], source_coordinates[0]),
    &#39;end&#39; : &#39;{},{}&#39;.format(dest_coordinates[1], dest_coordinates[0])
    }

    response = requests.get(
        &#39;https://api.openrouteservice.org/v2/directions/driving-car&#39;, params=parameters)

    if response.status_code == 200:
        data = response.json()
        summary = data[&#39;features&#39;][0][&#39;properties&#39;][&#39;summary&#39;]
        distance = summary[&#39;distance&#39;]
        return distance/1000
    else:
        print(&#39;Request failed.&#39;)
        return -9999

san_francisco = (37.7749, -122.4194)

destination_cities = {
    &#39;Los Angeles&#39;: (34.0522, -118.2437),
    &#39;Boston&#39;: (42.3601, -71.0589),
    &#39;Atlanta&#39;: (33.7490, -84.3880)
}</code></pre>
<hr />
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
