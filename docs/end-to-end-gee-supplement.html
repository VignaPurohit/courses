<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>End-to-End Google Earth Engine (Supplementary Course Material)</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372432-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372432-3');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="#">Back to Top</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">End-to-End Google Earth Engine
(Supplementary Course Material)</h1>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#advanced-supervised-classification-techniques"
id="toc-advanced-supervised-classification-techniques">Advanced
Supervised Classification Techniques</a>
<ul>
<li><a href="#hyperparameter-tuning"
id="toc-hyperparameter-tuning">Hyperparameter Tuning</a></li>
<li><a href="#post-processing-classification-results"
id="toc-post-processing-classification-results">Post-Processing
Classification Results</a></li>
<li><a href="#principal-component-analysis-pca"
id="toc-principal-component-analysis-pca">Principal Component Analysis
(PCA)</a></li>
<li><a href="#multi-temporal-composites-for-crop-classification"
id="toc-multi-temporal-composites-for-crop-classification">Multi-temporal
Composites for Crop Classification</a></li>
<li><a href="#computing-correlation"
id="toc-computing-correlation">Computing Correlation</a></li>
<li><a href="#calculating-band-correlation-matrix"
id="toc-calculating-band-correlation-matrix">Calculating Band
Correlation Matrix</a></li>
<li><a href="#calculating-area-by-class"
id="toc-calculating-area-by-class">Calculating Area by Class</a></li>
<li><a href="#spectral-signature-plots"
id="toc-spectral-signature-plots">Spectral Signature Plots</a></li>
<li><a href="#identify-misclassified-gcps"
id="toc-identify-misclassified-gcps">Identify Misclassified
GCPs</a></li>
<li><a href="#image-normalization-and-standardization"
id="toc-image-normalization-and-standardization">Image Normalization and
Standardization</a></li>
<li><a href="#calculate-feature-importance"
id="toc-calculate-feature-importance">Calculate Feature
Importance</a></li>
<li><a href="#classification-with-migrated-training-samples"
id="toc-classification-with-migrated-training-samples">Classification
with Migrated Training Samples</a></li>
</ul></li>
<li><a href="#advanced-change-detection-techniques"
id="toc-advanced-change-detection-techniques">Advanced Change Detection
Techniques</a>
<ul>
<li><a href="#landslide-detection-using-dynamic-world"
id="toc-landslide-detection-using-dynamic-world">Landslide Detection
using Dynamic World</a></li>
<li><a href="#urban-growth-detection-using-dynamic-world"
id="toc-urban-growth-detection-using-dynamic-world">Urban Growth
Detection using Dynamic World</a></li>
<li><a href="#conflict-mapping" id="toc-conflict-mapping">Conflict
Mapping</a></li>
</ul></li>
<li><a href="#image-collection-processing"
id="toc-image-collection-processing">Image Collection Processing</a>
<ul>
<li><a href="#aggregating-and-visualizing-imagecollections"
id="toc-aggregating-and-visualizing-imagecollections">Aggregating and
Visualizing ImageCollections</a></li>
<li><a href="#exporting-imagecollections"
id="toc-exporting-imagecollections">Exporting ImageCollections</a></li>
<li><a href="#get-pixelwise-dates-for-composites"
id="toc-get-pixelwise-dates-for-composites">Get Pixelwise Dates for
Composites</a></li>
<li><a href="#visualize-number-of-images-in-composites"
id="toc-visualize-number-of-images-in-composites">Visualize Number of
Images in Composites</a></li>
</ul></li>
<li><a href="#advanced-image-processing"
id="toc-advanced-image-processing">Advanced Image Processing</a>
<ul>
<li><a href="#working-with-landsat-collection-2"
id="toc-working-with-landsat-collection-2">Working with Landsat
Collection 2</a></li>
<li><a href="#derive-lst-from-landsat-images"
id="toc-derive-lst-from-landsat-images">Derive LST from Landsat
Images</a></li>
</ul></li>
<li><a href="#time-series-smoothing-and-gap-filling"
id="toc-time-series-smoothing-and-gap-filling">Time-Series Smoothing and
Gap-filling</a>
<ul>
<li><a href="#moving-window-smoothing"
id="toc-moving-window-smoothing">Moving Window Smoothing</a></li>
<li><a href="#temporal-interpolation"
id="toc-temporal-interpolation">Temporal Interpolation</a></li>
<li><a href="#savitzky-golay-smoothing"
id="toc-savitzky-golay-smoothing">Savitzky-Golay Smoothing</a></li>
</ul></li>
<li><a href="#user-interface-templates"
id="toc-user-interface-templates">User Interface Templates</a>
<ul>
<li><a href="#adding-a-discrete-legend"
id="toc-adding-a-discrete-legend">Adding a Discrete Legend</a></li>
<li><a href="#adding-a-continous-legend"
id="toc-adding-a-continous-legend">Adding a Continous Legend</a></li>
<li><a href="#change-visualization-ui-app"
id="toc-change-visualization-ui-app">Change Visualization UI
App</a></li>
<li><a href="#ndvi-explorer-ui-app" id="toc-ndvi-explorer-ui-app">NDVI
Explorer UI App</a></li>
</ul></li>
<li><a href="#code-sharing-and-script-modules"
id="toc-code-sharing-and-script-modules">Code Sharing and Script
Modules</a>
<ul>
<li><a href="#sharing-a-single-script"
id="toc-sharing-a-single-script">Sharing a Single Script</a></li>
<li><a href="#sharing-multiple-scripts"
id="toc-sharing-multiple-scripts">Sharing Multiple Scripts</a></li>
<li><a href="#sharing-code-between-scripts"
id="toc-sharing-code-between-scripts">Sharing Code between
Scripts</a></li>
</ul></li>
<li><a href="#license" id="toc-license">License</a></li>
<li><a href="#citing-and-referencing"
id="toc-citing-and-referencing">Citing and Referencing</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This page contains Supplementary Materials for the End-to-End Google
Earth Engine course. It is a collection useful scripts and code snippets
that can be adapted for your projects.</p>
<p>Please visit the <a
href="https://courses.spatialthoughts.com/end-to-end-gee.html">End-to-End
Google Earth Engine</a> course page for the full course material.</p>
</div>
<div id="advanced-supervised-classification-techniques"
class="section level1">
<h1>Advanced Supervised Classification Techniques</h1>
<div id="hyperparameter-tuning" class="section level2">
<h2>Hyperparameter Tuning</h2>
<p>A recommended best practice for improving the accuracy of your
machine learning model is to tune different parameters. For example,
when using the <code>ee.Classifier.smileRandomForest()</code>
classifier, we must specify the <em>Number of Trees</em>. We know that
higher number of trees result in more computation requirement, but it
doesn’t necessarily result in better results. Instead of guessing, we
programmatically try a range of values and choose the smallest value
possible that results in the highest accuracy.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/hyperparameter_tuning.png" alt="Supervised Classification Output" width="75%" />
<p class="caption">
Supervised Classification Output
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FHyperparameter_Tuning"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="kw">var</span> alos <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JAXA/ALOS/AW3D30/V2_2&quot;</span>)<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="co">// Function to remove cloud and snow pixels from Sentinel-2 SR image</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskCloudAndShadowsSR</span>(image) {</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>  <span class="kw">var</span> cloudProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_CLDPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  <span class="kw">var</span> snowProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_SNWPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>  <span class="kw">var</span> cloud <span class="op">=</span> cloudProb<span class="op">.</span><span class="fu">lt</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>  <span class="kw">var</span> scl <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SCL&#39;</span>)<span class="op">;</span> </span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>  <span class="kw">var</span> shadow <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>)<span class="op">;</span> <span class="co">// 3 = cloud shadow</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>  <span class="kw">var</span> cirrus <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">10</span>)<span class="op">;</span> <span class="co">// 10 = cirrus</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>  <span class="co">// Cloud probability less than 10% or cloud shadow classification</span></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> cloud<span class="op">.</span><span class="fu">and</span>(cirrus<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">.</span><span class="fu">and</span>(shadow<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>}</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(boundary))</span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskCloudAndShadowsSR)</span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(boundary) </span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">;</span></span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(boundary)</span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a><span class="kw">var</span> addIndices <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a>  <span class="kw">var</span> ndbi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B11&#39;</span><span class="op">,</span> <span class="st">&#39;B8&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndbi&#39;</span>])<span class="op">;</span></span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a>  <span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a>  <span class="kw">var</span> bsi <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a>      <span class="st">&#39;(( X + Y ) - (A + B)) /(( X + Y ) + (A + B)) &#39;</span><span class="op">,</span> {</span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a>        <span class="st">&#39;X&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">,</span> <span class="co">//swir1</span></span>
<span id="cb1-49"><a href="#cb1-49" tabindex="-1"></a>        <span class="st">&#39;Y&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B4&#39;</span>)<span class="op">,</span>  <span class="co">//red</span></span>
<span id="cb1-50"><a href="#cb1-50" tabindex="-1"></a>        <span class="st">&#39;A&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">,</span> <span class="co">// nir</span></span>
<span id="cb1-51"><a href="#cb1-51" tabindex="-1"></a>        <span class="st">&#39;B&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B2&#39;</span>)<span class="op">,</span> <span class="co">// blue</span></span>
<span id="cb1-52"><a href="#cb1-52" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;bsi&#39;</span>)<span class="op">;</span></span>
<span id="cb1-53"><a href="#cb1-53" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">.</span><span class="fu">addBands</span>(ndbi)<span class="op">.</span><span class="fu">addBands</span>(mndwi)<span class="op">.</span><span class="fu">addBands</span>(bsi)</span>
<span id="cb1-54"><a href="#cb1-54" tabindex="-1"></a>}</span>
<span id="cb1-55"><a href="#cb1-55" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">addIndices</span>(composite)<span class="op">;</span></span>
<span id="cb1-57"><a href="#cb1-57" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" tabindex="-1"></a></span>
<span id="cb1-59"><a href="#cb1-59" tabindex="-1"></a><span class="co">// Calculate Slope and Elevation</span></span>
<span id="cb1-60"><a href="#cb1-60" tabindex="-1"></a><span class="kw">var</span> elev <span class="op">=</span> alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;elev&#39;</span>)<span class="op">;</span></span>
<span id="cb1-61"><a href="#cb1-61" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> ee<span class="op">.</span><span class="at">Terrain</span><span class="op">.</span><span class="fu">slope</span>(alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb1-62"><a href="#cb1-62" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> composite<span class="op">.</span><span class="fu">addBands</span>(elev)<span class="op">.</span><span class="fu">addBands</span>(slope)<span class="op">;</span></span>
<span id="cb1-64"><a href="#cb1-64" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" tabindex="-1"></a></span>
<span id="cb1-67"><a href="#cb1-67" tabindex="-1"></a><span class="co">// Normalize the image </span></span>
<span id="cb1-68"><a href="#cb1-68" tabindex="-1"></a></span>
<span id="cb1-69"><a href="#cb1-69" tabindex="-1"></a><span class="co">// Machine learning algorithms work best on images when all features have</span></span>
<span id="cb1-70"><a href="#cb1-70" tabindex="-1"></a><span class="co">// the same range</span></span>
<span id="cb1-71"><a href="#cb1-71" tabindex="-1"></a></span>
<span id="cb1-72"><a href="#cb1-72" tabindex="-1"></a><span class="co">// Function to Normalize Image</span></span>
<span id="cb1-73"><a href="#cb1-73" tabindex="-1"></a><span class="co">// Pixel Values should be between 0 and 1</span></span>
<span id="cb1-74"><a href="#cb1-74" tabindex="-1"></a><span class="co">// Formula is (x - xmin) / (xmax - xmin)</span></span>
<span id="cb1-75"><a href="#cb1-75" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb1-76"><a href="#cb1-76" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span>(image){</span>
<span id="cb1-77"><a href="#cb1-77" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb1-78"><a href="#cb1-78" tabindex="-1"></a>  <span class="co">// Compute min and max of the image</span></span>
<span id="cb1-79"><a href="#cb1-79" tabindex="-1"></a>  <span class="kw">var</span> minDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb1-80"><a href="#cb1-80" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb1-81"><a href="#cb1-81" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> boundary<span class="op">,</span></span>
<span id="cb1-82"><a href="#cb1-82" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb1-83"><a href="#cb1-83" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb1-84"><a href="#cb1-84" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb1-85"><a href="#cb1-85" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb1-86"><a href="#cb1-86" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb1-87"><a href="#cb1-87" tabindex="-1"></a>  <span class="kw">var</span> maxDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb1-88"><a href="#cb1-88" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb1-89"><a href="#cb1-89" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> boundary<span class="op">,</span></span>
<span id="cb1-90"><a href="#cb1-90" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb1-91"><a href="#cb1-91" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb1-92"><a href="#cb1-92" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb1-93"><a href="#cb1-93" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb1-94"><a href="#cb1-94" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb1-95"><a href="#cb1-95" tabindex="-1"></a>  <span class="kw">var</span> mins <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(minDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb1-96"><a href="#cb1-96" tabindex="-1"></a>  <span class="kw">var</span> maxs <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(maxDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb1-97"><a href="#cb1-97" tabindex="-1"></a></span>
<span id="cb1-98"><a href="#cb1-98" tabindex="-1"></a>  <span class="kw">var</span> normalized <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(mins)<span class="op">.</span><span class="fu">divide</span>(maxs<span class="op">.</span><span class="fu">subtract</span>(mins))</span>
<span id="cb1-99"><a href="#cb1-99" tabindex="-1"></a>  <span class="cf">return</span> normalized</span>
<span id="cb1-100"><a href="#cb1-100" tabindex="-1"></a>}</span>
<span id="cb1-101"><a href="#cb1-101" tabindex="-1"></a></span>
<span id="cb1-102"><a href="#cb1-102" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">normalize</span>(composite)<span class="op">;</span></span>
<span id="cb1-103"><a href="#cb1-103" tabindex="-1"></a><span class="co">// Add a random column and split the GCPs into training and validation set</span></span>
<span id="cb1-104"><a href="#cb1-104" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()</span>
<span id="cb1-105"><a href="#cb1-105" tabindex="-1"></a></span>
<span id="cb1-106"><a href="#cb1-106" tabindex="-1"></a><span class="co">// This being a simpler classification, we take 60% points</span></span>
<span id="cb1-107"><a href="#cb1-107" tabindex="-1"></a><span class="co">// for validation. Normal recommended ratio is</span></span>
<span id="cb1-108"><a href="#cb1-108" tabindex="-1"></a><span class="co">// 70% training, 30% validation</span></span>
<span id="cb1-109"><a href="#cb1-109" tabindex="-1"></a><span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb1-110"><a href="#cb1-110" tabindex="-1"></a><span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb1-111"><a href="#cb1-111" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb1-112"><a href="#cb1-112" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb1-113"><a href="#cb1-113" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb1-114"><a href="#cb1-114" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb1-115"><a href="#cb1-115" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb1-116"><a href="#cb1-116" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb1-117"><a href="#cb1-117" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb1-118"><a href="#cb1-118" tabindex="-1"></a><span class="fu">print</span>(training)</span>
<span id="cb1-119"><a href="#cb1-119" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb1-120"><a href="#cb1-120" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb1-121"><a href="#cb1-121" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb1-122"><a href="#cb1-122" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb1-123"><a href="#cb1-123" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb1-124"><a href="#cb1-124" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb1-125"><a href="#cb1-125" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb1-126"><a href="#cb1-126" tabindex="-1"></a></span>
<span id="cb1-127"><a href="#cb1-127" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb1-128"><a href="#cb1-128" tabindex="-1"></a><span class="co">// Feature Importance</span></span>
<span id="cb1-129"><a href="#cb1-129" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb1-130"><a href="#cb1-130" tabindex="-1"></a></span>
<span id="cb1-131"><a href="#cb1-131" tabindex="-1"></a><span class="co">// Run .explain() to see what the classifer looks like</span></span>
<span id="cb1-132"><a href="#cb1-132" tabindex="-1"></a><span class="fu">print</span>(classifier<span class="op">.</span><span class="fu">explain</span>())</span>
<span id="cb1-133"><a href="#cb1-133" tabindex="-1"></a></span>
<span id="cb1-134"><a href="#cb1-134" tabindex="-1"></a><span class="co">// Calculate variable importance</span></span>
<span id="cb1-135"><a href="#cb1-135" tabindex="-1"></a><span class="kw">var</span> importance <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(classifier<span class="op">.</span><span class="fu">explain</span>()<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;importance&#39;</span>))</span>
<span id="cb1-136"><a href="#cb1-136" tabindex="-1"></a></span>
<span id="cb1-137"><a href="#cb1-137" tabindex="-1"></a><span class="co">// Calculate relative importance</span></span>
<span id="cb1-138"><a href="#cb1-138" tabindex="-1"></a><span class="kw">var</span> sum <span class="op">=</span> importance<span class="op">.</span><span class="fu">values</span>()<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb1-139"><a href="#cb1-139" tabindex="-1"></a></span>
<span id="cb1-140"><a href="#cb1-140" tabindex="-1"></a><span class="kw">var</span> relativeImportance <span class="op">=</span> importance<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(key<span class="op">,</span> val) {</span>
<span id="cb1-141"><a href="#cb1-141" tabindex="-1"></a>   <span class="cf">return</span> (ee<span class="op">.</span><span class="fu">Number</span>(val)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">100</span>))<span class="op">.</span><span class="fu">divide</span>(sum)</span>
<span id="cb1-142"><a href="#cb1-142" tabindex="-1"></a>  })</span>
<span id="cb1-143"><a href="#cb1-143" tabindex="-1"></a><span class="fu">print</span>(relativeImportance)</span>
<span id="cb1-144"><a href="#cb1-144" tabindex="-1"></a></span>
<span id="cb1-145"><a href="#cb1-145" tabindex="-1"></a><span class="co">// Create a FeatureCollection so we can chart it</span></span>
<span id="cb1-146"><a href="#cb1-146" tabindex="-1"></a><span class="kw">var</span> importanceFc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>([</span>
<span id="cb1-147"><a href="#cb1-147" tabindex="-1"></a>  ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> relativeImportance)</span>
<span id="cb1-148"><a href="#cb1-148" tabindex="-1"></a>])</span>
<span id="cb1-149"><a href="#cb1-149" tabindex="-1"></a></span>
<span id="cb1-150"><a href="#cb1-150" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byProperty</span>({</span>
<span id="cb1-151"><a href="#cb1-151" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> importanceFc</span>
<span id="cb1-152"><a href="#cb1-152" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb1-153"><a href="#cb1-153" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Feature Importance&#39;</span><span class="op">,</span></span>
<span id="cb1-154"><a href="#cb1-154" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Importance&#39;</span>}<span class="op">,</span></span>
<span id="cb1-155"><a href="#cb1-155" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Feature&#39;</span>}</span>
<span id="cb1-156"><a href="#cb1-156" tabindex="-1"></a>  })</span>
<span id="cb1-157"><a href="#cb1-157" tabindex="-1"></a><span class="fu">print</span>(chart)</span>
<span id="cb1-158"><a href="#cb1-158" tabindex="-1"></a></span>
<span id="cb1-159"><a href="#cb1-159" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb1-160"><a href="#cb1-160" tabindex="-1"></a><span class="co">// Hyperparameter Tuning</span></span>
<span id="cb1-161"><a href="#cb1-161" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb1-162"><a href="#cb1-162" tabindex="-1"></a></span>
<span id="cb1-163"><a href="#cb1-163" tabindex="-1"></a><span class="kw">var</span> test <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb1-164"><a href="#cb1-164" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb1-165"><a href="#cb1-165" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb1-166"><a href="#cb1-166" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb1-167"><a href="#cb1-167" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb1-168"><a href="#cb1-168" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb1-169"><a href="#cb1-169" tabindex="-1"></a></span>
<span id="cb1-170"><a href="#cb1-170" tabindex="-1"></a></span>
<span id="cb1-171"><a href="#cb1-171" tabindex="-1"></a><span class="co">// Tune the numberOfTrees parameter.</span></span>
<span id="cb1-172"><a href="#cb1-172" tabindex="-1"></a><span class="kw">var</span> numTreesList <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb1-173"><a href="#cb1-173" tabindex="-1"></a></span>
<span id="cb1-174"><a href="#cb1-174" tabindex="-1"></a><span class="kw">var</span> accuracies <span class="op">=</span> numTreesList<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(numTrees) {</span>
<span id="cb1-175"><a href="#cb1-175" tabindex="-1"></a>  <span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(numTrees)</span>
<span id="cb1-176"><a href="#cb1-176" tabindex="-1"></a>      <span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb1-177"><a href="#cb1-177" tabindex="-1"></a>        <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span></span>
<span id="cb1-178"><a href="#cb1-178" tabindex="-1"></a>        <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb1-179"><a href="#cb1-179" tabindex="-1"></a>        <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb1-180"><a href="#cb1-180" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb1-181"><a href="#cb1-181" tabindex="-1"></a></span>
<span id="cb1-182"><a href="#cb1-182" tabindex="-1"></a>  <span class="co">// Here we are classifying a table instead of an image</span></span>
<span id="cb1-183"><a href="#cb1-183" tabindex="-1"></a>  <span class="co">// Classifiers work on both images and tables</span></span>
<span id="cb1-184"><a href="#cb1-184" tabindex="-1"></a>  <span class="cf">return</span> test</span>
<span id="cb1-185"><a href="#cb1-185" tabindex="-1"></a>    <span class="op">.</span><span class="fu">classify</span>(classifier)</span>
<span id="cb1-186"><a href="#cb1-186" tabindex="-1"></a>    <span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb1-187"><a href="#cb1-187" tabindex="-1"></a>    <span class="op">.</span><span class="fu">accuracy</span>()<span class="op">;</span></span>
<span id="cb1-188"><a href="#cb1-188" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb1-189"><a href="#cb1-189" tabindex="-1"></a></span>
<span id="cb1-190"><a href="#cb1-190" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">array</span><span class="op">.</span><span class="fu">values</span>({</span>
<span id="cb1-191"><a href="#cb1-191" tabindex="-1"></a>  <span class="dt">array</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Array</span>(accuracies)<span class="op">,</span></span>
<span id="cb1-192"><a href="#cb1-192" tabindex="-1"></a>  <span class="dt">axis</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb1-193"><a href="#cb1-193" tabindex="-1"></a>  <span class="dt">xLabels</span><span class="op">:</span> numTreesList</span>
<span id="cb1-194"><a href="#cb1-194" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb1-195"><a href="#cb1-195" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Hyperparameter Tuning for the numberOfTrees Parameters&#39;</span><span class="op">,</span></span>
<span id="cb1-196"><a href="#cb1-196" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Validation Accuracy&#39;</span>}<span class="op">,</span></span>
<span id="cb1-197"><a href="#cb1-197" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Number of Tress&#39;</span><span class="op">,</span> <span class="dt">gridlines</span><span class="op">:</span> {<span class="dt">count</span><span class="op">:</span> <span class="dv">15</span>}}</span>
<span id="cb1-198"><a href="#cb1-198" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb1-199"><a href="#cb1-199" tabindex="-1"></a><span class="fu">print</span>(chart)</span>
<span id="cb1-200"><a href="#cb1-200" tabindex="-1"></a></span>
<span id="cb1-201"><a href="#cb1-201" tabindex="-1"></a><span class="co">// Tuning Multiple Parameters</span></span>
<span id="cb1-202"><a href="#cb1-202" tabindex="-1"></a><span class="co">// We can tune many parameters together using</span></span>
<span id="cb1-203"><a href="#cb1-203" tabindex="-1"></a><span class="co">// nested map() functions</span></span>
<span id="cb1-204"><a href="#cb1-204" tabindex="-1"></a><span class="co">// Let&#39;s tune 2 parameters</span></span>
<span id="cb1-205"><a href="#cb1-205" tabindex="-1"></a><span class="co">// numTrees and bagFraction </span></span>
<span id="cb1-206"><a href="#cb1-206" tabindex="-1"></a><span class="kw">var</span> numTreesList <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb1-207"><a href="#cb1-207" tabindex="-1"></a><span class="kw">var</span> bagFractionList <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.9</span><span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb1-208"><a href="#cb1-208" tabindex="-1"></a></span>
<span id="cb1-209"><a href="#cb1-209" tabindex="-1"></a><span class="kw">var</span> accuracies <span class="op">=</span> numTreesList<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(numTrees) {</span>
<span id="cb1-210"><a href="#cb1-210" tabindex="-1"></a>  <span class="cf">return</span> bagFractionList<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(bagFraction) {</span>
<span id="cb1-211"><a href="#cb1-211" tabindex="-1"></a>     <span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>({</span>
<span id="cb1-212"><a href="#cb1-212" tabindex="-1"></a>       <span class="dt">numberOfTrees</span><span class="op">:</span> numTrees<span class="op">,</span></span>
<span id="cb1-213"><a href="#cb1-213" tabindex="-1"></a>       <span class="dt">bagFraction</span><span class="op">:</span> bagFraction</span>
<span id="cb1-214"><a href="#cb1-214" tabindex="-1"></a>     })</span>
<span id="cb1-215"><a href="#cb1-215" tabindex="-1"></a>      <span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb1-216"><a href="#cb1-216" tabindex="-1"></a>        <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span></span>
<span id="cb1-217"><a href="#cb1-217" tabindex="-1"></a>        <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb1-218"><a href="#cb1-218" tabindex="-1"></a>        <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb1-219"><a href="#cb1-219" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb1-220"><a href="#cb1-220" tabindex="-1"></a></span>
<span id="cb1-221"><a href="#cb1-221" tabindex="-1"></a>    <span class="co">// Here we are classifying a table instead of an image</span></span>
<span id="cb1-222"><a href="#cb1-222" tabindex="-1"></a>    <span class="co">// Classifiers work on both images and tables</span></span>
<span id="cb1-223"><a href="#cb1-223" tabindex="-1"></a>    <span class="kw">var</span> accuracy <span class="op">=</span> test</span>
<span id="cb1-224"><a href="#cb1-224" tabindex="-1"></a>      <span class="op">.</span><span class="fu">classify</span>(classifier)</span>
<span id="cb1-225"><a href="#cb1-225" tabindex="-1"></a>      <span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb1-226"><a href="#cb1-226" tabindex="-1"></a>      <span class="op">.</span><span class="fu">accuracy</span>()<span class="op">;</span></span>
<span id="cb1-227"><a href="#cb1-227" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">&#39;accuracy&#39;</span><span class="op">:</span> accuracy<span class="op">,</span></span>
<span id="cb1-228"><a href="#cb1-228" tabindex="-1"></a>      <span class="st">&#39;numberOfTrees&#39;</span><span class="op">:</span> numTrees<span class="op">,</span></span>
<span id="cb1-229"><a href="#cb1-229" tabindex="-1"></a>      <span class="st">&#39;bagFraction&#39;</span><span class="op">:</span> bagFraction})</span>
<span id="cb1-230"><a href="#cb1-230" tabindex="-1"></a>  })</span>
<span id="cb1-231"><a href="#cb1-231" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb1-232"><a href="#cb1-232" tabindex="-1"></a><span class="kw">var</span> resultFc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(accuracies)</span>
<span id="cb1-233"><a href="#cb1-233" tabindex="-1"></a></span>
<span id="cb1-234"><a href="#cb1-234" tabindex="-1"></a><span class="co">// Export the result as CSV</span></span>
<span id="cb1-235"><a href="#cb1-235" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb1-236"><a href="#cb1-236" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> resultFc<span class="op">,</span></span>
<span id="cb1-237"><a href="#cb1-237" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Multiple_Parameter_Tuning_Results&#39;</span><span class="op">,</span></span>
<span id="cb1-238"><a href="#cb1-238" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb1-239"><a href="#cb1-239" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;numtrees_bagfraction&#39;</span><span class="op">,</span></span>
<span id="cb1-240"><a href="#cb1-240" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;CSV&#39;</span>}) </span>
<span id="cb1-241"><a href="#cb1-241" tabindex="-1"></a>  </span></code></pre></div>
</div>
<div id="post-processing-classification-results" class="section level2">
<h2>Post-Processing Classification Results</h2>
<p>Supervised classification results often contain salt-and-pepper noise
caused by mis-classified pixels. It is usually preferable to apply some
post-processing techniques to remove such noise. The following script
contains the code for two popular techniques for post-processing
classification results.</p>
<ul>
<li>Using un-supervised clustering to replacing classified value by
majority value in each cluster.</li>
<li>Replacing isolated pixels with surrounding value with a majority
filter.</li>
</ul>
<blockquote>
<p>Remember that the neighborhood methods are scale-dependent so the
results will change as you zoom in/out. Export the results at the
desired scale to see the effect of post-processing.</p>
</blockquote>
<p><img src="images/end_to_end_gee/post_processing.png" width="100%" style="display: block; margin: auto;" /></p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FPost_Processing_Classification_Results"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co">// Sentinel-2 Median Composite</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_2019_composite&quot;</span>)<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span>   <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">,</span> <span class="st">&#39;RGB Composite&#39;</span>)<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">// Raw Supervised Classification Results</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_final_classification&quot;</span>)<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;Original&#39;</span>)<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(classified<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="co">// Post process by clustering</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a><span class="co">// Cluster using Unsupervised Clustering methods</span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a><span class="kw">var</span> seeds <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="at">Segmentation</span><span class="op">.</span><span class="fu">seedGrid</span>(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a><span class="kw">var</span> snic <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="at">Segmentation</span><span class="op">.</span><span class="fu">SNIC</span>({</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">,</span> </span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>  <span class="dt">compactness</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>  <span class="dt">connectivity</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>  <span class="dt">neighborhoodSize</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>  <span class="dt">size</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>  <span class="dt">seeds</span><span class="op">:</span> seeds</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>})</span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a><span class="kw">var</span> clusters <span class="op">=</span> snic<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;clusters&#39;</span>)</span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a><span class="co">// Assign class to each cluster based on &#39;majority&#39; voting (using ee.Reducer.mode()</span></span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a><span class="kw">var</span> smoothed <span class="op">=</span> classified<span class="op">.</span><span class="fu">addBands</span>(clusters)<span class="op">;</span></span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a><span class="kw">var</span> clusterMajority <span class="op">=</span> smoothed<span class="op">.</span><span class="fu">reduceConnectedComponents</span>({</span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mode</span>()<span class="op">,</span></span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a>  <span class="dt">labelBand</span><span class="op">:</span> <span class="st">&#39;clusters&#39;</span></span>
<span id="cb2-36"><a href="#cb2-36" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-37"><a href="#cb2-37" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clusterMajority<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> </span>
<span id="cb2-38"><a href="#cb2-38" tabindex="-1"></a>  <span class="st">&#39;Processed using Clusters&#39;</span>)<span class="op">;</span></span>
<span id="cb2-39"><a href="#cb2-39" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb2-43"><a href="#cb2-43" tabindex="-1"></a><span class="co">// Post process by replacing isolated pixels with surrounding value</span></span>
<span id="cb2-44"><a href="#cb2-44" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb2-45"><a href="#cb2-45" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" tabindex="-1"></a><span class="co">// count patch sizes</span></span>
<span id="cb2-47"><a href="#cb2-47" tabindex="-1"></a><span class="kw">var</span> patchsize <span class="op">=</span> classified<span class="op">.</span><span class="fu">connectedPixelCount</span>(<span class="dv">40</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb2-48"><a href="#cb2-48" tabindex="-1"></a></span>
<span id="cb2-49"><a href="#cb2-49" tabindex="-1"></a><span class="co">// run a majority filter</span></span>
<span id="cb2-50"><a href="#cb2-50" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> classified<span class="op">.</span><span class="fu">focal_mode</span>({</span>
<span id="cb2-51"><a href="#cb2-51" tabindex="-1"></a>    <span class="dt">radius</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb2-52"><a href="#cb2-52" tabindex="-1"></a>    <span class="dt">kernelType</span><span class="op">:</span> <span class="st">&#39;square&#39;</span><span class="op">,</span></span>
<span id="cb2-53"><a href="#cb2-53" tabindex="-1"></a>    <span class="dt">units</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb2-54"><a href="#cb2-54" tabindex="-1"></a>})<span class="op">;</span> </span>
<span id="cb2-55"><a href="#cb2-55" tabindex="-1"></a>  </span>
<span id="cb2-56"><a href="#cb2-56" tabindex="-1"></a><span class="co">// updated image with majority filter where patch size is small</span></span>
<span id="cb2-57"><a href="#cb2-57" tabindex="-1"></a><span class="kw">var</span> connectedClassified <span class="op">=</span>  classified<span class="op">.</span><span class="fu">where</span>(patchsize<span class="op">.</span><span class="fu">lt</span>(<span class="dv">25</span>)<span class="op">,</span>filtered)<span class="op">;</span></span>
<span id="cb2-58"><a href="#cb2-58" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(connectedClassified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> </span>
<span id="cb2-59"><a href="#cb2-59" tabindex="-1"></a>  <span class="st">&#39;Processed using Connected Pixels&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
<div id="principal-component-analysis-pca" class="section level2">
<h2>Principal Component Analysis (PCA)</h2>
<p>PCA is a very useful technique in improving your supervised
classification results. This is a statistical technique that compresses
data from a large number of bands into fewer uncorrelated bands. You can
run PCA on your image and add the first few (typically 3) principal
component bands to the original composite before sampling training
points. In the example below, you will notice that 97% of the variance
from the 13-band original image is captured in the 3-band PCA image.
This sends a stronger signal to the classifier and improves accuracy by
allowing it to distinguish different classes better.</p>
<p><img src="images/end_to_end_gee/pca.png" width="75%" style="display: block; margin: auto;" /></p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FPrincipal_Components_Analysis"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co">// Script showing how to do Principal Component Analysis on images</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_2019_composite&quot;</span>)<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_boundary&quot;</span>)<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Input Composite&#39;</span><span class="op">,</span> composite)<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(composite)</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">// Define the geometry and scale parameters</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> boundary<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="kw">var</span> scale <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="co">// Run the PCA function</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="kw">var</span> pca <span class="op">=</span> <span class="fu">PCA</span>(composite)</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="co">// Extract the properties of the pca image</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="kw">var</span> variance <span class="op">=</span> pca<span class="op">.</span><span class="fu">toDictionary</span>()</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Variance of Principal Components&#39;</span><span class="op">,</span> variance)</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="co">// As you see from the printed results, ~97% of the variance</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="co">// from the original image is captured in the first 3 principal components</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="co">// We select those and discard others</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a><span class="kw">var</span> pca <span class="op">=</span> <span class="fu">PCA</span>(composite)<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;pc1&#39;</span><span class="op">,</span> <span class="st">&#39;pc2&#39;</span><span class="op">,</span> <span class="st">&#39;pc3&#39;</span>])</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;First 3 PCA Bands&#39;</span><span class="op">,</span> pca)<span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="co">// PCA computation is expensive and can time out when displaying on the map</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a><span class="co">// Export the results and import them back</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toAsset</span>({</span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> pca<span class="op">,</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Principal_Components_Image&#39;</span><span class="op">,</span></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>  <span class="dt">assetId</span><span class="op">:</span> <span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_pca&#39;</span><span class="op">,</span></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> scale<span class="op">,</span></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span>})</span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a><span class="co">// Once the export finishes, import the asset and display</span></span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a><span class="kw">var</span> pcaImported <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_pca&#39;</span>)</span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a><span class="kw">var</span> pcaVisParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;pc1&#39;</span><span class="op">,</span> <span class="st">&#39;pc2&#39;</span><span class="op">,</span> <span class="st">&#39;pc3&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">2</span>}<span class="op">;</span></span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(pcaImported<span class="op">,</span> pcaVisParams<span class="op">,</span> <span class="st">&#39;Principal Components&#39;</span>)<span class="op">;</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a><span class="co">// Function to calculate Principal Components</span></span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a><span class="co">// Code adapted from https://developers.google.com/earth-engine/guides/arrays_eigen_analysis</span></span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a><span class="kw">function</span> <span class="fu">PCA</span>(maskedImage){</span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a>  <span class="kw">var</span> image <span class="op">=</span> maskedImage<span class="op">.</span><span class="fu">unmask</span>()</span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a>  <span class="kw">var</span> scale <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a>  <span class="kw">var</span> region <span class="op">=</span> geometry<span class="op">;</span></span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a>  <span class="co">// Mean center the data to enable a faster covariance reducer</span></span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a>  <span class="co">// and an SD stretch of the principal components.</span></span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a>  <span class="kw">var</span> meanDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb3-54"><a href="#cb3-54" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb3-55"><a href="#cb3-55" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> region<span class="op">,</span></span>
<span id="cb3-56"><a href="#cb3-56" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> scale<span class="op">,</span></span>
<span id="cb3-57"><a href="#cb3-57" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span><span class="op">,</span></span>
<span id="cb3-58"><a href="#cb3-58" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb3-59"><a href="#cb3-59" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-60"><a href="#cb3-60" tabindex="-1"></a>  <span class="kw">var</span> means <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(meanDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb3-61"><a href="#cb3-61" tabindex="-1"></a>  <span class="kw">var</span> centered <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(means)<span class="op">;</span></span>
<span id="cb3-62"><a href="#cb3-62" tabindex="-1"></a>  <span class="co">// This helper function returns a list of new band names.</span></span>
<span id="cb3-63"><a href="#cb3-63" tabindex="-1"></a>  <span class="kw">var</span> getNewBandNames <span class="op">=</span> <span class="kw">function</span>(prefix) {</span>
<span id="cb3-64"><a href="#cb3-64" tabindex="-1"></a>    <span class="kw">var</span> seq <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> bandNames<span class="op">.</span><span class="fu">length</span>())<span class="op">;</span></span>
<span id="cb3-65"><a href="#cb3-65" tabindex="-1"></a>    <span class="cf">return</span> seq<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(b) {</span>
<span id="cb3-66"><a href="#cb3-66" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="fu">String</span>(prefix)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="fu">Number</span>(b)<span class="op">.</span><span class="fu">int</span>())<span class="op">;</span></span>
<span id="cb3-67"><a href="#cb3-67" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb3-68"><a href="#cb3-68" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb3-69"><a href="#cb3-69" tabindex="-1"></a>  <span class="co">// This function accepts mean centered imagery, a scale and</span></span>
<span id="cb3-70"><a href="#cb3-70" tabindex="-1"></a>  <span class="co">// a region in which to perform the analysis.  It returns the</span></span>
<span id="cb3-71"><a href="#cb3-71" tabindex="-1"></a>  <span class="co">// Principal Components (PC) in the region as a new image.</span></span>
<span id="cb3-72"><a href="#cb3-72" tabindex="-1"></a>  <span class="kw">var</span> getPrincipalComponents <span class="op">=</span> <span class="kw">function</span>(centered<span class="op">,</span> scale<span class="op">,</span> region) {</span>
<span id="cb3-73"><a href="#cb3-73" tabindex="-1"></a>    <span class="co">// Collapse the bands of the image into a 1D array per pixel.</span></span>
<span id="cb3-74"><a href="#cb3-74" tabindex="-1"></a>    <span class="kw">var</span> arrays <span class="op">=</span> centered<span class="op">.</span><span class="fu">toArray</span>()<span class="op">;</span></span>
<span id="cb3-75"><a href="#cb3-75" tabindex="-1"></a>    </span>
<span id="cb3-76"><a href="#cb3-76" tabindex="-1"></a>    <span class="co">// Compute the covariance of the bands within the region.</span></span>
<span id="cb3-77"><a href="#cb3-77" tabindex="-1"></a>    <span class="kw">var</span> covar <span class="op">=</span> arrays<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb3-78"><a href="#cb3-78" tabindex="-1"></a>      <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">centeredCovariance</span>()<span class="op">,</span></span>
<span id="cb3-79"><a href="#cb3-79" tabindex="-1"></a>      <span class="dt">geometry</span><span class="op">:</span> region<span class="op">,</span></span>
<span id="cb3-80"><a href="#cb3-80" tabindex="-1"></a>      <span class="dt">scale</span><span class="op">:</span> scale<span class="op">,</span></span>
<span id="cb3-81"><a href="#cb3-81" tabindex="-1"></a>      <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span><span class="op">,</span></span>
<span id="cb3-82"><a href="#cb3-82" tabindex="-1"></a>      <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb3-83"><a href="#cb3-83" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb3-84"><a href="#cb3-84" tabindex="-1"></a></span>
<span id="cb3-85"><a href="#cb3-85" tabindex="-1"></a>    <span class="co">// Get the &#39;array&#39; covariance result and cast to an array.</span></span>
<span id="cb3-86"><a href="#cb3-86" tabindex="-1"></a>    <span class="co">// This represents the band-to-band covariance within the region.</span></span>
<span id="cb3-87"><a href="#cb3-87" tabindex="-1"></a>    <span class="kw">var</span> covarArray <span class="op">=</span> ee<span class="op">.</span><span class="fu">Array</span>(covar<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;array&#39;</span>))<span class="op">;</span></span>
<span id="cb3-88"><a href="#cb3-88" tabindex="-1"></a></span>
<span id="cb3-89"><a href="#cb3-89" tabindex="-1"></a>    <span class="co">// Perform an eigen analysis and slice apart the values and vectors.</span></span>
<span id="cb3-90"><a href="#cb3-90" tabindex="-1"></a>    <span class="kw">var</span> eigens <span class="op">=</span> covarArray<span class="op">.</span><span class="fu">eigen</span>()<span class="op">;</span></span>
<span id="cb3-91"><a href="#cb3-91" tabindex="-1"></a></span>
<span id="cb3-92"><a href="#cb3-92" tabindex="-1"></a>    <span class="co">// This is a P-length vector of Eigenvalues.</span></span>
<span id="cb3-93"><a href="#cb3-93" tabindex="-1"></a>    <span class="kw">var</span> eigenValues <span class="op">=</span> eigens<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb3-94"><a href="#cb3-94" tabindex="-1"></a>    </span>
<span id="cb3-95"><a href="#cb3-95" tabindex="-1"></a>    <span class="co">// Compute Percentage Variance of each component</span></span>
<span id="cb3-96"><a href="#cb3-96" tabindex="-1"></a>    <span class="co">// This will allow us to decide how many components capture</span></span>
<span id="cb3-97"><a href="#cb3-97" tabindex="-1"></a>    <span class="co">// most of the variance in the input</span></span>
<span id="cb3-98"><a href="#cb3-98" tabindex="-1"></a>    <span class="kw">var</span> eigenValuesList <span class="op">=</span> eigenValues<span class="op">.</span><span class="fu">toList</span>()<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb3-99"><a href="#cb3-99" tabindex="-1"></a>    <span class="kw">var</span> total <span class="op">=</span> eigenValuesList<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb3-100"><a href="#cb3-100" tabindex="-1"></a></span>
<span id="cb3-101"><a href="#cb3-101" tabindex="-1"></a>    <span class="kw">var</span> percentageVariance <span class="op">=</span> eigenValuesList<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(item) {</span>
<span id="cb3-102"><a href="#cb3-102" tabindex="-1"></a>      <span class="kw">var</span> component <span class="op">=</span> eigenValuesList<span class="op">.</span><span class="fu">indexOf</span>(item)<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%02d&#39;</span>)</span>
<span id="cb3-103"><a href="#cb3-103" tabindex="-1"></a>      <span class="kw">var</span> variance <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(item)<span class="op">.</span><span class="fu">divide</span>(total)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">100</span>)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%.2f&#39;</span>)</span>
<span id="cb3-104"><a href="#cb3-104" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="fu">List</span>([component<span class="op">,</span> variance])</span>
<span id="cb3-105"><a href="#cb3-105" tabindex="-1"></a>    })</span>
<span id="cb3-106"><a href="#cb3-106" tabindex="-1"></a>    <span class="co">// Create a dictionary that will be used to set properties on final image</span></span>
<span id="cb3-107"><a href="#cb3-107" tabindex="-1"></a>    <span class="kw">var</span> varianceDict <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(percentageVariance<span class="op">.</span><span class="fu">flatten</span>())</span>
<span id="cb3-108"><a href="#cb3-108" tabindex="-1"></a>    <span class="co">// This is a PxP matrix with eigenvectors in rows.</span></span>
<span id="cb3-109"><a href="#cb3-109" tabindex="-1"></a>    <span class="kw">var</span> eigenVectors <span class="op">=</span> eigens<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb3-110"><a href="#cb3-110" tabindex="-1"></a>    <span class="co">// Convert the array image to 2D arrays for matrix computations.</span></span>
<span id="cb3-111"><a href="#cb3-111" tabindex="-1"></a>    <span class="kw">var</span> arrayImage <span class="op">=</span> arrays<span class="op">.</span><span class="fu">toArray</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb3-112"><a href="#cb3-112" tabindex="-1"></a></span>
<span id="cb3-113"><a href="#cb3-113" tabindex="-1"></a>    <span class="co">// Left multiply the image array by the matrix of eigenvectors.</span></span>
<span id="cb3-114"><a href="#cb3-114" tabindex="-1"></a>    <span class="kw">var</span> principalComponents <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(eigenVectors)<span class="op">.</span><span class="fu">matrixMultiply</span>(arrayImage)<span class="op">;</span></span>
<span id="cb3-115"><a href="#cb3-115" tabindex="-1"></a></span>
<span id="cb3-116"><a href="#cb3-116" tabindex="-1"></a>    <span class="co">// Turn the square roots of the Eigenvalues into a P-band image.</span></span>
<span id="cb3-117"><a href="#cb3-117" tabindex="-1"></a>    <span class="co">// Call abs() to turn negative eigenvalues to positive before</span></span>
<span id="cb3-118"><a href="#cb3-118" tabindex="-1"></a>    <span class="co">// taking the square root</span></span>
<span id="cb3-119"><a href="#cb3-119" tabindex="-1"></a>    <span class="kw">var</span> sdImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(eigenValues<span class="op">.</span><span class="fu">abs</span>()<span class="op">.</span><span class="fu">sqrt</span>())</span>
<span id="cb3-120"><a href="#cb3-120" tabindex="-1"></a>      <span class="op">.</span><span class="fu">arrayProject</span>([<span class="dv">0</span>])<span class="op">.</span><span class="fu">arrayFlatten</span>([<span class="fu">getNewBandNames</span>(<span class="st">&#39;sd&#39;</span>)])<span class="op">;</span></span>
<span id="cb3-121"><a href="#cb3-121" tabindex="-1"></a></span>
<span id="cb3-122"><a href="#cb3-122" tabindex="-1"></a>    <span class="co">// Turn the PCs into a P-band image, normalized by SD.</span></span>
<span id="cb3-123"><a href="#cb3-123" tabindex="-1"></a>    <span class="cf">return</span> principalComponents</span>
<span id="cb3-124"><a href="#cb3-124" tabindex="-1"></a>      <span class="co">// Throw out an an unneeded dimension, [[]] -&gt; [].</span></span>
<span id="cb3-125"><a href="#cb3-125" tabindex="-1"></a>      <span class="op">.</span><span class="fu">arrayProject</span>([<span class="dv">0</span>])</span>
<span id="cb3-126"><a href="#cb3-126" tabindex="-1"></a>      <span class="co">// Make the one band array image a multi-band image, [] -&gt; image.</span></span>
<span id="cb3-127"><a href="#cb3-127" tabindex="-1"></a>      <span class="op">.</span><span class="fu">arrayFlatten</span>([<span class="fu">getNewBandNames</span>(<span class="st">&#39;pc&#39;</span>)])</span>
<span id="cb3-128"><a href="#cb3-128" tabindex="-1"></a>      <span class="co">// Normalize the PCs by their SDs.</span></span>
<span id="cb3-129"><a href="#cb3-129" tabindex="-1"></a>      <span class="op">.</span><span class="fu">divide</span>(sdImage)</span>
<span id="cb3-130"><a href="#cb3-130" tabindex="-1"></a>      <span class="op">.</span><span class="fu">set</span>(varianceDict)<span class="op">;</span></span>
<span id="cb3-131"><a href="#cb3-131" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb3-132"><a href="#cb3-132" tabindex="-1"></a>  <span class="kw">var</span> pcImage <span class="op">=</span> <span class="fu">getPrincipalComponents</span>(centered<span class="op">,</span> scale<span class="op">,</span> region)<span class="op">;</span></span>
<span id="cb3-133"><a href="#cb3-133" tabindex="-1"></a>  <span class="cf">return</span> pcImage<span class="op">.</span><span class="fu">mask</span>(maskedImage<span class="op">.</span><span class="fu">mask</span>())<span class="op">;</span></span>
<span id="cb3-134"><a href="#cb3-134" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="multi-temporal-composites-for-crop-classification"
class="section level2">
<h2>Multi-temporal Composites for Crop Classification</h2>
<p>Crop classification is a difficult problem. A useful technique that
aids in clear distinction of crops is to account for crop phenology.
This technique can be applied to detect a specific type of crop or
distinguish crops from other forms of vegetation. You can create
composite images for different periods of the cropping cycle and create
a stacked image to be used for classification. This allows the
classifier to learn the temporal pattern and detect pixels that exhibit
similar patterns.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/seasonal_composite.png" alt="Capturing Crop Phenology through Seasonal Composites" width="100%" />
<p class="caption">
Capturing Crop Phenology through Seasonal Composites
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FSeasonal_Composites_for_Crop_Classification"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(boundary<span class="op">,</span> <span class="dv">11</span>)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">// Function to remove cloud pixels from Sentinel-2 SR image </span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskCloudAndShadowsSR</span>(image) {</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>  <span class="kw">var</span> cloudProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_CLDPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>  <span class="kw">var</span> snowProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_SNWPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>  <span class="kw">var</span> cloud <span class="op">=</span> cloudProb<span class="op">.</span><span class="fu">lt</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>  <span class="kw">var</span> scl <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SCL&#39;</span>)<span class="op">;</span> </span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>  <span class="kw">var</span> shadow <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>)<span class="op">;</span> <span class="co">// 3 = cloud shadow</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>  <span class="kw">var</span> cirrus <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">10</span>)<span class="op">;</span> <span class="co">// 10 = cirrus</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>  <span class="co">// Cloud probability less than 10% or cloud shadow classification</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> cloud<span class="op">.</span><span class="fu">and</span>(cirrus<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">.</span><span class="fu">and</span>(shadow<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>    <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])<span class="op">;</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>}</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(boundary))</span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskCloudAndShadowsSR)</span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a><span class="co">// There are 3 distinct crop seasons in the area of interest</span></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a><span class="co">// Jan-March = Winter (Rabi) Crops</span></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a><span class="co">// April-June  = Summer Crops / Harvest</span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a><span class="co">// July-December = Monsoon (Kharif) Crops</span></span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a><span class="kw">var</span> cropCalendar <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>]<span class="op">,</span> [<span class="dv">4</span><span class="op">,</span><span class="dv">6</span>]<span class="op">,</span> [<span class="dv">7</span><span class="op">,</span><span class="dv">12</span>]])</span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a><span class="co">// We create different composites for each season</span></span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a><span class="kw">var</span> createSeasonComposites <span class="op">=</span> <span class="kw">function</span>(months) {</span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>  <span class="kw">var</span> startMonth <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(months)<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>)</span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a>  <span class="kw">var</span> endMonth <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(months)<span class="op">.</span><span class="fu">get</span>(<span class="dv">1</span>)</span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>  <span class="kw">var</span> monthFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(startMonth<span class="op">,</span> endMonth<span class="op">,</span> <span class="st">&#39;month&#39;</span>)</span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a>  <span class="kw">var</span> seasonFiltered <span class="op">=</span> filtered<span class="op">.</span><span class="fu">filter</span>(monthFilter)</span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a>  <span class="kw">var</span> composite <span class="op">=</span> seasonFiltered<span class="op">.</span><span class="fu">median</span>()</span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>  <span class="cf">return</span> composite<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(boundary)</span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a>}</span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a><span class="kw">var</span> compositeList <span class="op">=</span> cropCalendar<span class="op">.</span><span class="fu">map</span>(createSeasonComposites)</span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a><span class="kw">var</span> rabi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(compositeList<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))</span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a><span class="kw">var</span> harvest <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(compositeList<span class="op">.</span><span class="fu">get</span>(<span class="dv">1</span>))</span>
<span id="cb4-47"><a href="#cb4-47" tabindex="-1"></a><span class="kw">var</span> kharif <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(compositeList<span class="op">.</span><span class="fu">get</span>(<span class="dv">2</span>))</span>
<span id="cb4-48"><a href="#cb4-48" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">;</span></span>
<span id="cb4-50"><a href="#cb4-50" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(rabi<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Rabi&#39;</span>)</span>
<span id="cb4-51"><a href="#cb4-51" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(harvest<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Harvest&#39;</span>)</span>
<span id="cb4-52"><a href="#cb4-52" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(kharif<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Kharif&#39;</span>)</span>
<span id="cb4-53"><a href="#cb4-53" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" tabindex="-1"></a><span class="co">// Create a stacked image with composites from all seasons</span></span>
<span id="cb4-55"><a href="#cb4-55" tabindex="-1"></a><span class="co">// This multi-temporal image is able capture the crop phenology</span></span>
<span id="cb4-56"><a href="#cb4-56" tabindex="-1"></a><span class="co">// Classifier will be able to detect crop-pixels from non-crop pixels</span></span>
<span id="cb4-57"><a href="#cb4-57" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> rabi<span class="op">.</span><span class="fu">addBands</span>(harvest)<span class="op">.</span><span class="fu">addBands</span>(kharif)</span>
<span id="cb4-58"><a href="#cb4-58" tabindex="-1"></a></span>
<span id="cb4-59"><a href="#cb4-59" tabindex="-1"></a><span class="co">// This is a 36-band image</span></span>
<span id="cb4-60"><a href="#cb4-60" tabindex="-1"></a><span class="co">// Use this image for sampling training points for</span></span>
<span id="cb4-61"><a href="#cb4-61" tabindex="-1"></a><span class="co">// to train a crop classifier </span></span>
<span id="cb4-62"><a href="#cb4-62" tabindex="-1"></a><span class="fu">print</span>(composite)</span></code></pre></div>
</div>
<div id="computing-correlation" class="section level2">
<h2>Computing Correlation</h2>
<p>A useful technique to aid crop classification is to model the
correlation between precipitation and changes in vegetation. This allows
the model to capture differentiated responses to rainfall (i.e. raid-fed
crops vs permanent forests). We first prepare an image collection where
each image consists of 2 bands - cumulative rainfall for each month and
average NDVI for the next month. This will create 11 images per year
which show precipitation and 1-month lagged NDVI at each pixels. The
collection is then reduced using the
<code>ee.Reducer.pearsonsCorrelation()</code> which outputs a
<code>correlation</code> band. Positive values will show regions where
precipitation caused an increase in NDVI. Adding this band to your input
image for classification will greatly aid the classifier in separating
different types of vegetation.</p>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FRainfall_NDVI_Correlation"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co">// Calculate Rainfall-NDVI Correlation</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">// We want to know whether there exists a correlation between</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">// rainfall and NDVI</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">// We build a collection containing monthly total rainfall for a year</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co">// and the next month&#39;s average NDVI.</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co">// We then use ee.Reducer.pearsonsCorrelation() to compute pixel-wise</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co">// correlation between rainfall and NDVI response.</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co">// Positive values will indicate vegetation growth in response to</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="co">// precipitation and generally rainfed agriculture.</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">75.71168046831512</span><span class="op">,</span> <span class="fl">13.30751919691132</span>])<span class="op">;</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a><span class="co">// Function to remove cloud and snow pixels from Sentinel-2 SR image</span></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskCloudAndShadowsSR</span>(image) {</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>  <span class="kw">var</span> cloudProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_CLDPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>  <span class="kw">var</span> snowProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_SNWPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>  <span class="kw">var</span> cloud <span class="op">=</span> cloudProb<span class="op">.</span><span class="fu">lt</span>(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>  <span class="kw">var</span> snow <span class="op">=</span> snowProb<span class="op">.</span><span class="fu">lt</span>(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>  <span class="kw">var</span> scl <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SCL&#39;</span>)<span class="op">;</span> </span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a>  <span class="kw">var</span> shadow <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>)<span class="op">;</span> <span class="co">// 3 = cloud shadow</span></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>  <span class="kw">var</span> cirrus <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">10</span>)<span class="op">;</span> <span class="co">// 10 = cirrus</span></span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>  <span class="co">// Cloud probability less than 5% or cloud shadow classification</span></span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> cloud<span class="op">.</span><span class="fu">and</span>(cirrus<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">.</span><span class="fu">and</span>(shadow<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a>}</span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a><span class="co">// Write a function that computes NDVI for an image and adds it as a band</span></span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addNDVI</span>(image) {</span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a>}</span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a><span class="kw">var</span> s2Filtered <span class="op">=</span> s2</span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2020-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2021-01-01&#39;</span>))</span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskCloudAndShadowsSR)</span>
<span id="cb5-49"><a href="#cb5-49" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(addNDVI)</span>
<span id="cb5-50"><a href="#cb5-50" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> s2Filtered<span class="op">.</span><span class="fu">median</span>()</span>
<span id="cb5-53"><a href="#cb5-53" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Composite&#39;</span>)  </span>
<span id="cb5-54"><a href="#cb5-54" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" tabindex="-1"></a></span>
<span id="cb5-56"><a href="#cb5-56" tabindex="-1"></a><span class="co">// Rainfall</span></span>
<span id="cb5-57"><a href="#cb5-57" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;UCSB-CHG/CHIRPS/PENTAD&quot;</span>)<span class="op">;</span></span>
<span id="cb5-58"><a href="#cb5-58" tabindex="-1"></a><span class="kw">var</span> chirpsFiltered <span class="op">=</span> chirps</span>
<span id="cb5-59"><a href="#cb5-59" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2020-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2021-01-01&#39;</span>))</span>
<span id="cb5-60"><a href="#cb5-60" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" tabindex="-1"></a></span>
<span id="cb5-62"><a href="#cb5-62" tabindex="-1"></a><span class="co">// Create a collection of monthly images</span></span>
<span id="cb5-63"><a href="#cb5-63" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">11</span>)</span>
<span id="cb5-64"><a href="#cb5-64" tabindex="-1"></a></span>
<span id="cb5-65"><a href="#cb5-65" tabindex="-1"></a><span class="kw">var</span> byMonth <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb5-66"><a href="#cb5-66" tabindex="-1"></a>    <span class="co">// Total monthly rainfall</span></span>
<span id="cb5-67"><a href="#cb5-67" tabindex="-1"></a>    <span class="kw">var</span> monthlyRain <span class="op">=</span> chirpsFiltered</span>
<span id="cb5-68"><a href="#cb5-68" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb5-69"><a href="#cb5-69" tabindex="-1"></a>    <span class="kw">var</span> totalRain <span class="op">=</span> monthlyRain<span class="op">.</span><span class="fu">sum</span>()</span>
<span id="cb5-70"><a href="#cb5-70" tabindex="-1"></a>    <span class="co">// Next month&#39;s average NDVI</span></span>
<span id="cb5-71"><a href="#cb5-71" tabindex="-1"></a>    <span class="kw">var</span> nextMonth <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(month)<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)</span>
<span id="cb5-72"><a href="#cb5-72" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> s2Filtered</span>
<span id="cb5-73"><a href="#cb5-73" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(nextMonth<span class="op">,</span> nextMonth<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb5-74"><a href="#cb5-74" tabindex="-1"></a>    <span class="kw">var</span> medianComposite <span class="op">=</span> monthly<span class="op">.</span><span class="fu">median</span>()</span>
<span id="cb5-75"><a href="#cb5-75" tabindex="-1"></a>  </span>
<span id="cb5-76"><a href="#cb5-76" tabindex="-1"></a>    <span class="cf">return</span> totalRain<span class="op">.</span><span class="fu">addBands</span>(medianComposite)<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month})</span>
<span id="cb5-77"><a href="#cb5-77" tabindex="-1"></a>})</span>
<span id="cb5-78"><a href="#cb5-78" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(byMonth)<span class="op">;</span></span>
<span id="cb5-79"><a href="#cb5-79" tabindex="-1"></a></span>
<span id="cb5-80"><a href="#cb5-80" tabindex="-1"></a><span class="co">// Display Composites</span></span>
<span id="cb5-81"><a href="#cb5-81" tabindex="-1"></a><span class="kw">var</span> julImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> <span class="dv">7</span>))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb5-82"><a href="#cb5-82" tabindex="-1"></a><span class="kw">var</span> augImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> <span class="dv">8</span>))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb5-83"><a href="#cb5-83" tabindex="-1"></a><span class="kw">var</span> sepImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> <span class="dv">9</span>))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb5-84"><a href="#cb5-84" tabindex="-1"></a></span>
<span id="cb5-85"><a href="#cb5-85" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(julImage<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;July&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb5-86"><a href="#cb5-86" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(augImage<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;August&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb5-87"><a href="#cb5-87" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(sepImage<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;September&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb5-88"><a href="#cb5-88" tabindex="-1"></a></span>
<span id="cb5-89"><a href="#cb5-89" tabindex="-1"></a></span>
<span id="cb5-90"><a href="#cb5-90" tabindex="-1"></a><span class="kw">var</span> correlationCol <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;precipitation&#39;</span><span class="op">,</span> <span class="st">&#39;ndvi&#39;</span>])</span>
<span id="cb5-91"><a href="#cb5-91" tabindex="-1"></a></span>
<span id="cb5-92"><a href="#cb5-92" tabindex="-1"></a><span class="kw">var</span> correlation <span class="op">=</span> correlationCol<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">pearsonsCorrelation</span>())<span class="op">;</span></span>
<span id="cb5-93"><a href="#cb5-93" tabindex="-1"></a></span>
<span id="cb5-94"><a href="#cb5-94" tabindex="-1"></a><span class="kw">var</span> positive <span class="op">=</span> correlation<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;correlation&#39;</span>)<span class="op">.</span><span class="fu">gt</span>(<span class="fl">0.5</span>)</span>
<span id="cb5-95"><a href="#cb5-95" tabindex="-1"></a></span>
<span id="cb5-96"><a href="#cb5-96" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(correlation<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;correlation&#39;</span>)<span class="op">,</span> </span>
<span id="cb5-97"><a href="#cb5-97" tabindex="-1"></a>  {<span class="dt">min</span><span class="op">:-</span><span class="dv">1</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Correlation&#39;</span>)<span class="op">;</span></span>
<span id="cb5-98"><a href="#cb5-98" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(positive<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> </span>
<span id="cb5-99"><a href="#cb5-99" tabindex="-1"></a>  {<span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;yellow&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Positive Correlation&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>   </span></code></pre></div>
</div>
<div id="calculating-band-correlation-matrix" class="section level2">
<h2>Calculating Band Correlation Matrix</h2>
<p>When selecting features for your machine learning model, it is
important to have features which are not correlated with each other.
Correlated features makes it difficult for machine learning models to
discover the interactions between different features. A commonly used
technique to aid in removing redundant variables is to create a
Correlation Matrix. In Earth Engine, you can take a multi-band image and
calculate pair-wise correlation between the bands using either
<code>ee.Reducer.pearsonsCorrelation()</code> or
<code>ee.Reducer.spearmansCorrelation()</code>. The correlation matrix
helps you identify variables that are redundant and can be removed. The
code below also shows how to export the table of features that can be
used in other software to compute correlation.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/correlation_matrix.png" alt="Correlation Matrix created in Python using data exported from GEE" width="80%" />
<p class="caption">
Correlation Matrix created in Python using data exported from GEE
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FCorrelation_Matrix"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">// Calculate Pair-wise Correlation Between Bands of an Image</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">// We take a multi-band composite image created in the previous sections</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_multiband_composite&#39;</span>)<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;WWF/HydroSHEDS/v1/Basins/hybas_7&#39;</span>)<span class="op">;</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="co">// This image has 18 bands and we want to compute correlation between them.</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="co">// Get the band names</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="co">// These bands will be the input variables to the model</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="kw">var</span> bands <span class="op">=</span> composite<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="fu">print</span>(bands)<span class="op">;</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a><span class="co">// Generate random points to sample from the image</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a><span class="kw">var</span> numPoints <span class="op">=</span> <span class="dv">5000</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a><span class="kw">var</span> samples <span class="op">=</span> composite<span class="op">.</span><span class="fu">sample</span>({ </span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> </span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>  <span class="dt">numPixels</span><span class="op">:</span> numPoints<span class="op">,</span></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a><span class="fu">print</span>(samples<span class="op">.</span><span class="fu">first</span>())<span class="op">;</span></span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a><span class="co">// Calculate pairwise-correlation between each pair of bands</span></span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a><span class="co">// Use ee.Reducer.pearsonsCorrelation() for Pearson&#39;s Correlation</span></span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a><span class="co">// Use ee.Reducer.spearmansCorrelation() for Spearman&#39;s Correlation</span></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a><span class="kw">var</span> pairwiseCorr <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(bands<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(i){</span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>  <span class="cf">return</span> bands<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(j){</span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a>    <span class="kw">var</span> stats <span class="op">=</span> samples<span class="op">.</span><span class="fu">reduceColumns</span>({</span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a>      <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">pearsonsCorrelation</span>()<span class="op">,</span></span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a>      <span class="dt">selectors</span><span class="op">:</span> [i<span class="op">,</span>j]</span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a>    <span class="kw">var</span> bandNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">String</span>(i)<span class="op">.</span><span class="fu">cat</span>(<span class="st">&#39;_&#39;</span>)<span class="op">.</span><span class="fu">cat</span>(j)<span class="op">;</span></span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">&#39;correlation&#39;</span><span class="op">:</span> stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;correlation&#39;</span>)<span class="op">,</span> <span class="st">&#39;band&#39;</span><span class="op">:</span> bandNames})<span class="op">;</span>  </span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>())<span class="op">;</span></span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a><span class="co">// Export the table as a CSV file</span></span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> pairwiseCorr<span class="op">,</span></span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Pairwise_Correlation&#39;</span><span class="op">,</span></span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;pairwise_correlation&#39;</span><span class="op">,</span></span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;CSV&#39;</span><span class="op">,</span></span>
<span id="cb6-51"><a href="#cb6-51" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb6-52"><a href="#cb6-52" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" tabindex="-1"></a><span class="co">// You can also export the sampled points and calculate correlation</span></span>
<span id="cb6-54"><a href="#cb6-54" tabindex="-1"></a><span class="co">// in Python or R. Reference Python implementation is at</span></span>
<span id="cb6-55"><a href="#cb6-55" tabindex="-1"></a><span class="co">// https://courses.spatialthoughts.com/python-dataviz.html#feature-correlation-matrix</span></span>
<span id="cb6-56"><a href="#cb6-56" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb6-57"><a href="#cb6-57" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> samples<span class="op">,</span></span>
<span id="cb6-58"><a href="#cb6-58" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Feature_Sample_Data&#39;</span><span class="op">,</span></span>
<span id="cb6-59"><a href="#cb6-59" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb6-60"><a href="#cb6-60" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;feature_sample_data&#39;</span><span class="op">,</span></span>
<span id="cb6-61"><a href="#cb6-61" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;CSV&#39;</span><span class="op">,</span></span>
<span id="cb6-62"><a href="#cb6-62" tabindex="-1"></a>  <span class="dt">selectors</span><span class="op">:</span> bands<span class="op">.</span><span class="fu">getInfo</span>()</span>
<span id="cb6-63"><a href="#cb6-63" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</div>
<div id="calculating-area-by-class" class="section level2">
<h2>Calculating Area by Class</h2>
<p>This code snippet shows how to use a <a
href="https://developers.google.com/earth-engine/guides/reducers_grouping">Grouped
Reducer</a> to calculate area covered by each class in a classified
image. It also shows how to use the
<code>ui.Chart.feature.byProperty()</code> function to create a column
chart and the <code>ui.Chart.feature.byFeature()</code> function to
create a pie chart with areas of each class.</p>
<p><img src="images/end_to_end_gee/area_by_class_bar.png" width="50%" style="display: block; margin: auto;" /></p>
<p><img src="images/end_to_end_gee/area_by_class_pie.png" width="50%" style="display: block; margin: auto;" /></p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FCalculating_Area_by_Class"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;users/ujavalgandhi/e2e/bangalore_classified&quot;</span>)<span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="kw">var</span> bangalore <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/public/bangalore_boundary&quot;</span>)<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> bangalore<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co">// We can calculate the areas of all classes in a single pass</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="co">// using a Grouped Reducer. Learn more at </span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="co">// https://spatialthoughts.com/2020/06/19/calculating-area-gee/</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="co">// First create a 2 band image with the area image and the classified image</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="co">// Divide the area image by 1e6 so area results are in Sq Km</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="kw">var</span> areaImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>()<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e6</span>)<span class="op">.</span><span class="fu">addBands</span>(classified)<span class="op">;</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a><span class="co">// Calculate areas</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="kw">var</span> areas <span class="op">=</span> areaImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>      <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">.</span><span class="fu">group</span>({</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>      <span class="dt">groupField</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>      <span class="dt">groupName</span><span class="op">:</span> <span class="st">&#39;classification&#39;</span><span class="op">,</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a>    })<span class="op">;</span> </span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a> </span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a><span class="kw">var</span> classAreas <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(areas<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;groups&#39;</span>))</span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a><span class="co">// Process results to extract the areas and</span></span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a><span class="co">// create a FeatureCollection</span></span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a><span class="co">// We can define a dictionary with class names</span></span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a><span class="kw">var</span> classNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>({</span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a>  <span class="st">&#39;0&#39;</span><span class="op">:</span> <span class="st">&#39;urban&#39;</span><span class="op">,</span></span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a>  <span class="st">&#39;1&#39;</span><span class="op">:</span> <span class="st">&#39;bare&#39;</span><span class="op">,</span></span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a>  <span class="st">&#39;2&#39;</span><span class="op">:</span> <span class="st">&#39;water&#39;</span><span class="op">,</span></span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a>  <span class="st">&#39;3&#39;</span><span class="op">:</span> <span class="st">&#39;vegetation&#39;</span></span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a>})</span>
<span id="cb7-39"><a href="#cb7-39" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" tabindex="-1"></a><span class="kw">var</span> classAreas <span class="op">=</span> classAreas<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(item) {</span>
<span id="cb7-41"><a href="#cb7-41" tabindex="-1"></a>  <span class="kw">var</span> areaDict <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(item)</span>
<span id="cb7-42"><a href="#cb7-42" tabindex="-1"></a>  <span class="kw">var</span> classNumber <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(areaDict<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;classification&#39;</span>))<span class="op">.</span><span class="fu">format</span>()<span class="op">;</span></span>
<span id="cb7-43"><a href="#cb7-43" tabindex="-1"></a>  <span class="kw">var</span> className <span class="op">=</span> classNames<span class="op">.</span><span class="fu">get</span>(classNumber)<span class="op">;</span></span>
<span id="cb7-44"><a href="#cb7-44" tabindex="-1"></a>  <span class="kw">var</span> area <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(</span>
<span id="cb7-45"><a href="#cb7-45" tabindex="-1"></a>    areaDict<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;sum&#39;</span>))</span>
<span id="cb7-46"><a href="#cb7-46" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">&#39;class&#39;</span><span class="op">:</span> classNumber<span class="op">,</span> <span class="st">&#39;class_name&#39;</span><span class="op">:</span> className<span class="op">,</span> <span class="st">&#39;area&#39;</span><span class="op">:</span> area})</span>
<span id="cb7-47"><a href="#cb7-47" tabindex="-1"></a>})</span>
<span id="cb7-48"><a href="#cb7-48" tabindex="-1"></a></span>
<span id="cb7-49"><a href="#cb7-49" tabindex="-1"></a><span class="kw">var</span> classAreaFc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(classAreas)<span class="op">;</span></span>
<span id="cb7-50"><a href="#cb7-50" tabindex="-1"></a></span>
<span id="cb7-51"><a href="#cb7-51" tabindex="-1"></a><span class="co">// We can now chart the resulting FeatureCollection</span></span>
<span id="cb7-52"><a href="#cb7-52" tabindex="-1"></a><span class="co">// If your area is large, it is advisable to first Export</span></span>
<span id="cb7-53"><a href="#cb7-53" tabindex="-1"></a><span class="co">// the FeatureCollection as an Asset and import it once</span></span>
<span id="cb7-54"><a href="#cb7-54" tabindex="-1"></a><span class="co">// the export is finished.</span></span>
<span id="cb7-55"><a href="#cb7-55" tabindex="-1"></a><span class="co">// Let&#39;s create a Bar Chart</span></span>
<span id="cb7-56"><a href="#cb7-56" tabindex="-1"></a><span class="kw">var</span> areaChart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byProperty</span>({</span>
<span id="cb7-57"><a href="#cb7-57" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> classAreaFc<span class="op">,</span></span>
<span id="cb7-58"><a href="#cb7-58" tabindex="-1"></a>  <span class="dt">xProperties</span><span class="op">:</span> [<span class="st">&#39;area&#39;</span>]<span class="op">,</span></span>
<span id="cb7-59"><a href="#cb7-59" tabindex="-1"></a>  <span class="dt">seriesProperty</span><span class="op">:</span> <span class="st">&#39;class_name&#39;</span><span class="op">,</span></span>
<span id="cb7-60"><a href="#cb7-60" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setChartType</span>(<span class="st">&#39;ColumnChart&#39;</span>)</span>
<span id="cb7-61"><a href="#cb7-61" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb7-62"><a href="#cb7-62" tabindex="-1"></a>    <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Classes&#39;</span>}<span class="op">,</span></span>
<span id="cb7-63"><a href="#cb7-63" tabindex="-1"></a>    <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Area Km^2&#39;</span>}<span class="op">,</span></span>
<span id="cb7-64"><a href="#cb7-64" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Area by class&#39;</span><span class="op">,</span></span>
<span id="cb7-65"><a href="#cb7-65" tabindex="-1"></a>    <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb7-66"><a href="#cb7-66" tabindex="-1"></a>      <span class="dv">0</span><span class="op">:</span> { <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#cc6d8f&#39;</span> }<span class="op">,</span></span>
<span id="cb7-67"><a href="#cb7-67" tabindex="-1"></a>      <span class="dv">1</span><span class="op">:</span> { <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#ffc107&#39;</span> }<span class="op">,</span></span>
<span id="cb7-68"><a href="#cb7-68" tabindex="-1"></a>      <span class="dv">2</span><span class="op">:</span> { <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#1e88e5&#39;</span> }<span class="op">,</span></span>
<span id="cb7-69"><a href="#cb7-69" tabindex="-1"></a>      <span class="dv">3</span><span class="op">:</span> { <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#004d40&#39;</span> }</span>
<span id="cb7-70"><a href="#cb7-70" tabindex="-1"></a>    }</span>
<span id="cb7-71"><a href="#cb7-71" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb7-72"><a href="#cb7-72" tabindex="-1"></a><span class="fu">print</span>(areaChart)<span class="op">;</span> </span>
<span id="cb7-73"><a href="#cb7-73" tabindex="-1"></a></span>
<span id="cb7-74"><a href="#cb7-74" tabindex="-1"></a><span class="co">// We can also create a Pie-Chart</span></span>
<span id="cb7-75"><a href="#cb7-75" tabindex="-1"></a><span class="kw">var</span> areaChart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byFeature</span>({</span>
<span id="cb7-76"><a href="#cb7-76" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> classAreaFc<span class="op">,</span></span>
<span id="cb7-77"><a href="#cb7-77" tabindex="-1"></a>  <span class="dt">xProperty</span><span class="op">:</span> <span class="st">&#39;class_name&#39;</span><span class="op">,</span></span>
<span id="cb7-78"><a href="#cb7-78" tabindex="-1"></a>  <span class="dt">yProperties</span><span class="op">:</span> [<span class="st">&#39;area&#39;</span>]</span>
<span id="cb7-79"><a href="#cb7-79" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setChartType</span>(<span class="st">&#39;PieChart&#39;</span>)</span>
<span id="cb7-80"><a href="#cb7-80" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb7-81"><a href="#cb7-81" tabindex="-1"></a>    <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Classes&#39;</span>}<span class="op">,</span></span>
<span id="cb7-82"><a href="#cb7-82" tabindex="-1"></a>    <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Area Km^2&#39;</span>}<span class="op">,</span></span>
<span id="cb7-83"><a href="#cb7-83" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Area by class&#39;</span><span class="op">,</span></span>
<span id="cb7-84"><a href="#cb7-84" tabindex="-1"></a>    <span class="dt">colors</span><span class="op">:</span> palette</span>
<span id="cb7-85"><a href="#cb7-85" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb7-86"><a href="#cb7-86" tabindex="-1"></a><span class="fu">print</span>(areaChart)<span class="op">;</span> </span></code></pre></div>
</div>
<div id="spectral-signature-plots" class="section level2">
<h2>Spectral Signature Plots</h2>
<p>For supervised classification, it is useful to visualize average
spectral responses for each band for each class. Such charts are called
<em>Spectral Response Curves</em> or <em>Spectral Signatures</em>. Such
charts helps determine separability of classes. If classes have very
different signatures, a classifier will be able to separate them
well.</p>
<p>We can also plot spectral signatures of all training samples for a
class and check the quality of the training dataset. If all training
samples show similar signatures - it indicates that you have done a good
job of collecting appropriate samples. You can also catch potential
outliers from these plots.</p>
<p>These charts provide a qualitative and visual methods for checking
separability of classes. For quantitative methods, one can apply
measures such as Spectral Distance, Mahalanobis distance, Bhattacharyya
distance , Jeffreys-Matusita (JM) distance etc. You can find the code
for these in <a href="https://gis.stackexchange.com/a/323778/5160">this
Stack Exchange answer</a>.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/mean_signatures.png" alt="Mean Signatures for All Classes" width="100%" />
<p class="caption">
Mean Signatures for All Classes
</p>
</div>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/spectral_signatures.png" alt="Spectral Signatures for All Training Points by Class" width="100%" />
<p class="caption">
Spectral Signatures for All Training Points by Class
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FSpectral_Signatures"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">var</span> gcps <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/bangalore_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;users/ujavalgandhi/e2e/bangalore_composite&#39;</span>)<span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co">// Overlay the point on the image to get bands data.</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> gcps<span class="op">,</span> </span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span> </span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="co">// We will create a chart of spectral signature for all classes</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a><span class="co">// We have multiple GCPs for each class</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="co">// Use a grouped reducer to calculate the average reflectance</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a><span class="co">// for each band for each class</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a><span class="co">// We have 12 bands so need to repeat the reducer 12 times</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a><span class="co">// We also need to group the results by class</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a><span class="co">// So we find the index of the landcover property and use it</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a><span class="co">// to group the results</span></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a><span class="kw">var</span> bands <span class="op">=</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a><span class="kw">var</span> numBands <span class="op">=</span> bands<span class="op">.</span><span class="fu">length</span>()</span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a><span class="kw">var</span> bandsWithClass <span class="op">=</span> bands<span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;landcover&#39;</span>)</span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a><span class="kw">var</span> classIndex <span class="op">=</span> bandsWithClass<span class="op">.</span><span class="fu">indexOf</span>(<span class="st">&#39;landcover&#39;</span>)</span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a><span class="co">// Use .combine() to get a reducer capable of </span></span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a><span class="co">// computing multiple stats on the input</span></span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a><span class="kw">var</span> combinedReducer <span class="op">=</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">combine</span>({</span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a>  <span class="dt">reducer2</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">stdDev</span>()<span class="op">,</span></span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a>  <span class="dt">sharedInputs</span><span class="op">:</span> <span class="kw">true</span>})</span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a><span class="co">// Use .repeat() to get a reducer for each band</span></span>
<span id="cb8-34"><a href="#cb8-34" tabindex="-1"></a><span class="co">// We then use .group() to get stats by class</span></span>
<span id="cb8-35"><a href="#cb8-35" tabindex="-1"></a><span class="kw">var</span> repeatedReducer <span class="op">=</span> combinedReducer<span class="op">.</span><span class="fu">repeat</span>(numBands)<span class="op">.</span><span class="fu">group</span>(classIndex)</span>
<span id="cb8-36"><a href="#cb8-36" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" tabindex="-1"></a><span class="kw">var</span> gcpStats <span class="op">=</span> training<span class="op">.</span><span class="fu">reduceColumns</span>({</span>
<span id="cb8-38"><a href="#cb8-38" tabindex="-1"></a>    <span class="dt">selectors</span><span class="op">:</span> bands<span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;landcover&#39;</span>)<span class="op">,</span></span>
<span id="cb8-39"><a href="#cb8-39" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> repeatedReducer<span class="op">,</span></span>
<span id="cb8-40"><a href="#cb8-40" tabindex="-1"></a>})</span>
<span id="cb8-41"><a href="#cb8-41" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" tabindex="-1"></a><span class="co">// Result is a dictionary, we do some post-processing to</span></span>
<span id="cb8-43"><a href="#cb8-43" tabindex="-1"></a><span class="co">// extract the results</span></span>
<span id="cb8-44"><a href="#cb8-44" tabindex="-1"></a><span class="kw">var</span> groups <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(gcpStats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;groups&#39;</span>))</span>
<span id="cb8-45"><a href="#cb8-45" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" tabindex="-1"></a><span class="kw">var</span> classNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([<span class="st">&#39;urban&#39;</span><span class="op">,</span> <span class="st">&#39;bare&#39;</span><span class="op">,</span> <span class="st">&#39;water&#39;</span><span class="op">,</span> <span class="st">&#39;vegetation&#39;</span>])</span>
<span id="cb8-47"><a href="#cb8-47" tabindex="-1"></a></span>
<span id="cb8-48"><a href="#cb8-48" tabindex="-1"></a><span class="kw">var</span> fc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(groups<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(item) {</span>
<span id="cb8-49"><a href="#cb8-49" tabindex="-1"></a>  <span class="co">// Extract the means</span></span>
<span id="cb8-50"><a href="#cb8-50" tabindex="-1"></a>  <span class="kw">var</span> values <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(item)<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;mean&#39;</span>)</span>
<span id="cb8-51"><a href="#cb8-51" tabindex="-1"></a>  <span class="kw">var</span> groupNumber <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(item)<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;group&#39;</span>)</span>
<span id="cb8-52"><a href="#cb8-52" tabindex="-1"></a>  <span class="kw">var</span> properties <span class="op">=</span> ee<span class="op">.</span><span class="at">Dictionary</span><span class="op">.</span><span class="fu">fromLists</span>(bands<span class="op">,</span> values)</span>
<span id="cb8-53"><a href="#cb8-53" tabindex="-1"></a>  <span class="kw">var</span> withClass <span class="op">=</span> properties<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;class&#39;</span><span class="op">,</span> classNames<span class="op">.</span><span class="fu">get</span>(groupNumber))</span>
<span id="cb8-54"><a href="#cb8-54" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> withClass)</span>
<span id="cb8-55"><a href="#cb8-55" tabindex="-1"></a>}))</span>
<span id="cb8-56"><a href="#cb8-56" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" tabindex="-1"></a><span class="co">// Chart spectral signatures of training data</span></span>
<span id="cb8-58"><a href="#cb8-58" tabindex="-1"></a><span class="kw">var</span> options <span class="op">=</span> {</span>
<span id="cb8-59"><a href="#cb8-59" tabindex="-1"></a>  <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Average Spectral Signatures&#39;</span><span class="op">,</span></span>
<span id="cb8-60"><a href="#cb8-60" tabindex="-1"></a>  <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Bands&#39;</span>}<span class="op">,</span></span>
<span id="cb8-61"><a href="#cb8-61" tabindex="-1"></a>  <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Reflectance&#39;</span><span class="op">,</span> </span>
<span id="cb8-62"><a href="#cb8-62" tabindex="-1"></a>    <span class="dt">viewWindowMode</span><span class="op">:</span><span class="st">&#39;explicit&#39;</span><span class="op">,</span></span>
<span id="cb8-63"><a href="#cb8-63" tabindex="-1"></a>    <span class="dt">viewWindow</span><span class="op">:</span> {</span>
<span id="cb8-64"><a href="#cb8-64" tabindex="-1"></a>        <span class="dt">max</span><span class="op">:</span><span class="fl">0.6</span><span class="op">,</span></span>
<span id="cb8-65"><a href="#cb8-65" tabindex="-1"></a>        <span class="dt">min</span><span class="op">:</span><span class="dv">0</span></span>
<span id="cb8-66"><a href="#cb8-66" tabindex="-1"></a>    }}<span class="op">,</span></span>
<span id="cb8-67"><a href="#cb8-67" tabindex="-1"></a>  <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb8-68"><a href="#cb8-68" tabindex="-1"></a>  <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb8-69"><a href="#cb8-69" tabindex="-1"></a>  <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb8-70"><a href="#cb8-70" tabindex="-1"></a>    <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> </span>
<span id="cb8-71"><a href="#cb8-71" tabindex="-1"></a>    <span class="dv">1</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;brown&#39;</span>}<span class="op">,</span> </span>
<span id="cb8-72"><a href="#cb8-72" tabindex="-1"></a>    <span class="dv">2</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span>}<span class="op">,</span> </span>
<span id="cb8-73"><a href="#cb8-73" tabindex="-1"></a>    <span class="dv">3</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;green&#39;</span>}<span class="op">,</span></span>
<span id="cb8-74"><a href="#cb8-74" tabindex="-1"></a>}}<span class="op">;</span></span>
<span id="cb8-75"><a href="#cb8-75" tabindex="-1"></a></span>
<span id="cb8-76"><a href="#cb8-76" tabindex="-1"></a><span class="co">// Default band names don&#39;t sort propertly</span></span>
<span id="cb8-77"><a href="#cb8-77" tabindex="-1"></a><span class="co">// Instead, we can give a dictionary with</span></span>
<span id="cb8-78"><a href="#cb8-78" tabindex="-1"></a><span class="co">// labels for each band in the X-Axis</span></span>
<span id="cb8-79"><a href="#cb8-79" tabindex="-1"></a><span class="kw">var</span> bandDescriptions <span class="op">=</span> {</span>
<span id="cb8-80"><a href="#cb8-80" tabindex="-1"></a>  <span class="st">&#39;B2&#39;</span><span class="op">:</span> <span class="st">&#39;B02/Blue&#39;</span><span class="op">,</span></span>
<span id="cb8-81"><a href="#cb8-81" tabindex="-1"></a>  <span class="st">&#39;B3&#39;</span><span class="op">:</span> <span class="st">&#39;B03/Green&#39;</span><span class="op">,</span></span>
<span id="cb8-82"><a href="#cb8-82" tabindex="-1"></a>  <span class="st">&#39;B4&#39;</span><span class="op">:</span> <span class="st">&#39;B04/Red&#39;</span><span class="op">,</span></span>
<span id="cb8-83"><a href="#cb8-83" tabindex="-1"></a>  <span class="st">&#39;B8&#39;</span><span class="op">:</span> <span class="st">&#39;B08/NIR&#39;</span><span class="op">,</span></span>
<span id="cb8-84"><a href="#cb8-84" tabindex="-1"></a>  <span class="st">&#39;B11&#39;</span><span class="op">:</span> <span class="st">&#39;B11/SWIR-1&#39;</span><span class="op">,</span></span>
<span id="cb8-85"><a href="#cb8-85" tabindex="-1"></a>  <span class="st">&#39;B12&#39;</span><span class="op">:</span> <span class="st">&#39;B12/SWIR-2&#39;</span></span>
<span id="cb8-86"><a href="#cb8-86" tabindex="-1"></a>}</span>
<span id="cb8-87"><a href="#cb8-87" tabindex="-1"></a><span class="co">// Create the chart and set options.</span></span>
<span id="cb8-88"><a href="#cb8-88" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byProperty</span>({</span>
<span id="cb8-89"><a href="#cb8-89" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> fc<span class="op">,</span></span>
<span id="cb8-90"><a href="#cb8-90" tabindex="-1"></a>  <span class="dt">xProperties</span><span class="op">:</span> bandDescriptions<span class="op">,</span></span>
<span id="cb8-91"><a href="#cb8-91" tabindex="-1"></a>  <span class="dt">seriesProperty</span><span class="op">:</span> <span class="st">&#39;class&#39;</span></span>
<span id="cb8-92"><a href="#cb8-92" tabindex="-1"></a>})</span>
<span id="cb8-93"><a href="#cb8-93" tabindex="-1"></a><span class="op">.</span><span class="fu">setChartType</span>(<span class="st">&#39;ScatterChart&#39;</span>)</span>
<span id="cb8-94"><a href="#cb8-94" tabindex="-1"></a><span class="op">.</span><span class="fu">setOptions</span>(options)<span class="op">;</span></span>
<span id="cb8-95"><a href="#cb8-95" tabindex="-1"></a></span>
<span id="cb8-96"><a href="#cb8-96" tabindex="-1"></a><span class="fu">print</span>(chart)</span>
<span id="cb8-97"><a href="#cb8-97" tabindex="-1"></a></span>
<span id="cb8-98"><a href="#cb8-98" tabindex="-1"></a><span class="kw">var</span> classChart <span class="op">=</span> <span class="kw">function</span>(landcover<span class="op">,</span> label<span class="op">,</span> color) {</span>
<span id="cb8-99"><a href="#cb8-99" tabindex="-1"></a>  <span class="kw">var</span> options <span class="op">=</span> {</span>
<span id="cb8-100"><a href="#cb8-100" tabindex="-1"></a>  <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Spectral Signatures for &#39;</span> <span class="op">+</span> label <span class="op">+</span> <span class="st">&#39; Class&#39;</span><span class="op">,</span></span>
<span id="cb8-101"><a href="#cb8-101" tabindex="-1"></a>  <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Bands&#39;</span>}<span class="op">,</span></span>
<span id="cb8-102"><a href="#cb8-102" tabindex="-1"></a>  <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Reflectance&#39;</span><span class="op">,</span> </span>
<span id="cb8-103"><a href="#cb8-103" tabindex="-1"></a>    <span class="dt">viewWindowMode</span><span class="op">:</span><span class="st">&#39;explicit&#39;</span><span class="op">,</span></span>
<span id="cb8-104"><a href="#cb8-104" tabindex="-1"></a>    <span class="dt">viewWindow</span><span class="op">:</span> {</span>
<span id="cb8-105"><a href="#cb8-105" tabindex="-1"></a>        <span class="dt">max</span><span class="op">:</span><span class="fl">0.6</span><span class="op">,</span></span>
<span id="cb8-106"><a href="#cb8-106" tabindex="-1"></a>        <span class="dt">min</span><span class="op">:</span><span class="dv">0</span></span>
<span id="cb8-107"><a href="#cb8-107" tabindex="-1"></a>    }}<span class="op">,</span></span>
<span id="cb8-108"><a href="#cb8-108" tabindex="-1"></a>  <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb8-109"><a href="#cb8-109" tabindex="-1"></a>  <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb8-110"><a href="#cb8-110" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb8-111"><a href="#cb8-111" tabindex="-1"></a></span>
<span id="cb8-112"><a href="#cb8-112" tabindex="-1"></a>  <span class="kw">var</span> fc <span class="op">=</span> training<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> landcover))</span>
<span id="cb8-113"><a href="#cb8-113" tabindex="-1"></a>  <span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byProperty</span>({</span>
<span id="cb8-114"><a href="#cb8-114" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> fc<span class="op">,</span></span>
<span id="cb8-115"><a href="#cb8-115" tabindex="-1"></a>  <span class="dt">xProperties</span><span class="op">:</span> bandDescriptions<span class="op">,</span></span>
<span id="cb8-116"><a href="#cb8-116" tabindex="-1"></a>  })</span>
<span id="cb8-117"><a href="#cb8-117" tabindex="-1"></a><span class="op">.</span><span class="fu">setChartType</span>(<span class="st">&#39;ScatterChart&#39;</span>)</span>
<span id="cb8-118"><a href="#cb8-118" tabindex="-1"></a><span class="op">.</span><span class="fu">setOptions</span>(options)<span class="op">;</span></span>
<span id="cb8-119"><a href="#cb8-119" tabindex="-1"></a></span>
<span id="cb8-120"><a href="#cb8-120" tabindex="-1"></a><span class="fu">print</span>(chart)</span>
<span id="cb8-121"><a href="#cb8-121" tabindex="-1"></a>}</span>
<span id="cb8-122"><a href="#cb8-122" tabindex="-1"></a><span class="fu">classChart</span>(<span class="dv">0</span><span class="op">,</span> <span class="st">&#39;Urban&#39;</span>)</span>
<span id="cb8-123"><a href="#cb8-123" tabindex="-1"></a><span class="fu">classChart</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;Bare&#39;</span>)</span>
<span id="cb8-124"><a href="#cb8-124" tabindex="-1"></a><span class="fu">classChart</span>(<span class="dv">2</span><span class="op">,</span> <span class="st">&#39;Water&#39;</span>)</span>
<span id="cb8-125"><a href="#cb8-125" tabindex="-1"></a><span class="fu">classChart</span>(<span class="dv">3</span><span class="op">,</span> <span class="st">&#39;Vegetation&#39;</span>)</span></code></pre></div>
</div>
<div id="identify-misclassified-gcps" class="section level2">
<h2>Identify Misclassified GCPs</h2>
<p>While doing accuracy assessment, you will see the validation features
that were not classified correctly. It is useful to visually see the
points that were misclassified. We can use <code>ee.Filter.eq()</code>
and <code>ee.Filter.neq()</code> filters to filter the features where
the actual and predicted classes were different. The code below shows
how to implement this and also use the <code>style()</code> function
visualize them effectively.</p>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FIdentify_Misclassified_Data"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co">// Script that shows how to apply filters to identify</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co">// validation points that were misclassified</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(gcp)</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a> </span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(boundary))</span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(boundary) </span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a><span class="co">// Add a random column and split the GCPs into training and validation set</span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()</span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a><span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a><span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a>  <span class="dt">geometries</span><span class="op">:</span><span class="kw">true</span></span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb9-42"><a href="#cb9-42" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb9-43"><a href="#cb9-43" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb9-44"><a href="#cb9-44" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb9-45"><a href="#cb9-45" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb9-46"><a href="#cb9-46" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb9-47"><a href="#cb9-47" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb9-48"><a href="#cb9-48" tabindex="-1"></a></span>
<span id="cb9-49"><a href="#cb9-49" tabindex="-1"></a><span class="co">// Classify the image.</span></span>
<span id="cb9-50"><a href="#cb9-50" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb9-51"><a href="#cb9-51" tabindex="-1"></a></span>
<span id="cb9-52"><a href="#cb9-52" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb9-53"><a href="#cb9-53" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb9-54"><a href="#cb9-54" tabindex="-1"></a></span>
<span id="cb9-55"><a href="#cb9-55" tabindex="-1"></a><span class="kw">var</span> test <span class="op">=</span> classified<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb9-56"><a href="#cb9-56" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb9-57"><a href="#cb9-57" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb9-58"><a href="#cb9-58" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb9-59"><a href="#cb9-59" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb9-60"><a href="#cb9-60" tabindex="-1"></a>  <span class="dt">geometries</span><span class="op">:</span><span class="kw">true</span></span>
<span id="cb9-61"><a href="#cb9-61" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb9-62"><a href="#cb9-62" tabindex="-1"></a></span>
<span id="cb9-63"><a href="#cb9-63" tabindex="-1"></a><span class="kw">var</span> testConfusionMatrix <span class="op">=</span> test<span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb9-64"><a href="#cb9-64" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Confusion Matrix&#39;</span><span class="op">,</span> testConfusionMatrix)<span class="op">;</span></span>
<span id="cb9-65"><a href="#cb9-65" tabindex="-1"></a></span>
<span id="cb9-66"><a href="#cb9-66" tabindex="-1"></a><span class="co">// Let&#39;s apply filters to find misclassified points</span></span>
<span id="cb9-67"><a href="#cb9-67" tabindex="-1"></a><span class="co">// We can find all points which are labeled landcover=0 (urban) </span></span>
<span id="cb9-68"><a href="#cb9-68" tabindex="-1"></a><span class="co">// but were not classified correctly</span></span>
<span id="cb9-69"><a href="#cb9-69" tabindex="-1"></a></span>
<span id="cb9-70"><a href="#cb9-70" tabindex="-1"></a><span class="co">// We use ee.Filter.and() function to create a combined filter</span></span>
<span id="cb9-71"><a href="#cb9-71" tabindex="-1"></a><span class="kw">var</span> combinedFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb9-72"><a href="#cb9-72" tabindex="-1"></a>  ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">,</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">neq</span>(<span class="st">&#39;classification&#39;</span><span class="op">,</span> <span class="dv">0</span>))</span>
<span id="cb9-73"><a href="#cb9-73" tabindex="-1"></a><span class="kw">var</span> urbanMisclassified <span class="op">=</span> test<span class="op">.</span><span class="fu">filter</span>(combinedFilter)</span>
<span id="cb9-74"><a href="#cb9-74" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Urban Misclassified Points&#39;</span><span class="op">,</span> urbanMisclassified)</span>
<span id="cb9-75"><a href="#cb9-75" tabindex="-1"></a></span>
<span id="cb9-76"><a href="#cb9-76" tabindex="-1"></a><span class="co">// We can also apply a filter to select all misclassified points</span></span>
<span id="cb9-77"><a href="#cb9-77" tabindex="-1"></a><span class="co">// Since we are comparing 2 properties agaist each-other,</span></span>
<span id="cb9-78"><a href="#cb9-78" tabindex="-1"></a><span class="co">// we need to use a binary filter</span></span>
<span id="cb9-79"><a href="#cb9-79" tabindex="-1"></a><span class="kw">var</span> misClassified <span class="op">=</span> test<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">notEquals</span>({</span>
<span id="cb9-80"><a href="#cb9-80" tabindex="-1"></a>  <span class="dt">leftField</span><span class="op">:</span><span class="st">&#39;classification&#39;</span><span class="op">,</span> <span class="dt">rightField</span><span class="op">:</span><span class="st">&#39;landcover&#39;</span>}))</span>
<span id="cb9-81"><a href="#cb9-81" tabindex="-1"></a>  </span>
<span id="cb9-82"><a href="#cb9-82" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;All Misclassified Points&#39;</span><span class="op">,</span> misClassified)</span>
<span id="cb9-83"><a href="#cb9-83" tabindex="-1"></a></span>
<span id="cb9-84"><a href="#cb9-84" tabindex="-1"></a><span class="co">// Display the misclassified points by styling them</span></span>
<span id="cb9-85"><a href="#cb9-85" tabindex="-1"></a><span class="kw">var</span> landcover <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])</span>
<span id="cb9-86"><a href="#cb9-86" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([<span class="st">&#39;gray&#39;</span><span class="op">,</span><span class="st">&#39;brown&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span>])</span>
<span id="cb9-87"><a href="#cb9-87" tabindex="-1"></a><span class="kw">var</span> misclassStyled <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(</span>
<span id="cb9-88"><a href="#cb9-88" tabindex="-1"></a>  landcover<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(lc){</span>
<span id="cb9-89"><a href="#cb9-89" tabindex="-1"></a>    <span class="kw">var</span> feature <span class="op">=</span> misClassified<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> lc))</span>
<span id="cb9-90"><a href="#cb9-90" tabindex="-1"></a>    <span class="kw">var</span> color <span class="op">=</span> palette<span class="op">.</span><span class="fu">get</span>(landcover<span class="op">.</span><span class="fu">indexOf</span>(lc))<span class="op">;</span></span>
<span id="cb9-91"><a href="#cb9-91" tabindex="-1"></a>    <span class="kw">var</span> markerStyle <span class="op">=</span> {<span class="dt">color</span><span class="op">:</span>color}</span>
<span id="cb9-92"><a href="#cb9-92" tabindex="-1"></a>    <span class="cf">return</span> feature<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(point){</span>
<span id="cb9-93"><a href="#cb9-93" tabindex="-1"></a>       <span class="cf">return</span> point<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;style&#39;</span><span class="op">,</span> markerStyle)</span>
<span id="cb9-94"><a href="#cb9-94" tabindex="-1"></a>       })</span>
<span id="cb9-95"><a href="#cb9-95" tabindex="-1"></a>    }))<span class="op">.</span><span class="fu">flatten</span>()<span class="op">;</span></span>
<span id="cb9-96"><a href="#cb9-96" tabindex="-1"></a>      </span>
<span id="cb9-97"><a href="#cb9-97" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(misclassStyled<span class="op">.</span><span class="fu">style</span>({<span class="dt">styleProperty</span><span class="op">:</span><span class="st">&quot;style&quot;</span>})<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Misclassified Points&#39;</span>)</span></code></pre></div>
</div>
<div id="image-normalization-and-standardization"
class="section level2">
<h2>Image Normalization and Standardization</h2>
<p>For machine learning, it is a recommended practice to either
normalize or standardize your features. The code below shows how to
implement these feature scaling techniques.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FImage_Normalization_and_Standardization"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_2019_composite&quot;</span>)<span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_boundary&quot;</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> boundary<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co">// Function to Normalize Image</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co">// Pixel Values should be between 0 and 1</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="co">// Formula is (x - xmin) / (xmax - xmin)</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span>(image){</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>  <span class="co">// Compute min and max of the image</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  <span class="kw">var</span> minDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>  <span class="kw">var</span> maxDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>  <span class="kw">var</span> mins <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(minDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>  <span class="kw">var</span> maxs <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(maxDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>  <span class="kw">var</span> normalized <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(mins)<span class="op">.</span><span class="fu">divide</span>(maxs<span class="op">.</span><span class="fu">subtract</span>(mins))</span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a>  <span class="cf">return</span> normalized</span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>}</span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a><span class="co">// Function to Standardize Image</span></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a><span class="co">// (Mean Centered Imagery with Unit Standard Deviation)</span></span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a><span class="co">// https://365datascience.com/tutorials/statistics-tutorials/standardization/</span></span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a><span class="kw">function</span> <span class="fu">standardize</span>(image){</span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a>  <span class="co">// Mean center the data to enable a faster covariance reducer</span></span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a>  <span class="co">// and an SD stretch of the principal components.</span></span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a>  <span class="kw">var</span> meanDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb10-47"><a href="#cb10-47" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb10-48"><a href="#cb10-48" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb10-49"><a href="#cb10-49" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb10-50"><a href="#cb10-50" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb10-51"><a href="#cb10-51" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb10-52"><a href="#cb10-52" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb10-53"><a href="#cb10-53" tabindex="-1"></a>  <span class="kw">var</span> means <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(meanDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb10-54"><a href="#cb10-54" tabindex="-1"></a>  <span class="kw">var</span> centered <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(means)</span>
<span id="cb10-55"><a href="#cb10-55" tabindex="-1"></a>  </span>
<span id="cb10-56"><a href="#cb10-56" tabindex="-1"></a>  <span class="kw">var</span> stdDevDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb10-57"><a href="#cb10-57" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">stdDev</span>()<span class="op">,</span></span>
<span id="cb10-58"><a href="#cb10-58" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb10-59"><a href="#cb10-59" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb10-60"><a href="#cb10-60" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb10-61"><a href="#cb10-61" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb10-62"><a href="#cb10-62" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb10-63"><a href="#cb10-63" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb10-64"><a href="#cb10-64" tabindex="-1"></a>  <span class="kw">var</span> stddevs <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(stdDevDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb10-65"><a href="#cb10-65" tabindex="-1"></a></span>
<span id="cb10-66"><a href="#cb10-66" tabindex="-1"></a>  <span class="kw">var</span> standardized <span class="op">=</span> centered<span class="op">.</span><span class="fu">divide</span>(stddevs)<span class="op">;</span></span>
<span id="cb10-67"><a href="#cb10-67" tabindex="-1"></a>   </span>
<span id="cb10-68"><a href="#cb10-68" tabindex="-1"></a>  <span class="cf">return</span> standardized</span>
<span id="cb10-69"><a href="#cb10-69" tabindex="-1"></a>}</span>
<span id="cb10-70"><a href="#cb10-70" tabindex="-1"></a></span>
<span id="cb10-71"><a href="#cb10-71" tabindex="-1"></a><span class="kw">var</span> standardizedImage <span class="op">=</span> <span class="fu">standardize</span>(image)</span>
<span id="cb10-72"><a href="#cb10-72" tabindex="-1"></a><span class="kw">var</span> normalizedImage <span class="op">=</span> <span class="fu">normalize</span>(image)</span>
<span id="cb10-73"><a href="#cb10-73" tabindex="-1"></a></span>
<span id="cb10-74"><a href="#cb10-74" tabindex="-1"></a></span>
<span id="cb10-75"><a href="#cb10-75" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> </span>
<span id="cb10-76"><a href="#cb10-76" tabindex="-1"></a>  {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">,</span> <span class="st">&#39;Original Image&#39;</span>)<span class="op">;</span></span>
<span id="cb10-77"><a href="#cb10-77" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(normalizedImage<span class="op">,</span></span>
<span id="cb10-78"><a href="#cb10-78" tabindex="-1"></a>  {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">,</span> <span class="st">&#39;Normalized Image&#39;</span>)<span class="op">;</span></span>
<span id="cb10-79"><a href="#cb10-79" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(standardizedImage<span class="op">,</span></span>
<span id="cb10-80"><a href="#cb10-80" tabindex="-1"></a>  {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">,</span> <span class="st">&#39;Standarized Image&#39;</span>)<span class="op">;</span></span>
<span id="cb10-81"><a href="#cb10-81" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb10-82"><a href="#cb10-82" tabindex="-1"></a></span>
<span id="cb10-83"><a href="#cb10-83" tabindex="-1"></a><span class="co">// Verify Normalization</span></span>
<span id="cb10-84"><a href="#cb10-84" tabindex="-1"></a></span>
<span id="cb10-85"><a href="#cb10-85" tabindex="-1"></a><span class="kw">var</span> beforeDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb10-86"><a href="#cb10-86" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">minMax</span>()<span class="op">,</span></span>
<span id="cb10-87"><a href="#cb10-87" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb10-88"><a href="#cb10-88" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb10-89"><a href="#cb10-89" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb10-90"><a href="#cb10-90" tabindex="-1"></a>  <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb10-91"><a href="#cb10-91" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb10-92"><a href="#cb10-92" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb10-93"><a href="#cb10-93" tabindex="-1"></a></span>
<span id="cb10-94"><a href="#cb10-94" tabindex="-1"></a><span class="kw">var</span> afterDict <span class="op">=</span> normalizedImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb10-95"><a href="#cb10-95" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">minMax</span>()<span class="op">,</span></span>
<span id="cb10-96"><a href="#cb10-96" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb10-97"><a href="#cb10-97" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb10-98"><a href="#cb10-98" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb10-99"><a href="#cb10-99" tabindex="-1"></a>  <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb10-100"><a href="#cb10-100" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb10-101"><a href="#cb10-101" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb10-102"><a href="#cb10-102" tabindex="-1"></a></span>
<span id="cb10-103"><a href="#cb10-103" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Original Image Min/Max&#39;</span><span class="op">,</span> beforeDict)</span>
<span id="cb10-104"><a href="#cb10-104" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Normalized Image Min/Max&#39;</span><span class="op">,</span> afterDict)</span>
<span id="cb10-105"><a href="#cb10-105" tabindex="-1"></a></span>
<span id="cb10-106"><a href="#cb10-106" tabindex="-1"></a><span class="co">// Verify Standadization</span></span>
<span id="cb10-107"><a href="#cb10-107" tabindex="-1"></a><span class="co">// Verify that the means are 0 and standard deviations are 1</span></span>
<span id="cb10-108"><a href="#cb10-108" tabindex="-1"></a><span class="kw">var</span> beforeDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb10-109"><a href="#cb10-109" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">combine</span>({</span>
<span id="cb10-110"><a href="#cb10-110" tabindex="-1"></a>      <span class="dt">reducer2</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">stdDev</span>()<span class="op">,</span> <span class="dt">sharedInputs</span><span class="op">:</span> <span class="kw">true</span>})<span class="op">,</span></span>
<span id="cb10-111"><a href="#cb10-111" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb10-112"><a href="#cb10-112" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb10-113"><a href="#cb10-113" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb10-114"><a href="#cb10-114" tabindex="-1"></a>  <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb10-115"><a href="#cb10-115" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb10-116"><a href="#cb10-116" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb10-117"><a href="#cb10-117" tabindex="-1"></a></span>
<span id="cb10-118"><a href="#cb10-118" tabindex="-1"></a><span class="kw">var</span> resultDict <span class="op">=</span> standardizedImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb10-119"><a href="#cb10-119" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">combine</span>({</span>
<span id="cb10-120"><a href="#cb10-120" tabindex="-1"></a>      <span class="dt">reducer2</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">stdDev</span>()<span class="op">,</span> <span class="dt">sharedInputs</span><span class="op">:</span> <span class="kw">true</span>})<span class="op">,</span></span>
<span id="cb10-121"><a href="#cb10-121" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb10-122"><a href="#cb10-122" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb10-123"><a href="#cb10-123" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb10-124"><a href="#cb10-124" tabindex="-1"></a>  <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb10-125"><a href="#cb10-125" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb10-126"><a href="#cb10-126" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb10-127"><a href="#cb10-127" tabindex="-1"></a><span class="co">// Means are very small franctions close to 0</span></span>
<span id="cb10-128"><a href="#cb10-128" tabindex="-1"></a><span class="co">// Round them off to 2 decimals</span></span>
<span id="cb10-129"><a href="#cb10-129" tabindex="-1"></a><span class="kw">var</span> afterDict <span class="op">=</span> resultDict<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(key<span class="op">,</span> value) {</span>
<span id="cb10-130"><a href="#cb10-130" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Number</span>(value)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%.2f&#39;</span>)</span>
<span id="cb10-131"><a href="#cb10-131" tabindex="-1"></a>})</span>
<span id="cb10-132"><a href="#cb10-132" tabindex="-1"></a></span>
<span id="cb10-133"><a href="#cb10-133" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Original Image Mean/StdDev&#39;</span><span class="op">,</span> beforeDict)</span>
<span id="cb10-134"><a href="#cb10-134" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Standadized Image Mean/StdDev&#39;</span><span class="op">,</span> afterDict)</span></code></pre></div>
</div>
<div id="calculate-feature-importance" class="section level2">
<h2>Calculate Feature Importance</h2>
<p>Many classifiers in GEE have a <code>explain()</code> method that
calculates feature importances. The classifier will assign a score to
each input variable on how useful they were at predicting the correct
value. The script below shows how to extract the feature importance and
create a chart to visualize it.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/feature_importance.png" alt="Relative Feature Importance" width="100%" />
<p class="caption">
Relative Feature Importance
</p>
</div>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FFeature_Importance"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="kw">var</span> bangalore <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/public/bangalore_boundary&#39;</span>)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR&#39;</span>)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="kw">var</span> gcps <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/e2e/bangalore_gcps&#39;</span>)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(bangalore))</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(bangalore) </span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="kw">var</span> addIndices <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>  <span class="kw">var</span> ndbi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B11&#39;</span><span class="op">,</span> <span class="st">&#39;B8&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndbi&#39;</span>])<span class="op">;</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>  <span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>  <span class="kw">var</span> bsi <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>      <span class="st">&#39;(( X + Y ) - (A + B)) /(( X + Y ) + (A + B)) &#39;</span><span class="op">,</span> {</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>        <span class="st">&#39;X&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">,</span> <span class="co">//swir1</span></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>        <span class="st">&#39;Y&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B4&#39;</span>)<span class="op">,</span>  <span class="co">//red</span></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>        <span class="st">&#39;A&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">,</span> <span class="co">// nir</span></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>        <span class="st">&#39;B&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B2&#39;</span>)<span class="op">,</span> <span class="co">// blue</span></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;bsi&#39;</span>)<span class="op">;</span></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">.</span><span class="fu">addBands</span>(ndbi)<span class="op">.</span><span class="fu">addBands</span>(mndwi)<span class="op">.</span><span class="fu">addBands</span>(bsi)</span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>}</span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>composite <span class="op">=</span> <span class="fu">addIndices</span>(composite)</span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a></span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> gcps<span class="op">,</span> </span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span> </span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a></span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb11-49"><a href="#cb11-49" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)<span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb11-50"><a href="#cb11-50" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb11-51"><a href="#cb11-51" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span> </span>
<span id="cb11-52"><a href="#cb11-52" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb11-53"><a href="#cb11-53" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb11-54"><a href="#cb11-54" tabindex="-1"></a><span class="co">// // Classify the image.</span></span>
<span id="cb11-55"><a href="#cb11-55" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb11-56"><a href="#cb11-56" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb11-57"><a href="#cb11-57" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb11-58"><a href="#cb11-58" tabindex="-1"></a></span>
<span id="cb11-59"><a href="#cb11-59" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb11-61"><a href="#cb11-61" tabindex="-1"></a><span class="co">// Calculate Feature Importance</span></span>
<span id="cb11-62"><a href="#cb11-62" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb11-63"><a href="#cb11-63" tabindex="-1"></a>    </span>
<span id="cb11-64"><a href="#cb11-64" tabindex="-1"></a><span class="co">// Run .explain() to see what the classifer looks like</span></span>
<span id="cb11-65"><a href="#cb11-65" tabindex="-1"></a><span class="fu">print</span>(classifier<span class="op">.</span><span class="fu">explain</span>())</span>
<span id="cb11-66"><a href="#cb11-66" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" tabindex="-1"></a><span class="co">// Calculate variable importance</span></span>
<span id="cb11-68"><a href="#cb11-68" tabindex="-1"></a><span class="kw">var</span> importance <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(classifier<span class="op">.</span><span class="fu">explain</span>()<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;importance&#39;</span>))</span>
<span id="cb11-69"><a href="#cb11-69" tabindex="-1"></a></span>
<span id="cb11-70"><a href="#cb11-70" tabindex="-1"></a></span>
<span id="cb11-71"><a href="#cb11-71" tabindex="-1"></a><span class="co">// Calculate relative importance</span></span>
<span id="cb11-72"><a href="#cb11-72" tabindex="-1"></a><span class="kw">var</span> sum <span class="op">=</span> importance<span class="op">.</span><span class="fu">values</span>()<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb11-73"><a href="#cb11-73" tabindex="-1"></a></span>
<span id="cb11-74"><a href="#cb11-74" tabindex="-1"></a><span class="kw">var</span> relativeImportance <span class="op">=</span> importance<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(key<span class="op">,</span> val) {</span>
<span id="cb11-75"><a href="#cb11-75" tabindex="-1"></a>   <span class="cf">return</span> (ee<span class="op">.</span><span class="fu">Number</span>(val)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">100</span>))<span class="op">.</span><span class="fu">divide</span>(sum)</span>
<span id="cb11-76"><a href="#cb11-76" tabindex="-1"></a>  })</span>
<span id="cb11-77"><a href="#cb11-77" tabindex="-1"></a><span class="fu">print</span>(relativeImportance)</span>
<span id="cb11-78"><a href="#cb11-78" tabindex="-1"></a></span>
<span id="cb11-79"><a href="#cb11-79" tabindex="-1"></a><span class="co">// Create a FeatureCollection so we can chart it</span></span>
<span id="cb11-80"><a href="#cb11-80" tabindex="-1"></a><span class="kw">var</span> importanceFc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>([</span>
<span id="cb11-81"><a href="#cb11-81" tabindex="-1"></a>  ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> relativeImportance)</span>
<span id="cb11-82"><a href="#cb11-82" tabindex="-1"></a>])</span>
<span id="cb11-83"><a href="#cb11-83" tabindex="-1"></a></span>
<span id="cb11-84"><a href="#cb11-84" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byProperty</span>({</span>
<span id="cb11-85"><a href="#cb11-85" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> importanceFc</span>
<span id="cb11-86"><a href="#cb11-86" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb11-87"><a href="#cb11-87" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Feature Importance&#39;</span><span class="op">,</span></span>
<span id="cb11-88"><a href="#cb11-88" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Importance&#39;</span>}<span class="op">,</span></span>
<span id="cb11-89"><a href="#cb11-89" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Feature&#39;</span>}<span class="op">,</span></span>
<span id="cb11-90"><a href="#cb11-90" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">&#39;none&#39;</span>}</span>
<span id="cb11-91"><a href="#cb11-91" tabindex="-1"></a>  })</span>
<span id="cb11-92"><a href="#cb11-92" tabindex="-1"></a><span class="fu">print</span>(chart)</span></code></pre></div>
</div>
<div id="classification-with-migrated-training-samples"
class="section level2">
<h2>Classification with Migrated Training Samples</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FClassification_with_Migrated_Training_Samples"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co">// Script showing how to use migrated training samples</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co">// for multi-year classification</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co">// Training samples are collected on a 2019 Sentinel-2 composite</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="co">// and are used to classify a 2020 Sentinel-2 composite</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="co">// We use spectral distance measure to discard samples that show</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="co">// large change between the target and reference years.</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>    </span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))<span class="op">;</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a><span class="kw">var</span> scaleValues <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])<span class="op">;</span></span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a><span class="co">// Prepare 2019 composite</span></span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(scaleValues)<span class="op">;</span></span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a><span class="kw">var</span> composite2019 <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a><span class="co">// Prepare 2020 Composite</span></span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2020-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2021-01-01&#39;</span>))</span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(scaleValues)<span class="op">;</span></span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" tabindex="-1"></a><span class="kw">var</span> composite2020 <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb12-46"><a href="#cb12-46" tabindex="-1"></a></span>
<span id="cb12-47"><a href="#cb12-47" tabindex="-1"></a><span class="co">// Display the 2020 composite.</span></span>
<span id="cb12-48"><a href="#cb12-48" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite2019<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Composite 2019&#39;</span>)<span class="op">;</span></span>
<span id="cb12-49"><a href="#cb12-49" tabindex="-1"></a><span class="co">// Display the 2021 composite.</span></span>
<span id="cb12-50"><a href="#cb12-50" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite2020<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Composite 2020&#39;</span>)<span class="op">;</span></span>
<span id="cb12-51"><a href="#cb12-51" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" tabindex="-1"></a></span>
<span id="cb12-53"><a href="#cb12-53" tabindex="-1"></a><span class="co">// Compute Spectral Distance between 2019 and 2020 images</span></span>
<span id="cb12-54"><a href="#cb12-54" tabindex="-1"></a><span class="kw">var</span> distance <span class="op">=</span> composite2019<span class="op">.</span><span class="fu">spectralDistance</span>(composite2020<span class="op">,</span> <span class="st">&#39;sam&#39;</span>)<span class="op">;</span></span>
<span id="cb12-55"><a href="#cb12-55" tabindex="-1"></a><span class="co">// GCPs were collected on 2020 image</span></span>
<span id="cb12-56"><a href="#cb12-56" tabindex="-1"></a><span class="co">// Find out which GCPs are still unchanged in 2021</span></span>
<span id="cb12-57"><a href="#cb12-57" tabindex="-1"></a></span>
<span id="cb12-58"><a href="#cb12-58" tabindex="-1"></a><span class="co">// Get the distance at the training points</span></span>
<span id="cb12-59"><a href="#cb12-59" tabindex="-1"></a><span class="kw">var</span> gcpWithDistance <span class="op">=</span> distance<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb12-60"><a href="#cb12-60" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> gcp<span class="op">,</span></span>
<span id="cb12-61"><a href="#cb12-61" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb12-62"><a href="#cb12-62" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb12-63"><a href="#cb12-63" tabindex="-1"></a>  <span class="dt">geometries</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb12-64"><a href="#cb12-64" tabindex="-1"></a>})</span>
<span id="cb12-65"><a href="#cb12-65" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(gcpWithDistance<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span>}<span class="op">,</span> <span class="st">&#39;GCPs with Distance&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb12-66"><a href="#cb12-66" tabindex="-1"></a></span>
<span id="cb12-67"><a href="#cb12-67" tabindex="-1"></a><span class="co">// Adjust the threshold to discard GCPs are changed locations</span></span>
<span id="cb12-68"><a href="#cb12-68" tabindex="-1"></a><span class="co">// Threshold is determined manually</span></span>
<span id="cb12-69"><a href="#cb12-69" tabindex="-1"></a><span class="kw">var</span> threshold <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb12-70"><a href="#cb12-70" tabindex="-1"></a><span class="kw">var</span> newGcp <span class="op">=</span> gcpWithDistance<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;distance&#39;</span><span class="op">,</span> threshold))<span class="op">;</span></span>
<span id="cb12-71"><a href="#cb12-71" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(newGcp<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span>}<span class="op">,</span> <span class="st">&#39;Filtered GCPs&#39;</span>)<span class="op">;</span></span>
<span id="cb12-72"><a href="#cb12-72" tabindex="-1"></a></span>
<span id="cb12-73"><a href="#cb12-73" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Total GCPs&#39;</span><span class="op">,</span> gcp<span class="op">.</span><span class="fu">size</span>())<span class="op">;</span></span>
<span id="cb12-74"><a href="#cb12-74" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Migrated GCPs&#39;</span><span class="op">,</span> newGcp<span class="op">.</span><span class="fu">size</span>())<span class="op">;</span></span>
<span id="cb12-75"><a href="#cb12-75" tabindex="-1"></a><span class="co">// We wrap the classification workflow in a function</span></span>
<span id="cb12-76"><a href="#cb12-76" tabindex="-1"></a><span class="co">// and call the function with the different composites and GCPs</span></span>
<span id="cb12-77"><a href="#cb12-77" tabindex="-1"></a><span class="fu">performClassification</span>(composite2019<span class="op">,</span> gcp<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb12-78"><a href="#cb12-78" tabindex="-1"></a><span class="fu">performClassification</span>(composite2020<span class="op">,</span> newGcp<span class="op">,</span> <span class="st">&#39;2020&#39;</span>)<span class="op">;</span></span>
<span id="cb12-79"><a href="#cb12-79" tabindex="-1"></a></span>
<span id="cb12-80"><a href="#cb12-80" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb12-81"><a href="#cb12-81" tabindex="-1"></a><span class="co">// Classification and Accuracy Assessment</span></span>
<span id="cb12-82"><a href="#cb12-82" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb12-83"><a href="#cb12-83" tabindex="-1"></a><span class="kw">function</span> <span class="fu">performClassification</span>(image<span class="op">,</span> gcp<span class="op">,</span> year) {</span>
<span id="cb12-84"><a href="#cb12-84" tabindex="-1"></a>  <span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()<span class="op">;</span></span>
<span id="cb12-85"><a href="#cb12-85" tabindex="-1"></a>  <span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb12-86"><a href="#cb12-86" tabindex="-1"></a>  <span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb12-87"><a href="#cb12-87" tabindex="-1"></a>  </span>
<span id="cb12-88"><a href="#cb12-88" tabindex="-1"></a>  <span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb12-89"><a href="#cb12-89" tabindex="-1"></a>  <span class="kw">var</span> training <span class="op">=</span> image<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb12-90"><a href="#cb12-90" tabindex="-1"></a>    <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb12-91"><a href="#cb12-91" tabindex="-1"></a>    <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb12-92"><a href="#cb12-92" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb12-93"><a href="#cb12-93" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb12-94"><a href="#cb12-94" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb12-95"><a href="#cb12-95" tabindex="-1"></a>  </span>
<span id="cb12-96"><a href="#cb12-96" tabindex="-1"></a>  <span class="co">// Train a classifier.</span></span>
<span id="cb12-97"><a href="#cb12-97" tabindex="-1"></a>  <span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb12-98"><a href="#cb12-98" tabindex="-1"></a>  <span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb12-99"><a href="#cb12-99" tabindex="-1"></a>    <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb12-100"><a href="#cb12-100" tabindex="-1"></a>    <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb12-101"><a href="#cb12-101" tabindex="-1"></a>    <span class="dt">inputProperties</span><span class="op">:</span> image<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb12-102"><a href="#cb12-102" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb12-103"><a href="#cb12-103" tabindex="-1"></a>  </span>
<span id="cb12-104"><a href="#cb12-104" tabindex="-1"></a>  <span class="co">// Classify the image.</span></span>
<span id="cb12-105"><a href="#cb12-105" tabindex="-1"></a>  <span class="kw">var</span> classified <span class="op">=</span> image<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb12-106"><a href="#cb12-106" tabindex="-1"></a>  </span>
<span id="cb12-107"><a href="#cb12-107" tabindex="-1"></a>  <span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb12-108"><a href="#cb12-108" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> year)<span class="op">;</span></span>
<span id="cb12-109"><a href="#cb12-109" tabindex="-1"></a>  </span>
<span id="cb12-110"><a href="#cb12-110" tabindex="-1"></a>  <span class="co">// Use classification map to assess accuracy using the validation fraction</span></span>
<span id="cb12-111"><a href="#cb12-111" tabindex="-1"></a>  <span class="co">// of the overall training set created above.</span></span>
<span id="cb12-112"><a href="#cb12-112" tabindex="-1"></a>  <span class="kw">var</span> test <span class="op">=</span> classified<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb12-113"><a href="#cb12-113" tabindex="-1"></a>    <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb12-114"><a href="#cb12-114" tabindex="-1"></a>    <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb12-115"><a href="#cb12-115" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb12-116"><a href="#cb12-116" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb12-117"><a href="#cb12-117" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb12-118"><a href="#cb12-118" tabindex="-1"></a>  </span>
<span id="cb12-119"><a href="#cb12-119" tabindex="-1"></a>  <span class="kw">var</span> testConfusionMatrix <span class="op">=</span> test<span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb12-120"><a href="#cb12-120" tabindex="-1"></a>  <span class="co">// Printing of confusion matrix may time out. Alternatively, you can export it as CSV</span></span>
<span id="cb12-121"><a href="#cb12-121" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&#39;Confusion Matrix &#39;</span> <span class="op">+</span> year<span class="op">,</span> testConfusionMatrix)<span class="op">;</span></span>
<span id="cb12-122"><a href="#cb12-122" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&#39;Test Accuracy &#39;</span> <span class="op">+</span> year<span class="op">,</span> testConfusionMatrix<span class="op">.</span><span class="fu">accuracy</span>())<span class="op">;</span></span>
<span id="cb12-123"><a href="#cb12-123" tabindex="-1"></a></span>
<span id="cb12-124"><a href="#cb12-124" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="advanced-change-detection-techniques" class="section level1">
<h1>Advanced Change Detection Techniques</h1>
<div id="landslide-detection-using-dynamic-world"
class="section level2">
<h2>Landslide Detection using Dynamic World</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FChange_Detection%2FDynamic_World_Landslides_Detection"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co">// Landslides Detection using Dynamic World Probability Bands</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="co">// We want to detect landslides occurred in December 2018</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co">// in India&#39;s Kodagu district.</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>  [<span class="fl">75.70357667713435</span><span class="op">,</span> <span class="fl">12.49723970868507</span>]<span class="op">,</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>  [<span class="fl">75.70357667713435</span><span class="op">,</span> <span class="fl">12.470171844429931</span>]<span class="op">,</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  [<span class="fl">75.7528434923199</span><span class="op">,</span> <span class="fl">12.470171844429931</span>]<span class="op">,</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>  [<span class="fl">75.7528434923199</span><span class="op">,</span> <span class="fl">12.49723970868507</span>]</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="kw">var</span> dateOfIncident <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">&#39;2018-12-15&#39;</span>)<span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)</span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a><span class="co">// Write a function for Cloud masking</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskS2clouds</span>(image) {</span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)</span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>             qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))</span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="co">//.divide(10000)</span></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(<span class="st">&quot;B.*&quot;</span>)</span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&quot;system:time_start&quot;</span>])</span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a>} </span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb13-31"><a href="#cb13-31" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb13-32"><a href="#cb13-32" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)</span>
<span id="cb13-33"><a href="#cb13-33" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb13-34"><a href="#cb13-34" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" tabindex="-1"></a><span class="kw">var</span> beforeS2 <span class="op">=</span> filtered</span>
<span id="cb13-36"><a href="#cb13-36" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(dateOfIncident<span class="op">.</span><span class="fu">advance</span>(<span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">,</span> dateOfIncident))</span>
<span id="cb13-37"><a href="#cb13-37" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(<span class="dv">12</span><span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb13-38"><a href="#cb13-38" tabindex="-1"></a>  <span class="op">.</span><span class="fu">median</span>()</span>
<span id="cb13-39"><a href="#cb13-39" tabindex="-1"></a></span>
<span id="cb13-40"><a href="#cb13-40" tabindex="-1"></a><span class="kw">var</span> afterS2 <span class="op">=</span> filtered</span>
<span id="cb13-41"><a href="#cb13-41" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(dateOfIncident<span class="op">,</span> dateOfIncident<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>)))<span class="op">.</span><span class="fu">median</span>()</span>
<span id="cb13-42"><a href="#cb13-42" tabindex="-1"></a></span>
<span id="cb13-43"><a href="#cb13-43" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span>}<span class="op">;</span></span>
<span id="cb13-44"><a href="#cb13-44" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeS2<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Before&#39;</span>)</span>
<span id="cb13-45"><a href="#cb13-45" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterS2<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;After&#39;</span>)</span>
<span id="cb13-46"><a href="#cb13-46" tabindex="-1"></a></span>
<span id="cb13-47"><a href="#cb13-47" tabindex="-1"></a><span class="co">// Load the Dynamic World collection</span></span>
<span id="cb13-48"><a href="#cb13-48" tabindex="-1"></a><span class="kw">var</span> dw <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/DYNAMICWORLD/V1&#39;</span>)</span>
<span id="cb13-49"><a href="#cb13-49" tabindex="-1"></a></span>
<span id="cb13-50"><a href="#cb13-50" tabindex="-1"></a><span class="kw">var</span> beforeDW <span class="op">=</span> dw</span>
<span id="cb13-51"><a href="#cb13-51" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(dateOfIncident<span class="op">.</span><span class="fu">advance</span>(<span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">,</span> dateOfIncident))</span>
<span id="cb13-52"><a href="#cb13-52" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(<span class="dv">12</span><span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb13-53"><a href="#cb13-53" tabindex="-1"></a>  <span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb13-54"><a href="#cb13-54" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;bare&#39;</span>)<span class="op">;</span></span>
<span id="cb13-55"><a href="#cb13-55" tabindex="-1"></a></span>
<span id="cb13-56"><a href="#cb13-56" tabindex="-1"></a><span class="kw">var</span> afterDW <span class="op">=</span> dw</span>
<span id="cb13-57"><a href="#cb13-57" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(dateOfIncident<span class="op">,</span> dateOfIncident<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>)))</span>
<span id="cb13-58"><a href="#cb13-58" tabindex="-1"></a>  <span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb13-59"><a href="#cb13-59" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;bare&#39;</span>)<span class="op">;</span></span>
<span id="cb13-60"><a href="#cb13-60" tabindex="-1"></a></span>
<span id="cb13-61"><a href="#cb13-61" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeDW<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Before Probabilities&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb13-62"><a href="#cb13-62" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterDW<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;After Probabilities&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb13-63"><a href="#cb13-63" tabindex="-1"></a></span>
<span id="cb13-64"><a href="#cb13-64" tabindex="-1"></a><span class="co">// Change in &#39;bare&#39; class &gt; 0.1</span></span>
<span id="cb13-65"><a href="#cb13-65" tabindex="-1"></a><span class="kw">var</span> change <span class="op">=</span> afterDW<span class="op">.</span><span class="fu">subtract</span>(beforeDW)<span class="op">.</span><span class="fu">gt</span>(<span class="fl">0.1</span>)</span>
<span id="cb13-66"><a href="#cb13-66" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(change<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;red&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Change&#39;</span>)</span></code></pre></div>
</div>
<div id="urban-growth-detection-using-dynamic-world"
class="section level2">
<h2>Urban Growth Detection using Dynamic World</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FChange_Detection%2FDynamic_World_Urban_Growth"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co">// Urban Growth Change Detection using Dynamic World Probability Bands</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>  [<span class="fl">77.43062052556523</span><span class="op">,</span> <span class="fl">13.103764122826366</span>]<span class="op">,</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  [<span class="fl">77.43062052556523</span><span class="op">,</span> <span class="fl">12.821384160047845</span>]<span class="op">,</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>  [<span class="fl">77.7588370782996</span><span class="op">,</span> <span class="fl">12.821384160047845</span>]<span class="op">,</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  [<span class="fl">77.7588370782996</span><span class="op">,</span> <span class="fl">13.103764122826366</span>]</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="co">// Detect newly urbanized regions from the year 2019 to 2020.</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="kw">var</span> beforeYear <span class="op">=</span> <span class="dv">2019</span><span class="op">;</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="kw">var</span> afterYear <span class="op">=</span> <span class="dv">2020</span><span class="op">;</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a><span class="co">// Create start and end dates for the before and after periods.</span></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(beforeYear<span class="op">,</span> <span class="dv">1</span> <span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> beforeStart<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(afterYear<span class="op">,</span> <span class="dv">1</span> <span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> afterStart<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a><span class="co">// Add Sentinel-2 Composites to verify the results.</span></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)</span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>     <span class="op">.</span><span class="fu">filterBounds</span>(geometry)</span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>     <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">35</span>))<span class="op">;</span></span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a><span class="co">// Create a median composite from sentinel-2 images.</span></span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a><span class="kw">var</span> beforeS2 <span class="op">=</span> s2<span class="op">.</span><span class="fu">filterDate</span>(beforeStart<span class="op">,</span> beforeEnd)<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a><span class="kw">var</span> afterS2 <span class="op">=</span> s2<span class="op">.</span><span class="fu">filterDate</span>(afterStart<span class="op">,</span> afterEnd)<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a>  </span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a><span class="kw">var</span> s2VisParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span>}<span class="op">;</span></span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeS2<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> s2VisParams<span class="op">,</span> <span class="st">&#39;Before S2&#39;</span>)<span class="op">;</span></span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterS2<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> s2VisParams<span class="op">,</span> <span class="st">&#39;After S2&#39;</span>)<span class="op">;</span></span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a><span class="co">// Load the Dynamic World collection</span></span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a><span class="kw">var</span> dw <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/DYNAMICWORLD/V1&#39;</span>)</span>
<span id="cb14-38"><a href="#cb14-38" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" tabindex="-1"></a><span class="co">// Filter the collection and select the &#39;built&#39; band.</span></span>
<span id="cb14-40"><a href="#cb14-40" tabindex="-1"></a><span class="kw">var</span> dwFiltered <span class="op">=</span> dw</span>
<span id="cb14-41"><a href="#cb14-41" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb14-42"><a href="#cb14-42" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;built&#39;</span>)<span class="op">;</span></span>
<span id="cb14-43"><a href="#cb14-43" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" tabindex="-1"></a><span class="co">// Create a mean composite indicating the average probability through the year.</span></span>
<span id="cb14-45"><a href="#cb14-45" tabindex="-1"></a><span class="kw">var</span> beforeDw <span class="op">=</span> dwFiltered<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))<span class="op">.</span><span class="fu">mean</span>()<span class="op">;</span></span>
<span id="cb14-46"><a href="#cb14-46" tabindex="-1"></a>  </span>
<span id="cb14-47"><a href="#cb14-47" tabindex="-1"></a><span class="kw">var</span> afterDw <span class="op">=</span> dwFiltered<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))<span class="op">.</span><span class="fu">mean</span>()<span class="op">;</span></span>
<span id="cb14-48"><a href="#cb14-48" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" tabindex="-1"></a><span class="co">// Select all pixels that are</span></span>
<span id="cb14-50"><a href="#cb14-50" tabindex="-1"></a><span class="co">// &lt; 0.2 &#39;built&#39; probability before</span></span>
<span id="cb14-51"><a href="#cb14-51" tabindex="-1"></a><span class="co">// &gt; 0.5 &#39;built&#39; probability after</span></span>
<span id="cb14-52"><a href="#cb14-52" tabindex="-1"></a><span class="kw">var</span> newUrban <span class="op">=</span> beforeDw<span class="op">.</span><span class="fu">lt</span>(<span class="fl">0.2</span>)<span class="op">.</span><span class="fu">and</span>(afterDw<span class="op">.</span><span class="fu">gt</span>(<span class="fl">0.5</span>))<span class="op">;</span></span>
<span id="cb14-53"><a href="#cb14-53" tabindex="-1"></a></span>
<span id="cb14-54"><a href="#cb14-54" tabindex="-1"></a><span class="kw">var</span> changeVisParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;red&#39;</span>]}<span class="op">;</span></span>
<span id="cb14-55"><a href="#cb14-55" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(newUrban<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> changeVisParams<span class="op">,</span> <span class="st">&#39;New Urban&#39;</span>)<span class="op">;</span></span>
<span id="cb14-56"><a href="#cb14-56" tabindex="-1"></a></span>
<span id="cb14-57"><a href="#cb14-57" tabindex="-1"></a><span class="co">// Mask non-change pixels from the binary newUrban image </span></span>
<span id="cb14-58"><a href="#cb14-58" tabindex="-1"></a><span class="co">// using the selfMask function and add it to the map.</span></span>
<span id="cb14-59"><a href="#cb14-59" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(</span>
<span id="cb14-60"><a href="#cb14-60" tabindex="-1"></a>  newUrban<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> changeVisParams<span class="op">,</span> <span class="st">&#39;New Urban (Masked)&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
<div id="conflict-mapping" class="section level2">
<h2>Conflict Mapping</h2>
<p>During the <a
href="https://en.wikipedia.org/wiki/2021_Israel%E2%80%93Palestine_crisis">Israel-Palestine
Crisis of 2021</a>, Gaza was bombed heavily during May 2021. We are able
to monitor and detect bombed sites using Sentinel-2 images captured
before and after the bombing. Jamon Van Den Hoek put together a <a
href="https://jamonvdh.users.earthengine.app/view/gaza-bomb-damage-analysis">Google
Earth Engine App</a> with his analysis of the bombing. The script below
is an adaptation with open-source code showing how to carry out such
mapping using change detection techniques.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FChange_Detection%2FGaza_Conflict_Change_Detection_Index"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co">// Gaza bomb damage analysis</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="co">// Adapted from https://jamonvdh.users.earthengine.app/view/gaza-bomb-damage-analysis</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="co">// Original app by: Jamon Van Den Hoek</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co">// Adapted code by: Ujaval Gandhi </span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="kw">var</span> gaul <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL/2015/level0&quot;</span>)<span class="op">;</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="kw">var</span> gaza <span class="op">=</span> gaul<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM0_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Gaza Strip&#39;</span>))</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> gaza<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">34.45</span><span class="op">,</span> <span class="fl">31.5</span><span class="op">,</span> <span class="dv">14</span>)</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskS2clouds</span>(image) {</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)<span class="op">;</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>  <span class="co">// Bits 10 and 11 are clouds and cirrus, respectively.</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>  <span class="co">// Both flags should be set to zero, indicating clear conditions.</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)</span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>      <span class="op">.</span><span class="fu">and</span>(qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])<span class="op">;</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a>}</span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2&quot;</span>)</span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)<span class="op">;</span></span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a><span class="kw">var</span> beforeDate  <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">&#39;2021-05-10&#39;</span>)</span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a><span class="kw">var</span> afterDate <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">&#39;2021-05-15&#39;</span>)</span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeDate<span class="op">,</span> beforeDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;day&#39;</span>)))</span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a><span class="kw">var</span> beforeComposite <span class="op">=</span> before<span class="op">.</span><span class="fu">median</span>()</span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterDate<span class="op">,</span> afterDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;day&#39;</span>)))</span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a></span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a><span class="kw">var</span> afterComposite <span class="op">=</span> after<span class="op">.</span><span class="fu">median</span>()</span>
<span id="cb15-39"><a href="#cb15-39" tabindex="-1"></a></span>
<span id="cb15-40"><a href="#cb15-40" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb15-41"><a href="#cb15-41" tabindex="-1"></a><span class="kw">var</span> nrgVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span>]}<span class="op">;</span></span>
<span id="cb15-42"><a href="#cb15-42" tabindex="-1"></a></span>
<span id="cb15-43"><a href="#cb15-43" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeComposite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Before&#39;</span>)</span>
<span id="cb15-44"><a href="#cb15-44" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterComposite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.4</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">,</span> <span class="st">&#39;After&#39;</span>)</span>
<span id="cb15-45"><a href="#cb15-45" tabindex="-1"></a></span>
<span id="cb15-46"><a href="#cb15-46" tabindex="-1"></a><span class="kw">var</span> addIndices <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb15-47"><a href="#cb15-47" tabindex="-1"></a>  <span class="kw">var</span> nbr <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B12&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;nbr&#39;</span>])<span class="op">;</span></span>
<span id="cb15-48"><a href="#cb15-48" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])</span>
<span id="cb15-49"><a href="#cb15-49" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(nbr)<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb15-50"><a href="#cb15-50" tabindex="-1"></a>}</span>
<span id="cb15-51"><a href="#cb15-51" tabindex="-1"></a></span>
<span id="cb15-52"><a href="#cb15-52" tabindex="-1"></a><span class="co">// You can try change detection with either NBR or NDVI</span></span>
<span id="cb15-53"><a href="#cb15-53" tabindex="-1"></a><span class="kw">var</span> selectedIndex <span class="op">=</span> <span class="st">&#39;nbr&#39;</span><span class="op">;</span></span>
<span id="cb15-54"><a href="#cb15-54" tabindex="-1"></a><span class="kw">var</span> beforeNbr <span class="op">=</span> <span class="fu">addIndices</span>(beforeComposite)<span class="op">.</span><span class="fu">select</span>(selectedIndex)<span class="op">;</span></span>
<span id="cb15-55"><a href="#cb15-55" tabindex="-1"></a><span class="kw">var</span> afterNbr <span class="op">=</span> <span class="fu">addIndices</span>(afterComposite)<span class="op">.</span><span class="fu">select</span>(selectedIndex)<span class="op">;</span></span>
<span id="cb15-56"><a href="#cb15-56" tabindex="-1"></a></span>
<span id="cb15-57"><a href="#cb15-57" tabindex="-1"></a><span class="co">// Change in Index</span></span>
<span id="cb15-58"><a href="#cb15-58" tabindex="-1"></a><span class="kw">var</span> difference <span class="op">=</span> beforeNbr<span class="op">.</span><span class="fu">subtract</span>(afterNbr)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb15-59"><a href="#cb15-59" tabindex="-1"></a></span>
<span id="cb15-60"><a href="#cb15-60" tabindex="-1"></a><span class="kw">var</span> indexThreshold <span class="op">=</span> <span class="fl">0.25</span><span class="op">;</span></span>
<span id="cb15-61"><a href="#cb15-61" tabindex="-1"></a><span class="kw">var</span> change <span class="op">=</span> difference<span class="op">.</span><span class="fu">gt</span>(indexThreshold)</span>
<span id="cb15-62"><a href="#cb15-62" tabindex="-1"></a></span>
<span id="cb15-63"><a href="#cb15-63" tabindex="-1"></a><span class="co">// Mask Waterbodies using WorldCover</span></span>
<span id="cb15-64"><a href="#cb15-64" tabindex="-1"></a><span class="kw">var</span> classification <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb15-65"><a href="#cb15-65" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> classification<span class="op">.</span><span class="fu">eq</span>(<span class="dv">80</span>)</span>
<span id="cb15-66"><a href="#cb15-66" tabindex="-1"></a><span class="kw">var</span> change <span class="op">=</span> change<span class="op">.</span><span class="fu">updateMask</span>(water<span class="op">.</span><span class="fu">not</span>())</span>
<span id="cb15-67"><a href="#cb15-67" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(change<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;orange&#39;</span>]} <span class="op">,</span> <span class="st">&#39;Detected Change&#39;</span>)</span>
<span id="cb15-68"><a href="#cb15-68" tabindex="-1"></a></span>
<span id="cb15-69"><a href="#cb15-69" tabindex="-1"></a><span class="kw">var</span> minArea <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb15-70"><a href="#cb15-70" tabindex="-1"></a><span class="kw">var</span> maxArea <span class="op">=</span> <span class="dv">50000</span></span>
<span id="cb15-71"><a href="#cb15-71" tabindex="-1"></a><span class="co">// S2 resolution is 10m</span></span>
<span id="cb15-72"><a href="#cb15-72" tabindex="-1"></a><span class="kw">var</span> minPixels <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(minArea)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">100</span>)</span>
<span id="cb15-73"><a href="#cb15-73" tabindex="-1"></a><span class="kw">var</span> maxPixels <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(maxArea)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">100</span>)</span>
<span id="cb15-74"><a href="#cb15-74" tabindex="-1"></a></span>
<span id="cb15-75"><a href="#cb15-75" tabindex="-1"></a><span class="kw">var</span> change <span class="op">=</span> change</span>
<span id="cb15-76"><a href="#cb15-76" tabindex="-1"></a><span class="kw">var</span> connections <span class="op">=</span> change<span class="op">.</span><span class="fu">connectedPixelCount</span>(maxPixels<span class="op">.</span><span class="fu">add</span>(<span class="dv">10</span>))</span>
<span id="cb15-77"><a href="#cb15-77" tabindex="-1"></a></span>
<span id="cb15-78"><a href="#cb15-78" tabindex="-1"></a><span class="kw">var</span> masked <span class="op">=</span> change</span>
<span id="cb15-79"><a href="#cb15-79" tabindex="-1"></a>  <span class="op">.</span><span class="fu">updateMask</span>(connections<span class="op">.</span><span class="fu">gt</span>(minPixels)<span class="op">.</span><span class="fu">and</span>(connections<span class="op">.</span><span class="fu">lte</span>(maxPixels)))</span>
<span id="cb15-80"><a href="#cb15-80" tabindex="-1"></a></span>
<span id="cb15-81"><a href="#cb15-81" tabindex="-1"></a><span class="kw">var</span> vectors <span class="op">=</span> masked<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">.</span><span class="fu">reduceToVectors</span>({</span>
<span id="cb15-82"><a href="#cb15-82" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb15-83"><a href="#cb15-83" tabindex="-1"></a>  <span class="dt">eightConnected</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb15-84"><a href="#cb15-84" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span>})</span>
<span id="cb15-85"><a href="#cb15-85" tabindex="-1"></a></span>
<span id="cb15-86"><a href="#cb15-86" tabindex="-1"></a><span class="co">// Paint all the polygon edges with the same number and width, display.</span></span>
<span id="cb15-87"><a href="#cb15-87" tabindex="-1"></a><span class="kw">var</span> colored <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>()<span class="op">.</span><span class="fu">byte</span>()<span class="op">.</span><span class="fu">paint</span>({</span>
<span id="cb15-88"><a href="#cb15-88" tabindex="-1"></a>  <span class="dt">featureCollection</span><span class="op">:</span> vectors<span class="op">,</span></span>
<span id="cb15-89"><a href="#cb15-89" tabindex="-1"></a>  <span class="dt">color</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb15-90"><a href="#cb15-90" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb15-91"><a href="#cb15-91" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(colored<span class="op">,</span> {<span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;red&#39;</span>]} <span class="op">,</span> <span class="st">&#39;Detected Change (Filtered)&#39;</span>)</span>
<span id="cb15-92"><a href="#cb15-92" tabindex="-1"></a></span>
<span id="cb15-93"><a href="#cb15-93" tabindex="-1"></a><span class="kw">var</span> centroids <span class="op">=</span> vectors<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(f) {</span>
<span id="cb15-94"><a href="#cb15-94" tabindex="-1"></a>  <span class="cf">return</span> f<span class="op">.</span><span class="fu">centroid</span>({<span class="dt">maxError</span><span class="op">:</span><span class="dv">1</span>})</span>
<span id="cb15-95"><a href="#cb15-95" tabindex="-1"></a>})</span>
<span id="cb15-96"><a href="#cb15-96" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(centroids<span class="op">,</span> {<span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;cyan&#39;</span>} <span class="op">,</span> <span class="st">&#39;Detected Site Centroids&#39;</span>)</span>
<span id="cb15-97"><a href="#cb15-97" tabindex="-1"></a></span>
<span id="cb15-98"><a href="#cb15-98" tabindex="-1"></a></span>
<span id="cb15-99"><a href="#cb15-99" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb15-100"><a href="#cb15-100" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> centroids<span class="op">,</span></span>
<span id="cb15-101"><a href="#cb15-101" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Detected_Site_Centroids&#39;</span><span class="op">,</span></span>
<span id="cb15-102"><a href="#cb15-102" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb15-103"><a href="#cb15-103" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;change_sites&#39;</span><span class="op">,</span></span>
<span id="cb15-104"><a href="#cb15-104" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;SHP&#39;</span>})</span></code></pre></div>
</div>
</div>
<div id="image-collection-processing" class="section level1">
<h1>Image Collection Processing</h1>
<div id="aggregating-and-visualizing-imagecollections"
class="section level2">
<h2>Aggregating and Visualizing ImageCollections</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FAggregating_and_Visualizing_ImageCollections"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co">// Script showing techniques for visualizing image collections</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="co">// using UI elements and animation.</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2&quot;</span>)<span class="op">;</span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a><span class="co">// Write a function for Cloud masking</span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a><span class="kw">var</span> maskS2clouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)</span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>             qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))</span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="co">//.divide(10000)</span></span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(<span class="st">&quot;B.*&quot;</span>)</span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&quot;system:time_start&quot;</span>])</span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a>}</span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a><span class="co">// Write a function to scale the bands</span></span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a><span class="kw">var</span> scaleImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a>  <span class="cf">return</span> image</span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a>    <span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)</span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a>    <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&quot;system:time_start&quot;</span>])</span>
<span id="cb16-34"><a href="#cb16-34" tabindex="-1"></a>}</span>
<span id="cb16-35"><a href="#cb16-35" tabindex="-1"></a></span>
<span id="cb16-36"><a href="#cb16-36" tabindex="-1"></a><span class="kw">var</span> processedCol <span class="op">=</span> filtered</span>
<span id="cb16-37"><a href="#cb16-37" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)</span>
<span id="cb16-38"><a href="#cb16-38" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(scaleImage)</span>
<span id="cb16-39"><a href="#cb16-39" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" tabindex="-1"></a><span class="co">// Aggregate it to yearly composites</span></span>
<span id="cb16-41"><a href="#cb16-41" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">2017</span><span class="op">,</span> <span class="dv">2021</span>)<span class="op">;</span></span>
<span id="cb16-42"><a href="#cb16-42" tabindex="-1"></a></span>
<span id="cb16-43"><a href="#cb16-43" tabindex="-1"></a><span class="co">// Write a function to create yearly composites</span></span>
<span id="cb16-44"><a href="#cb16-44" tabindex="-1"></a><span class="kw">var</span> createYearlyComposite <span class="op">=</span> <span class="kw">function</span>(year) {</span>
<span id="cb16-45"><a href="#cb16-45" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb16-46"><a href="#cb16-46" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb16-47"><a href="#cb16-47" tabindex="-1"></a>  <span class="kw">var</span> yearImages <span class="op">=</span> processedCol<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb16-48"><a href="#cb16-48" tabindex="-1"></a>      ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))<span class="op">;</span></span>
<span id="cb16-49"><a href="#cb16-49" tabindex="-1"></a>  <span class="kw">var</span> yearComposite <span class="op">=</span> yearImages<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb16-50"><a href="#cb16-50" tabindex="-1"></a>  <span class="cf">return</span> yearComposite<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb16-51"><a href="#cb16-51" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb16-52"><a href="#cb16-52" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb16-53"><a href="#cb16-53" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Number</span>(year)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%04d&#39;</span>)})</span>
<span id="cb16-54"><a href="#cb16-54" tabindex="-1"></a>}</span>
<span id="cb16-55"><a href="#cb16-55" tabindex="-1"></a></span>
<span id="cb16-56"><a href="#cb16-56" tabindex="-1"></a><span class="co">// map() the function to create composite for all years</span></span>
<span id="cb16-57"><a href="#cb16-57" tabindex="-1"></a><span class="kw">var</span> yearComposites <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(createYearlyComposite)</span>
<span id="cb16-58"><a href="#cb16-58" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" tabindex="-1"></a><span class="co">// Create an ImageCollection from yearly composites</span></span>
<span id="cb16-60"><a href="#cb16-60" tabindex="-1"></a><span class="kw">var</span> yearlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(yearComposites)</span>
<span id="cb16-61"><a href="#cb16-61" tabindex="-1"></a><span class="fu">print</span>(yearlyCol)<span class="op">;</span></span>
<span id="cb16-62"><a href="#cb16-62" tabindex="-1"></a></span>
<span id="cb16-63"><a href="#cb16-63" tabindex="-1"></a><span class="co">// Visualize the collection</span></span>
<span id="cb16-64"><a href="#cb16-64" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb16-65"><a href="#cb16-65" tabindex="-1"></a></span>
<span id="cb16-66"><a href="#cb16-66" tabindex="-1"></a><span class="co">// A simple way to visualize is to use ui.Select()</span></span>
<span id="cb16-67"><a href="#cb16-67" tabindex="-1"></a><span class="co">// Our collection has a unique &#39;year&#39; property</span></span>
<span id="cb16-68"><a href="#cb16-68" tabindex="-1"></a><span class="co">// Use that to create a dropdown</span></span>
<span id="cb16-69"><a href="#cb16-69" tabindex="-1"></a></span>
<span id="cb16-70"><a href="#cb16-70" tabindex="-1"></a><span class="co">// Display the image with the given year.</span></span>
<span id="cb16-71"><a href="#cb16-71" tabindex="-1"></a><span class="kw">var</span> display <span class="op">=</span> <span class="kw">function</span>(year) {</span>
<span id="cb16-72"><a href="#cb16-72" tabindex="-1"></a>  <span class="kw">var</span> filtered <span class="op">=</span> yearlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> year))</span>
<span id="cb16-73"><a href="#cb16-73" tabindex="-1"></a>  <span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())<span class="op">;</span></span>
<span id="cb16-74"><a href="#cb16-74" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;RGB_Composite_&#39;</span> <span class="op">+</span> year)</span>
<span id="cb16-75"><a href="#cb16-75" tabindex="-1"></a>}</span>
<span id="cb16-76"><a href="#cb16-76" tabindex="-1"></a></span>
<span id="cb16-77"><a href="#cb16-77" tabindex="-1"></a><span class="co">// Get the list of IDs and put them into a select</span></span>
<span id="cb16-78"><a href="#cb16-78" tabindex="-1"></a>yearlyCol<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;year&#39;</span>)<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(years) {</span>
<span id="cb16-79"><a href="#cb16-79" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb16-80"><a href="#cb16-80" tabindex="-1"></a>    <span class="dt">placeholder</span><span class="op">:</span> <span class="st">&#39;Select a year&#39;</span><span class="op">,</span></span>
<span id="cb16-81"><a href="#cb16-81" tabindex="-1"></a>    <span class="dt">items</span><span class="op">:</span> years<span class="op">,</span></span>
<span id="cb16-82"><a href="#cb16-82" tabindex="-1"></a>    <span class="dt">onChange</span><span class="op">:</span> display</span>
<span id="cb16-83"><a href="#cb16-83" tabindex="-1"></a>  }))</span>
<span id="cb16-84"><a href="#cb16-84" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb16-85"><a href="#cb16-85" tabindex="-1"></a></span>
<span id="cb16-86"><a href="#cb16-86" tabindex="-1"></a><span class="co">// Another way is to create an animation</span></span>
<span id="cb16-87"><a href="#cb16-87" tabindex="-1"></a></span>
<span id="cb16-88"><a href="#cb16-88" tabindex="-1"></a><span class="co">// Define a function to convert an image to an RGB visualization</span></span>
<span id="cb16-89"><a href="#cb16-89" tabindex="-1"></a><span class="co">// Clip the image and copy the system:time_start property</span></span>
<span id="cb16-90"><a href="#cb16-90" tabindex="-1"></a><span class="kw">var</span> visualizeImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb16-91"><a href="#cb16-91" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">visualize</span>(rgbVis)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb16-92"><a href="#cb16-92" tabindex="-1"></a>    <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span></span>
<span id="cb16-93"><a href="#cb16-93" tabindex="-1"></a>      [<span class="st">&#39;system:time_start&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_end&#39;</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>])</span>
<span id="cb16-94"><a href="#cb16-94" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb16-95"><a href="#cb16-95" tabindex="-1"></a></span>
<span id="cb16-96"><a href="#cb16-96" tabindex="-1"></a><span class="kw">var</span> visCol <span class="op">=</span> yearlyCol<span class="op">.</span><span class="fu">map</span>(visualizeImage)</span>
<span id="cb16-97"><a href="#cb16-97" tabindex="-1"></a></span>
<span id="cb16-98"><a href="#cb16-98" tabindex="-1"></a><span class="co">// Define arguments for animation function parameters.</span></span>
<span id="cb16-99"><a href="#cb16-99" tabindex="-1"></a><span class="kw">var</span> videoArgs <span class="op">=</span> {</span>
<span id="cb16-100"><a href="#cb16-100" tabindex="-1"></a>  <span class="dt">dimensions</span><span class="op">:</span> <span class="dv">768</span><span class="op">,</span></span>
<span id="cb16-101"><a href="#cb16-101" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb16-102"><a href="#cb16-102" tabindex="-1"></a>  <span class="dt">framesPerSecond</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb16-103"><a href="#cb16-103" tabindex="-1"></a>  <span class="dt">crs</span><span class="op">:</span> <span class="st">&#39;EPSG:3857&#39;</span><span class="op">,</span></span>
<span id="cb16-104"><a href="#cb16-104" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb16-105"><a href="#cb16-105" tabindex="-1"></a><span class="fu">print</span>(ui<span class="op">.</span><span class="fu">Thumbnail</span>(visCol<span class="op">,</span> videoArgs))<span class="op">;</span></span></code></pre></div>
</div>
<div id="exporting-imagecollections" class="section level2">
<h2>Exporting ImageCollections</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FExporting_ImageCollections"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co">// Example script showing how to export ImageCollections</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="co">// This script exports a NDVI time-series as separate</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="co">// GeoTiff files</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2&quot;</span>)<span class="op">;</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>  [<span class="fl">82.60642647743225</span><span class="op">,</span> <span class="fl">27.16350437805251</span>]<span class="op">,</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>  [<span class="fl">82.60984897613525</span><span class="op">,</span> <span class="fl">27.1618529901377</span>]<span class="op">,</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>  [<span class="fl">82.61088967323303</span><span class="op">,</span> <span class="fl">27.163695288375266</span>]<span class="op">,</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>  [<span class="fl">82.60757446289062</span><span class="op">,</span> <span class="fl">27.16517483230927</span>]</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span>}<span class="op">,</span> <span class="st">&#39;Farm&#39;</span>)</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2017-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2018-01-01&#39;</span>))</span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a><span class="co">// Write a function for Cloud masking</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskS2clouds</span>(image) {</span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)</span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a>             qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))</span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="co">//.divide(10000)</span></span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(<span class="st">&quot;B.*&quot;</span>)</span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&quot;system:time_start&quot;</span>])</span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a>}</span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskS2clouds)</span>
<span id="cb17-34"><a href="#cb17-34" tabindex="-1"></a><span class="co">// Write a function that computes NDVI for an image and adds it as a band</span></span>
<span id="cb17-35"><a href="#cb17-35" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addNDVI</span>(image) {</span>
<span id="cb17-36"><a href="#cb17-36" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb17-37"><a href="#cb17-37" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb17-38"><a href="#cb17-38" tabindex="-1"></a>}</span>
<span id="cb17-39"><a href="#cb17-39" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" tabindex="-1"></a><span class="co">// Map the function over the collection</span></span>
<span id="cb17-41"><a href="#cb17-41" tabindex="-1"></a><span class="kw">var</span> withNdvi <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(addNDVI)<span class="op">;</span></span>
<span id="cb17-42"><a href="#cb17-42" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" tabindex="-1"></a><span class="kw">var</span> exportCol <span class="op">=</span> withNdvi<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb17-44"><a href="#cb17-44" tabindex="-1"></a></span>
<span id="cb17-45"><a href="#cb17-45" tabindex="-1"></a><span class="co">// The function below exports the collection</span></span>
<span id="cb17-46"><a href="#cb17-46" tabindex="-1"></a><span class="co">// The key is to use &#39;evaluate()&#39; to asynchronously get a list</span></span>
<span id="cb17-47"><a href="#cb17-47" tabindex="-1"></a><span class="co">// if image ids and start an export task for each image</span></span>
<span id="cb17-48"><a href="#cb17-48" tabindex="-1"></a></span>
<span id="cb17-49"><a href="#cb17-49" tabindex="-1"></a><span class="kw">var</span> doExport <span class="op">=</span> <span class="kw">function</span>() {</span>
<span id="cb17-50"><a href="#cb17-50" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&#39;Working&#39;</span>)</span>
<span id="cb17-51"><a href="#cb17-51" tabindex="-1"></a>  <span class="kw">var</span> ids <span class="op">=</span> exportCol<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;system:index&#39;</span>)<span class="op">;</span></span>
<span id="cb17-52"><a href="#cb17-52" tabindex="-1"></a>  <span class="co">// evaluate() will not block the UI and once the result is available</span></span>
<span id="cb17-53"><a href="#cb17-53" tabindex="-1"></a>  <span class="co">// will be passed-on to the callback function where we will call</span></span>
<span id="cb17-54"><a href="#cb17-54" tabindex="-1"></a>  <span class="co">// Export.image.toDrive()</span></span>
<span id="cb17-55"><a href="#cb17-55" tabindex="-1"></a>  ids<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(imageIds) {</span>
<span id="cb17-56"><a href="#cb17-56" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&#39;Total number of images&#39;</span><span class="op">,</span> imageIds<span class="op">.</span><span class="at">length</span>)</span>
<span id="cb17-57"><a href="#cb17-57" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&#39;Exporting now... (see Tasks tab)&#39;</span>)</span>
<span id="cb17-58"><a href="#cb17-58" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&#39;Tip: Use Ctrl+Click/Cmd+Click on tasks to skip confirmation.&#39;</span>)</span>
<span id="cb17-59"><a href="#cb17-59" tabindex="-1"></a>    <span class="cf">for</span>(<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> imageIds<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb17-60"><a href="#cb17-60" tabindex="-1"></a>      </span>
<span id="cb17-61"><a href="#cb17-61" tabindex="-1"></a>      <span class="co">// Filter using the image id</span></span>
<span id="cb17-62"><a href="#cb17-62" tabindex="-1"></a>      <span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(exportCol<span class="op">.</span><span class="fu">toList</span>(<span class="dv">1</span><span class="op">,</span> i)<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb17-63"><a href="#cb17-63" tabindex="-1"></a></span>
<span id="cb17-64"><a href="#cb17-64" tabindex="-1"></a>      Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb17-65"><a href="#cb17-65" tabindex="-1"></a>        <span class="dt">image</span><span class="op">:</span> image<span class="op">,</span></span>
<span id="cb17-66"><a href="#cb17-66" tabindex="-1"></a>        <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb17-67"><a href="#cb17-67" tabindex="-1"></a>        <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb17-68"><a href="#cb17-68" tabindex="-1"></a>        <span class="dt">fileNamePrefix</span><span class="op">:</span> imageIds[i]<span class="op">,</span></span>
<span id="cb17-69"><a href="#cb17-69" tabindex="-1"></a>        <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb17-70"><a href="#cb17-70" tabindex="-1"></a>        <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Export_&#39;</span> <span class="op">+</span> i <span class="op">+</span> <span class="st">&#39;_&#39;</span> <span class="op">+</span> imageIds[i]<span class="op">,</span></span>
<span id="cb17-71"><a href="#cb17-71" tabindex="-1"></a>      })</span>
<span id="cb17-72"><a href="#cb17-72" tabindex="-1"></a>      }</span>
<span id="cb17-73"><a href="#cb17-73" tabindex="-1"></a>  })</span>
<span id="cb17-74"><a href="#cb17-74" tabindex="-1"></a>  </span>
<span id="cb17-75"><a href="#cb17-75" tabindex="-1"></a>}</span>
<span id="cb17-76"><a href="#cb17-76" tabindex="-1"></a></span>
<span id="cb17-77"><a href="#cb17-77" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Click button below to start export&#39;</span>)</span>
<span id="cb17-78"><a href="#cb17-78" tabindex="-1"></a><span class="kw">var</span> button <span class="op">=</span> ui<span class="op">.</span><span class="fu">Button</span>({<span class="dt">label</span><span class="op">:</span> <span class="st">&#39;Export&#39;</span><span class="op">,</span> <span class="dt">onClick</span><span class="op">:</span> doExport})</span>
<span id="cb17-79"><a href="#cb17-79" tabindex="-1"></a><span class="fu">print</span>(button)</span>
<span id="cb17-80"><a href="#cb17-80" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span></code></pre></div>
</div>
<div id="get-pixelwise-dates-for-composites" class="section level2">
<h2>Get Pixelwise Dates for Composites</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FGet_Pixelwise_Dates_in_Composites"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co">// Example script showing how to determine the date of each pixel</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="co">// in a composite image</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="co">// Select a region</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="kw">var</span> admin1 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;FAO/GAUL_SIMPLIFIED_500m/2015/level1&#39;</span>)<span class="op">;</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="kw">var</span> karnataka <span class="op">=</span> admin1<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))<span class="op">;</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> karnataka<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="co">// Use the Sentinel-2 collection </span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a><span class="co">// Write a function for Cloud masking</span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a><span class="kw">var</span> maskS2clouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a>             qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))</span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)</span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a>}</span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a><span class="co">// Write a function to apply the scaling factor to</span></span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a><span class="co">// each of the bands to get reflectance values</span></span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a><span class="kw">var</span> scaleImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a>  <span class="cf">return</span> image</span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a>    <span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)</span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a>    <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb18-30"><a href="#cb18-30" tabindex="-1"></a>}</span>
<span id="cb18-31"><a href="#cb18-31" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" tabindex="-1"></a><span class="co">// Write a function that computes NDVI for an image and adds it as a band</span></span>
<span id="cb18-34"><a href="#cb18-34" tabindex="-1"></a><span class="co">// We also add negative ndvi so we can find date of lowest NDVI</span></span>
<span id="cb18-35"><a href="#cb18-35" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addNDVI</span>(image) {</span>
<span id="cb18-36"><a href="#cb18-36" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb18-37"><a href="#cb18-37" tabindex="-1"></a>  <span class="kw">var</span> invertNdvi <span class="op">=</span> ndvi<span class="op">.</span><span class="fu">multiply</span>(<span class="op">-</span><span class="dv">1</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;invertndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb18-38"><a href="#cb18-38" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>([ndvi<span class="op">,</span> invertNdvi])<span class="op">;</span></span>
<span id="cb18-39"><a href="#cb18-39" tabindex="-1"></a>}</span>
<span id="cb18-40"><a href="#cb18-40" tabindex="-1"></a><span class="co">// Write a function to add date band</span></span>
<span id="cb18-41"><a href="#cb18-41" tabindex="-1"></a><span class="kw">var</span> addDateBand <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb18-42"><a href="#cb18-42" tabindex="-1"></a>  <span class="co">// Create an image with day of the year as value</span></span>
<span id="cb18-43"><a href="#cb18-43" tabindex="-1"></a>  <span class="kw">var</span> date <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;system:time_start&#39;</span>))<span class="op">;</span></span>
<span id="cb18-44"><a href="#cb18-44" tabindex="-1"></a>  <span class="co">// Create an image where each pixel&#39;s value is the</span></span>
<span id="cb18-45"><a href="#cb18-45" tabindex="-1"></a>  <span class="co">// timestamp of the image date</span></span>
<span id="cb18-46"><a href="#cb18-46" tabindex="-1"></a>  <span class="kw">var</span> dateImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(date<span class="op">.</span><span class="fu">millis</span>())<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;timestamp&#39;</span>])<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb18-47"><a href="#cb18-47" tabindex="-1"></a>  <span class="co">// We can also create an image where each pixel has the value</span></span>
<span id="cb18-48"><a href="#cb18-48" tabindex="-1"></a>  <span class="co">// equivalent to the day of the year of the image date</span></span>
<span id="cb18-49"><a href="#cb18-49" tabindex="-1"></a>  <span class="kw">var</span> doy <span class="op">=</span> date<span class="op">.</span><span class="fu">getRelative</span>(<span class="st">&#39;day&#39;</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb18-50"><a href="#cb18-50" tabindex="-1"></a>  <span class="kw">var</span> doyImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(doy)<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;doy&#39;</span>])<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb18-51"><a href="#cb18-51" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>([dateImage<span class="op">,</span> doyImage])<span class="op">;</span></span>
<span id="cb18-52"><a href="#cb18-52" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb18-53"><a href="#cb18-53" tabindex="-1"></a></span>
<span id="cb18-54"><a href="#cb18-54" tabindex="-1"></a><span class="co">// Filter and pre-process the collection</span></span>
<span id="cb18-55"><a href="#cb18-55" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb18-56"><a href="#cb18-56" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb18-57"><a href="#cb18-57" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb18-58"><a href="#cb18-58" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb18-59"><a href="#cb18-59" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)</span>
<span id="cb18-60"><a href="#cb18-60" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(scaleImage)</span>
<span id="cb18-61"><a href="#cb18-61" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(addNDVI)</span>
<span id="cb18-62"><a href="#cb18-62" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(addDateBand)<span class="op">;</span></span>
<span id="cb18-63"><a href="#cb18-63" tabindex="-1"></a>  </span>
<span id="cb18-64"><a href="#cb18-64" tabindex="-1"></a><span class="co">// Create a composite with highest and lowest NDVI per pixel</span></span>
<span id="cb18-65"><a href="#cb18-65" tabindex="-1"></a><span class="kw">var</span> maxNdvi <span class="op">=</span> filtered<span class="op">.</span><span class="fu">qualityMosaic</span>(<span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb18-66"><a href="#cb18-66" tabindex="-1"></a><span class="kw">var</span> minNdvi <span class="op">=</span> filtered<span class="op">.</span><span class="fu">qualityMosaic</span>(<span class="st">&#39;invertndvi&#39;</span>)</span>
<span id="cb18-67"><a href="#cb18-67" tabindex="-1"></a></span>
<span id="cb18-68"><a href="#cb18-68" tabindex="-1"></a><span class="co">// We select the &#39;doy&#39; band</span></span>
<span id="cb18-69"><a href="#cb18-69" tabindex="-1"></a><span class="co">// The DOY images have a pixel value equivalent to day of the year</span></span>
<span id="cb18-70"><a href="#cb18-70" tabindex="-1"></a><span class="co">// of the image from which the pixel was used.</span></span>
<span id="cb18-71"><a href="#cb18-71" tabindex="-1"></a><span class="kw">var</span> maxDoy <span class="op">=</span> maxNdvi<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;doy&#39;</span>)<span class="op">;</span></span>
<span id="cb18-72"><a href="#cb18-72" tabindex="-1"></a><span class="kw">var</span> minDoy <span class="op">=</span> minNdvi<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;doy&#39;</span>)<span class="op">;</span></span>
<span id="cb18-73"><a href="#cb18-73" tabindex="-1"></a></span>
<span id="cb18-74"><a href="#cb18-74" tabindex="-1"></a><span class="co">//  Visualize the results</span></span>
<span id="cb18-75"><a href="#cb18-75" tabindex="-1"></a></span>
<span id="cb18-76"><a href="#cb18-76" tabindex="-1"></a><span class="co">// First add the collection so we can validate the results</span></span>
<span id="cb18-77"><a href="#cb18-77" tabindex="-1"></a><span class="co">// by inspecting pixel values</span></span>
<span id="cb18-78"><a href="#cb18-78" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(filtered<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Full Collection&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb18-79"><a href="#cb18-79" tabindex="-1"></a></span>
<span id="cb18-80"><a href="#cb18-80" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb18-81"><a href="#cb18-81" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#fef0d9&#39;</span><span class="op">,</span><span class="st">&#39;#fdcc8a&#39;</span><span class="op">,</span><span class="st">&#39;#fc8d59&#39;</span><span class="op">,</span><span class="st">&#39;#e34a33&#39;</span><span class="op">,</span><span class="st">&#39;#b30000&#39;</span>]<span class="op">;</span></span>
<span id="cb18-82"><a href="#cb18-82" tabindex="-1"></a><span class="kw">var</span> doyVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">365</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}</span>
<span id="cb18-83"><a href="#cb18-83" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(minDoy<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> doyVis<span class="op">,</span> <span class="st">&#39;DOY of Minimum NDVI&#39;</span>)<span class="op">;</span></span>
<span id="cb18-84"><a href="#cb18-84" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(maxDoy<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> doyVis<span class="op">,</span> <span class="st">&#39;DOY of Maximum NDVI&#39;</span>)<span class="op">;</span></span>
<span id="cb18-85"><a href="#cb18-85" tabindex="-1"></a></span>
<span id="cb18-86"><a href="#cb18-86" tabindex="-1"></a>  </span></code></pre></div>
</div>
<div id="visualize-number-of-images-in-composites"
class="section level2">
<h2>Visualize Number of Images in Composites</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FVisualize_Number_of_Images_in_Composites"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co">// Exploring Composite Images</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="co">// Example script showing </span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="co">// 1. How to visualize the DOY (day-of-year) of each pixel of a composite</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="co">// 2. How to visualize count of images at each pixel of a composite</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="kw">var</span> admin1 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;FAO/GAUL_SIMPLIFIED_500m/2015/level1&#39;</span>)<span class="op">;</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="kw">var</span> karnataka <span class="op">=</span> admin1<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))<span class="op">;</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> karnataka<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span>ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a><span class="co">// Add a band to each image indicating the DOY of each image</span></span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a><span class="kw">var</span> filteredWithDoyBand <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a>  <span class="co">// Create an image with day of the year as value</span></span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a>  <span class="kw">var</span> date <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;system:time_start&#39;</span>))<span class="op">;</span></span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a>  <span class="kw">var</span> day <span class="op">=</span> date<span class="op">.</span><span class="fu">getRelative</span>(<span class="st">&#39;day&#39;</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a>  <span class="kw">var</span> dayImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(day)<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;dayofyear&#39;</span>])<span class="op">.</span><span class="fu">int</span>()<span class="op">.</span><span class="fu">clip</span>(image<span class="op">.</span><span class="fu">geometry</span>())<span class="op">;</span></span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>([dayImage])<span class="op">;</span></span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filteredWithDoyBand<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb19-32"><a href="#cb19-32" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb19-34"><a href="#cb19-34" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;2019 Median Composite&#39;</span>)</span>
<span id="cb19-35"><a href="#cb19-35" tabindex="-1"></a></span>
<span id="cb19-36"><a href="#cb19-36" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" tabindex="-1"></a><span class="co">// Visualize which pixels contribute to the composite</span></span>
<span id="cb19-38"><a href="#cb19-38" tabindex="-1"></a><span class="kw">var</span> dateImage <span class="op">=</span> composite<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;dayofyear&#39;</span>)<span class="op">.</span><span class="fu">int</span>()<span class="op">;</span></span>
<span id="cb19-39"><a href="#cb19-39" tabindex="-1"></a></span>
<span id="cb19-40"><a href="#cb19-40" tabindex="-1"></a><span class="kw">var</span> doyVis <span class="op">=</span> {</span>
<span id="cb19-41"><a href="#cb19-41" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">20</span><span class="op">,</span></span>
<span id="cb19-42"><a href="#cb19-42" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb19-43"><a href="#cb19-43" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;d7191c&#39;</span><span class="op">,</span><span class="st">&#39;fdae61&#39;</span><span class="op">,</span><span class="st">&#39;ffffbf&#39;</span><span class="op">,</span><span class="st">&#39;a6d96a&#39;</span><span class="op">,</span><span class="st">&#39;1a9641&#39;</span>]</span>
<span id="cb19-44"><a href="#cb19-44" tabindex="-1"></a>}</span>
<span id="cb19-45"><a href="#cb19-45" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(dateImage<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> doyVis<span class="op">,</span> <span class="st">&#39;DOY of Each Pixel in Composite&#39;</span>)<span class="op">;</span></span>
<span id="cb19-46"><a href="#cb19-46" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" tabindex="-1"></a><span class="co">// Visualize the number of images contributing to each pixel </span></span>
<span id="cb19-48"><a href="#cb19-48" tabindex="-1"></a><span class="co">// of the composite</span></span>
<span id="cb19-49"><a href="#cb19-49" tabindex="-1"></a><span class="co">// Select a single band and use count()</span></span>
<span id="cb19-50"><a href="#cb19-50" tabindex="-1"></a><span class="kw">var</span> count <span class="op">=</span> filtered<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">count</span>()<span class="op">;</span></span>
<span id="cb19-51"><a href="#cb19-51" tabindex="-1"></a></span>
<span id="cb19-52"><a href="#cb19-52" tabindex="-1"></a><span class="co">// show image count</span></span>
<span id="cb19-53"><a href="#cb19-53" tabindex="-1"></a><span class="kw">var</span> countVis <span class="op">=</span> {</span>
<span id="cb19-54"><a href="#cb19-54" tabindex="-1"></a>    <span class="dt">min</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb19-55"><a href="#cb19-55" tabindex="-1"></a>    <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb19-56"><a href="#cb19-56" tabindex="-1"></a>    <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;#fee5d9&#39;</span><span class="op">,</span><span class="st">&#39;#fcae91&#39;</span><span class="op">,</span><span class="st">&#39;#fb6a4a&#39;</span><span class="op">,</span><span class="st">&#39;#de2d26&#39;</span><span class="op">,</span><span class="st">&#39;#a50f15&#39;</span>]</span>
<span id="cb19-57"><a href="#cb19-57" tabindex="-1"></a>}</span>
<span id="cb19-58"><a href="#cb19-58" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(count<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> countVis<span class="op">,</span> <span class="st">&#39;Number of S2 Scenes&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="advanced-image-processing" class="section level1">
<h1>Advanced Image Processing</h1>
<div id="working-with-landsat-collection-2" class="section level2">
<h2>Working with Landsat Collection 2</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Processing%2FLandsat_Indices"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co">// Example script for calculating NDVI and EVI from Landsat Collection 2 images</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="co">// Get Banglore boundary </span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a> </span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="kw">var</span> bangalore <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> bangalore<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a><span class="co">// Applies cloud mask and scaling factors.</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskL8sr</span>(image) {</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>  <span class="co">// Bit 0 - Fill</span></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>  <span class="co">// Bit 1 - Dilated Cloud</span></span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>  <span class="co">// Bit 2 - Cirrus</span></span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>  <span class="co">// Bit 3 - Cloud</span></span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>  <span class="co">// Bit 4 - Cloud Shadow</span></span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_PIXEL&#39;</span>)<span class="op">.</span><span class="fu">bitwiseAnd</span>(<span class="pp">parseInt</span>(<span class="st">&#39;11111&#39;</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a>  <span class="kw">var</span> saturationMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_RADSAT&#39;</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a>  <span class="co">// Apply the scaling factors to the appropriate bands.</span></span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a>  <span class="kw">var</span> opticalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B.&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0000275</span>)<span class="op">.</span><span class="fu">add</span>(<span class="op">-</span><span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a>  <span class="kw">var</span> thermalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ST_B.*&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00341802</span>)<span class="op">.</span><span class="fu">add</span>(<span class="fl">149.0</span>)<span class="op">;</span></span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a>  <span class="co">// Replace the original bands with the scaled ones and apply the masks.</span></span>
<span id="cb20-24"><a href="#cb20-24" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(opticalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb20-25"><a href="#cb20-25" tabindex="-1"></a>      <span class="op">.</span><span class="fu">addBands</span>(thermalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb20-26"><a href="#cb20-26" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb20-27"><a href="#cb20-27" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(saturationMask)<span class="op">;</span></span>
<span id="cb20-28"><a href="#cb20-28" tabindex="-1"></a>}</span>
<span id="cb20-29"><a href="#cb20-29" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" tabindex="-1"></a><span class="co">// Filter to 2021 Landsat 8 images over banglore. </span></span>
<span id="cb20-31"><a href="#cb20-31" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LC08/C02/T1_L2&#39;</span>)</span>
<span id="cb20-32"><a href="#cb20-32" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2021-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2022-01-01&#39;</span>))</span>
<span id="cb20-33"><a href="#cb20-33" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb20-34"><a href="#cb20-34" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(maskL8sr)<span class="op">;</span></span>
<span id="cb20-35"><a href="#cb20-35" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" tabindex="-1"></a><span class="co">// Create a median composite</span></span>
<span id="cb20-37"><a href="#cb20-37" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> dataset<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span> </span>
<span id="cb20-38"><a href="#cb20-38" tabindex="-1"></a></span>
<span id="cb20-39"><a href="#cb20-39" tabindex="-1"></a><span class="co">// Print to check the bands. </span></span>
<span id="cb20-40"><a href="#cb20-40" tabindex="-1"></a><span class="fu">print</span>(image)</span>
<span id="cb20-41"><a href="#cb20-41" tabindex="-1"></a></span>
<span id="cb20-42"><a href="#cb20-42" tabindex="-1"></a><span class="co">// Create NDVI image. </span></span>
<span id="cb20-43"><a href="#cb20-43" tabindex="-1"></a><span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;SR_B5&#39;</span><span class="op">,</span> <span class="st">&#39;SR_B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])</span>
<span id="cb20-44"><a href="#cb20-44" tabindex="-1"></a></span>
<span id="cb20-45"><a href="#cb20-45" tabindex="-1"></a><span class="co">// Create MNDWI image. </span></span>
<span id="cb20-46"><a href="#cb20-46" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;SR_B3&#39;</span><span class="op">,</span> <span class="st">&#39;SR_B6&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])</span>
<span id="cb20-47"><a href="#cb20-47" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" tabindex="-1"></a><span class="co">// Create EVI image</span></span>
<span id="cb20-49"><a href="#cb20-49" tabindex="-1"></a><span class="co">// EVI = 2.5 * ((Band 5 – Band 4) / (Band 5 + 6 * Band 4 – 7.5 * Band 2 + 1)).</span></span>
<span id="cb20-50"><a href="#cb20-50" tabindex="-1"></a><span class="kw">var</span> evi <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb20-51"><a href="#cb20-51" tabindex="-1"></a>    <span class="st">&#39;2.5 * ( (NIR - RED) / (NIR + 6 * RED - 7.5 * BLUE + 1))&#39;</span><span class="op">,</span> {</span>
<span id="cb20-52"><a href="#cb20-52" tabindex="-1"></a>      <span class="st">&#39;BLUE&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B2&#39;</span>)<span class="op">,</span></span>
<span id="cb20-53"><a href="#cb20-53" tabindex="-1"></a>      <span class="st">&#39;RED&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B4&#39;</span>)<span class="op">,</span></span>
<span id="cb20-54"><a href="#cb20-54" tabindex="-1"></a>      <span class="st">&#39;NIR&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B5&#39;</span>)</span>
<span id="cb20-55"><a href="#cb20-55" tabindex="-1"></a>})<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;evi&#39;</span>)<span class="op">;</span></span>
<span id="cb20-56"><a href="#cb20-56" tabindex="-1"></a></span>
<span id="cb20-57"><a href="#cb20-57" tabindex="-1"></a><span class="co">// Create MNDWI image</span></span>
<span id="cb20-58"><a href="#cb20-58" tabindex="-1"></a></span>
<span id="cb20-59"><a href="#cb20-59" tabindex="-1"></a><span class="co">// Visualization parameter. </span></span>
<span id="cb20-60"><a href="#cb20-60" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.3</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span>[<span class="st">&#39;SR_B4&#39;</span><span class="op">,</span> <span class="st">&#39;SR_B3&#39;</span><span class="op">,</span> <span class="st">&#39;SR_B2&#39;</span>]}</span>
<span id="cb20-61"><a href="#cb20-61" tabindex="-1"></a><span class="kw">var</span> ndviVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}</span>
<span id="cb20-62"><a href="#cb20-62" tabindex="-1"></a><span class="kw">var</span> ndwiVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb20-63"><a href="#cb20-63" tabindex="-1"></a></span>
<span id="cb20-64"><a href="#cb20-64" tabindex="-1"></a><span class="co">// Add EVI and NDVI images to Map. </span></span>
<span id="cb20-65"><a href="#cb20-65" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb20-66"><a href="#cb20-66" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)</span>
<span id="cb20-67"><a href="#cb20-67" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(evi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndviVis<span class="op">,</span> <span class="st">&#39;EVI&#39;</span>)</span>
<span id="cb20-68"><a href="#cb20-68" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(ndvi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndviVis<span class="op">,</span> <span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb20-69"><a href="#cb20-69" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(mndwi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndwiVis<span class="op">,</span> <span class="st">&#39;MNDWI&#39;</span>)</span></code></pre></div>
</div>
<div id="derive-lst-from-landsat-images" class="section level2">
<h2>Derive LST from Landsat Images</h2>
<p>Many researchers are interested in studying the effects of climate
change and the urban environment. Landsat sensors have thermal bands
which makes it possible to study these interactions at high spatial and
temporal resolutions. The script below shows how to compute LST using
two different methods.</p>
<ul>
<li>Method 1: Using the <a
href="https://www.mdpi.com/2072-4292/12/9/1471">LST Computation
Algorithm by Sofia Ermida</a>.</li>
<li>Method 2: Using <a
href="https://www.usgs.gov/landsat-missions/landsat-collection-2-surface-temperature">Landsat
Collection 2 Level 2 Dataset</a>.</li>
</ul>
<p>The script generates a map of land surface temperature distribution
along with a time series for different land surfaces.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/landsat_lst_time_series.png" alt="LST Time-Series for Different Landcovers" width="100%" />
<p class="caption">
LST Time-Series for Different Landcovers
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Processing%2FLandsat_LST"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co">// Script showing how to obtain a Landsat LST Time-Series</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="co">// over different land surfaces</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="kw">var</span> metalroof <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">72.8550936937685</span><span class="op">,</span> <span class="fl">19.044646120301234</span>])<span class="op">;</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="kw">var</span> concreteroof <span class="op">=</span>  ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">72.85441764267667</span><span class="op">,</span> <span class="fl">19.028290540890772</span>])<span class="op">;</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="kw">var</span> airport <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">72.86249644714638</span><span class="op">,</span> <span class="fl">19.09355985643176</span>])<span class="op">;</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">72.91107782264197</span><span class="op">,</span> <span class="fl">19.152799035509638</span>])<span class="op">;</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="kw">var</span> mangrove <span class="op">=</span>  ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">72.8115905761819</span><span class="op">,</span> <span class="fl">19.152316393168405</span>])<span class="op">;</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>    </span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a><span class="co">// Use Mumbai city boundary</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a><span class="kw">var</span> mumbai_wards <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(</span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>  <span class="st">&#39;users/ujavalgandhi/public/mumbai_bmc_wards_datameet&#39;</span>)<span class="op">;</span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> mumbai_wards<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a><span class="co">// Method 1</span></span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a><span class="co">// LST Computation code by Sofia Ermida (sofia.ermida@ipma.pt; @ermida_sofia)</span></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a><span class="co">// Ermida, S.L., Soares, P., Mantas, V., Göttsche, F.-M., Trigo, I.F., 2020. </span></span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a><span class="co">//     Google Earth Engine open-source code for Land Surface Temperature estimation from the Landsat series.</span></span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a><span class="co">//     Remote Sensing, 12 (9), 1471; https://doi.org/10.3390/rs12091471</span></span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a><span class="kw">var</span> LandsatLST <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/sofiaermida/landsat_smw_lst:modules/Landsat_LST.js&#39;</span>)</span>
<span id="cb21-23"><a href="#cb21-23" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" tabindex="-1"></a><span class="co">// Set parameters to get Landsat 8 data</span></span>
<span id="cb21-25"><a href="#cb21-25" tabindex="-1"></a><span class="kw">var</span> satellite <span class="op">=</span> <span class="st">&#39;L8&#39;</span><span class="op">;</span></span>
<span id="cb21-26"><a href="#cb21-26" tabindex="-1"></a><span class="kw">var</span> date_start <span class="op">=</span> <span class="st">&#39;2015-01-01&#39;</span><span class="op">;</span></span>
<span id="cb21-27"><a href="#cb21-27" tabindex="-1"></a><span class="kw">var</span> date_end <span class="op">=</span> <span class="st">&#39;2016-01-01&#39;</span><span class="op">;</span></span>
<span id="cb21-28"><a href="#cb21-28" tabindex="-1"></a><span class="kw">var</span> use_ndvi <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb21-29"><a href="#cb21-29" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" tabindex="-1"></a><span class="co">// get landsat collection with added variables: NDVI, FVC, TPW, EM, LST</span></span>
<span id="cb21-31"><a href="#cb21-31" tabindex="-1"></a><span class="kw">var</span> LandsatColl <span class="op">=</span> LandsatLST<span class="op">.</span><span class="fu">collection</span>(satellite<span class="op">,</span> date_start<span class="op">,</span> date_end<span class="op">,</span> geometry<span class="op">,</span> use_ndvi)</span>
<span id="cb21-32"><a href="#cb21-32" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" tabindex="-1"></a><span class="co">// Select LST band</span></span>
<span id="cb21-34"><a href="#cb21-34" tabindex="-1"></a><span class="kw">var</span> lstK <span class="op">=</span> LandsatColl<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;LST&#39;</span>)</span>
<span id="cb21-35"><a href="#cb21-35" tabindex="-1"></a></span>
<span id="cb21-36"><a href="#cb21-36" tabindex="-1"></a><span class="co">// Convert to celsius</span></span>
<span id="cb21-37"><a href="#cb21-37" tabindex="-1"></a><span class="kw">var</span> lstC <span class="op">=</span> lstK<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image){</span>
<span id="cb21-38"><a href="#cb21-38" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">273.15</span>)<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> image<span class="op">.</span><span class="fu">propertyNames</span>())</span>
<span id="cb21-39"><a href="#cb21-39" tabindex="-1"></a>})</span>
<span id="cb21-40"><a href="#cb21-40" tabindex="-1"></a></span>
<span id="cb21-41"><a href="#cb21-41" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" tabindex="-1"></a><span class="co">// Filter to May month image to visualize in map. </span></span>
<span id="cb21-43"><a href="#cb21-43" tabindex="-1"></a><span class="kw">var</span> lstMay  <span class="op">=</span> lstC</span>
<span id="cb21-44"><a href="#cb21-44" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2015-04-01&#39;</span><span class="op">,</span> <span class="st">&#39;2015-05-01&#39;</span>))</span>
<span id="cb21-45"><a href="#cb21-45" tabindex="-1"></a>  <span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb21-46"><a href="#cb21-46" tabindex="-1"></a></span>
<span id="cb21-47"><a href="#cb21-47" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(lstMay<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> </span>
<span id="cb21-48"><a href="#cb21-48" tabindex="-1"></a>  {<span class="dt">min</span><span class="op">:</span><span class="dv">25</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">45</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;green&#39;</span><span class="op">,</span><span class="st">&#39;yellow&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span>]}<span class="op">,</span> </span>
<span id="cb21-49"><a href="#cb21-49" tabindex="-1"></a>  <span class="st">&#39;Landsat-LST (Ermida, S.L)&#39;</span>)</span>
<span id="cb21-50"><a href="#cb21-50" tabindex="-1"></a></span>
<span id="cb21-51"><a href="#cb21-51" tabindex="-1"></a><span class="co">// Create the LSt time series chart. </span></span>
<span id="cb21-52"><a href="#cb21-52" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">seriesByRegion</span>({</span>
<span id="cb21-53"><a href="#cb21-53" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span>lstC<span class="op">,</span>  </span>
<span id="cb21-54"><a href="#cb21-54" tabindex="-1"></a>  <span class="dt">regions</span><span class="op">:</span> [airport<span class="op">,</span> metalroof<span class="op">,</span> concreteroof<span class="op">,</span> mangrove<span class="op">,</span> water]<span class="op">,</span></span>
<span id="cb21-55"><a href="#cb21-55" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span>ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb21-56"><a href="#cb21-56" tabindex="-1"></a>  <span class="dt">band</span><span class="op">:</span>[<span class="st">&#39;LST&#39;</span>]<span class="op">,</span></span>
<span id="cb21-57"><a href="#cb21-57" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span>  </span>
<span id="cb21-58"><a href="#cb21-58" tabindex="-1"></a>  <span class="dt">xProperty</span><span class="op">:</span><span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb21-59"><a href="#cb21-59" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb21-60"><a href="#cb21-60" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb21-61"><a href="#cb21-61" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Land Surface Temperature Time-Series (Ermida, S.L)&#39;</span><span class="op">,</span></span>
<span id="cb21-62"><a href="#cb21-62" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb21-63"><a href="#cb21-63" tabindex="-1"></a>      <span class="dt">viewWindowMode</span><span class="op">:</span><span class="st">&#39;explicit&#39;</span><span class="op">,</span></span>
<span id="cb21-64"><a href="#cb21-64" tabindex="-1"></a>        <span class="dt">viewWindow</span><span class="op">:</span> {</span>
<span id="cb21-65"><a href="#cb21-65" tabindex="-1"></a>            <span class="dt">max</span><span class="op">:</span><span class="dv">50</span><span class="op">,</span></span>
<span id="cb21-66"><a href="#cb21-66" tabindex="-1"></a>            <span class="dt">min</span><span class="op">:</span><span class="dv">25</span></span>
<span id="cb21-67"><a href="#cb21-67" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb21-68"><a href="#cb21-68" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;LST (°C)&#39;</span>}<span class="op">,</span></span>
<span id="cb21-69"><a href="#cb21-69" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MMM&#39;</span>}<span class="op">,</span></span>
<span id="cb21-70"><a href="#cb21-70" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb21-71"><a href="#cb21-71" tabindex="-1"></a>      <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Airport Tarmac&#39;</span>}<span class="op">,</span> </span>
<span id="cb21-72"><a href="#cb21-72" tabindex="-1"></a>      <span class="dv">1</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;pink&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Residential-Slum (Metal Roof)&#39;</span>}<span class="op">,</span> </span>
<span id="cb21-73"><a href="#cb21-73" tabindex="-1"></a>      <span class="dv">2</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Residential (Concrete Roof)&#39;</span>}<span class="op">,</span></span>
<span id="cb21-74"><a href="#cb21-74" tabindex="-1"></a>      <span class="dv">3</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Mangrove&#39;</span>}<span class="op">,</span></span>
<span id="cb21-75"><a href="#cb21-75" tabindex="-1"></a>      <span class="dv">4</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Water&#39;</span>}</span>
<span id="cb21-76"><a href="#cb21-76" tabindex="-1"></a>    } </span>
<span id="cb21-77"><a href="#cb21-77" tabindex="-1"></a>    })</span>
<span id="cb21-78"><a href="#cb21-78" tabindex="-1"></a>  </span>
<span id="cb21-79"><a href="#cb21-79" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb21-80"><a href="#cb21-80" tabindex="-1"></a></span>
<span id="cb21-81"><a href="#cb21-81" tabindex="-1"></a><span class="co">// Method 2</span></span>
<span id="cb21-82"><a href="#cb21-82" tabindex="-1"></a><span class="co">// Landsat Collection 2 Level 2 LST</span></span>
<span id="cb21-83"><a href="#cb21-83" tabindex="-1"></a></span>
<span id="cb21-84"><a href="#cb21-84" tabindex="-1"></a><span class="kw">var</span> date_start <span class="op">=</span> <span class="st">&#39;2015-01-01&#39;</span><span class="op">;</span></span>
<span id="cb21-85"><a href="#cb21-85" tabindex="-1"></a><span class="kw">var</span> date_end <span class="op">=</span> <span class="st">&#39;2016-01-01&#39;</span><span class="op">;</span></span>
<span id="cb21-86"><a href="#cb21-86" tabindex="-1"></a></span>
<span id="cb21-87"><a href="#cb21-87" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LC08/C02/T1_L2&#39;</span>)</span>
<span id="cb21-88"><a href="#cb21-88" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filterDate</span>(date_start<span class="op">,</span> date_end)</span>
<span id="cb21-89"><a href="#cb21-89" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb21-90"><a href="#cb21-90" tabindex="-1"></a>    </span>
<span id="cb21-91"><a href="#cb21-91" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskL8sr</span>(image) {</span>
<span id="cb21-92"><a href="#cb21-92" tabindex="-1"></a>  <span class="co">// Bit 0 - Fill</span></span>
<span id="cb21-93"><a href="#cb21-93" tabindex="-1"></a>  <span class="co">// Bit 1 - Dilated Cloud</span></span>
<span id="cb21-94"><a href="#cb21-94" tabindex="-1"></a>  <span class="co">// Bit 2 - Cirrus</span></span>
<span id="cb21-95"><a href="#cb21-95" tabindex="-1"></a>  <span class="co">// Bit 3 - Cloud</span></span>
<span id="cb21-96"><a href="#cb21-96" tabindex="-1"></a>  <span class="co">// Bit 4 - Cloud Shadow</span></span>
<span id="cb21-97"><a href="#cb21-97" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_PIXEL&#39;</span>)<span class="op">.</span><span class="fu">bitwiseAnd</span>(<span class="pp">parseInt</span>(<span class="st">&#39;11111&#39;</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb21-98"><a href="#cb21-98" tabindex="-1"></a>  <span class="kw">var</span> saturationMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_RADSAT&#39;</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb21-99"><a href="#cb21-99" tabindex="-1"></a></span>
<span id="cb21-100"><a href="#cb21-100" tabindex="-1"></a>  <span class="co">// Apply the scaling factors to the appropriate bands.</span></span>
<span id="cb21-101"><a href="#cb21-101" tabindex="-1"></a>  <span class="kw">var</span> opticalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B.&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0000275</span>)<span class="op">.</span><span class="fu">add</span>(<span class="op">-</span><span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb21-102"><a href="#cb21-102" tabindex="-1"></a>  <span class="kw">var</span> thermalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ST_B.*&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00341802</span>)<span class="op">.</span><span class="fu">add</span>(<span class="fl">149.0</span>)<span class="op">;</span></span>
<span id="cb21-103"><a href="#cb21-103" tabindex="-1"></a></span>
<span id="cb21-104"><a href="#cb21-104" tabindex="-1"></a>  <span class="co">// Replace the original bands with the scaled ones and apply the masks.</span></span>
<span id="cb21-105"><a href="#cb21-105" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(opticalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb21-106"><a href="#cb21-106" tabindex="-1"></a>      <span class="op">.</span><span class="fu">addBands</span>(thermalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb21-107"><a href="#cb21-107" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb21-108"><a href="#cb21-108" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(saturationMask)<span class="op">;</span></span>
<span id="cb21-109"><a href="#cb21-109" tabindex="-1"></a>}</span>
<span id="cb21-110"><a href="#cb21-110" tabindex="-1"></a></span>
<span id="cb21-111"><a href="#cb21-111" tabindex="-1"></a></span>
<span id="cb21-112"><a href="#cb21-112" tabindex="-1"></a>dataset <span class="op">=</span> dataset<span class="op">.</span><span class="fu">map</span>(maskL8sr)</span>
<span id="cb21-113"><a href="#cb21-113" tabindex="-1"></a></span>
<span id="cb21-114"><a href="#cb21-114" tabindex="-1"></a><span class="co">// Select B10 band and rename it to LST</span></span>
<span id="cb21-115"><a href="#cb21-115" tabindex="-1"></a><span class="kw">var</span> lstK <span class="op">=</span> dataset<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;ST_B10&#39;</span>]<span class="op">,</span> [<span class="st">&#39;LST&#39;</span>])</span>
<span id="cb21-116"><a href="#cb21-116" tabindex="-1"></a></span>
<span id="cb21-117"><a href="#cb21-117" tabindex="-1"></a><span class="co">// Convert to celsius</span></span>
<span id="cb21-118"><a href="#cb21-118" tabindex="-1"></a><span class="kw">var</span> lstC <span class="op">=</span> lstK<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image){</span>
<span id="cb21-119"><a href="#cb21-119" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">273.15</span>)<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> image<span class="op">.</span><span class="fu">propertyNames</span>())</span>
<span id="cb21-120"><a href="#cb21-120" tabindex="-1"></a>})</span>
<span id="cb21-121"><a href="#cb21-121" tabindex="-1"></a></span>
<span id="cb21-122"><a href="#cb21-122" tabindex="-1"></a></span>
<span id="cb21-123"><a href="#cb21-123" tabindex="-1"></a><span class="co">// Filter to May month image to visualize in map. </span></span>
<span id="cb21-124"><a href="#cb21-124" tabindex="-1"></a><span class="kw">var</span> lstMay  <span class="op">=</span> lstC</span>
<span id="cb21-125"><a href="#cb21-125" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2015-04-01&#39;</span><span class="op">,</span> <span class="st">&#39;2015-05-01&#39;</span>))<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb21-126"><a href="#cb21-126" tabindex="-1"></a></span>
<span id="cb21-127"><a href="#cb21-127" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(lstMay<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span></span>
<span id="cb21-128"><a href="#cb21-128" tabindex="-1"></a>  {<span class="dt">min</span><span class="op">:</span><span class="dv">25</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">45</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;green&#39;</span><span class="op">,</span><span class="st">&#39;yellow&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span>]}<span class="op">,</span></span>
<span id="cb21-129"><a href="#cb21-129" tabindex="-1"></a>  <span class="st">&#39;Landsat-LST (Landsat Collection 2)&#39;</span>)</span>
<span id="cb21-130"><a href="#cb21-130" tabindex="-1"></a></span>
<span id="cb21-131"><a href="#cb21-131" tabindex="-1"></a><span class="co">// Create the LSt time series chart. </span></span>
<span id="cb21-132"><a href="#cb21-132" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">seriesByRegion</span>({</span>
<span id="cb21-133"><a href="#cb21-133" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span>lstC<span class="op">,</span>  </span>
<span id="cb21-134"><a href="#cb21-134" tabindex="-1"></a>  <span class="dt">regions</span><span class="op">:</span> [airport<span class="op">,</span> metalroof<span class="op">,</span> concreteroof<span class="op">,</span> mangrove<span class="op">,</span> water]<span class="op">,</span></span>
<span id="cb21-135"><a href="#cb21-135" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span>ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb21-136"><a href="#cb21-136" tabindex="-1"></a>  <span class="dt">band</span><span class="op">:</span>[<span class="st">&#39;LST&#39;</span>]<span class="op">,</span></span>
<span id="cb21-137"><a href="#cb21-137" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span>  </span>
<span id="cb21-138"><a href="#cb21-138" tabindex="-1"></a>  <span class="dt">xProperty</span><span class="op">:</span><span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb21-139"><a href="#cb21-139" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb21-140"><a href="#cb21-140" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb21-141"><a href="#cb21-141" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Land Surface Temperature Time-Series (Landsat Collection 2)&#39;</span><span class="op">,</span></span>
<span id="cb21-142"><a href="#cb21-142" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb21-143"><a href="#cb21-143" tabindex="-1"></a>      <span class="dt">viewWindowMode</span><span class="op">:</span><span class="st">&#39;explicit&#39;</span><span class="op">,</span></span>
<span id="cb21-144"><a href="#cb21-144" tabindex="-1"></a>        <span class="dt">viewWindow</span><span class="op">:</span> {</span>
<span id="cb21-145"><a href="#cb21-145" tabindex="-1"></a>            <span class="dt">max</span><span class="op">:</span><span class="dv">50</span><span class="op">,</span></span>
<span id="cb21-146"><a href="#cb21-146" tabindex="-1"></a>            <span class="dt">min</span><span class="op">:</span><span class="dv">25</span></span>
<span id="cb21-147"><a href="#cb21-147" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb21-148"><a href="#cb21-148" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;LST (°C)&#39;</span>}<span class="op">,</span></span>
<span id="cb21-149"><a href="#cb21-149" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MMM&#39;</span>}<span class="op">,</span></span>
<span id="cb21-150"><a href="#cb21-150" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb21-151"><a href="#cb21-151" tabindex="-1"></a>      <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Airport Tarmac&#39;</span>}<span class="op">,</span> </span>
<span id="cb21-152"><a href="#cb21-152" tabindex="-1"></a>      <span class="dv">1</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;pink&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Residential-Slum (Metal Roof)&#39;</span>}<span class="op">,</span> </span>
<span id="cb21-153"><a href="#cb21-153" tabindex="-1"></a>      <span class="dv">2</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Residential (Concrete Roof)&#39;</span>}<span class="op">,</span></span>
<span id="cb21-154"><a href="#cb21-154" tabindex="-1"></a>      <span class="dv">3</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Mangrove&#39;</span>}<span class="op">,</span></span>
<span id="cb21-155"><a href="#cb21-155" tabindex="-1"></a>      <span class="dv">4</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Water&#39;</span>}</span>
<span id="cb21-156"><a href="#cb21-156" tabindex="-1"></a>    } </span>
<span id="cb21-157"><a href="#cb21-157" tabindex="-1"></a>    })</span>
<span id="cb21-158"><a href="#cb21-158" tabindex="-1"></a>  </span>
<span id="cb21-159"><a href="#cb21-159" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span></code></pre></div>
</div>
</div>
<div id="time-series-smoothing-and-gap-filling" class="section level1">
<h1>Time-Series Smoothing and Gap-filling</h1>
<div id="moving-window-smoothing" class="section level2">
<h2>Moving Window Smoothing</h2>
<p>A technique applied to a time series for removal of the fine-grained
variation between time steps is known as Smoothing. This example shows
how a moving-window smoothing algorithm can be applied in Earth Engine.
Using a <a
href="https://developers.google.com/earth-engine/guides/joins_save_all">Save-all
Join</a>, the collection is joined with itself and all images that fall
within the temporal-window are added as a property of each image. Next,
a <em>mean</em> reducer is applied on all the images, resulting in the
average value of the pixel within the time-frame. The resulting
time-series reduces the sharp peaks and valleys - and is more robust
against outliers (such as cloudy pixels)</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/Moving_Window_Smoothing.png" alt="Moving Window Average Smoothing" width="100%" />
<p class="caption">
Moving Window Average Smoothing
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?accept_repo=users%2Fujavalgandhi%2FEnd-to-End-GEE&amp;scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FTime_Series_Smoothing%2FMoving_Window_Smoothing"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co">// Moving-Window Temporal Smoothing </span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">74.80368345518073</span><span class="op">,</span> <span class="fl">30.391793042969</span>])<span class="op">;</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2019</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2021</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="co">// Function to add a NDVI band to an image</span></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addNDVI</span>(image) {</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a>} </span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a><span class="co">// Function to mask clouds</span></span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskS2clouds</span>(image) {</span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)</span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a>             qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))</span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(<span class="st">&quot;B.*&quot;</span>)</span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&quot;system:time_start&quot;</span>])</span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a>}</span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" tabindex="-1"></a><span class="kw">var</span> originalCollection <span class="op">=</span> s2</span>
<span id="cb22-27"><a href="#cb22-27" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb22-28"><a href="#cb22-28" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb22-29"><a href="#cb22-29" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb22-30"><a href="#cb22-30" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)</span>
<span id="cb22-31"><a href="#cb22-31" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(addNDVI)<span class="op">;</span></span>
<span id="cb22-32"><a href="#cb22-32" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" tabindex="-1"></a><span class="co">// Display a time-series chart</span></span>
<span id="cb22-34"><a href="#cb22-34" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb22-35"><a href="#cb22-35" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> originalCollection<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb22-36"><a href="#cb22-36" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb22-37"><a href="#cb22-37" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb22-38"><a href="#cb22-38" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span></span>
<span id="cb22-39"><a href="#cb22-39" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb22-40"><a href="#cb22-40" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Original NDVI Time Series&#39;</span><span class="op">,</span></span>
<span id="cb22-41"><a href="#cb22-41" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb22-42"><a href="#cb22-42" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI&#39;</span><span class="op">,</span> <span class="dt">viewWindow</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span>}}<span class="op">,</span></span>
<span id="cb22-43"><a href="#cb22-43" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MM&#39;</span>}<span class="op">,</span></span>
<span id="cb22-44"><a href="#cb22-44" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb22-45"><a href="#cb22-45" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb22-46"><a href="#cb22-46" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb22-47"><a href="#cb22-47" tabindex="-1"></a>        <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#238b45&#39;</span>}<span class="op">,</span></span>
<span id="cb22-48"><a href="#cb22-48" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb22-49"><a href="#cb22-49" tabindex="-1"></a></span>
<span id="cb22-50"><a href="#cb22-50" tabindex="-1"></a>    })</span>
<span id="cb22-51"><a href="#cb22-51" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb22-52"><a href="#cb22-52" tabindex="-1"></a></span>
<span id="cb22-53"><a href="#cb22-53" tabindex="-1"></a><span class="co">// Moving-Window Smoothing</span></span>
<span id="cb22-54"><a href="#cb22-54" tabindex="-1"></a></span>
<span id="cb22-55"><a href="#cb22-55" tabindex="-1"></a><span class="co">// Specify the time-window</span></span>
<span id="cb22-56"><a href="#cb22-56" tabindex="-1"></a><span class="kw">var</span> days <span class="op">=</span> <span class="dv">15</span><span class="op">;</span></span>
<span id="cb22-57"><a href="#cb22-57" tabindex="-1"></a></span>
<span id="cb22-58"><a href="#cb22-58" tabindex="-1"></a><span class="co">// Convert to milliseconds </span></span>
<span id="cb22-59"><a href="#cb22-59" tabindex="-1"></a><span class="kw">var</span> millis <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(days)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1000</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">24</span>)<span class="op">;</span></span>
<span id="cb22-60"><a href="#cb22-60" tabindex="-1"></a></span>
<span id="cb22-61"><a href="#cb22-61" tabindex="-1"></a><span class="co">// We use a &#39;save-all join&#39; to find all images </span></span>
<span id="cb22-62"><a href="#cb22-62" tabindex="-1"></a><span class="co">// that are within the time-window</span></span>
<span id="cb22-63"><a href="#cb22-63" tabindex="-1"></a></span>
<span id="cb22-64"><a href="#cb22-64" tabindex="-1"></a><span class="co">// The join will add all matching images into a</span></span>
<span id="cb22-65"><a href="#cb22-65" tabindex="-1"></a><span class="co">// new property called &#39;images&#39;</span></span>
<span id="cb22-66"><a href="#cb22-66" tabindex="-1"></a><span class="kw">var</span> join <span class="op">=</span> ee<span class="op">.</span><span class="at">Join</span><span class="op">.</span><span class="fu">saveAll</span>({</span>
<span id="cb22-67"><a href="#cb22-67" tabindex="-1"></a>  <span class="dt">matchesKey</span><span class="op">:</span> <span class="st">&#39;images&#39;</span></span>
<span id="cb22-68"><a href="#cb22-68" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb22-69"><a href="#cb22-69" tabindex="-1"></a></span>
<span id="cb22-70"><a href="#cb22-70" tabindex="-1"></a><span class="co">// This filter will match all images that are captured</span></span>
<span id="cb22-71"><a href="#cb22-71" tabindex="-1"></a><span class="co">// within the specified day of the source image</span></span>
<span id="cb22-72"><a href="#cb22-72" tabindex="-1"></a><span class="kw">var</span> diffFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">maxDifference</span>({</span>
<span id="cb22-73"><a href="#cb22-73" tabindex="-1"></a>  <span class="dt">difference</span><span class="op">:</span> millis<span class="op">,</span></span>
<span id="cb22-74"><a href="#cb22-74" tabindex="-1"></a>  <span class="dt">leftField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span> </span>
<span id="cb22-75"><a href="#cb22-75" tabindex="-1"></a>  <span class="dt">rightField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span></span>
<span id="cb22-76"><a href="#cb22-76" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb22-77"><a href="#cb22-77" tabindex="-1"></a></span>
<span id="cb22-78"><a href="#cb22-78" tabindex="-1"></a></span>
<span id="cb22-79"><a href="#cb22-79" tabindex="-1"></a><span class="kw">var</span> joinedCollection <span class="op">=</span> join<span class="op">.</span><span class="fu">apply</span>({</span>
<span id="cb22-80"><a href="#cb22-80" tabindex="-1"></a>  <span class="dt">primary</span><span class="op">:</span> originalCollection<span class="op">,</span> </span>
<span id="cb22-81"><a href="#cb22-81" tabindex="-1"></a>  <span class="dt">secondary</span><span class="op">:</span> originalCollection<span class="op">,</span> </span>
<span id="cb22-82"><a href="#cb22-82" tabindex="-1"></a>  <span class="dt">condition</span><span class="op">:</span> diffFilter</span>
<span id="cb22-83"><a href="#cb22-83" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb22-84"><a href="#cb22-84" tabindex="-1"></a></span>
<span id="cb22-85"><a href="#cb22-85" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Joined Collection&#39;</span><span class="op">,</span> joinedCollection)<span class="op">;</span></span>
<span id="cb22-86"><a href="#cb22-86" tabindex="-1"></a></span>
<span id="cb22-87"><a href="#cb22-87" tabindex="-1"></a><span class="co">// Each image in the joined collection will contain</span></span>
<span id="cb22-88"><a href="#cb22-88" tabindex="-1"></a><span class="co">// matching images in the &#39;images&#39; property</span></span>
<span id="cb22-89"><a href="#cb22-89" tabindex="-1"></a><span class="co">// Extract and return the mean of matched images</span></span>
<span id="cb22-90"><a href="#cb22-90" tabindex="-1"></a><span class="kw">var</span> extractAndComputeMean <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb22-91"><a href="#cb22-91" tabindex="-1"></a>  <span class="kw">var</span> matchingImages <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;images&#39;</span>))<span class="op">;</span></span>
<span id="cb22-92"><a href="#cb22-92" tabindex="-1"></a>  <span class="kw">var</span> meanImage <span class="op">=</span> matchingImages<span class="op">.</span><span class="fu">reduce</span>(</span>
<span id="cb22-93"><a href="#cb22-93" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">setOutputs</span>([<span class="st">&#39;moving_average&#39;</span>]))</span>
<span id="cb22-94"><a href="#cb22-94" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(image)<span class="op">.</span><span class="fu">addBands</span>(meanImage)</span>
<span id="cb22-95"><a href="#cb22-95" tabindex="-1"></a>}</span>
<span id="cb22-96"><a href="#cb22-96" tabindex="-1"></a></span>
<span id="cb22-97"><a href="#cb22-97" tabindex="-1"></a><span class="kw">var</span> smoothedCollection <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(</span>
<span id="cb22-98"><a href="#cb22-98" tabindex="-1"></a>  joinedCollection<span class="op">.</span><span class="fu">map</span>(extractAndComputeMean))<span class="op">;</span></span>
<span id="cb22-99"><a href="#cb22-99" tabindex="-1"></a></span>
<span id="cb22-100"><a href="#cb22-100" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Smoothed Collection&#39;</span><span class="op">,</span> smoothedCollection)</span>
<span id="cb22-101"><a href="#cb22-101" tabindex="-1"></a></span>
<span id="cb22-102"><a href="#cb22-102" tabindex="-1"></a><span class="co">// Display a time-series chart</span></span>
<span id="cb22-103"><a href="#cb22-103" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb22-104"><a href="#cb22-104" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> smoothedCollection<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;ndvi&#39;</span><span class="op">,</span> <span class="st">&#39;ndvi_moving_average&#39;</span>])<span class="op">,</span></span>
<span id="cb22-105"><a href="#cb22-105" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb22-106"><a href="#cb22-106" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb22-107"><a href="#cb22-107" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span></span>
<span id="cb22-108"><a href="#cb22-108" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb22-109"><a href="#cb22-109" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI Time Series&#39;</span><span class="op">,</span></span>
<span id="cb22-110"><a href="#cb22-110" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb22-111"><a href="#cb22-111" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI&#39;</span><span class="op">,</span> <span class="dt">viewWindow</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span>}}<span class="op">,</span></span>
<span id="cb22-112"><a href="#cb22-112" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MM&#39;</span>}<span class="op">,</span></span>
<span id="cb22-113"><a href="#cb22-113" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb22-114"><a href="#cb22-114" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb22-115"><a href="#cb22-115" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb22-116"><a href="#cb22-116" tabindex="-1"></a>        <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#66c2a4&#39;</span><span class="op">,</span> <span class="dt">lineDashStyle</span><span class="op">:</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">2</span>}<span class="op">,</span> <span class="co">// Original NDVI</span></span>
<span id="cb22-117"><a href="#cb22-117" tabindex="-1"></a>        <span class="dv">1</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#238b45&#39;</span><span class="op">,</span> <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">2</span> }<span class="op">,</span> <span class="co">// Smoothed NDVI</span></span>
<span id="cb22-118"><a href="#cb22-118" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb22-119"><a href="#cb22-119" tabindex="-1"></a></span>
<span id="cb22-120"><a href="#cb22-120" tabindex="-1"></a>    })</span>
<span id="cb22-121"><a href="#cb22-121" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb22-122"><a href="#cb22-122" tabindex="-1"></a></span>
<span id="cb22-123"><a href="#cb22-123" tabindex="-1"></a><span class="co">// Let&#39;s export the NDVI time-series as a video</span></span>
<span id="cb22-124"><a href="#cb22-124" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#d73027&#39;</span><span class="op">,</span><span class="st">&#39;#f46d43&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span><span class="st">&#39;#fee08b&#39;</span><span class="op">,</span></span>
<span id="cb22-125"><a href="#cb22-125" tabindex="-1"></a>  <span class="st">&#39;#ffffbf&#39;</span><span class="op">,</span><span class="st">&#39;#d9ef8b&#39;</span><span class="op">,</span><span class="st">&#39;#a6d96a&#39;</span><span class="op">,</span><span class="st">&#39;#66bd63&#39;</span><span class="op">,</span><span class="st">&#39;#1a9850&#39;</span>]<span class="op">;</span></span>
<span id="cb22-126"><a href="#cb22-126" tabindex="-1"></a><span class="kw">var</span> ndviVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:-</span><span class="fl">0.2</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.8</span><span class="op">,</span>  <span class="dt">palette</span><span class="op">:</span> palette}</span>
<span id="cb22-127"><a href="#cb22-127" tabindex="-1"></a></span>
<span id="cb22-128"><a href="#cb22-128" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">16</span>)<span class="op">;</span></span>
<span id="cb22-129"><a href="#cb22-129" tabindex="-1"></a><span class="kw">var</span> bbox <span class="op">=</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">getBounds</span>({<span class="dt">asGeoJSON</span><span class="op">:</span> <span class="kw">true</span>})<span class="op">;</span></span>
<span id="cb22-130"><a href="#cb22-130" tabindex="-1"></a></span>
<span id="cb22-131"><a href="#cb22-131" tabindex="-1"></a><span class="kw">var</span> visualizeImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb22-132"><a href="#cb22-132" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">visualize</span>(ndviVis)<span class="op">.</span><span class="fu">clip</span>(bbox)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb22-133"><a href="#cb22-133" tabindex="-1"></a>}</span>
<span id="cb22-134"><a href="#cb22-134" tabindex="-1"></a></span>
<span id="cb22-135"><a href="#cb22-135" tabindex="-1"></a><span class="kw">var</span> visCollectionOriginal <span class="op">=</span> originalCollection<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb22-136"><a href="#cb22-136" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(visualizeImage)</span>
<span id="cb22-137"><a href="#cb22-137" tabindex="-1"></a></span>
<span id="cb22-138"><a href="#cb22-138" tabindex="-1"></a></span>
<span id="cb22-139"><a href="#cb22-139" tabindex="-1"></a><span class="kw">var</span> visCollectionSmoothed <span class="op">=</span> smoothedCollection<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi_moving_average&#39;</span>)</span>
<span id="cb22-140"><a href="#cb22-140" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(visualizeImage)</span>
<span id="cb22-141"><a href="#cb22-141" tabindex="-1"></a></span>
<span id="cb22-142"><a href="#cb22-142" tabindex="-1"></a></span>
<span id="cb22-143"><a href="#cb22-143" tabindex="-1"></a>Export<span class="op">.</span><span class="at">video</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb22-144"><a href="#cb22-144" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> visCollectionOriginal<span class="op">,</span></span>
<span id="cb22-145"><a href="#cb22-145" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Original_Time_Series&#39;</span><span class="op">,</span></span>
<span id="cb22-146"><a href="#cb22-146" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb22-147"><a href="#cb22-147" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;original&#39;</span><span class="op">,</span></span>
<span id="cb22-148"><a href="#cb22-148" tabindex="-1"></a>  <span class="dt">framesPerSecond</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb22-149"><a href="#cb22-149" tabindex="-1"></a>  <span class="dt">dimensions</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></span>
<span id="cb22-150"><a href="#cb22-150" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> bbox})</span>
<span id="cb22-151"><a href="#cb22-151" tabindex="-1"></a>  </span>
<span id="cb22-152"><a href="#cb22-152" tabindex="-1"></a>Export<span class="op">.</span><span class="at">video</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb22-153"><a href="#cb22-153" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> visCollectionSmoothed<span class="op">,</span></span>
<span id="cb22-154"><a href="#cb22-154" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Smoothed_Time_Series&#39;</span><span class="op">,</span></span>
<span id="cb22-155"><a href="#cb22-155" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb22-156"><a href="#cb22-156" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;smoothed&#39;</span><span class="op">,</span></span>
<span id="cb22-157"><a href="#cb22-157" tabindex="-1"></a>  <span class="dt">framesPerSecond</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb22-158"><a href="#cb22-158" tabindex="-1"></a>  <span class="dt">dimensions</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></span>
<span id="cb22-159"><a href="#cb22-159" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> bbox})</span></code></pre></div>
</div>
<div id="temporal-interpolation" class="section level2">
<h2>Temporal Interpolation</h2>
<p>The code below shows how to do temporal gap-filling of time-series
data. A detailed explanation of the code and other examples are
described in our blog post <a
href="https://spatialthoughts.com/2021/11/08/temporal-interpolation-gee/"
target="_blank">Temporal Gap-Filling with Linear Interpolation in
GEE</a>.</p>
<p><a
href="https://code.earthengine.google.co.in/?accept_repo=users%2Fujavalgandhi%2FEnd-to-End-GEE&amp;scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FTime_Series_Smoothing%2FTemporal_Interpolation"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co">// Temporal Interpolation (Gap-Filling Masked Pixels)</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">74.80368345518073</span><span class="op">,</span> <span class="fl">30.391793042969</span>])<span class="op">;</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2019</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2021</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a><span class="co">// Function to add a NDVI band to an image</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addNDVI</span>(image) {</span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>} </span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a><span class="co">// Function to mask clouds</span></span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskS2clouds</span>(image) {</span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)</span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb23-20"><a href="#cb23-20" tabindex="-1"></a>             qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))</span>
<span id="cb23-21"><a href="#cb23-21" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb23-22"><a href="#cb23-22" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(<span class="st">&quot;B.*&quot;</span>)</span>
<span id="cb23-23"><a href="#cb23-23" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&quot;system:time_start&quot;</span>])</span>
<span id="cb23-24"><a href="#cb23-24" tabindex="-1"></a>}</span>
<span id="cb23-25"><a href="#cb23-25" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" tabindex="-1"></a><span class="kw">var</span> originalCollection <span class="op">=</span> s2</span>
<span id="cb23-27"><a href="#cb23-27" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb23-28"><a href="#cb23-28" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb23-29"><a href="#cb23-29" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb23-30"><a href="#cb23-30" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)</span>
<span id="cb23-31"><a href="#cb23-31" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(addNDVI)<span class="op">;</span></span>
<span id="cb23-32"><a href="#cb23-32" tabindex="-1"></a></span>
<span id="cb23-33"><a href="#cb23-33" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" tabindex="-1"></a><span class="co">// Display a time-series chart</span></span>
<span id="cb23-35"><a href="#cb23-35" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb23-36"><a href="#cb23-36" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> originalCollection<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb23-37"><a href="#cb23-37" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb23-38"><a href="#cb23-38" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb23-39"><a href="#cb23-39" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span></span>
<span id="cb23-40"><a href="#cb23-40" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb23-41"><a href="#cb23-41" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Original NDVI Time Series&#39;</span><span class="op">,</span></span>
<span id="cb23-42"><a href="#cb23-42" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb23-43"><a href="#cb23-43" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI&#39;</span><span class="op">,</span> <span class="dt">viewWindow</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span>}}<span class="op">,</span></span>
<span id="cb23-44"><a href="#cb23-44" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MM&#39;</span>}<span class="op">,</span></span>
<span id="cb23-45"><a href="#cb23-45" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb23-46"><a href="#cb23-46" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb23-47"><a href="#cb23-47" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb23-48"><a href="#cb23-48" tabindex="-1"></a>        <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#238b45&#39;</span>}<span class="op">,</span></span>
<span id="cb23-49"><a href="#cb23-49" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb23-50"><a href="#cb23-50" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" tabindex="-1"></a>    })</span>
<span id="cb23-52"><a href="#cb23-52" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb23-53"><a href="#cb23-53" tabindex="-1"></a></span>
<span id="cb23-54"><a href="#cb23-54" tabindex="-1"></a><span class="co">// Gap-filling</span></span>
<span id="cb23-55"><a href="#cb23-55" tabindex="-1"></a></span>
<span id="cb23-56"><a href="#cb23-56" tabindex="-1"></a><span class="co">// Add a band containing timestamp to each image</span></span>
<span id="cb23-57"><a href="#cb23-57" tabindex="-1"></a><span class="co">// This will be used to do pixel-wise interpolation later</span></span>
<span id="cb23-58"><a href="#cb23-58" tabindex="-1"></a><span class="kw">var</span> originalCollection <span class="op">=</span> originalCollection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb23-59"><a href="#cb23-59" tabindex="-1"></a>  <span class="kw">var</span> timeImage <span class="op">=</span> image<span class="op">.</span><span class="fu">metadata</span>(<span class="st">&#39;system:time_start&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;timestamp&#39;</span>)</span>
<span id="cb23-60"><a href="#cb23-60" tabindex="-1"></a>  <span class="co">// The time image doesn&#39;t have a mask. </span></span>
<span id="cb23-61"><a href="#cb23-61" tabindex="-1"></a>  <span class="co">// We set the mask of the time band to be the same as the first band of the image</span></span>
<span id="cb23-62"><a href="#cb23-62" tabindex="-1"></a>  <span class="kw">var</span> timeImageMasked <span class="op">=</span> timeImage<span class="op">.</span><span class="fu">updateMask</span>(image<span class="op">.</span><span class="fu">mask</span>()<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>))</span>
<span id="cb23-63"><a href="#cb23-63" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(timeImageMasked)<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb23-64"><a href="#cb23-64" tabindex="-1"></a>})</span>
<span id="cb23-65"><a href="#cb23-65" tabindex="-1"></a></span>
<span id="cb23-66"><a href="#cb23-66" tabindex="-1"></a><span class="co">// For each image in the collection, we need to find all images</span></span>
<span id="cb23-67"><a href="#cb23-67" tabindex="-1"></a><span class="co">// before and after the specified time-window</span></span>
<span id="cb23-68"><a href="#cb23-68" tabindex="-1"></a></span>
<span id="cb23-69"><a href="#cb23-69" tabindex="-1"></a><span class="co">// This is accomplished using Joins</span></span>
<span id="cb23-70"><a href="#cb23-70" tabindex="-1"></a><span class="co">// We need to do 2 joins</span></span>
<span id="cb23-71"><a href="#cb23-71" tabindex="-1"></a><span class="co">// Join 1: Join the collection with itself to find all images before each image</span></span>
<span id="cb23-72"><a href="#cb23-72" tabindex="-1"></a><span class="co">// Join 2: Join the collection with itself to find all images after each image</span></span>
<span id="cb23-73"><a href="#cb23-73" tabindex="-1"></a></span>
<span id="cb23-74"><a href="#cb23-74" tabindex="-1"></a><span class="co">// We first define the filters needed for the join</span></span>
<span id="cb23-75"><a href="#cb23-75" tabindex="-1"></a></span>
<span id="cb23-76"><a href="#cb23-76" tabindex="-1"></a><span class="co">// Define a maxDifference filter to find all images within the specified days</span></span>
<span id="cb23-77"><a href="#cb23-77" tabindex="-1"></a><span class="co">// The filter needs the time difference in milliseconds</span></span>
<span id="cb23-78"><a href="#cb23-78" tabindex="-1"></a><span class="co">// Convert days to milliseconds</span></span>
<span id="cb23-79"><a href="#cb23-79" tabindex="-1"></a></span>
<span id="cb23-80"><a href="#cb23-80" tabindex="-1"></a><span class="co">// Specify the time-window to look for unmasked pixel</span></span>
<span id="cb23-81"><a href="#cb23-81" tabindex="-1"></a><span class="kw">var</span> days <span class="op">=</span> <span class="dv">45</span><span class="op">;</span></span>
<span id="cb23-82"><a href="#cb23-82" tabindex="-1"></a><span class="kw">var</span> millis <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(days)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1000</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">24</span>)</span>
<span id="cb23-83"><a href="#cb23-83" tabindex="-1"></a></span>
<span id="cb23-84"><a href="#cb23-84" tabindex="-1"></a><span class="kw">var</span> maxDiffFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">maxDifference</span>({</span>
<span id="cb23-85"><a href="#cb23-85" tabindex="-1"></a>  <span class="dt">difference</span><span class="op">:</span> millis<span class="op">,</span></span>
<span id="cb23-86"><a href="#cb23-86" tabindex="-1"></a>  <span class="dt">leftField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb23-87"><a href="#cb23-87" tabindex="-1"></a>  <span class="dt">rightField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span></span>
<span id="cb23-88"><a href="#cb23-88" tabindex="-1"></a>})</span>
<span id="cb23-89"><a href="#cb23-89" tabindex="-1"></a></span>
<span id="cb23-90"><a href="#cb23-90" tabindex="-1"></a><span class="co">// We need a lessThanOrEquals filter to find all images after a given image</span></span>
<span id="cb23-91"><a href="#cb23-91" tabindex="-1"></a><span class="co">// This will compare the given image&#39;s timestamp against other images&#39; timestamps</span></span>
<span id="cb23-92"><a href="#cb23-92" tabindex="-1"></a><span class="kw">var</span> lessEqFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lessThanOrEquals</span>({</span>
<span id="cb23-93"><a href="#cb23-93" tabindex="-1"></a>  <span class="dt">leftField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb23-94"><a href="#cb23-94" tabindex="-1"></a>  <span class="dt">rightField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span></span>
<span id="cb23-95"><a href="#cb23-95" tabindex="-1"></a>})</span>
<span id="cb23-96"><a href="#cb23-96" tabindex="-1"></a></span>
<span id="cb23-97"><a href="#cb23-97" tabindex="-1"></a><span class="co">// We need a greaterThanOrEquals filter to find all images before a given image</span></span>
<span id="cb23-98"><a href="#cb23-98" tabindex="-1"></a><span class="co">// This will compare the given image&#39;s timestamp against other images&#39; timestamps</span></span>
<span id="cb23-99"><a href="#cb23-99" tabindex="-1"></a><span class="kw">var</span> greaterEqFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">greaterThanOrEquals</span>({</span>
<span id="cb23-100"><a href="#cb23-100" tabindex="-1"></a>  <span class="dt">leftField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb23-101"><a href="#cb23-101" tabindex="-1"></a>  <span class="dt">rightField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span></span>
<span id="cb23-102"><a href="#cb23-102" tabindex="-1"></a>})</span>
<span id="cb23-103"><a href="#cb23-103" tabindex="-1"></a></span>
<span id="cb23-104"><a href="#cb23-104" tabindex="-1"></a></span>
<span id="cb23-105"><a href="#cb23-105" tabindex="-1"></a><span class="co">// Apply the joins</span></span>
<span id="cb23-106"><a href="#cb23-106" tabindex="-1"></a></span>
<span id="cb23-107"><a href="#cb23-107" tabindex="-1"></a><span class="co">// For the first join, we need to match all images that are after the given image.</span></span>
<span id="cb23-108"><a href="#cb23-108" tabindex="-1"></a><span class="co">// To do this we need to match 2 conditions</span></span>
<span id="cb23-109"><a href="#cb23-109" tabindex="-1"></a><span class="co">// 1. The resulting images must be within the specified time-window of target image</span></span>
<span id="cb23-110"><a href="#cb23-110" tabindex="-1"></a><span class="co">// 2. The target image&#39;s timestamp must be lesser than the timestamp of resulting images</span></span>
<span id="cb23-111"><a href="#cb23-111" tabindex="-1"></a><span class="co">// Combine two filters to match both these conditions</span></span>
<span id="cb23-112"><a href="#cb23-112" tabindex="-1"></a><span class="kw">var</span> filter1 <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(maxDiffFilter<span class="op">,</span> lessEqFilter)</span>
<span id="cb23-113"><a href="#cb23-113" tabindex="-1"></a><span class="co">// This join will find all images after, sorted in descending order</span></span>
<span id="cb23-114"><a href="#cb23-114" tabindex="-1"></a><span class="co">// This will gives us images so that closest is last</span></span>
<span id="cb23-115"><a href="#cb23-115" tabindex="-1"></a><span class="kw">var</span> join1 <span class="op">=</span> ee<span class="op">.</span><span class="at">Join</span><span class="op">.</span><span class="fu">saveAll</span>({</span>
<span id="cb23-116"><a href="#cb23-116" tabindex="-1"></a>  <span class="dt">matchesKey</span><span class="op">:</span> <span class="st">&#39;after&#39;</span><span class="op">,</span></span>
<span id="cb23-117"><a href="#cb23-117" tabindex="-1"></a>  <span class="dt">ordering</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb23-118"><a href="#cb23-118" tabindex="-1"></a>  <span class="dt">ascending</span><span class="op">:</span> <span class="kw">false</span>})</span>
<span id="cb23-119"><a href="#cb23-119" tabindex="-1"></a>  </span>
<span id="cb23-120"><a href="#cb23-120" tabindex="-1"></a><span class="kw">var</span> join1Result <span class="op">=</span> join1<span class="op">.</span><span class="fu">apply</span>({</span>
<span id="cb23-121"><a href="#cb23-121" tabindex="-1"></a>  <span class="dt">primary</span><span class="op">:</span> originalCollection<span class="op">,</span></span>
<span id="cb23-122"><a href="#cb23-122" tabindex="-1"></a>  <span class="dt">secondary</span><span class="op">:</span> originalCollection<span class="op">,</span></span>
<span id="cb23-123"><a href="#cb23-123" tabindex="-1"></a>  <span class="dt">condition</span><span class="op">:</span> filter1</span>
<span id="cb23-124"><a href="#cb23-124" tabindex="-1"></a>})</span>
<span id="cb23-125"><a href="#cb23-125" tabindex="-1"></a><span class="co">// Each image now as a property called &#39;after&#39; containing</span></span>
<span id="cb23-126"><a href="#cb23-126" tabindex="-1"></a><span class="co">// all images that come after it within the time-window</span></span>
<span id="cb23-127"><a href="#cb23-127" tabindex="-1"></a><span class="fu">print</span>(join1Result<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb23-128"><a href="#cb23-128" tabindex="-1"></a></span>
<span id="cb23-129"><a href="#cb23-129" tabindex="-1"></a><span class="co">// Do the second join now to match all images within the time-window</span></span>
<span id="cb23-130"><a href="#cb23-130" tabindex="-1"></a><span class="co">// that come before each image</span></span>
<span id="cb23-131"><a href="#cb23-131" tabindex="-1"></a><span class="kw">var</span> filter2 <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(maxDiffFilter<span class="op">,</span> greaterEqFilter)</span>
<span id="cb23-132"><a href="#cb23-132" tabindex="-1"></a><span class="co">// This join will find all images before, sorted in ascending order</span></span>
<span id="cb23-133"><a href="#cb23-133" tabindex="-1"></a><span class="co">// This will gives us images so that closest is last</span></span>
<span id="cb23-134"><a href="#cb23-134" tabindex="-1"></a><span class="kw">var</span> join2 <span class="op">=</span> ee<span class="op">.</span><span class="at">Join</span><span class="op">.</span><span class="fu">saveAll</span>({</span>
<span id="cb23-135"><a href="#cb23-135" tabindex="-1"></a>  <span class="dt">matchesKey</span><span class="op">:</span> <span class="st">&#39;before&#39;</span><span class="op">,</span></span>
<span id="cb23-136"><a href="#cb23-136" tabindex="-1"></a>  <span class="dt">ordering</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb23-137"><a href="#cb23-137" tabindex="-1"></a>  <span class="dt">ascending</span><span class="op">:</span> <span class="kw">true</span>})</span>
<span id="cb23-138"><a href="#cb23-138" tabindex="-1"></a>  </span>
<span id="cb23-139"><a href="#cb23-139" tabindex="-1"></a><span class="kw">var</span> join2Result <span class="op">=</span> join2<span class="op">.</span><span class="fu">apply</span>({</span>
<span id="cb23-140"><a href="#cb23-140" tabindex="-1"></a>  <span class="dt">primary</span><span class="op">:</span> join1Result<span class="op">,</span></span>
<span id="cb23-141"><a href="#cb23-141" tabindex="-1"></a>  <span class="dt">secondary</span><span class="op">:</span> join1Result<span class="op">,</span></span>
<span id="cb23-142"><a href="#cb23-142" tabindex="-1"></a>  <span class="dt">condition</span><span class="op">:</span> filter2</span>
<span id="cb23-143"><a href="#cb23-143" tabindex="-1"></a>})</span>
<span id="cb23-144"><a href="#cb23-144" tabindex="-1"></a></span>
<span id="cb23-145"><a href="#cb23-145" tabindex="-1"></a><span class="kw">var</span> joinedCol <span class="op">=</span> join2Result<span class="op">;</span></span>
<span id="cb23-146"><a href="#cb23-146" tabindex="-1"></a></span>
<span id="cb23-147"><a href="#cb23-147" tabindex="-1"></a><span class="co">// Each image now as a property called &#39;before&#39; containing</span></span>
<span id="cb23-148"><a href="#cb23-148" tabindex="-1"></a><span class="co">// all images that come after it within the time-window</span></span>
<span id="cb23-149"><a href="#cb23-149" tabindex="-1"></a><span class="fu">print</span>(joinedCol<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb23-150"><a href="#cb23-150" tabindex="-1"></a><span class="co">// Do the gap-filling</span></span>
<span id="cb23-151"><a href="#cb23-151" tabindex="-1"></a></span>
<span id="cb23-152"><a href="#cb23-152" tabindex="-1"></a><span class="co">// We now write a function that will be used to interpolate all images</span></span>
<span id="cb23-153"><a href="#cb23-153" tabindex="-1"></a><span class="co">// This function takes an image and replaces the masked pixels</span></span>
<span id="cb23-154"><a href="#cb23-154" tabindex="-1"></a><span class="co">// with the interpolated value from before and after images.</span></span>
<span id="cb23-155"><a href="#cb23-155" tabindex="-1"></a></span>
<span id="cb23-156"><a href="#cb23-156" tabindex="-1"></a><span class="kw">var</span> interpolateImages <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb23-157"><a href="#cb23-157" tabindex="-1"></a>  <span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(image)<span class="op">;</span></span>
<span id="cb23-158"><a href="#cb23-158" tabindex="-1"></a>  <span class="co">// We get the list of before and after images from the image property</span></span>
<span id="cb23-159"><a href="#cb23-159" tabindex="-1"></a>  <span class="co">// Mosaic the images so we a before and after image with the closest unmasked pixel</span></span>
<span id="cb23-160"><a href="#cb23-160" tabindex="-1"></a>  <span class="kw">var</span> beforeImages <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;before&#39;</span>))</span>
<span id="cb23-161"><a href="#cb23-161" tabindex="-1"></a>  <span class="kw">var</span> beforeMosaic <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(beforeImages)<span class="op">.</span><span class="fu">mosaic</span>()</span>
<span id="cb23-162"><a href="#cb23-162" tabindex="-1"></a>  <span class="kw">var</span> afterImages <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;after&#39;</span>))</span>
<span id="cb23-163"><a href="#cb23-163" tabindex="-1"></a>  <span class="kw">var</span> afterMosaic <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(afterImages)<span class="op">.</span><span class="fu">mosaic</span>()</span>
<span id="cb23-164"><a href="#cb23-164" tabindex="-1"></a></span>
<span id="cb23-165"><a href="#cb23-165" tabindex="-1"></a>  <span class="co">// Interpolation formula</span></span>
<span id="cb23-166"><a href="#cb23-166" tabindex="-1"></a>  <span class="co">// y = y1 + (y2-y1)*((t – t1) / (t2 – t1))</span></span>
<span id="cb23-167"><a href="#cb23-167" tabindex="-1"></a>  <span class="co">// y = interpolated image</span></span>
<span id="cb23-168"><a href="#cb23-168" tabindex="-1"></a>  <span class="co">// y1 = before image</span></span>
<span id="cb23-169"><a href="#cb23-169" tabindex="-1"></a>  <span class="co">// y2 = after image</span></span>
<span id="cb23-170"><a href="#cb23-170" tabindex="-1"></a>  <span class="co">// t = interpolation timestamp</span></span>
<span id="cb23-171"><a href="#cb23-171" tabindex="-1"></a>  <span class="co">// t1 = before image timestamp</span></span>
<span id="cb23-172"><a href="#cb23-172" tabindex="-1"></a>  <span class="co">// t2 = after image timestamp</span></span>
<span id="cb23-173"><a href="#cb23-173" tabindex="-1"></a>  </span>
<span id="cb23-174"><a href="#cb23-174" tabindex="-1"></a>  <span class="co">// We first compute the ratio (t – t1) / (t2 – t1)</span></span>
<span id="cb23-175"><a href="#cb23-175" tabindex="-1"></a></span>
<span id="cb23-176"><a href="#cb23-176" tabindex="-1"></a>  <span class="co">// Get image with before and after times</span></span>
<span id="cb23-177"><a href="#cb23-177" tabindex="-1"></a>  <span class="kw">var</span> t1 <span class="op">=</span> beforeMosaic<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;timestamp&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;t1&#39;</span>)</span>
<span id="cb23-178"><a href="#cb23-178" tabindex="-1"></a>  <span class="kw">var</span> t2 <span class="op">=</span> afterMosaic<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;timestamp&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;t2&#39;</span>)</span>
<span id="cb23-179"><a href="#cb23-179" tabindex="-1"></a></span>
<span id="cb23-180"><a href="#cb23-180" tabindex="-1"></a>  <span class="kw">var</span> t <span class="op">=</span> image<span class="op">.</span><span class="fu">metadata</span>(<span class="st">&#39;system:time_start&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;t&#39;</span>)</span>
<span id="cb23-181"><a href="#cb23-181" tabindex="-1"></a></span>
<span id="cb23-182"><a href="#cb23-182" tabindex="-1"></a>  <span class="kw">var</span> timeImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>([t1<span class="op">,</span> t2<span class="op">,</span> t])</span>
<span id="cb23-183"><a href="#cb23-183" tabindex="-1"></a></span>
<span id="cb23-184"><a href="#cb23-184" tabindex="-1"></a>  <span class="kw">var</span> timeRatio <span class="op">=</span> timeImage<span class="op">.</span><span class="fu">expression</span>(<span class="st">&#39;(t - t1) / (t2 - t1)&#39;</span><span class="op">,</span> {</span>
<span id="cb23-185"><a href="#cb23-185" tabindex="-1"></a>    <span class="st">&#39;t&#39;</span><span class="op">:</span> timeImage<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;t&#39;</span>)<span class="op">,</span></span>
<span id="cb23-186"><a href="#cb23-186" tabindex="-1"></a>    <span class="st">&#39;t1&#39;</span><span class="op">:</span> timeImage<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;t1&#39;</span>)<span class="op">,</span></span>
<span id="cb23-187"><a href="#cb23-187" tabindex="-1"></a>    <span class="st">&#39;t2&#39;</span><span class="op">:</span> timeImage<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;t2&#39;</span>)<span class="op">,</span></span>
<span id="cb23-188"><a href="#cb23-188" tabindex="-1"></a>  })</span>
<span id="cb23-189"><a href="#cb23-189" tabindex="-1"></a>  <span class="co">// You can replace timeRatio with a constant value 0.5</span></span>
<span id="cb23-190"><a href="#cb23-190" tabindex="-1"></a>  <span class="co">// if you wanted a simple average</span></span>
<span id="cb23-191"><a href="#cb23-191" tabindex="-1"></a>  </span>
<span id="cb23-192"><a href="#cb23-192" tabindex="-1"></a>  <span class="co">// Compute an image with the interpolated image y</span></span>
<span id="cb23-193"><a href="#cb23-193" tabindex="-1"></a>  <span class="kw">var</span> interpolated <span class="op">=</span> beforeMosaic</span>
<span id="cb23-194"><a href="#cb23-194" tabindex="-1"></a>    <span class="op">.</span><span class="fu">add</span>((afterMosaic<span class="op">.</span><span class="fu">subtract</span>(beforeMosaic)<span class="op">.</span><span class="fu">multiply</span>(timeRatio)))</span>
<span id="cb23-195"><a href="#cb23-195" tabindex="-1"></a>  <span class="co">// Replace the masked pixels in the current image with the average value</span></span>
<span id="cb23-196"><a href="#cb23-196" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> image<span class="op">.</span><span class="fu">unmask</span>(interpolated)</span>
<span id="cb23-197"><a href="#cb23-197" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb23-198"><a href="#cb23-198" tabindex="-1"></a>}</span>
<span id="cb23-199"><a href="#cb23-199" tabindex="-1"></a></span>
<span id="cb23-200"><a href="#cb23-200" tabindex="-1"></a><span class="co">// map() the function to gap-fill all images in the collection</span></span>
<span id="cb23-201"><a href="#cb23-201" tabindex="-1"></a><span class="kw">var</span> gapFilledCol <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(joinedCol<span class="op">.</span><span class="fu">map</span>(interpolateImages))</span>
<span id="cb23-202"><a href="#cb23-202" tabindex="-1"></a>  </span>
<span id="cb23-203"><a href="#cb23-203" tabindex="-1"></a><span class="co">// Display a time-series chart</span></span>
<span id="cb23-204"><a href="#cb23-204" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb23-205"><a href="#cb23-205" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> gapFilledCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb23-206"><a href="#cb23-206" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb23-207"><a href="#cb23-207" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb23-208"><a href="#cb23-208" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span></span>
<span id="cb23-209"><a href="#cb23-209" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb23-210"><a href="#cb23-210" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Gap-Filled NDVI Time Series&#39;</span><span class="op">,</span></span>
<span id="cb23-211"><a href="#cb23-211" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb23-212"><a href="#cb23-212" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI&#39;</span><span class="op">,</span> <span class="dt">viewWindow</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span>}}<span class="op">,</span></span>
<span id="cb23-213"><a href="#cb23-213" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MM&#39;</span>}<span class="op">,</span></span>
<span id="cb23-214"><a href="#cb23-214" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb23-215"><a href="#cb23-215" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb23-216"><a href="#cb23-216" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb23-217"><a href="#cb23-217" tabindex="-1"></a>        <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#238b45&#39;</span>}<span class="op">,</span></span>
<span id="cb23-218"><a href="#cb23-218" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb23-219"><a href="#cb23-219" tabindex="-1"></a>    })</span>
<span id="cb23-220"><a href="#cb23-220" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb23-221"><a href="#cb23-221" tabindex="-1"></a></span>
<span id="cb23-222"><a href="#cb23-222" tabindex="-1"></a><span class="co">// Let&#39;s visualize the NDVI time-series</span></span>
<span id="cb23-223"><a href="#cb23-223" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">16</span>)<span class="op">;</span></span>
<span id="cb23-224"><a href="#cb23-224" tabindex="-1"></a><span class="kw">var</span> bbox <span class="op">=</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">getBounds</span>({<span class="dt">asGeoJSON</span><span class="op">:</span> <span class="kw">true</span>})<span class="op">;</span></span>
<span id="cb23-225"><a href="#cb23-225" tabindex="-1"></a></span>
<span id="cb23-226"><a href="#cb23-226" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#d73027&#39;</span><span class="op">,</span><span class="st">&#39;#f46d43&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span><span class="st">&#39;#fee08b&#39;</span><span class="op">,</span><span class="st">&#39;#ffffbf&#39;</span><span class="op">,</span><span class="st">&#39;#d9ef8b&#39;</span><span class="op">,</span><span class="st">&#39;#a6d96a&#39;</span><span class="op">,</span><span class="st">&#39;#66bd63&#39;</span><span class="op">,</span><span class="st">&#39;#1a9850&#39;</span>]<span class="op">;</span></span>
<span id="cb23-227"><a href="#cb23-227" tabindex="-1"></a><span class="kw">var</span> ndviVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:-</span><span class="fl">0.2</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.8</span><span class="op">,</span>  <span class="dt">palette</span><span class="op">:</span> palette}</span>
<span id="cb23-228"><a href="#cb23-228" tabindex="-1"></a></span>
<span id="cb23-229"><a href="#cb23-229" tabindex="-1"></a><span class="kw">var</span> visualizeImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb23-230"><a href="#cb23-230" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">visualize</span>(ndviVis)<span class="op">.</span><span class="fu">clip</span>(bbox)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb23-231"><a href="#cb23-231" tabindex="-1"></a>}</span>
<span id="cb23-232"><a href="#cb23-232" tabindex="-1"></a></span>
<span id="cb23-233"><a href="#cb23-233" tabindex="-1"></a><span class="kw">var</span> visCollectionOriginal <span class="op">=</span> originalCollection<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb23-234"><a href="#cb23-234" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(visualizeImage)</span>
<span id="cb23-235"><a href="#cb23-235" tabindex="-1"></a></span>
<span id="cb23-236"><a href="#cb23-236" tabindex="-1"></a><span class="kw">var</span> visualizeIGapFilled <span class="op">=</span> gapFilledCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb23-237"><a href="#cb23-237" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(visualizeImage)</span>
<span id="cb23-238"><a href="#cb23-238" tabindex="-1"></a></span>
<span id="cb23-239"><a href="#cb23-239" tabindex="-1"></a></span>
<span id="cb23-240"><a href="#cb23-240" tabindex="-1"></a>Export<span class="op">.</span><span class="at">video</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb23-241"><a href="#cb23-241" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> visCollectionOriginal<span class="op">,</span></span>
<span id="cb23-242"><a href="#cb23-242" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Original_Time_Series&#39;</span><span class="op">,</span></span>
<span id="cb23-243"><a href="#cb23-243" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb23-244"><a href="#cb23-244" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;original&#39;</span><span class="op">,</span></span>
<span id="cb23-245"><a href="#cb23-245" tabindex="-1"></a>  <span class="dt">framesPerSecond</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb23-246"><a href="#cb23-246" tabindex="-1"></a>  <span class="dt">dimensions</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></span>
<span id="cb23-247"><a href="#cb23-247" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> bbox})</span>
<span id="cb23-248"><a href="#cb23-248" tabindex="-1"></a></span>
<span id="cb23-249"><a href="#cb23-249" tabindex="-1"></a>Export<span class="op">.</span><span class="at">video</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb23-250"><a href="#cb23-250" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> visualizeIGapFilled<span class="op">,</span></span>
<span id="cb23-251"><a href="#cb23-251" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Gap_Filled_Time_Series&#39;</span><span class="op">,</span></span>
<span id="cb23-252"><a href="#cb23-252" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb23-253"><a href="#cb23-253" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;gap_filled&#39;</span><span class="op">,</span></span>
<span id="cb23-254"><a href="#cb23-254" tabindex="-1"></a>  <span class="dt">framesPerSecond</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb23-255"><a href="#cb23-255" tabindex="-1"></a>  <span class="dt">dimensions</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></span>
<span id="cb23-256"><a href="#cb23-256" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> bbox}) </span></code></pre></div>
</div>
<div id="savitzky-golay-smoothing" class="section level2">
<h2>Savitzky-Golay Smoothing</h2>
<p>The Savitzky–Golay filter fits a polynomial to a set of data points
in a time-series. The <a
href="https://www.open-geocomputing.org/OpenEarthEngineLibrary/">Open
Earth Engine Library (OEEL)</a> provides an efficient implementation of
this filter that can be applied on an ImageCollection. However, the
time-series must be pre-processed so there are images at a regular
interval. We use the <a href="#temporal-interpolation">interpolation
technique</a> described in the previous section and prepare a continous
time-series without any masked pixels. The result is a new
ImageCollection containing images at a regular interval (5-day) and with
pixel values smoothed using the Savitzky–Golay filter.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/Savitzky_Golay_Smoothing.png" alt="Savitzky-Golay Smoothing" width="100%" />
<p class="caption">
Savitzky-Golay Smoothing
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FTime_Series_Smoothing%2FSavitzky_Golay_Smoothing"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co">// Aplying Savitzky-Golay Filter on a NDVI Time-Series</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="co">// This script uses the OEEL library to apply a </span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="co">// Savitzky-Golay filter on a imagecollection</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a><span class="co">// We require a regularly-spaced time-series without</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a><span class="co">// any masked pixels. So this script applies</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a><span class="co">// linear interpolation to created regularly spaced images</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a><span class="co">// from the original time-series</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a><span class="co">// Step-1: Prepare a NDVI Time-Series</span></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a><span class="co">// Step-2: Create an empty Time-Series with images at n days</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a><span class="co">// Step-3: Use Joins to find before/after images</span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a><span class="co">// Step-4: Apply linear interpolation to fill each image</span></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a><span class="co">// Step-5: Apply Savitzky-Golay filter</span></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a><span class="co">// Step-6: Visualize the results</span></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">74.80368345518073</span><span class="op">,</span> <span class="fl">30.391793042969</span>])<span class="op">;</span></span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2019</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2021</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a><span class="co">// Function to add a NDVI band to an image</span></span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addNDVI</span>(image) {</span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a>} </span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a></span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a><span class="co">// Function to mask clouds</span></span>
<span id="cb24-30"><a href="#cb24-30" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskS2clouds</span>(image) {</span>
<span id="cb24-31"><a href="#cb24-31" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)</span>
<span id="cb24-32"><a href="#cb24-32" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb24-33"><a href="#cb24-33" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb24-34"><a href="#cb24-34" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb24-35"><a href="#cb24-35" tabindex="-1"></a>             qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))</span>
<span id="cb24-36"><a href="#cb24-36" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb24-37"><a href="#cb24-37" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(<span class="st">&quot;B.*&quot;</span>)</span>
<span id="cb24-38"><a href="#cb24-38" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&quot;system:time_start&quot;</span>])</span>
<span id="cb24-39"><a href="#cb24-39" tabindex="-1"></a>}</span>
<span id="cb24-40"><a href="#cb24-40" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" tabindex="-1"></a><span class="kw">var</span> originalCollection <span class="op">=</span> s2</span>
<span id="cb24-42"><a href="#cb24-42" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb24-43"><a href="#cb24-43" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb24-44"><a href="#cb24-44" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb24-45"><a href="#cb24-45" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)</span>
<span id="cb24-46"><a href="#cb24-46" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(addNDVI)<span class="op">;</span></span>
<span id="cb24-47"><a href="#cb24-47" tabindex="-1"></a></span>
<span id="cb24-48"><a href="#cb24-48" tabindex="-1"></a></span>
<span id="cb24-49"><a href="#cb24-49" tabindex="-1"></a><span class="co">// Display a time-series chart</span></span>
<span id="cb24-50"><a href="#cb24-50" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb24-51"><a href="#cb24-51" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> originalCollection<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb24-52"><a href="#cb24-52" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb24-53"><a href="#cb24-53" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb24-54"><a href="#cb24-54" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span></span>
<span id="cb24-55"><a href="#cb24-55" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb24-56"><a href="#cb24-56" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Original NDVI Time Series&#39;</span><span class="op">,</span></span>
<span id="cb24-57"><a href="#cb24-57" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb24-58"><a href="#cb24-58" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI&#39;</span><span class="op">,</span> <span class="dt">viewWindow</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span>}}<span class="op">,</span></span>
<span id="cb24-59"><a href="#cb24-59" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MM&#39;</span>}<span class="op">,</span></span>
<span id="cb24-60"><a href="#cb24-60" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb24-61"><a href="#cb24-61" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb24-62"><a href="#cb24-62" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb24-63"><a href="#cb24-63" tabindex="-1"></a>        <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#238b45&#39;</span>}<span class="op">,</span></span>
<span id="cb24-64"><a href="#cb24-64" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb24-65"><a href="#cb24-65" tabindex="-1"></a></span>
<span id="cb24-66"><a href="#cb24-66" tabindex="-1"></a>    })</span>
<span id="cb24-67"><a href="#cb24-67" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb24-68"><a href="#cb24-68" tabindex="-1"></a></span>
<span id="cb24-69"><a href="#cb24-69" tabindex="-1"></a><span class="co">// Prepare a regularly-spaced Time-Series</span></span>
<span id="cb24-70"><a href="#cb24-70" tabindex="-1"></a></span>
<span id="cb24-71"><a href="#cb24-71" tabindex="-1"></a><span class="co">// Generate an empty multi-band image matching the bands</span></span>
<span id="cb24-72"><a href="#cb24-72" tabindex="-1"></a><span class="co">// in the original collection</span></span>
<span id="cb24-73"><a href="#cb24-73" tabindex="-1"></a><span class="kw">var</span> bandNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(originalCollection<span class="op">.</span><span class="fu">first</span>())<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb24-74"><a href="#cb24-74" tabindex="-1"></a><span class="kw">var</span> numBands <span class="op">=</span> bandNames<span class="op">.</span><span class="fu">size</span>()<span class="op">;</span></span>
<span id="cb24-75"><a href="#cb24-75" tabindex="-1"></a><span class="kw">var</span> initBands <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="fu">Image</span>()<span class="op">,</span> numBands)<span class="op">;</span></span>
<span id="cb24-76"><a href="#cb24-76" tabindex="-1"></a><span class="kw">var</span> initImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(initBands)<span class="op">.</span><span class="fu">toBands</span>()<span class="op">.</span><span class="fu">rename</span>(bandNames)</span>
<span id="cb24-77"><a href="#cb24-77" tabindex="-1"></a></span>
<span id="cb24-78"><a href="#cb24-78" tabindex="-1"></a><span class="co">// Select the interval. We will have 1 image every n days</span></span>
<span id="cb24-79"><a href="#cb24-79" tabindex="-1"></a><span class="kw">var</span> n <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb24-80"><a href="#cb24-80" tabindex="-1"></a><span class="kw">var</span> firstImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(originalCollection<span class="op">.</span><span class="fu">sort</span>(<span class="st">&#39;system:time_start&#39;</span>)<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb24-81"><a href="#cb24-81" tabindex="-1"></a><span class="kw">var</span> lastImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(originalCollection<span class="op">.</span><span class="fu">sort</span>(<span class="st">&#39;system:time_start&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb24-82"><a href="#cb24-82" tabindex="-1"></a><span class="kw">var</span> timeStart <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(firstImage<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;system:time_start&#39;</span>))</span>
<span id="cb24-83"><a href="#cb24-83" tabindex="-1"></a><span class="kw">var</span> timeEnd <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(lastImage<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;system:time_start&#39;</span>))</span>
<span id="cb24-84"><a href="#cb24-84" tabindex="-1"></a></span>
<span id="cb24-85"><a href="#cb24-85" tabindex="-1"></a><span class="kw">var</span> totalDays <span class="op">=</span> timeEnd<span class="op">.</span><span class="fu">difference</span>(timeStart<span class="op">,</span> <span class="st">&#39;day&#39;</span>)<span class="op">;</span></span>
<span id="cb24-86"><a href="#cb24-86" tabindex="-1"></a><span class="kw">var</span> daysToInterpolate <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">0</span><span class="op">,</span> totalDays<span class="op">,</span> n)</span>
<span id="cb24-87"><a href="#cb24-87" tabindex="-1"></a></span>
<span id="cb24-88"><a href="#cb24-88" tabindex="-1"></a><span class="kw">var</span> initImages <span class="op">=</span> daysToInterpolate<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(day) {</span>
<span id="cb24-89"><a href="#cb24-89" tabindex="-1"></a>  <span class="kw">var</span> image <span class="op">=</span> initImage<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb24-90"><a href="#cb24-90" tabindex="-1"></a>    <span class="st">&#39;system:index&#39;</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Number</span>(day)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%d&#39;</span>)<span class="op">,</span></span>
<span id="cb24-91"><a href="#cb24-91" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> timeStart<span class="op">.</span><span class="fu">advance</span>(day<span class="op">,</span> <span class="st">&#39;day&#39;</span>)<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb24-92"><a href="#cb24-92" tabindex="-1"></a>    <span class="co">// Set a property so we can identify interpolated images</span></span>
<span id="cb24-93"><a href="#cb24-93" tabindex="-1"></a>    <span class="st">&#39;type&#39;</span><span class="op">:</span> <span class="st">&#39;interpolated&#39;</span></span>
<span id="cb24-94"><a href="#cb24-94" tabindex="-1"></a>  })</span>
<span id="cb24-95"><a href="#cb24-95" tabindex="-1"></a>  <span class="cf">return</span> image</span>
<span id="cb24-96"><a href="#cb24-96" tabindex="-1"></a>})</span>
<span id="cb24-97"><a href="#cb24-97" tabindex="-1"></a></span>
<span id="cb24-98"><a href="#cb24-98" tabindex="-1"></a><span class="kw">var</span> initCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(initImages)</span>
<span id="cb24-99"><a href="#cb24-99" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Empty Collection&#39;</span><span class="op">,</span> initCol)</span>
<span id="cb24-100"><a href="#cb24-100" tabindex="-1"></a></span>
<span id="cb24-101"><a href="#cb24-101" tabindex="-1"></a><span class="co">// Merge original and empty collections</span></span>
<span id="cb24-102"><a href="#cb24-102" tabindex="-1"></a><span class="kw">var</span> originalCollection <span class="op">=</span> originalCollection<span class="op">.</span><span class="fu">merge</span>(initCol)</span>
<span id="cb24-103"><a href="#cb24-103" tabindex="-1"></a></span>
<span id="cb24-104"><a href="#cb24-104" tabindex="-1"></a><span class="co">// Interpolation</span></span>
<span id="cb24-105"><a href="#cb24-105" tabindex="-1"></a></span>
<span id="cb24-106"><a href="#cb24-106" tabindex="-1"></a><span class="co">// Add a band containing timestamp to each image</span></span>
<span id="cb24-107"><a href="#cb24-107" tabindex="-1"></a><span class="co">// This will be used to do pixel-wise interpolation later</span></span>
<span id="cb24-108"><a href="#cb24-108" tabindex="-1"></a><span class="kw">var</span> originalCollection <span class="op">=</span> originalCollection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb24-109"><a href="#cb24-109" tabindex="-1"></a>  <span class="kw">var</span> timeImage <span class="op">=</span> image<span class="op">.</span><span class="fu">metadata</span>(<span class="st">&#39;system:time_start&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;timestamp&#39;</span>)</span>
<span id="cb24-110"><a href="#cb24-110" tabindex="-1"></a>  <span class="co">// The time image doesn&#39;t have a mask. </span></span>
<span id="cb24-111"><a href="#cb24-111" tabindex="-1"></a>  <span class="co">// We set the mask of the time band to be the same as the first band of the image</span></span>
<span id="cb24-112"><a href="#cb24-112" tabindex="-1"></a>  <span class="kw">var</span> timeImageMasked <span class="op">=</span> timeImage<span class="op">.</span><span class="fu">updateMask</span>(image<span class="op">.</span><span class="fu">mask</span>()<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>))</span>
<span id="cb24-113"><a href="#cb24-113" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(timeImageMasked)<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb24-114"><a href="#cb24-114" tabindex="-1"></a>})</span>
<span id="cb24-115"><a href="#cb24-115" tabindex="-1"></a></span>
<span id="cb24-116"><a href="#cb24-116" tabindex="-1"></a><span class="co">// For each image in the collection, we need to find all images</span></span>
<span id="cb24-117"><a href="#cb24-117" tabindex="-1"></a><span class="co">// before and after the specified time-window</span></span>
<span id="cb24-118"><a href="#cb24-118" tabindex="-1"></a></span>
<span id="cb24-119"><a href="#cb24-119" tabindex="-1"></a><span class="co">// This is accomplished using Joins</span></span>
<span id="cb24-120"><a href="#cb24-120" tabindex="-1"></a><span class="co">// We need to do 2 joins</span></span>
<span id="cb24-121"><a href="#cb24-121" tabindex="-1"></a><span class="co">// Join 1: Join the collection with itself to find all images before each image</span></span>
<span id="cb24-122"><a href="#cb24-122" tabindex="-1"></a><span class="co">// Join 2: Join the collection with itself to find all images after each image</span></span>
<span id="cb24-123"><a href="#cb24-123" tabindex="-1"></a></span>
<span id="cb24-124"><a href="#cb24-124" tabindex="-1"></a><span class="co">// We first define the filters needed for the join</span></span>
<span id="cb24-125"><a href="#cb24-125" tabindex="-1"></a></span>
<span id="cb24-126"><a href="#cb24-126" tabindex="-1"></a><span class="co">// Define a maxDifference filter to find all images within the specified days</span></span>
<span id="cb24-127"><a href="#cb24-127" tabindex="-1"></a><span class="co">// The filter needs the time difference in milliseconds</span></span>
<span id="cb24-128"><a href="#cb24-128" tabindex="-1"></a><span class="co">// Convert days to milliseconds</span></span>
<span id="cb24-129"><a href="#cb24-129" tabindex="-1"></a></span>
<span id="cb24-130"><a href="#cb24-130" tabindex="-1"></a><span class="co">// Specify the time-window to look for unmasked pixel</span></span>
<span id="cb24-131"><a href="#cb24-131" tabindex="-1"></a><span class="kw">var</span> days <span class="op">=</span> <span class="dv">45</span><span class="op">;</span></span>
<span id="cb24-132"><a href="#cb24-132" tabindex="-1"></a><span class="kw">var</span> millis <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(days)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1000</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">24</span>)</span>
<span id="cb24-133"><a href="#cb24-133" tabindex="-1"></a></span>
<span id="cb24-134"><a href="#cb24-134" tabindex="-1"></a><span class="kw">var</span> maxDiffFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">maxDifference</span>({</span>
<span id="cb24-135"><a href="#cb24-135" tabindex="-1"></a>  <span class="dt">difference</span><span class="op">:</span> millis<span class="op">,</span></span>
<span id="cb24-136"><a href="#cb24-136" tabindex="-1"></a>  <span class="dt">leftField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb24-137"><a href="#cb24-137" tabindex="-1"></a>  <span class="dt">rightField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span></span>
<span id="cb24-138"><a href="#cb24-138" tabindex="-1"></a>})</span>
<span id="cb24-139"><a href="#cb24-139" tabindex="-1"></a></span>
<span id="cb24-140"><a href="#cb24-140" tabindex="-1"></a><span class="co">// We need a lessThanOrEquals filter to find all images after a given image</span></span>
<span id="cb24-141"><a href="#cb24-141" tabindex="-1"></a><span class="co">// This will compare the given image&#39;s timestamp against other images&#39; timestamps</span></span>
<span id="cb24-142"><a href="#cb24-142" tabindex="-1"></a><span class="kw">var</span> lessEqFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lessThanOrEquals</span>({</span>
<span id="cb24-143"><a href="#cb24-143" tabindex="-1"></a>  <span class="dt">leftField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb24-144"><a href="#cb24-144" tabindex="-1"></a>  <span class="dt">rightField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span></span>
<span id="cb24-145"><a href="#cb24-145" tabindex="-1"></a>})</span>
<span id="cb24-146"><a href="#cb24-146" tabindex="-1"></a></span>
<span id="cb24-147"><a href="#cb24-147" tabindex="-1"></a><span class="co">// We need a greaterThanOrEquals filter to find all images before a given image</span></span>
<span id="cb24-148"><a href="#cb24-148" tabindex="-1"></a><span class="co">// This will compare the given image&#39;s timestamp against other images&#39; timestamps</span></span>
<span id="cb24-149"><a href="#cb24-149" tabindex="-1"></a><span class="kw">var</span> greaterEqFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">greaterThanOrEquals</span>({</span>
<span id="cb24-150"><a href="#cb24-150" tabindex="-1"></a>  <span class="dt">leftField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb24-151"><a href="#cb24-151" tabindex="-1"></a>  <span class="dt">rightField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span></span>
<span id="cb24-152"><a href="#cb24-152" tabindex="-1"></a>})</span>
<span id="cb24-153"><a href="#cb24-153" tabindex="-1"></a></span>
<span id="cb24-154"><a href="#cb24-154" tabindex="-1"></a></span>
<span id="cb24-155"><a href="#cb24-155" tabindex="-1"></a><span class="co">// Apply the joins</span></span>
<span id="cb24-156"><a href="#cb24-156" tabindex="-1"></a></span>
<span id="cb24-157"><a href="#cb24-157" tabindex="-1"></a><span class="co">// For the first join, we need to match all images that are after the given image.</span></span>
<span id="cb24-158"><a href="#cb24-158" tabindex="-1"></a><span class="co">// To do this we need to match 2 conditions</span></span>
<span id="cb24-159"><a href="#cb24-159" tabindex="-1"></a><span class="co">// 1. The resulting images must be within the specified time-window of target image</span></span>
<span id="cb24-160"><a href="#cb24-160" tabindex="-1"></a><span class="co">// 2. The target image&#39;s timestamp must be lesser than the timestamp of resulting images</span></span>
<span id="cb24-161"><a href="#cb24-161" tabindex="-1"></a><span class="co">// Combine two filters to match both these conditions</span></span>
<span id="cb24-162"><a href="#cb24-162" tabindex="-1"></a><span class="kw">var</span> filter1 <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(maxDiffFilter<span class="op">,</span> lessEqFilter)</span>
<span id="cb24-163"><a href="#cb24-163" tabindex="-1"></a><span class="co">// This join will find all images after, sorted in descending order</span></span>
<span id="cb24-164"><a href="#cb24-164" tabindex="-1"></a><span class="co">// This will gives us images so that closest is last</span></span>
<span id="cb24-165"><a href="#cb24-165" tabindex="-1"></a><span class="kw">var</span> join1 <span class="op">=</span> ee<span class="op">.</span><span class="at">Join</span><span class="op">.</span><span class="fu">saveAll</span>({</span>
<span id="cb24-166"><a href="#cb24-166" tabindex="-1"></a>  <span class="dt">matchesKey</span><span class="op">:</span> <span class="st">&#39;after&#39;</span><span class="op">,</span></span>
<span id="cb24-167"><a href="#cb24-167" tabindex="-1"></a>  <span class="dt">ordering</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb24-168"><a href="#cb24-168" tabindex="-1"></a>  <span class="dt">ascending</span><span class="op">:</span> <span class="kw">false</span>})</span>
<span id="cb24-169"><a href="#cb24-169" tabindex="-1"></a>  </span>
<span id="cb24-170"><a href="#cb24-170" tabindex="-1"></a><span class="kw">var</span> join1Result <span class="op">=</span> join1<span class="op">.</span><span class="fu">apply</span>({</span>
<span id="cb24-171"><a href="#cb24-171" tabindex="-1"></a>  <span class="dt">primary</span><span class="op">:</span> originalCollection<span class="op">,</span></span>
<span id="cb24-172"><a href="#cb24-172" tabindex="-1"></a>  <span class="dt">secondary</span><span class="op">:</span> originalCollection<span class="op">,</span></span>
<span id="cb24-173"><a href="#cb24-173" tabindex="-1"></a>  <span class="dt">condition</span><span class="op">:</span> filter1</span>
<span id="cb24-174"><a href="#cb24-174" tabindex="-1"></a>})</span>
<span id="cb24-175"><a href="#cb24-175" tabindex="-1"></a><span class="co">// Each image now as a property called &#39;after&#39; containing</span></span>
<span id="cb24-176"><a href="#cb24-176" tabindex="-1"></a><span class="co">// all images that come after it within the time-window</span></span>
<span id="cb24-177"><a href="#cb24-177" tabindex="-1"></a><span class="fu">print</span>(join1Result<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb24-178"><a href="#cb24-178" tabindex="-1"></a></span>
<span id="cb24-179"><a href="#cb24-179" tabindex="-1"></a><span class="co">// Do the second join now to match all images within the time-window</span></span>
<span id="cb24-180"><a href="#cb24-180" tabindex="-1"></a><span class="co">// that come before each image</span></span>
<span id="cb24-181"><a href="#cb24-181" tabindex="-1"></a><span class="kw">var</span> filter2 <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(maxDiffFilter<span class="op">,</span> greaterEqFilter)</span>
<span id="cb24-182"><a href="#cb24-182" tabindex="-1"></a><span class="co">// This join will find all images before, sorted in ascending order</span></span>
<span id="cb24-183"><a href="#cb24-183" tabindex="-1"></a><span class="co">// This will gives us images so that closest is last</span></span>
<span id="cb24-184"><a href="#cb24-184" tabindex="-1"></a><span class="kw">var</span> join2 <span class="op">=</span> ee<span class="op">.</span><span class="at">Join</span><span class="op">.</span><span class="fu">saveAll</span>({</span>
<span id="cb24-185"><a href="#cb24-185" tabindex="-1"></a>  <span class="dt">matchesKey</span><span class="op">:</span> <span class="st">&#39;before&#39;</span><span class="op">,</span></span>
<span id="cb24-186"><a href="#cb24-186" tabindex="-1"></a>  <span class="dt">ordering</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb24-187"><a href="#cb24-187" tabindex="-1"></a>  <span class="dt">ascending</span><span class="op">:</span> <span class="kw">true</span>})</span>
<span id="cb24-188"><a href="#cb24-188" tabindex="-1"></a>  </span>
<span id="cb24-189"><a href="#cb24-189" tabindex="-1"></a><span class="kw">var</span> join2Result <span class="op">=</span> join2<span class="op">.</span><span class="fu">apply</span>({</span>
<span id="cb24-190"><a href="#cb24-190" tabindex="-1"></a>  <span class="dt">primary</span><span class="op">:</span> join1Result<span class="op">,</span></span>
<span id="cb24-191"><a href="#cb24-191" tabindex="-1"></a>  <span class="dt">secondary</span><span class="op">:</span> join1Result<span class="op">,</span></span>
<span id="cb24-192"><a href="#cb24-192" tabindex="-1"></a>  <span class="dt">condition</span><span class="op">:</span> filter2</span>
<span id="cb24-193"><a href="#cb24-193" tabindex="-1"></a>})</span>
<span id="cb24-194"><a href="#cb24-194" tabindex="-1"></a></span>
<span id="cb24-195"><a href="#cb24-195" tabindex="-1"></a><span class="co">// Each image now as a property called &#39;before&#39; containing</span></span>
<span id="cb24-196"><a href="#cb24-196" tabindex="-1"></a><span class="co">// all images that come after it within the time-window</span></span>
<span id="cb24-197"><a href="#cb24-197" tabindex="-1"></a><span class="fu">print</span>(join2Result<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb24-198"><a href="#cb24-198" tabindex="-1"></a></span>
<span id="cb24-199"><a href="#cb24-199" tabindex="-1"></a><span class="kw">var</span> joinedCol <span class="op">=</span> join2Result<span class="op">;</span></span>
<span id="cb24-200"><a href="#cb24-200" tabindex="-1"></a></span>
<span id="cb24-201"><a href="#cb24-201" tabindex="-1"></a><span class="co">// Do the interpolation</span></span>
<span id="cb24-202"><a href="#cb24-202" tabindex="-1"></a></span>
<span id="cb24-203"><a href="#cb24-203" tabindex="-1"></a><span class="co">// We now write a function that will be used to interpolate all images</span></span>
<span id="cb24-204"><a href="#cb24-204" tabindex="-1"></a><span class="co">// This function takes an image and replaces the masked pixels</span></span>
<span id="cb24-205"><a href="#cb24-205" tabindex="-1"></a><span class="co">// with the interpolated value from before and after images.</span></span>
<span id="cb24-206"><a href="#cb24-206" tabindex="-1"></a></span>
<span id="cb24-207"><a href="#cb24-207" tabindex="-1"></a><span class="kw">var</span> interpolateImages <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb24-208"><a href="#cb24-208" tabindex="-1"></a>  <span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(image)<span class="op">;</span></span>
<span id="cb24-209"><a href="#cb24-209" tabindex="-1"></a>  <span class="co">// We get the list of before and after images from the image property</span></span>
<span id="cb24-210"><a href="#cb24-210" tabindex="-1"></a>  <span class="co">// Mosaic the images so we a before and after image with the closest unmasked pixel</span></span>
<span id="cb24-211"><a href="#cb24-211" tabindex="-1"></a>  <span class="kw">var</span> beforeImages <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;before&#39;</span>))</span>
<span id="cb24-212"><a href="#cb24-212" tabindex="-1"></a>  <span class="kw">var</span> beforeMosaic <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(beforeImages)<span class="op">.</span><span class="fu">mosaic</span>()</span>
<span id="cb24-213"><a href="#cb24-213" tabindex="-1"></a>  <span class="kw">var</span> afterImages <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;after&#39;</span>))</span>
<span id="cb24-214"><a href="#cb24-214" tabindex="-1"></a>  <span class="kw">var</span> afterMosaic <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(afterImages)<span class="op">.</span><span class="fu">mosaic</span>()</span>
<span id="cb24-215"><a href="#cb24-215" tabindex="-1"></a></span>
<span id="cb24-216"><a href="#cb24-216" tabindex="-1"></a>  <span class="co">// Interpolation formula</span></span>
<span id="cb24-217"><a href="#cb24-217" tabindex="-1"></a>  <span class="co">// y = y1 + (y2-y1)*((t – t1) / (t2 – t1))</span></span>
<span id="cb24-218"><a href="#cb24-218" tabindex="-1"></a>  <span class="co">// y = interpolated image</span></span>
<span id="cb24-219"><a href="#cb24-219" tabindex="-1"></a>  <span class="co">// y1 = before image</span></span>
<span id="cb24-220"><a href="#cb24-220" tabindex="-1"></a>  <span class="co">// y2 = after image</span></span>
<span id="cb24-221"><a href="#cb24-221" tabindex="-1"></a>  <span class="co">// t = interpolation timestamp</span></span>
<span id="cb24-222"><a href="#cb24-222" tabindex="-1"></a>  <span class="co">// t1 = before image timestamp</span></span>
<span id="cb24-223"><a href="#cb24-223" tabindex="-1"></a>  <span class="co">// t2 = after image timestamp</span></span>
<span id="cb24-224"><a href="#cb24-224" tabindex="-1"></a>  </span>
<span id="cb24-225"><a href="#cb24-225" tabindex="-1"></a>  <span class="co">// We first compute the ratio (t – t1) / (t2 – t1)</span></span>
<span id="cb24-226"><a href="#cb24-226" tabindex="-1"></a></span>
<span id="cb24-227"><a href="#cb24-227" tabindex="-1"></a>  <span class="co">// Get image with before and after times</span></span>
<span id="cb24-228"><a href="#cb24-228" tabindex="-1"></a>  <span class="kw">var</span> t1 <span class="op">=</span> beforeMosaic<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;timestamp&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;t1&#39;</span>)</span>
<span id="cb24-229"><a href="#cb24-229" tabindex="-1"></a>  <span class="kw">var</span> t2 <span class="op">=</span> afterMosaic<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;timestamp&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;t2&#39;</span>)</span>
<span id="cb24-230"><a href="#cb24-230" tabindex="-1"></a></span>
<span id="cb24-231"><a href="#cb24-231" tabindex="-1"></a>  <span class="kw">var</span> t <span class="op">=</span> image<span class="op">.</span><span class="fu">metadata</span>(<span class="st">&#39;system:time_start&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;t&#39;</span>)</span>
<span id="cb24-232"><a href="#cb24-232" tabindex="-1"></a></span>
<span id="cb24-233"><a href="#cb24-233" tabindex="-1"></a>  <span class="kw">var</span> timeImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>([t1<span class="op">,</span> t2<span class="op">,</span> t])</span>
<span id="cb24-234"><a href="#cb24-234" tabindex="-1"></a></span>
<span id="cb24-235"><a href="#cb24-235" tabindex="-1"></a>  <span class="kw">var</span> timeRatio <span class="op">=</span> timeImage<span class="op">.</span><span class="fu">expression</span>(<span class="st">&#39;(t - t1) / (t2 - t1)&#39;</span><span class="op">,</span> {</span>
<span id="cb24-236"><a href="#cb24-236" tabindex="-1"></a>    <span class="st">&#39;t&#39;</span><span class="op">:</span> timeImage<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;t&#39;</span>)<span class="op">,</span></span>
<span id="cb24-237"><a href="#cb24-237" tabindex="-1"></a>    <span class="st">&#39;t1&#39;</span><span class="op">:</span> timeImage<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;t1&#39;</span>)<span class="op">,</span></span>
<span id="cb24-238"><a href="#cb24-238" tabindex="-1"></a>    <span class="st">&#39;t2&#39;</span><span class="op">:</span> timeImage<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;t2&#39;</span>)<span class="op">,</span></span>
<span id="cb24-239"><a href="#cb24-239" tabindex="-1"></a>  })</span>
<span id="cb24-240"><a href="#cb24-240" tabindex="-1"></a>  <span class="co">// You can replace timeRatio with a constant value 0.5</span></span>
<span id="cb24-241"><a href="#cb24-241" tabindex="-1"></a>  <span class="co">// if you wanted a simple average</span></span>
<span id="cb24-242"><a href="#cb24-242" tabindex="-1"></a>  </span>
<span id="cb24-243"><a href="#cb24-243" tabindex="-1"></a>  <span class="co">// Compute an image with the interpolated image y</span></span>
<span id="cb24-244"><a href="#cb24-244" tabindex="-1"></a>  <span class="kw">var</span> interpolated <span class="op">=</span> beforeMosaic</span>
<span id="cb24-245"><a href="#cb24-245" tabindex="-1"></a>    <span class="op">.</span><span class="fu">add</span>((afterMosaic<span class="op">.</span><span class="fu">subtract</span>(beforeMosaic)<span class="op">.</span><span class="fu">multiply</span>(timeRatio)))</span>
<span id="cb24-246"><a href="#cb24-246" tabindex="-1"></a>  <span class="co">// Replace the masked pixels in the current image with the average value</span></span>
<span id="cb24-247"><a href="#cb24-247" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> image<span class="op">.</span><span class="fu">unmask</span>(interpolated)</span>
<span id="cb24-248"><a href="#cb24-248" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb24-249"><a href="#cb24-249" tabindex="-1"></a>}</span>
<span id="cb24-250"><a href="#cb24-250" tabindex="-1"></a></span>
<span id="cb24-251"><a href="#cb24-251" tabindex="-1"></a><span class="co">// map() the function to interpolate all images in the collection</span></span>
<span id="cb24-252"><a href="#cb24-252" tabindex="-1"></a><span class="kw">var</span> interpolatedCol <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(joinedCol<span class="op">.</span><span class="fu">map</span>(interpolateImages))</span>
<span id="cb24-253"><a href="#cb24-253" tabindex="-1"></a></span>
<span id="cb24-254"><a href="#cb24-254" tabindex="-1"></a><span class="co">// Once the interpolation are done, remove original images</span></span>
<span id="cb24-255"><a href="#cb24-255" tabindex="-1"></a><span class="co">// We keep only the generated interpolated images</span></span>
<span id="cb24-256"><a href="#cb24-256" tabindex="-1"></a><span class="kw">var</span> regularCol <span class="op">=</span> interpolatedCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;type&#39;</span><span class="op">,</span> <span class="st">&#39;interpolated&#39;</span>))</span>
<span id="cb24-257"><a href="#cb24-257" tabindex="-1"></a></span>
<span id="cb24-258"><a href="#cb24-258" tabindex="-1"></a></span>
<span id="cb24-259"><a href="#cb24-259" tabindex="-1"></a><span class="co">// Display a time-series chart</span></span>
<span id="cb24-260"><a href="#cb24-260" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb24-261"><a href="#cb24-261" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> regularCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb24-262"><a href="#cb24-262" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb24-263"><a href="#cb24-263" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb24-264"><a href="#cb24-264" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span></span>
<span id="cb24-265"><a href="#cb24-265" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb24-266"><a href="#cb24-266" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Regular NDVI Time Series&#39;</span><span class="op">,</span></span>
<span id="cb24-267"><a href="#cb24-267" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb24-268"><a href="#cb24-268" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI&#39;</span><span class="op">,</span> <span class="dt">viewWindow</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span>}}<span class="op">,</span></span>
<span id="cb24-269"><a href="#cb24-269" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MM&#39;</span>}<span class="op">,</span></span>
<span id="cb24-270"><a href="#cb24-270" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb24-271"><a href="#cb24-271" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb24-272"><a href="#cb24-272" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb24-273"><a href="#cb24-273" tabindex="-1"></a>        <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#238b45&#39;</span>}<span class="op">,</span></span>
<span id="cb24-274"><a href="#cb24-274" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb24-275"><a href="#cb24-275" tabindex="-1"></a>    })</span>
<span id="cb24-276"><a href="#cb24-276" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb24-277"><a href="#cb24-277" tabindex="-1"></a></span>
<span id="cb24-278"><a href="#cb24-278" tabindex="-1"></a></span>
<span id="cb24-279"><a href="#cb24-279" tabindex="-1"></a><span class="co">// SavatskyGolayFilter</span></span>
<span id="cb24-280"><a href="#cb24-280" tabindex="-1"></a><span class="co">// https://www.open-geocomputing.org/OpenEarthEngineLibrary/#.ImageCollection.SavatskyGolayFilter</span></span>
<span id="cb24-281"><a href="#cb24-281" tabindex="-1"></a></span>
<span id="cb24-282"><a href="#cb24-282" tabindex="-1"></a><span class="co">// Use the default distanceFunction</span></span>
<span id="cb24-283"><a href="#cb24-283" tabindex="-1"></a><span class="kw">var</span> distanceFunction <span class="op">=</span> <span class="kw">function</span>(infromedImage<span class="op">,</span> estimationImage) {</span>
<span id="cb24-284"><a href="#cb24-284" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(</span>
<span id="cb24-285"><a href="#cb24-285" tabindex="-1"></a>      ee<span class="op">.</span><span class="fu">Number</span>(infromedImage<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;system:time_start&#39;</span>))</span>
<span id="cb24-286"><a href="#cb24-286" tabindex="-1"></a>      <span class="op">.</span><span class="fu">subtract</span>(</span>
<span id="cb24-287"><a href="#cb24-287" tabindex="-1"></a>        ee<span class="op">.</span><span class="fu">Number</span>(estimationImage<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;system:time_start&#39;</span>)))</span>
<span id="cb24-288"><a href="#cb24-288" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb24-289"><a href="#cb24-289" tabindex="-1"></a>  }</span>
<span id="cb24-290"><a href="#cb24-290" tabindex="-1"></a></span>
<span id="cb24-291"><a href="#cb24-291" tabindex="-1"></a><span class="co">// Apply smoothing</span></span>
<span id="cb24-292"><a href="#cb24-292" tabindex="-1"></a></span>
<span id="cb24-293"><a href="#cb24-293" tabindex="-1"></a><span class="kw">var</span> oeel<span class="op">=</span><span class="pp">require</span>(<span class="st">&#39;users/OEEL/lib:loadAll&#39;</span>)<span class="op">;</span></span>
<span id="cb24-294"><a href="#cb24-294" tabindex="-1"></a></span>
<span id="cb24-295"><a href="#cb24-295" tabindex="-1"></a><span class="kw">var</span> order <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb24-296"><a href="#cb24-296" tabindex="-1"></a></span>
<span id="cb24-297"><a href="#cb24-297" tabindex="-1"></a><span class="kw">var</span> sgFilteredCol <span class="op">=</span> oeel<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">SavatskyGolayFilter</span>(</span>
<span id="cb24-298"><a href="#cb24-298" tabindex="-1"></a>  regularCol<span class="op">,</span> </span>
<span id="cb24-299"><a href="#cb24-299" tabindex="-1"></a>  maxDiffFilter<span class="op">,</span></span>
<span id="cb24-300"><a href="#cb24-300" tabindex="-1"></a>  distanceFunction<span class="op">,</span></span>
<span id="cb24-301"><a href="#cb24-301" tabindex="-1"></a>  order)</span>
<span id="cb24-302"><a href="#cb24-302" tabindex="-1"></a></span>
<span id="cb24-303"><a href="#cb24-303" tabindex="-1"></a><span class="fu">print</span>(sgFilteredCol<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb24-304"><a href="#cb24-304" tabindex="-1"></a><span class="co">// Display a time-series chart</span></span>
<span id="cb24-305"><a href="#cb24-305" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb24-306"><a href="#cb24-306" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> sgFilteredCol<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;ndvi&#39;</span><span class="op">,</span> <span class="st">&#39;d_0_ndvi&#39;</span>]<span class="op">,</span> [<span class="st">&#39;ndvi&#39;</span><span class="op">,</span> <span class="st">&#39;ndvi_sg&#39;</span>])<span class="op">,</span></span>
<span id="cb24-307"><a href="#cb24-307" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb24-308"><a href="#cb24-308" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb24-309"><a href="#cb24-309" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span></span>
<span id="cb24-310"><a href="#cb24-310" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb24-311"><a href="#cb24-311" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb24-312"><a href="#cb24-312" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI Time Series&#39;</span><span class="op">,</span></span>
<span id="cb24-313"><a href="#cb24-313" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb24-314"><a href="#cb24-314" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI&#39;</span><span class="op">,</span> <span class="dt">viewWindow</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span>}}<span class="op">,</span></span>
<span id="cb24-315"><a href="#cb24-315" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MM&#39;</span>}<span class="op">,</span></span>
<span id="cb24-316"><a href="#cb24-316" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb24-317"><a href="#cb24-317" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb24-318"><a href="#cb24-318" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb24-319"><a href="#cb24-319" tabindex="-1"></a>        <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#66c2a4&#39;</span><span class="op">,</span> <span class="dt">lineDashStyle</span><span class="op">:</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">2</span>}<span class="op">,</span> <span class="co">// Original NDVI</span></span>
<span id="cb24-320"><a href="#cb24-320" tabindex="-1"></a>        <span class="dv">1</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#238b45&#39;</span><span class="op">,</span> <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">2</span> }<span class="op">,</span> <span class="co">// Smoothed NDVI</span></span>
<span id="cb24-321"><a href="#cb24-321" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb24-322"><a href="#cb24-322" tabindex="-1"></a></span>
<span id="cb24-323"><a href="#cb24-323" tabindex="-1"></a>    })</span>
<span id="cb24-324"><a href="#cb24-324" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb24-325"><a href="#cb24-325" tabindex="-1"></a></span>
<span id="cb24-326"><a href="#cb24-326" tabindex="-1"></a></span>
<span id="cb24-327"><a href="#cb24-327" tabindex="-1"></a><span class="co">// Let&#39;s visualize the NDVI time-series</span></span>
<span id="cb24-328"><a href="#cb24-328" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">16</span>)<span class="op">;</span></span>
<span id="cb24-329"><a href="#cb24-329" tabindex="-1"></a><span class="kw">var</span> bbox <span class="op">=</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">getBounds</span>({<span class="dt">asGeoJSON</span><span class="op">:</span> <span class="kw">true</span>})<span class="op">;</span></span>
<span id="cb24-330"><a href="#cb24-330" tabindex="-1"></a></span>
<span id="cb24-331"><a href="#cb24-331" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#d73027&#39;</span><span class="op">,</span><span class="st">&#39;#f46d43&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span><span class="st">&#39;#fee08b&#39;</span><span class="op">,</span><span class="st">&#39;#ffffbf&#39;</span><span class="op">,</span><span class="st">&#39;#d9ef8b&#39;</span><span class="op">,</span><span class="st">&#39;#a6d96a&#39;</span><span class="op">,</span><span class="st">&#39;#66bd63&#39;</span><span class="op">,</span><span class="st">&#39;#1a9850&#39;</span>]<span class="op">;</span></span>
<span id="cb24-332"><a href="#cb24-332" tabindex="-1"></a><span class="kw">var</span> ndviVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:-</span><span class="fl">0.2</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.8</span><span class="op">,</span>  <span class="dt">palette</span><span class="op">:</span> palette}</span>
<span id="cb24-333"><a href="#cb24-333" tabindex="-1"></a></span>
<span id="cb24-334"><a href="#cb24-334" tabindex="-1"></a><span class="kw">var</span> visualizeImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb24-335"><a href="#cb24-335" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">visualize</span>(ndviVis)<span class="op">.</span><span class="fu">clip</span>(bbox)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb24-336"><a href="#cb24-336" tabindex="-1"></a>}</span>
<span id="cb24-337"><a href="#cb24-337" tabindex="-1"></a></span>
<span id="cb24-338"><a href="#cb24-338" tabindex="-1"></a><span class="kw">var</span> visCollectionRegular <span class="op">=</span> regularCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb24-339"><a href="#cb24-339" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(visualizeImage)</span>
<span id="cb24-340"><a href="#cb24-340" tabindex="-1"></a></span>
<span id="cb24-341"><a href="#cb24-341" tabindex="-1"></a><span class="kw">var</span> visualizeSgFiltered <span class="op">=</span> sgFilteredCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;d_0_ndvi&#39;</span>)</span>
<span id="cb24-342"><a href="#cb24-342" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(visualizeImage)</span>
<span id="cb24-343"><a href="#cb24-343" tabindex="-1"></a></span>
<span id="cb24-344"><a href="#cb24-344" tabindex="-1"></a></span>
<span id="cb24-345"><a href="#cb24-345" tabindex="-1"></a>Export<span class="op">.</span><span class="at">video</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb24-346"><a href="#cb24-346" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> visCollectionRegular<span class="op">,</span></span>
<span id="cb24-347"><a href="#cb24-347" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Regular_Time_Series&#39;</span><span class="op">,</span></span>
<span id="cb24-348"><a href="#cb24-348" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb24-349"><a href="#cb24-349" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;regular&#39;</span><span class="op">,</span></span>
<span id="cb24-350"><a href="#cb24-350" tabindex="-1"></a>  <span class="dt">framesPerSecond</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb24-351"><a href="#cb24-351" tabindex="-1"></a>  <span class="dt">dimensions</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></span>
<span id="cb24-352"><a href="#cb24-352" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> bbox})</span>
<span id="cb24-353"><a href="#cb24-353" tabindex="-1"></a>  </span>
<span id="cb24-354"><a href="#cb24-354" tabindex="-1"></a>Export<span class="op">.</span><span class="at">video</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb24-355"><a href="#cb24-355" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> visualizeSgFiltered<span class="op">,</span></span>
<span id="cb24-356"><a href="#cb24-356" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Filtered_Time_Series&#39;</span><span class="op">,</span></span>
<span id="cb24-357"><a href="#cb24-357" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb24-358"><a href="#cb24-358" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;sg_filtered&#39;</span><span class="op">,</span></span>
<span id="cb24-359"><a href="#cb24-359" tabindex="-1"></a>  <span class="dt">framesPerSecond</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb24-360"><a href="#cb24-360" tabindex="-1"></a>  <span class="dt">dimensions</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></span>
<span id="cb24-361"><a href="#cb24-361" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> bbox})</span></code></pre></div>
</div>
</div>
<div id="user-interface-templates" class="section level1">
<h1>User Interface Templates</h1>
<div id="adding-a-discrete-legend" class="section level2">
<h2>Adding a Discrete Legend</h2>
<p>You may want to add a legend for a classified image to your map
visualization in your App. Here’s a code snippet that shows how you can
build it using the UI Widgets.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/map_legend.png" alt="Creating a Discrete Map Legend" width="100%" />
<p class="caption">
Creating a Discrete Map Legend
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FUI_Widgets_and_Apps%2FMap_Legend"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;users/ujavalgandhi/e2e/bangalore_classified&quot;</span>)</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(classified)</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span>]<span class="op">;</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="kw">var</span> legend <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({<span class="dt">style</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">&#39;middle-right&#39;</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">&#39;8px 15px&#39;</span>}})<span class="op">;</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="kw">var</span> makeRow <span class="op">=</span> <span class="kw">function</span>(color<span class="op">,</span> name) {</span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>  <span class="kw">var</span> colorBox <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#ffffff&#39;</span><span class="op">,</span></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a>      <span class="dt">backgroundColor</span><span class="op">:</span> color<span class="op">,</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a>      <span class="dt">padding</span><span class="op">:</span> <span class="st">&#39;10px&#39;</span><span class="op">,</span></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a>      <span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;0 0 4px 0&#39;</span><span class="op">,</span></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>    }</span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a>  <span class="kw">var</span> description <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>    <span class="dt">value</span><span class="op">:</span> name<span class="op">,</span></span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a>      <span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;0px 0 4px 6px&#39;</span><span class="op">,</span></span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a>    }</span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a>  })<span class="op">;</span> </span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a>  <span class="cf">return</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a>    <span class="dt">widgets</span><span class="op">:</span> [colorBox<span class="op">,</span> description]<span class="op">,</span></span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a>    <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">Flow</span>(<span class="st">&#39;horizontal&#39;</span>)}</span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a>)}<span class="op">;</span></span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a><span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb25-28"><a href="#cb25-28" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;Legend&#39;</span><span class="op">,</span></span>
<span id="cb25-29"><a href="#cb25-29" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontWeight</span><span class="op">:</span> <span class="st">&#39;bold&#39;</span><span class="op">,</span></span>
<span id="cb25-30"><a href="#cb25-30" tabindex="-1"></a>    <span class="dt">fontSize</span><span class="op">:</span> <span class="st">&#39;16px&#39;</span><span class="op">,</span></span>
<span id="cb25-31"><a href="#cb25-31" tabindex="-1"></a>    <span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;0px 0 4px 0px&#39;</span>}})<span class="op">;</span></span>
<span id="cb25-32"><a href="#cb25-32" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(title)<span class="op">;</span></span>
<span id="cb25-34"><a href="#cb25-34" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(<span class="fu">makeRow</span>(<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span><span class="st">&#39;Built-up&#39;</span>))</span>
<span id="cb25-35"><a href="#cb25-35" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(<span class="fu">makeRow</span>(<span class="st">&#39;#ffc107&#39;</span><span class="op">,</span><span class="st">&#39;Bare Earth&#39;</span>))</span>
<span id="cb25-36"><a href="#cb25-36" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(<span class="fu">makeRow</span>(<span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span><span class="st">&#39;Water&#39;</span>))</span>
<span id="cb25-37"><a href="#cb25-37" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(<span class="fu">makeRow</span>(<span class="st">&#39;#004d40&#39;</span><span class="op">,</span><span class="st">&#39;Vegetation&#39;</span>))</span>
<span id="cb25-38"><a href="#cb25-38" tabindex="-1"></a></span>
<span id="cb25-39"><a href="#cb25-39" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(legend)<span class="op">;</span></span></code></pre></div>
</div>
<div id="adding-a-continous-legend" class="section level2">
<h2>Adding a Continous Legend</h2>
<p>If you are displaying a raster layer in your app with a color
palette, you can use the following technique to add a colorbar using the
snipet below.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/colorbar.png" alt="Creating a Continuous Raster Legend" width="100%" />
<p class="caption">
Creating a Continuous Raster Legend
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FUI_Widgets_and_Apps%2FColorbar_Legend"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2&quot;</span>)<span class="op">;</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="kw">var</span> bangalore <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> bangalore<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span> </span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a><span class="co">// Calculate  Normalized Difference Vegetation Index (NDVI)</span></span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a><span class="co">// &#39;NIR&#39; (B8) and &#39;RED&#39; (B4)</span></span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a><span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#d7191c&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span><span class="st">&#39;#ffffbf&#39;</span><span class="op">,</span><span class="st">&#39;#a6d96a&#39;</span><span class="op">,</span><span class="st">&#39;#1a9641&#39;</span>]</span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a><span class="kw">var</span> ndviVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}</span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">12</span>)</span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(ndvi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndviVis<span class="op">,</span> <span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createColorBar</span>(titleText<span class="op">,</span> palette<span class="op">,</span> min<span class="op">,</span> max) {</span>
<span id="cb26-24"><a href="#cb26-24" tabindex="-1"></a>  <span class="co">// Legend Title</span></span>
<span id="cb26-25"><a href="#cb26-25" tabindex="-1"></a>  <span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb26-26"><a href="#cb26-26" tabindex="-1"></a>    <span class="dt">value</span><span class="op">:</span> titleText<span class="op">,</span> </span>
<span id="cb26-27"><a href="#cb26-27" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontWeight</span><span class="op">:</span> <span class="st">&#39;bold&#39;</span><span class="op">,</span> <span class="dt">textAlign</span><span class="op">:</span> <span class="st">&#39;center&#39;</span><span class="op">,</span> <span class="dt">stretch</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span>}})<span class="op">;</span></span>
<span id="cb26-28"><a href="#cb26-28" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" tabindex="-1"></a>  <span class="co">// Colorbar</span></span>
<span id="cb26-30"><a href="#cb26-30" tabindex="-1"></a>  <span class="kw">var</span> legend <span class="op">=</span> ui<span class="op">.</span><span class="fu">Thumbnail</span>({</span>
<span id="cb26-31"><a href="#cb26-31" tabindex="-1"></a>    <span class="dt">image</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelLonLat</span>()<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb26-32"><a href="#cb26-32" tabindex="-1"></a>    <span class="dt">params</span><span class="op">:</span> {</span>
<span id="cb26-33"><a href="#cb26-33" tabindex="-1"></a>      <span class="dt">bbox</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.1</span>]<span class="op">,</span></span>
<span id="cb26-34"><a href="#cb26-34" tabindex="-1"></a>      <span class="dt">dimensions</span><span class="op">:</span> <span class="st">&#39;200x20&#39;</span><span class="op">,</span></span>
<span id="cb26-35"><a href="#cb26-35" tabindex="-1"></a>      <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;png&#39;</span><span class="op">,</span> </span>
<span id="cb26-36"><a href="#cb26-36" tabindex="-1"></a>      <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb26-37"><a href="#cb26-37" tabindex="-1"></a>      <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span></span>
<span id="cb26-38"><a href="#cb26-38" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">stretch</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span><span class="op">,</span> <span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;8px 8px&#39;</span><span class="op">,</span> <span class="dt">maxHeight</span><span class="op">:</span> <span class="st">&#39;40px&#39;</span>}<span class="op">,</span></span>
<span id="cb26-39"><a href="#cb26-39" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb26-40"><a href="#cb26-40" tabindex="-1"></a>  </span>
<span id="cb26-41"><a href="#cb26-41" tabindex="-1"></a>  <span class="co">// Legend Labels</span></span>
<span id="cb26-42"><a href="#cb26-42" tabindex="-1"></a>  <span class="kw">var</span> labels <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb26-43"><a href="#cb26-43" tabindex="-1"></a>    <span class="dt">widgets</span><span class="op">:</span> [</span>
<span id="cb26-44"><a href="#cb26-44" tabindex="-1"></a>      ui<span class="op">.</span><span class="fu">Label</span>(min<span class="op">,</span> {<span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;4px 10px&#39;</span><span class="op">,</span><span class="dt">textAlign</span><span class="op">:</span> <span class="st">&#39;left&#39;</span><span class="op">,</span> <span class="dt">stretch</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span>})<span class="op">,</span></span>
<span id="cb26-45"><a href="#cb26-45" tabindex="-1"></a>      ui<span class="op">.</span><span class="fu">Label</span>((min<span class="op">+</span>max)<span class="op">/</span><span class="dv">2</span><span class="op">,</span> {<span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;4px 20px&#39;</span><span class="op">,</span> <span class="dt">textAlign</span><span class="op">:</span> <span class="st">&#39;center&#39;</span><span class="op">,</span> <span class="dt">stretch</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span>})<span class="op">,</span></span>
<span id="cb26-46"><a href="#cb26-46" tabindex="-1"></a>      ui<span class="op">.</span><span class="fu">Label</span>(max<span class="op">,</span> {<span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;4px 10px&#39;</span><span class="op">,</span><span class="dt">textAlign</span><span class="op">:</span> <span class="st">&#39;right&#39;</span><span class="op">,</span> <span class="dt">stretch</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span>})]<span class="op">,</span></span>
<span id="cb26-47"><a href="#cb26-47" tabindex="-1"></a>    <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">&#39;horizontal&#39;</span>)})<span class="op">;</span></span>
<span id="cb26-48"><a href="#cb26-48" tabindex="-1"></a>  </span>
<span id="cb26-49"><a href="#cb26-49" tabindex="-1"></a>  <span class="co">// Create a panel with all 3 widgets</span></span>
<span id="cb26-50"><a href="#cb26-50" tabindex="-1"></a>  <span class="kw">var</span> legendPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb26-51"><a href="#cb26-51" tabindex="-1"></a>    <span class="dt">widgets</span><span class="op">:</span> [title<span class="op">,</span> legend<span class="op">,</span> labels]<span class="op">,</span></span>
<span id="cb26-52"><a href="#cb26-52" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">&#39;bottom-center&#39;</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">&#39;8px 15px&#39;</span>}</span>
<span id="cb26-53"><a href="#cb26-53" tabindex="-1"></a>  })</span>
<span id="cb26-54"><a href="#cb26-54" tabindex="-1"></a>  <span class="cf">return</span> legendPanel</span>
<span id="cb26-55"><a href="#cb26-55" tabindex="-1"></a>}</span>
<span id="cb26-56"><a href="#cb26-56" tabindex="-1"></a><span class="co">// Call the function to create a colorbar legend  </span></span>
<span id="cb26-57"><a href="#cb26-57" tabindex="-1"></a><span class="kw">var</span> colorBar <span class="op">=</span> <span class="fu">createColorBar</span>(<span class="st">&#39;NDVI Values&#39;</span><span class="op">,</span> palette<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="fl">0.5</span>)</span>
<span id="cb26-58"><a href="#cb26-58" tabindex="-1"></a></span>
<span id="cb26-59"><a href="#cb26-59" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(colorBar)</span></code></pre></div>
</div>
<div id="change-visualization-ui-app" class="section level2">
<h2>Change Visualization UI App</h2>
<p>A common use-case for Earth Engine Apps is to display 2 images in a
split panel app. Below script contains a simple template that you can
use to create an interactive split panel app. Here we have 2 map objects
- <code>leftMap</code> and <code>rightMap</code>. You can add different
images to each of the maps and users will be able to explore them
side-by-side. [<a
href="https://courses.spatialthoughts.com/images/end_to_end_gee/dust_storm_app.gif"
target="_blank">View Animated GIF ↗</a>]</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/dust_storm_app.png" alt="A Split Panel App that displays Pre- and Post-Storm Images" width="100%" />
<p class="caption">
A Split Panel App that displays Pre- and Post-Storm Images
</p>
</div>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FUI_Widgets_and_Apps%2FChange_Visualization_UI_App"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="co">// On June 9, 2018 - A massive dust storm hit North India</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="co">// This example shows before and after imagery from Sentinel-2</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="co">// Display two visualizations of a map.</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a><span class="co">// Set a center and zoom level.</span></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a><span class="kw">var</span> center <span class="op">=</span> {<span class="dt">lon</span><span class="op">:</span> <span class="fl">77.47</span><span class="op">,</span> <span class="dt">lat</span><span class="op">:</span> <span class="fl">28.41</span><span class="op">,</span> <span class="dt">zoom</span><span class="op">:</span> <span class="dv">12</span>}<span class="op">;</span></span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a><span class="co">// Create two maps.</span></span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a><span class="kw">var</span> leftMap <span class="op">=</span> ui<span class="op">.</span><span class="fu">Map</span>(center)<span class="op">;</span></span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a><span class="kw">var</span> rightMap <span class="op">=</span> ui<span class="op">.</span><span class="fu">Map</span>(center)<span class="op">;</span></span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a><span class="co">// Remove UI controls from both maps, but leave zoom control on the left map.</span></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a>leftMap<span class="op">.</span><span class="fu">setControlVisibility</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb27-15"><a href="#cb27-15" tabindex="-1"></a>rightMap<span class="op">.</span><span class="fu">setControlVisibility</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb27-16"><a href="#cb27-16" tabindex="-1"></a>leftMap<span class="op">.</span><span class="fu">setControlVisibility</span>({<span class="dt">zoomControl</span><span class="op">:</span> <span class="kw">true</span>})<span class="op">;</span></span>
<span id="cb27-17"><a href="#cb27-17" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" tabindex="-1"></a><span class="co">// Link them together.</span></span>
<span id="cb27-19"><a href="#cb27-19" tabindex="-1"></a><span class="kw">var</span> linker <span class="op">=</span> <span class="kw">new</span> ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Linker</span>([leftMap<span class="op">,</span> rightMap])<span class="op">;</span></span>
<span id="cb27-20"><a href="#cb27-20" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" tabindex="-1"></a><span class="co">// Create a split panel with the two maps.</span></span>
<span id="cb27-22"><a href="#cb27-22" tabindex="-1"></a><span class="kw">var</span> splitPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">SplitPanel</span>({</span>
<span id="cb27-23"><a href="#cb27-23" tabindex="-1"></a>  <span class="dt">firstPanel</span><span class="op">:</span> leftMap<span class="op">,</span></span>
<span id="cb27-24"><a href="#cb27-24" tabindex="-1"></a>  <span class="dt">secondPanel</span><span class="op">:</span> rightMap<span class="op">,</span></span>
<span id="cb27-25"><a href="#cb27-25" tabindex="-1"></a>  <span class="dt">orientation</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span><span class="op">,</span></span>
<span id="cb27-26"><a href="#cb27-26" tabindex="-1"></a>  <span class="dt">wipe</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb27-27"><a href="#cb27-27" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb27-28"><a href="#cb27-28" tabindex="-1"></a></span>
<span id="cb27-29"><a href="#cb27-29" tabindex="-1"></a><span class="co">// Remove the default map from the root panel.</span></span>
<span id="cb27-30"><a href="#cb27-30" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb27-31"><a href="#cb27-31" tabindex="-1"></a></span>
<span id="cb27-32"><a href="#cb27-32" tabindex="-1"></a><span class="co">// Add our split panel to the root panel.</span></span>
<span id="cb27-33"><a href="#cb27-33" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(splitPanel)<span class="op">;</span></span>
<span id="cb27-34"><a href="#cb27-34" tabindex="-1"></a></span>
<span id="cb27-35"><a href="#cb27-35" tabindex="-1"></a><span class="kw">var</span> rgb_vis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3200</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb27-36"><a href="#cb27-36" tabindex="-1"></a></span>
<span id="cb27-37"><a href="#cb27-37" tabindex="-1"></a><span class="kw">var</span> preStorm <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;COPERNICUS/S2/20180604T052651_20180604T053435_T43RGM&#39;</span>)</span>
<span id="cb27-38"><a href="#cb27-38" tabindex="-1"></a><span class="kw">var</span> postStorm <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;COPERNICUS/S2/20180614T052651_20180614T053611_T43RGM&#39;</span>)</span>
<span id="cb27-39"><a href="#cb27-39" tabindex="-1"></a></span>
<span id="cb27-40"><a href="#cb27-40" tabindex="-1"></a><span class="co">// Add a RGB Landsat 8 layer to the left map.</span></span>
<span id="cb27-41"><a href="#cb27-41" tabindex="-1"></a>leftMap<span class="op">.</span><span class="fu">addLayer</span>(preStorm<span class="op">,</span> rgb_vis)<span class="op">;</span></span>
<span id="cb27-42"><a href="#cb27-42" tabindex="-1"></a>rightMap<span class="op">.</span><span class="fu">addLayer</span>(postStorm<span class="op">,</span> rgb_vis)<span class="op">;</span></span></code></pre></div>
</div>
<div id="ndvi-explorer-ui-app" class="section level2">
<h2>NDVI Explorer UI App</h2>
<p>Earth Engine Apps allow you to display interactive charts in response
to user action. This app shows the common design pattern to build an app
that allows the user to click anywhere on the map and obtain a chart
using the clicked-location.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/global_ndvi_explorer.png" alt="Global NDVI Explorer App" width="100%" />
<p class="caption">
Global NDVI Explorer App
</p>
</div>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FUI_Widgets_and_Apps%2FNDVI%20Explorer%20UI%20App"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.5979</span><span class="op">,</span> <span class="fl">13.00896</span>])<span class="op">;</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2&quot;</span>)</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [</span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a>  <span class="st">&#39;FFFFFF&#39;</span><span class="op">,</span> <span class="st">&#39;CE7E45&#39;</span><span class="op">,</span> <span class="st">&#39;DF923D&#39;</span><span class="op">,</span> <span class="st">&#39;F1B555&#39;</span><span class="op">,</span> <span class="st">&#39;FCD163&#39;</span><span class="op">,</span> <span class="st">&#39;99B718&#39;</span><span class="op">,</span></span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a>  <span class="st">&#39;74A901&#39;</span><span class="op">,</span> <span class="st">&#39;66A000&#39;</span><span class="op">,</span> <span class="st">&#39;529400&#39;</span><span class="op">,</span> <span class="st">&#39;3E8601&#39;</span><span class="op">,</span> <span class="st">&#39;207401&#39;</span><span class="op">,</span> <span class="st">&#39;056201&#39;</span><span class="op">,</span></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a>  <span class="st">&#39;004C00&#39;</span><span class="op">,</span> <span class="st">&#39;023B01&#39;</span><span class="op">,</span> <span class="st">&#39;012E01&#39;</span><span class="op">,</span> <span class="st">&#39;011D01&#39;</span><span class="op">,</span> <span class="st">&#39;011301&#39;</span>]<span class="op">;</span></span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" tabindex="-1"></a><span class="kw">var</span> ndviVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette }</span>
<span id="cb28-17"><a href="#cb28-17" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" tabindex="-1"></a><span class="co">// Write a function for Cloud masking</span></span>
<span id="cb28-20"><a href="#cb28-20" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskS2clouds</span>(image) {</span>
<span id="cb28-21"><a href="#cb28-21" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)</span>
<span id="cb28-22"><a href="#cb28-22" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb28-23"><a href="#cb28-23" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb28-24"><a href="#cb28-24" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb28-25"><a href="#cb28-25" tabindex="-1"></a>             qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))</span>
<span id="cb28-26"><a href="#cb28-26" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb28-27"><a href="#cb28-27" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(<span class="st">&quot;B.*&quot;</span>)</span>
<span id="cb28-28"><a href="#cb28-28" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&quot;system:time_start&quot;</span>])</span>
<span id="cb28-29"><a href="#cb28-29" tabindex="-1"></a>}</span>
<span id="cb28-30"><a href="#cb28-30" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" tabindex="-1"></a><span class="co">// Write a function that computes NDVI for an image and adds it as a band</span></span>
<span id="cb28-33"><a href="#cb28-33" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addNDVI</span>(image) {</span>
<span id="cb28-34"><a href="#cb28-34" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb28-35"><a href="#cb28-35" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb28-36"><a href="#cb28-36" tabindex="-1"></a>}</span>
<span id="cb28-37"><a href="#cb28-37" tabindex="-1"></a></span>
<span id="cb28-38"><a href="#cb28-38" tabindex="-1"></a><span class="kw">function</span> <span class="fu">getComposite</span>(geometry) {</span>
<span id="cb28-39"><a href="#cb28-39" tabindex="-1"></a>  <span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb28-40"><a href="#cb28-40" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2019-12-31&#39;</span>))</span>
<span id="cb28-41"><a href="#cb28-41" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb28-42"><a href="#cb28-42" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb28-43"><a href="#cb28-43" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)</span>
<span id="cb28-44"><a href="#cb28-44" tabindex="-1"></a>  <span class="co">// Map the function over the collection</span></span>
<span id="cb28-45"><a href="#cb28-45" tabindex="-1"></a>  <span class="kw">var</span> withNdvi <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(addNDVI)<span class="op">;</span></span>
<span id="cb28-46"><a href="#cb28-46" tabindex="-1"></a></span>
<span id="cb28-47"><a href="#cb28-47" tabindex="-1"></a>  <span class="kw">var</span> composite <span class="op">=</span> withNdvi<span class="op">.</span><span class="fu">median</span>()</span>
<span id="cb28-48"><a href="#cb28-48" tabindex="-1"></a>  <span class="cf">return</span> composite</span>
<span id="cb28-49"><a href="#cb28-49" tabindex="-1"></a>}</span>
<span id="cb28-50"><a href="#cb28-50" tabindex="-1"></a></span>
<span id="cb28-51"><a href="#cb28-51" tabindex="-1"></a></span>
<span id="cb28-52"><a href="#cb28-52" tabindex="-1"></a><span class="co">// Create UI Elements</span></span>
<span id="cb28-53"><a href="#cb28-53" tabindex="-1"></a><span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">&#39;Global NDVI Explorer&#39;</span>)<span class="op">;</span></span>
<span id="cb28-54"><a href="#cb28-54" tabindex="-1"></a>title<span class="op">.</span><span class="fu">style</span>()<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb28-55"><a href="#cb28-55" tabindex="-1"></a>  <span class="st">&#39;position&#39;</span><span class="op">:</span>  <span class="st">&#39;top-center&#39;</span><span class="op">,</span></span>
<span id="cb28-56"><a href="#cb28-56" tabindex="-1"></a>  <span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;24px&#39;</span></span>
<span id="cb28-57"><a href="#cb28-57" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb28-58"><a href="#cb28-58" tabindex="-1"></a><span class="kw">var</span> resultsPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()<span class="op">;</span></span>
<span id="cb28-59"><a href="#cb28-59" tabindex="-1"></a><span class="kw">var</span> chartPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()<span class="op">;</span></span>
<span id="cb28-60"><a href="#cb28-60" tabindex="-1"></a><span class="kw">var</span> selectionPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb28-61"><a href="#cb28-61" tabindex="-1"></a>  <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">&#39;horizontal&#39;</span>)<span class="op">,</span></span>
<span id="cb28-62"><a href="#cb28-62" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb28-63"><a href="#cb28-63" tabindex="-1"></a></span>
<span id="cb28-64"><a href="#cb28-64" tabindex="-1"></a>resultsPanel<span class="op">.</span><span class="fu">style</span>()<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb28-65"><a href="#cb28-65" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="st">&#39;400px&#39;</span><span class="op">,</span></span>
<span id="cb28-66"><a href="#cb28-66" tabindex="-1"></a>  <span class="dt">position</span><span class="op">:</span> <span class="st">&#39;bottom-right&#39;</span></span>
<span id="cb28-67"><a href="#cb28-67" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb28-68"><a href="#cb28-68" tabindex="-1"></a></span>
<span id="cb28-69"><a href="#cb28-69" tabindex="-1"></a><span class="kw">var</span> resetPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()<span class="op">;</span></span>
<span id="cb28-70"><a href="#cb28-70" tabindex="-1"></a></span>
<span id="cb28-71"><a href="#cb28-71" tabindex="-1"></a></span>
<span id="cb28-72"><a href="#cb28-72" tabindex="-1"></a>resultsPanel<span class="op">.</span><span class="fu">add</span>(selectionPanel)</span>
<span id="cb28-73"><a href="#cb28-73" tabindex="-1"></a>resultsPanel<span class="op">.</span><span class="fu">add</span>(chartPanel)</span>
<span id="cb28-74"><a href="#cb28-74" tabindex="-1"></a>resultsPanel<span class="op">.</span><span class="fu">add</span>(resetPanel)</span>
<span id="cb28-75"><a href="#cb28-75" tabindex="-1"></a></span>
<span id="cb28-76"><a href="#cb28-76" tabindex="-1"></a><span class="co">// Function to reset the app to initial state</span></span>
<span id="cb28-77"><a href="#cb28-77" tabindex="-1"></a><span class="kw">var</span> resetEverything <span class="op">=</span> <span class="kw">function</span>() {</span>
<span id="cb28-78"><a href="#cb28-78" tabindex="-1"></a>  chartPanel<span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb28-79"><a href="#cb28-79" tabindex="-1"></a>  selectionPanel<span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb28-80"><a href="#cb28-80" tabindex="-1"></a>  resetPanel<span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb28-81"><a href="#cb28-81" tabindex="-1"></a></span>
<span id="cb28-82"><a href="#cb28-82" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb28-83"><a href="#cb28-83" tabindex="-1"></a></span>
<span id="cb28-84"><a href="#cb28-84" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(title)<span class="op">;</span></span>
<span id="cb28-85"><a href="#cb28-85" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(resultsPanel)</span>
<span id="cb28-86"><a href="#cb28-86" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">onClick</span>(displayChart)</span>
<span id="cb28-87"><a href="#cb28-87" tabindex="-1"></a>  <span class="co">// Use the current viewport</span></span>
<span id="cb28-88"><a href="#cb28-88" tabindex="-1"></a>  <span class="kw">var</span> bounds <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Rectangle</span>(<span class="bu">Map</span><span class="op">.</span><span class="fu">getBounds</span>())</span>
<span id="cb28-89"><a href="#cb28-89" tabindex="-1"></a>  <span class="kw">var</span> composite <span class="op">=</span> <span class="fu">getComposite</span>(bounds)</span>
<span id="cb28-90"><a href="#cb28-90" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Sentinel-2 Composite&#39;</span>)</span>
<span id="cb28-91"><a href="#cb28-91" tabindex="-1"></a>  <span class="kw">var</span> label <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">&#39;Click anywhere to see the chart&#39;</span>)</span>
<span id="cb28-92"><a href="#cb28-92" tabindex="-1"></a>  resetPanel<span class="op">.</span><span class="fu">add</span>(label)</span>
<span id="cb28-93"><a href="#cb28-93" tabindex="-1"></a></span>
<span id="cb28-94"><a href="#cb28-94" tabindex="-1"></a>}</span>
<span id="cb28-95"><a href="#cb28-95" tabindex="-1"></a></span>
<span id="cb28-96"><a href="#cb28-96" tabindex="-1"></a><span class="co">// Function to create and display NDVI time-series chart</span></span>
<span id="cb28-97"><a href="#cb28-97" tabindex="-1"></a><span class="kw">var</span> displayChart <span class="op">=</span> <span class="kw">function</span>(point) {</span>
<span id="cb28-98"><a href="#cb28-98" tabindex="-1"></a>  resetPanel<span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb28-99"><a href="#cb28-99" tabindex="-1"></a>  <span class="kw">var</span> button <span class="op">=</span> ui<span class="op">.</span><span class="fu">Button</span>({</span>
<span id="cb28-100"><a href="#cb28-100" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">&#39;Reset&#39;</span><span class="op">,</span></span>
<span id="cb28-101"><a href="#cb28-101" tabindex="-1"></a>    <span class="dt">onClick</span><span class="op">:</span> resetEverything})</span>
<span id="cb28-102"><a href="#cb28-102" tabindex="-1"></a>  resetPanel<span class="op">.</span><span class="fu">add</span>(button)</span>
<span id="cb28-103"><a href="#cb28-103" tabindex="-1"></a>  <span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>(point[<span class="st">&#39;lon&#39;</span>]<span class="op">,</span> point[<span class="st">&#39;lat&#39;</span>])<span class="op">;</span></span>
<span id="cb28-104"><a href="#cb28-104" tabindex="-1"></a>  </span>
<span id="cb28-105"><a href="#cb28-105" tabindex="-1"></a>  <span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb28-106"><a href="#cb28-106" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2019-12-31&#39;</span>))</span>
<span id="cb28-107"><a href="#cb28-107" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">50</span>))</span>
<span id="cb28-108"><a href="#cb28-108" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(maskS2clouds)</span>
<span id="cb28-109"><a href="#cb28-109" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(addNDVI)</span>
<span id="cb28-110"><a href="#cb28-110" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb28-111"><a href="#cb28-111" tabindex="-1"></a>  </span>
<span id="cb28-112"><a href="#cb28-112" tabindex="-1"></a>  <span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb28-113"><a href="#cb28-113" tabindex="-1"></a>    <span class="dt">imageCollection</span><span class="op">:</span> filtered<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb28-114"><a href="#cb28-114" tabindex="-1"></a>    <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb28-115"><a href="#cb28-115" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb28-116"><a href="#cb28-116" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb28-117"><a href="#cb28-117" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI Time Series&#39;</span><span class="op">,</span></span>
<span id="cb28-118"><a href="#cb28-118" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI&#39;</span>}<span class="op">,</span></span>
<span id="cb28-119"><a href="#cb28-119" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Date&#39;</span><span class="op">,</span> <span class="dt">gridlines</span><span class="op">:</span> {<span class="dt">count</span><span class="op">:</span> <span class="dv">12</span>}}</span>
<span id="cb28-120"><a href="#cb28-120" tabindex="-1"></a>    })</span>
<span id="cb28-121"><a href="#cb28-121" tabindex="-1"></a>      </span>
<span id="cb28-122"><a href="#cb28-122" tabindex="-1"></a>  chartPanel<span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb28-123"><a href="#cb28-123" tabindex="-1"></a>  selectionPanel<span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb28-124"><a href="#cb28-124" tabindex="-1"></a>  selectionPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">&#39;Choose an image to display:&#39;</span>))</span>
<span id="cb28-125"><a href="#cb28-125" tabindex="-1"></a>  chartPanel<span class="op">.</span><span class="fu">add</span>(chart)</span>
<span id="cb28-126"><a href="#cb28-126" tabindex="-1"></a>  </span>
<span id="cb28-127"><a href="#cb28-127" tabindex="-1"></a>  </span>
<span id="cb28-128"><a href="#cb28-128" tabindex="-1"></a>  <span class="kw">var</span> addNdviLayer <span class="op">=</span> <span class="kw">function</span>(dateString) {</span>
<span id="cb28-129"><a href="#cb28-129" tabindex="-1"></a>    <span class="kw">var</span> date <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">parse</span>(<span class="st">&#39;YYYY-MM-dd&#39;</span><span class="op">,</span> dateString)</span>
<span id="cb28-130"><a href="#cb28-130" tabindex="-1"></a>    <span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(date<span class="op">,</span> date<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;day&#39;</span>)))<span class="op">.</span><span class="fu">mosaic</span>())</span>
<span id="cb28-131"><a href="#cb28-131" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span> ndviVis<span class="op">,</span> <span class="st">&#39;NDVI Image -&#39;</span> <span class="op">+</span> dateString)</span>
<span id="cb28-132"><a href="#cb28-132" tabindex="-1"></a>  }</span>
<span id="cb28-133"><a href="#cb28-133" tabindex="-1"></a></span>
<span id="cb28-134"><a href="#cb28-134" tabindex="-1"></a></span>
<span id="cb28-135"><a href="#cb28-135" tabindex="-1"></a>  filtered<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;system:time_start&#39;</span>)<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(ids) {</span>
<span id="cb28-136"><a href="#cb28-136" tabindex="-1"></a>    <span class="kw">var</span> dates <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(ids)<span class="op">.</span><span class="fu">distinct</span>()<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(timestamp) {</span>
<span id="cb28-137"><a href="#cb28-137" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Date</span>(timestamp)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;YYYY-MM-dd&#39;</span>)</span>
<span id="cb28-138"><a href="#cb28-138" tabindex="-1"></a>    })</span>
<span id="cb28-139"><a href="#cb28-139" tabindex="-1"></a>    dates<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(dateList){</span>
<span id="cb28-140"><a href="#cb28-140" tabindex="-1"></a>      selectionPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb28-141"><a href="#cb28-141" tabindex="-1"></a>      <span class="dt">items</span><span class="op">:</span> dateList<span class="op">,</span></span>
<span id="cb28-142"><a href="#cb28-142" tabindex="-1"></a>      <span class="dt">onChange</span><span class="op">:</span> addNdviLayer<span class="op">,</span></span>
<span id="cb28-143"><a href="#cb28-143" tabindex="-1"></a>      <span class="dt">placeholder</span><span class="op">:</span> <span class="st">&#39;Select a date&#39;</span></span>
<span id="cb28-144"><a href="#cb28-144" tabindex="-1"></a>    }))</span>
<span id="cb28-145"><a href="#cb28-145" tabindex="-1"></a>    })</span>
<span id="cb28-146"><a href="#cb28-146" tabindex="-1"></a></span>
<span id="cb28-147"><a href="#cb28-147" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb28-148"><a href="#cb28-148" tabindex="-1"></a></span>
<span id="cb28-149"><a href="#cb28-149" tabindex="-1"></a>}</span>
<span id="cb28-150"><a href="#cb28-150" tabindex="-1"></a><span class="co">// Call the function to build the initial UI state.</span></span>
<span id="cb28-151"><a href="#cb28-151" tabindex="-1"></a><span class="fu">resetEverything</span>()<span class="op">;</span></span></code></pre></div>
</div>
</div>
<div id="code-sharing-and-script-modules" class="section level1">
<h1>Code Sharing and Script Modules</h1>
<p>As your Earth Engine project grows, you need a way to organize and
share your code to collaborate with others. We will learn some best
practices on how best to set-up your project in Earth Engine.</p>
<div id="sharing-a-single-script" class="section level2">
<h2>Sharing a Single Script</h2>
<p>To share your code from a single script, you need to use the
<strong>Get Link</strong> button in the code editor. As you click the
button, the contents of your code editor is captured and encoded into a
URL. When you share this URL with someone, they will be able see same
content as your code editor. This is a great way to send a snapshot of
your code so others can reproduce your output. Remember that the script
links are just snapshots, if you change your code after sending the link
to someone, they will not see the updates.</p>
<blockquote>
<p>When trying to send someone a link, do NOT click the <em>Copy Script
Path</em> button. Sending this path to someone will NOT give them access
to your code. The script path only works only on public or shared
repositories.</p>
</blockquote>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/get_link.png" alt="Code Sharing using Get Link button" width="75%" />
<p class="caption">
Code Sharing using Get Link button
</p>
</div>
<p>While sharing the script using <em>Get Link</em>, you should also
share any private <strong>Assets</strong> that you may have uploaded and
are using in the script. You can share the asset with a specific email
address, or check the <em>Anyone can read</em> box if you want anyone
with the script link to be able to access it. Failing to do so will
prevent others from running your script.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/sharing_assets.png" alt="Sharing Uploaded Assets" width="75%" />
<p class="caption">
Sharing Uploaded Assets
</p>
</div>
<p>Learn more in the <a
href="https://developers.google.com/earth-engine/guides/playground#get-link">Script
links</a> section of the Google Earth Engine User Guide.</p>
</div>
<div id="sharing-multiple-scripts" class="section level2">
<h2>Sharing Multiple Scripts</h2>
<p>If you want to share a collection of scripts with other users or your
collaborators, the best way is to create a new
<strong>Repository</strong>.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/new_repository.png" alt="Creating New Repository" width="40%" />
<p class="caption">
Creating New Repository
</p>
</div>
<p>You can put multiple scripts within the repository and share the
repository with other users. You can grant them <strong>Reader</strong>
or <strong>Writer</strong> access so they can view/add/modify/delete
scripts in that repository. If you want to make it readable by
<strong>Public</strong>, you can check the <em>Anyone can read</em>
option. You will see a URL in the form of
<code>https://code.earthengine.google.co.in/?accept_repo=...</code>.
When you share this URL with other users and they visit that link, your
repository will be added to their Code Editor under the <em>Reader</em>
or <em>Writer</em> folder depending on their access.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/sharing_repository.png" alt="Creating New Repository" width="75%" />
<p class="caption">
Creating New Repository
</p>
</div>
<p>Learn more in the <a
href="https://developers.google.com/earth-engine/guides/playground#script-manager-scripts-tab">Script
Manager</a> section of the Google Earth Engine User Guide.</p>
</div>
<div id="sharing-code-between-scripts" class="section level2">
<h2>Sharing Code between Scripts</h2>
<p>For a large project, it is preferable to share commonly used
functions between scripts. That way, each script doesn’t have to
re-implement the same code. Earth Engine enables this using
<strong>Script Modules</strong>. Using a special object called
<code>exports</code>, you can expose a function to other scripts. Learn
more in the <a
href="https://developers.google.com/earth-engine/guides/playground#script-modules">Script
modules</a> section of the Google Earth Engine User Guide.</p>
<p>There are many Earth Engine users who have shared their repositories
publicly and written script modules to perform a variety of tasks.
Here’s an example of using the <code>grid</code> module from the
<code>users/gena/packages</code> repository to create regularly spaced
grids in Earth Engine.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/script_modules.png" alt="Using a function from a script module" width="100%" />
<p class="caption">
Using a function from a script module
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?accept_repo=users%2Fujavalgandhi%2FEnd-to-End-GEE&amp;scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FMiscellaneous%2FCode_Sharing_and_Script_Modules"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="kw">var</span> karnataka <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/public/karnataka&quot;</span>)<span class="op">;</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(karnataka<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;gray&#39;</span>}<span class="op">,</span> <span class="st">&#39;State Boundary&#39;</span>)</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="kw">var</span> bounds <span class="op">=</span> karnataka<span class="op">.</span><span class="fu">geometry</span>()<span class="op">.</span><span class="fu">bounds</span>()</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="kw">var</span> coords <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(bounds<span class="op">.</span><span class="fu">coordinates</span>()<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a><span class="kw">var</span> xmin <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(coords<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>)</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a><span class="kw">var</span> ymin <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(coords<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">.</span><span class="fu">get</span>(<span class="dv">1</span>)</span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a><span class="kw">var</span> xmax <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(coords<span class="op">.</span><span class="fu">get</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>)</span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a><span class="kw">var</span> ymax <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(coords<span class="op">.</span><span class="fu">get</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">get</span>(<span class="dv">1</span>)</span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a><span class="co">// source code for the grid package:</span></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a><span class="co">// https://code.earthengine.google.com/?accept_repo=users/gena/packages</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a><span class="co">// Import the module to our script using &#39;require&#39;</span></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a><span class="kw">var</span> gridModule <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/gena/packages:grid&#39;</span>)</span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a><span class="co">// Now we can run any function from the module</span></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a><span class="co">// We try running the generateGrid function to create regularly spaced vector grid</span></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a><span class="co">// generateGrid(xmin, ymin, xmax, ymax, dx, dy, marginx, marginy, opt_proj)</span></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a><span class="kw">var</span> spacing <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a><span class="kw">var</span> gridVector <span class="op">=</span> gridModule<span class="op">.</span><span class="fu">generateGrid</span>(xmin<span class="op">,</span> ymin<span class="op">,</span> xmax<span class="op">,</span> ymax<span class="op">,</span> spacing<span class="op">,</span> spacing<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)</span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(gridVector)</span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(gridVector<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span>}<span class="op">,</span> <span class="st">&#39;Grids&#39;</span>)</span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>The course material (text, images, presentation, videos) is licensed
under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative
Commons Attribution 4.0 International License</a>.</p>
<p>The code (scripts, Jupyter notebooks) is licensed under the MIT
License. For a copy, see <a href="https://opensource.org/licenses/MIT"
class="uri">https://opensource.org/licenses/MIT</a></p>
<p>Kindly give appropriate credit to the original author as below:</p>
<p>Copyright © 2022 Ujaval Gandhi <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>
<div id="citing-and-referencing" class="section level1">
<h1>Citing and Referencing</h1>
<p>You can cite the course materials as follows</p>
<ul>
<li>Gandhi, Ujaval, 2021. <em>End-to-End Google Earth Engine</em>
Course. Spatial Thoughts. <a
href="https://courses.spatialthoughts.com/end-to-end-gee.html"
class="uri">https://courses.spatialthoughts.com/end-to-end-gee.html</a></li>
</ul>
<hr />
<p><strong>This course is offered as an instructor-led online class.
Visit <a href="https://spatialthoughts.com/events/">Spatial Thoughts</a>
to know details of upcoming sessions.</strong></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
