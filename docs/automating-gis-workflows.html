<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>Automating GIS Workflows with QGIS (Full Course Material)</title>

<script src="site_libs/header-attrs-2.6/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372432-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372432-3');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>




<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Automating GIS Workflows with QGIS (Full Course Material)</h1>
<h3 class="subtitle">A deep dive into the Processing Toolbox for building fast, automated and reproducible workflows.</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#get-the-data-package">Get the Data Package</a></li>
<li><a href="#the-processing-framework">The Processing Framework</a></li>
<li><a href="#processing-toolbox">Processing Toolbox</a>
<ul>
<li><a href="#why-should-you-use-processing-algorithms">Why should you use Processing Algorithms</a></li>
<li><a href="#exercise-find-the-length-of-interstate-highways-in-each-state-of-the-us">Exercise: Find the length of interstate highways in each state of the US</a></li>
<li><a href="#lesser-known-algorithms">Lesser Known Algorithms</a></li>
</ul></li>
<li><a href="#graphical-modeler">Graphical Modeler</a>
<ul>
<li><a href="#exercise-build-a-model-to-calculate-road-lengths">Exercise: Build a model to calculate road lengths</a></li>
</ul></li>
<li><a href="#batch-processing">Batch Processing</a>
<ul>
<li><a href="#exercise-clip-multiple-layers-to-a-polygon">Exercise: Clip multiple layers to a polygon</a></li>
</ul></li>
<li><a href="#packaging-your-work">Packaging Your Work</a>
<ul>
<li><a href="#exercise-package-source-layers-results-and-model-in-a-geopackage">Exercise: Package source layers, results and model in a GeoPackage</a></li>
</ul></li>
<li><a href="#data-credits">Data Credits</a></li>
<li><a href="#license">License</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This class focuses on techniques for automation of GIS workflows. The class covers the Processing Toolbox in detail.Below are the topics covered in this class</p>
<ul>
<li>Processing Providers</li>
<li>Processing Algorithms,</li>
<li>Processing Modeler</li>
<li>Batch processing</li>
</ul>
</div>
<div id="get-the-data-package" class="section level1">
<h1>Get the Data Package</h1>
<p>The code examples in this class use a variety of datasets. All the required layers, project files etc. are supplied to you in the <code>automating_gis_workflows.zip</code> file with your purchase. Unzip this file to the <code>Downloads</code> directory.</p>
<p><em>Not enrolled in our instructor-led class but want to work through the material on your own?</em> <a href="https://docs.google.com/forms/d/e/1FAIpQLSfhjKqX0g3HK0D0PVJIRz2GHDDJF9-3MIC3h9-iuJwXpnTBWw/viewform" target="_blank">Get free access to the data package</a></p>
</div>
<div id="the-processing-framework" class="section level1">
<h1>The Processing Framework</h1>
<p>QGIS 2.0 introduced a new concept called Processing Framework. Previously known as Sextante, the Processing Framework provides an environment within QGIS to run native and third-party algorithms for processing data. It is now the recommended way to run any type of data processing and analysis within QGIS - including tasks such as selecting features, altering attributes, saving layers etc. - that can be accomplished by other means. But leveraging the processing framework allows you to be more productive, fast, and less error prone.</p>
<p>The Processing Framework consists of the following distinct elements that work together.</p>
<ul>
<li><strong>Processing Toolbox</strong>: Contains individual tools (i.e. algorithms) grouped by providers and functionality</li>
<li><strong>Batch Processing Interface</strong>: Allows any processing tool to be executed on multiple layers together.</li>
<li><strong>Graphical Modeler</strong>: Allows the user to define the workflow and chain multiple processing steps together using a drag-and-drop mechanism.</li>
<li><strong>History Manager</strong>: Records and stores all executions of algorithms to allow users to reproduce past analysis.</li>
<li><strong>Results Viewer</strong>: An interface to view non-spatial outputs from algorithms - such as tables and charts.</li>
</ul>
<div style="page-break-after: always;"></div>
</div>
<div id="processing-toolbox" class="section level1">
<h1>Processing Toolbox</h1>
<p>Processing Toolbox is available from the top-level menu <strong>Processing → Toolbox</strong>. There are hundreds of algorithms available out of the box. They are organized by <em>Providers</em>. The tools created by QGIS developers is available as a <strong>Native</strong> QGIS provider. Processing Framework providers an easy way to integrate tools written by other software and libraries such as GDAL, GRASS and SAGA. QGIS Plugins can also add new functionality via processing algorithms in the toolbox.</p>
<p><img src="images/automating_gis_workflows/toolbox_algorithms.png" width="75%" style="display: block; margin: auto;" /></p>
<div id="why-should-you-use-processing-algorithms" class="section level2">
<h2>Why should you use Processing Algorithms</h2>
<ul>
<li>Well tested and rigorous implementations</li>
<li>Majority are written in C++ and are faster than alternatives</li>
<li>Long processes can run the the background while you continue to use QGIS</li>
<li>Many multi-threaded algorithms can take advantage of multi-core CPU on your machines and give you better performance</li>
<li>Robust handling of invalid geometry</li>
<li>Ability to see progress of the operation and cancel it</li>
<li>Easily run on all or just selected features</li>
</ul>
</div>
<div id="exercise-find-the-length-of-interstate-highways-in-each-state-of-the-us" class="section level2">
<h2>Exercise: Find the length of interstate highways in each state of the US</h2>
<p>The aim of this exercise is to show how a multi-step spatial analysis problem can be solved using a purely processing-based workflow. This exercise also shows the richness of available algorithms in QGIS that are able to do sophisticated operations that previously needed plugins or were more complex.</p>
<p>We will work with shapefiles provided by US Census Bureau. The <code>tl_2019_us_primaryroads.zip</code> file comes TIGER/Line roads database and contains all the major roads in the US - including Interstate highways. The <code>tl_2019_us_state.zip</code> file comes from the Cartographic Boundary Files and contains the state boundaries.</p>
<ol style="list-style-type: decimal">
<li>Browse to the data directory and expand <code>tl_2019_us_primaryroads.zip</code> and <code>tl_2019_us_state.zip</code> files. Drag and drop the <code>tl_2019_us_primaryroads.shp</code> and <code>tl_2019_us_state.shp</code> layers to the canvas.</li>
</ol>
<p><img src="images/automating_gis_workflows/1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>The layer <code>tl_2019_us_primaryroads</code> contain all major roads, including interstate highways, state highways, US highways etc. Select the layer and use the keyboard shortcut <strong>F6</strong> to open the attribute table. You will notice that the <code>RTTYP</code> column has information about road designation. As we are interested in only interstate highways, we can use the information in this column to extract relevant road segments.</li>
</ol>
<blockquote>
<p>Note: The roads layer has 2 line segments per road, representing the route in both directions.</p>
</blockquote>
<p><img src="images/automating_gis_workflows/2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Open the Processing Toolbox by going to <strong>Processing → Toolbox</strong></li>
</ol>
<p><img src="images/automating_gis_workflows/3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>You can use tools such as <em>Select by expression</em>, export the selected features as a new layer and continue to work. But the processing toolbox providers a better and seamless workflow. Search for the algorithm <strong>Extract by attribute</strong>.</li>
</ol>
<p><img src="images/automating_gis_workflows/4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Select <code>tl_2019_us_primaryroads</code> as the <em>Input layer</em>. Select <code>RTTYP</code> as the <em>Selection attribute</em> and <code>I</code> as the <em>Value</em>. This will extract all feature where RTTYP value is I (Interstate). Click <em>Run</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>You will get a new layer <code>Extracted (attribute)</code> in the Layers Panel. Next, we want to calculate the length of each segment. You can use the built-in algorithm <strong>Add geometry attributes</strong></li>
</ol>
<p><img src="images/automating_gis_workflows/6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>The source layer is in the Geographic CRS EPSG:4269 (NAD83) with degrees as units. But for the analysis, we want the lengths to be measured in linear units - such as miles. The algorithm provides us with a handy option to calculate the distances in <strong>Elliposidal</strong> math - which is ideal for layers in the geographic CRS. Select <code>Extracted (attribute)</code> as the <em>Input layer</em>, select <code>Ellipsoidal</code> as <em>Calculate using</em> and click <em>Run</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>A new layer with an additional field called <code>length</code> will be added to the Layers panel. The distances in this field are in meters.</li>
</ol>
<p><img src="images/automating_gis_workflows/8.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>We have the state information in the <code>tl_2019_us_state</code> layer, but not in the roads layer. To add the name of the state to the roads layer, we need to perform a spatial-join. This is done using the <strong>Join attributes by Location</strong> algorithm.</li>
</ol>
<p><img src="images/automating_gis_workflows/9.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>Select the <code>Added geom info</code> as the <em>Input layer</em> and <code>tl_2019_us_state</code> as the <em>Join layer</em>. For the <em>Fields to add</em>, we need only the <code>NAME</code> of the state.</li>
</ol>
<p><img src="images/automating_gis_workflows/10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>Fortunately for us, each road segment is split at the state boundary. So we can select <code>Take attribute of the first located feature only</code> and click <em>Run</em> to perform a one-to-one join.</li>
</ol>
<blockquote>
<p>If our input road layers had segments that crossed state lines, we would have to do an extra step of splitting them so when we count road lengths per state - we get accurate results. You may do this by converting the states layer to lines using <em>Polygons to lines</em> algorithm, followed by the <em>Split by Lines</em> to split the road segments at the boundary.</p>
</blockquote>
<p><img src="images/automating_gis_workflows/11.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="12" style="list-style-type: decimal">
<li>The new layer <code>Joined layer</code> now has the state name for every road segment.</li>
</ol>
<p><img src="images/automating_gis_workflows/12.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>We can now sum the road lengths and group them for each state You may recall that in earlier versions of QGIS, you needed a plugin called Group Stats to do this. But now we can do this via the built-in <strong>Statistic by Categories</strong> algorithm.</li>
</ol>
<p><img src="images/automating_gis_workflows/13.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="14" style="list-style-type: decimal">
<li>Select <code>Joined layer</code> as the <em>Input vector layer</em>. We want to calculate lengths, but group them by states. So select <code>length</code> as the <em>Field to calculate statistics on</em> and <code>NAME</code> as the <em>Field(s) with categories</em>. Click <em>Run</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/14.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="15" style="list-style-type: decimal">
<li>The output of the algorithm is a table containing various statistics on the <code>length</code> column for each state. The values in the <strong>sum</strong> column is the total length of national highways in the district.</li>
</ol>
<p><img src="images/automating_gis_workflows/15.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="16" style="list-style-type: decimal">
<li>The layer contains many fields which are not relevant to us, so let’s delete some columns before saving. The <em>classic</em> way to do this is to toggle editing and use the <em>Delete Column</em> button from the Attribute Table. If you wanted to rename/reorder certain fields, that needed a plugin. But now, we have a really easy processing algorithm called <strong>Refactor Fields</strong> that can add, delete, rename, re-order, re-calculate and change the field types all at once.</li>
</ol>
<p><img src="images/automating_gis_workflows/16.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="17" style="list-style-type: decimal">
<li>In the <em>Refactor fields</em> dialog, select rows containing fields that you want to delete and click the <em>Delete selected field</em> button. Delete all except the <code>NAME</code> and <code>sum</code> fields.</li>
</ol>
<p><img src="images/automating_gis_workflows/17.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="18" style="list-style-type: decimal">
<li>The lengths contained in the <code>sum</code> field is in meters. We can convert it to miles here itself. Click the button next to <code>sum</code> in the <em>Source experssion</em> column and enter the following expression that converts meters to miles and rounds the value to the nearest integer. Click <em>OK</em>.</li>
</ol>
<pre><code>round(sum*0.000621371)</code></pre>
<p><img src="images/automating_gis_workflows/18.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="19" style="list-style-type: decimal">
<li>We can also rename the field to a better name. Change the <em>Field name</em> of <code>NAME</code> to <code>State</code> and <code>sum</code> to <code>Length_Miles</code>. We are ready to apply the changes. So far we have created temporary output layers, but this is the final result of the analysis, so we can save it to the disk. Click the <code>...</code> button at the bottom and select <code>Save to GeoPackage</code>.</li>
</ol>
<p><img src="images/automating_gis_workflows/19.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="20" style="list-style-type: decimal">
<li>Enter the name of the file as <code>roads.gpkg</code>. When prompted for a layer name, enter <code>road_length_by_state</code>. Click <em>Run</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/20.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="21" style="list-style-type: decimal">
<li>A new layer <code>road_length_by_state</code> will be added to the <em>Layers</em> panel. The table will have the fields renamed and re-calculated as we had specified.</li>
</ol>
<p><img src="images/automating_gis_workflows/21.png" width="75%" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Note: The refactor fields algorithm has a <a href="https://github.com/qgis/QGIS/issues/32492">bug</a> for the Mac version that makes all fields as strings regardless of the user’s choice. This is a known issue and will be fixed in the future version. Till then, if you are on Mac, a workaround is to use the <em>Field Calculator</em> algorithm to take the result and add fields with correct types and conversion expressions such as to_int(), to_double() etc.</p>
</blockquote>
<p>Note that we did data processing, spatial analysis and statistical analysis - all using just processing algorithms in a fast, re-producible and intuitive workflow.</p>
</div>
<div id="lesser-known-algorithms" class="section level2">
<h2>Lesser Known Algorithms</h2>
<p>The Processing Toolbox contains hundreds of algorithms - with new ones being added everyday. Many plugins also add processing algorithms that support new functionality. While you may think that processing algorithms are meant for <strong>analysis</strong> - there are plenty of algorithms that offer functionality that is beyond geoprocessing. Here are a few algorithms that I find very useful to automate my workflows that you may not be aware of.</p>
<ul>
<li><code>Download file</code>: Download file from a URL or FTP site. Allows you to automate tasks where you need to download new data regularly and process it.</li>
<li><code>Import geotagged photos</code>: Extracts latitude, longitude and azimuth information from a directory of photos and creates a point layer.</li>
<li><code>Add autoincremental field</code>: Simple but very useful algorithm to add a unique integer field. Many databases (even geopackage) requires that each layer has a unique integer field. This algorithm helps creating this field if your source layer doesn’t have one. CAD or CSV layers frequently have this problem.</li>
<li><code>Create spatial index</code>: Spatial indexes speed up your geoprocessing operation a lot. This algorithm can create spatial indices on many types of layers, including those loaded from a database.</li>
<li><code>ORS Tools Algorithms</code>: OpenRouteService (ORS) provides a QGIS plugin which installs a slew of network analysis algorithms to the Processing Toolbox. They allow rich network analysis functionality using OpenStreetMap data and it works without having to download any data.</li>
</ul>
<blockquote>
<p>A fun and interesting algorithm is called <code>Topological coloring</code>. This algorithm implements helps with cartography by allowing you assign a <em>color_id</em> to your polygon layers such that no adjacent polygons have the same color.</p>
</blockquote>
<p><img src="images/automating_gis_workflows/color3.png" width="75%" style="display: block; margin: auto;" /></p>
<div style="page-break-after: always;"></div>
</div>
</div>
<div id="graphical-modeler" class="section level1">
<h1>Graphical Modeler</h1>
<p>As we saw in the previous example, GIS Workflows typically involve many steps - with each step generating intermediate output that is used by the next step. If you change the input data or want to tweak a parameter, you will need to run through the entire process again manually. Fortunately, Processing Framework provides a graphical modeler that can help you define your workflow and run it with a single invocation. You can also run these workflows as a batch over a large number of inputs.</p>
<div id="exercise-build-a-model-to-calculate-road-lengths" class="section level2">
<h2>Exercise: Build a model to calculate road lengths</h2>
<p>We will take the workflow from the previous section and build a model that can precisely reproduce all the intermediate steps and give us the result. The model will allow us to specify the input layers and parameters and perform all intermediate steps without any user input. This will greatly speed up our analysis and ensure we do not make manual errors when running the same calculations again.</p>
<ol style="list-style-type: decimal">
<li>Open the modeler tool from <strong>Processing → Graphical Modeler</strong>.</li>
</ol>
<p><img src="images/automating_gis_workflows/model1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Enter the name of the model as <code>calculate_road_lengths</code> and click the <em>Save</em> button. Save the model as <code>calculate_road_lengths.model3</code> file at the default location.</li>
</ol>
<p><img src="images/automating_gis_workflows/model2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>The modeler interface contains the left-hand panel with 2 tabs - <em>Inputs</em> and <em>Algorithms</em>. Our first step is to define the inputs to the model. In our case, the inputs are the 2 vector layers - primary roads and states. Find the <code>Vector Layer</code> input and drag it to the canvas.</li>
</ol>
<p><img src="images/automating_gis_workflows/model3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>In the <em>Vector Layer Parameter Definition</em> dialog, enter <code>Roads</code> as the <em>Parameter name</em> and set <code>Line</code> as the <em>Geometry Type</em>. Click <em>OK</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/model4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Similarly, drag another <code>Vector Layer</code> input. <code>States</code> as the <em>Parameter name</em> and set <code>Polygon</code> as the <em>Geometry Type</em>. Click <em>OK</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/model5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>You should have 2 boxes representing the input layers. Now switch to the <em>Algorithms</em> tab and search for the <code>Extract by attribute</code> algorithm. Drag it to the canvas.</li>
</ol>
<p><img src="images/automating_gis_workflows/model6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>Fill in the parameters the same way we did in the previous exercise. <code>Roads</code> as the <em>Input layer</em>, <code>RTTYP</code> as the <em>Selection attribute</em> and <code>I</code> as the <em>Value</em>. Click <em>OK</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/model7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>In the modeler canvas, you will see a new box with the <em>Extract by attribute</em> algorithm and an arrow connecting it with one of the inputs. This indicates that the algorithm is using that input for processing. Next search for and add the <code>Add geometry attributes</code> algorithm.</li>
</ol>
<p><img src="images/automating_gis_workflows/model8.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>Set the <code>'Extracted (attribute)' from algorithm 'Extract by Attribute'</code> as the <em>Input layer</em>. Select <code>Ellipsoidal</code> as the method for <em>Calculate using</em>. Click <em>OK</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/model9.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>Referring back to the previous example, the next step in the processing is doing a spatial join. Search for and add the <code>Join attribute by location</code> algorithm.</li>
</ol>
<p><img src="images/automating_gis_workflows/model10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>Set the <code>'Added geom info' from algorithm 'Add geometry attributes'</code> as the <em>Input layer</em>. The <em>Joim layer</em> will be the <code>States</code> layer. In the <em>Fields to add</em>, enter <code>NAME</code>. Click <em>OK</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/model11.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="12" style="list-style-type: decimal">
<li>In the canvas, you will see another arrow now connecting the <code>States</code> input to the <code>Join attributes by location</code> box. Next, add the <code>Statistics by category</code> algorithm.</li>
</ol>
<p><img src="images/automating_gis_workflows/model12.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>Set the <code>'Join layer' from algorithm 'Join attribues by location'</code> as the <em>Input vector layer</em>. Enter <code>length</code> as the <em>Field to calculate statistics on</em> and <code>NAME</code> as the <em>Field(s) with categories</em>. Click <em>OK</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/model13.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="14" style="list-style-type: decimal">
<li>We are at the last step now. Add the <code>Refactor fields</code> algorithm.</li>
</ol>
<p><img src="images/automating_gis_workflows/model14.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="15" style="list-style-type: decimal">
<li>Set <code>'Statistics by category' from algorithm 'Statistics by categories'</code> as the <em>Input layer</em>. The <em>Field mapping</em> table is empty. We need to add rows for the fields that we want in the output. Click <em>Add new field</em> twice to add 2 rows. Configure the rows to match our input in Step 19 from the previous exercise. As this is the final result, we should specify the name of the output layer. Enter <code>road_length_by_states</code> as <em>Refactored</em>. Click <em>OK</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/model15.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="16" style="list-style-type: decimal">
<li>The model is ready to run. Click the <em>Run</em> button.</li>
</ol>
<p><img src="images/automating_gis_workflows/model16.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="17" style="list-style-type: decimal">
<li>Set <code>tl_2019_us_primaryroads</code> as <em>Roads</em> and <code>tl_2019_us_states</code> as <em>States</em>. Click <em>Run</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/model17.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="18" style="list-style-type: decimal">
<li>As the model runs, you will each step of the process being run and intermediate results generated.</li>
</ol>
<p><img src="images/automating_gis_workflows/model18.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="19" style="list-style-type: decimal">
<li>Once the process finishes, you will see only 1 new layer - our final result, loaded to the <em>Layers</em> panel. You can verify that the result is exactly the same as our manual processing in the previous example. But this time, we only had to specify the inputs and the model did all the hard work.</li>
</ol>
<p><img src="images/automating_gis_workflows/model19.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="20" style="list-style-type: decimal">
<li>Let’s learn how to improve this model. We can generalize this model a little to calculate lengths of not only interstate highways, but other types of roads as well. Go back to the modeler window. Switch to the <em>Inputs</em> tab and drag a new <em>String</em> input. Enter <code>Road Category</code> as the <em>Parameter name</em>.</li>
</ol>
<blockquote>
<p>If you closed the modeler window, you can open it again by going to Processing → Toolbox → Models. Locate the <code>calculate_road_lengths</code> model, right-click and select <em>Edit</em>.</p>
</blockquote>
<p><img src="images/automating_gis_workflows/model20.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="21" style="list-style-type: decimal">
<li>Now instead of hard-coding the value <code>I</code> for the road category, we will make it user configurable. Right-click the <code>Extract by attribute</code> box and select <em>Edit</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/model21.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="22" style="list-style-type: decimal">
<li>Select the <em>123</em> button for <em>Value</em> and select <code>Model Input</code>.</li>
</ol>
<p><img src="images/automating_gis_workflows/model22.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="23" style="list-style-type: decimal">
<li>The parameter <code>Road Category</code> will be auto-selected for the value. This update to our model will allow the user to enter any value as the <em>Road Category</em> which will be used by this algorithm.</li>
</ol>
<p><img src="images/automating_gis_workflows/model23.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="24" style="list-style-type: decimal">
<li>Let’s test the updated algorithm. Click <em>Run</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/model24.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="25" style="list-style-type: decimal">
<li>You will see a new input in the model dialog. Enter <code>U</code> and select the other vector layer inputs. Click <em>Run</em>. The result will be a table with lengths of US Highways for each state.</li>
</ol>
<p><img src="images/automating_gis_workflows/model25.png" width="75%" style="display: block; margin: auto;" /></p>
<div style="page-break-after: always;"></div>
</div>
</div>
<div id="batch-processing" class="section level1">
<h1>Batch Processing</h1>
<p>So far we have run the algorithm on 1 layer at a time. But each processing algorithm can also be run in a <strong>Batch</strong> mode on multiple inputs. This provides an easy way to process large amounts of data and automate repetitive tasks.</p>
<p>The batch processing interface can be invoked by right-clicking any processing algorithm and choosing <strong>Execute as Batch Process</strong>.</p>
<div id="exercise-clip-multiple-layers-to-a-polygon" class="section level2">
<h2>Exercise: Clip multiple layers to a polygon</h2>
<p>We will take multiple country-level data layers and use the batch processing operation to clip them to a state polygon in a single operation.</p>
<p>Open the <strong>batch_processing</strong> project from the data package. The project contains 5 layers in total. The <code>tl_2019_us_state</code> represents individual states. The other layers <code>tl_2019_us_places</code>, <code>tl_2019_us_mil</code>, <code>tl_2019_us_rails</code> and <code>tl_2019_us_primaryroads</code> are line and polygon layers which need to be clipped.</p>
<ol style="list-style-type: decimal">
<li>Select the <code>tl_2019_us_state</code> layer and use the <strong>Select Features</strong> tool to select a state by clicking it.</li>
</ol>
<p><img src="images/automating_gis_workflows/batch1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Next, run the <strong>Extract selected features</strong> processing algorithm. Select <code>tl_2019_us_state</code> as the <em>Input layer</em> and click <em>Run</em>. This will create a new layer with the selected state polygon called <code>Selected features</code></li>
</ol>
<p><img src="images/automating_gis_workflows/batch2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Search for the <strong>Vector Overlay → Clip</strong> algorithm and right-click on it. Select <strong>Execute as Batch Process</strong>.</li>
</ol>
<p><img src="images/automating_gis_workflows/batch3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>In the batch processing dialog, click the <em>…</em> button on the first row of the <em>Input layer</em> column and choose <em>Select from Open Layers..</em>. Select <code>tl_2019_us_places</code>, <code>tl_2019_us_mil</code>, <code>tl_2019_us_rails</code> and <code>tl_2019_us_primaryroads</code> layers and click <em>OK</em>. 3 new rows will be automatically added to accommodate all 4 inputs.</li>
</ol>
<p><img src="images/automating_gis_workflows/batch4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Click the <em>…</em> button on the first row of the <em>Overlay layer</em> column. Select the <code>Selected features</code> layer as the <em>Overlay layer</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/batch5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>As all input layers need to be clipped with the same overlay layer, you can click <em>Autofill..</em> and select <em>Fill Down</em> to autofill all the remaining rows with the same value.</li>
</ol>
<p><img src="images/automating_gis_workflows/batch6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>In the last <em>Clipped</em> column, click the <em>…</em> button and name the output <code>clipped_</code>. When prompted, choose <em>Fill with parameter values</em> as the <em>autofill mode</em>, and <em>Input layer</em> as the <em>Parameter to use</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/batch7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>Make sure the <em>Load layers on completion</em> box is checked and click <em>Run</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/batch8.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>Resulting clipped layers will be added to the Layers panel. We can combine all the clipped layers into a single geopackage file for ease of sharing. Run the <strong>Package Layers</strong> processing algorithm.</li>
</ol>
<p><img src="images/automating_gis_workflows/batch9.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>Choose all the clipped layers and save the output as <code>clipped.gpkg</code>.</li>
</ol>
<p><img src="images/automating_gis_workflows/batch10.png" width="75%" style="display: block; margin: auto;" /></p>
<div style="page-break-after: always;"></div>
</div>
</div>
<div id="packaging-your-work" class="section level1">
<h1>Packaging Your Work</h1>
<p>We saw how we can save multiple layers to a single geopackage file. This makes data sharing easy between computers and users. Your spatial analysis project contains a lot more information than the dataset. There are layer styles, settings, variables, processing models etc. that are saved in different places. Modern versions of QGIS have the ability to store all relevant information into a single geopackage. This means you can document your entire project in a single geopackage.</p>
<div id="exercise-package-source-layers-results-and-model-in-a-geopackage" class="section level2">
<h2>Exercise: Package source layers, results and model in a GeoPackage</h2>
<p>We will take the source layers and result of the spatial analysis exercise of finding length of interstate roads and package them up in a GeoPackage.</p>
<ol style="list-style-type: decimal">
<li>Load the <code>tl_2019_us_primaryroads</code>, <code>tl_2019_us_state</code> and <code>road_lengths_by_state</code> layers in QGIS. Run the <strong>Package Layers</strong> processing algorithm.</li>
</ol>
<p><img src="images/automating_gis_workflows/package1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Choose all the layers as the <em>Input layers</em>. Make sure the <em>Save layer stles into GeoPackage</em> option is checked. Name the <em>Destination GeoPackage</em> as <code>results.gpkg</code>. Click <em>Run</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/package2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Now the layers and their respective layer styles are all contained in a single geopackage file. Click <em>New Project</em> button. You can click <em>Don’t Save</em> when prompted to save the current project.</li>
</ol>
<p><img src="images/automating_gis_workflows/package3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>In the fresh project, drag all the layers from the <code>results.gpkg</code> back in QGIS. Now that all loaded layers are from a single geopackage, we can save the project. Go to <strong>Project → Save To → GeoPackage</strong>.</li>
</ol>
<p><img src="images/automating_gis_workflows/package4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Click the <em>…</em> button next to <em>Connection</em> and browse to the <code>results.gpkg</code> file. Click <em>OK</em>. Enter <code>results</code> as the <em>Project</em> name. Click <em>OK</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/package5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Now the current project - with its layers, settings, variables etc. is also saved inside the <code>results.gpkg</code> file. Click the <em>Refresh</em> button in the <em>Browser</em> panel and expand the <code>results.gpkg</code> file. You will see the <code>results</code> project.</li>
</ol>
<p><img src="images/automating_gis_workflows/package6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>We can also package our processing model that created the results inside the package. This is a good practice since anyone who has the geopackage can reproduce the results using the included model. Open Processing Toolbox and locate the <code>calculate_road_lenghts</code> model under <em>Models</em>. Right-click and select <em>Edit Model</em>.</li>
</ol>
<p><img src="images/automating_gis_workflows/package7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>In the Processing Modeler toolbar, click the <em>Save model in project</em> button. You will get a success message confirming that the model was saved inside the current project.</li>
</ol>
<p><img src="images/automating_gis_workflows/package8.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>Back in the main QGIS window, you will see a new section in the Processing Toolbox called <em>Project Models</em>. This folder contains the models that are saved inside the current project. Anyone who opens this project will have this folder and all the models within it.</li>
</ol>
<p><img src="images/automating_gis_workflows/package9.png" width="75%" style="display: block; margin: auto;" /></p>
<p>GeoPackage is a flexible and versatile format that is adopted across QGIS. You saw how you can package all relevant information about your project inside a single file. Following these practices of saving your models along with source data ensures no information is lost. It also ensures you have well documented workflows that are reproducible by you in the future or by anyone with whom you have shared your data.</p>
<div style="page-break-after: always;"></div>
</div>
</div>
<div id="data-credits" class="section level1">
<h1>Data Credits</h1>
<ul>
<li><a href="https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html">TIGER/Line Shapefiles 2019</a>, US Census Bureau.</li>
<li><a href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html">Cartographic Boundary Files 2018</a> for US States, US Census Bureau.</li>
</ul>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>This course material is licensed under a <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>. You are free to use the material for any non-commercial purpose. Kindly give appropriate credit to the original author.</p>
<p>© 2020 Ujaval Gandhi <a href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
<hr />
<p><strong>This course is offered as an instructor-led online class. Visit <a href="https://spatialthoughts.com/events/">Spatial Thoughts</a> to know details of upcoming sessions.</strong></p>
</div>

<div id="disqus_thread" class="standardPadding"></div>

<!-- disqus -->
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = 'https://courses.spatialthoughts.com' + location.pathname;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://spatialthoughts.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
